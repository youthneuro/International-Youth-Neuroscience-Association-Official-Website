<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <meta name="description" content="">
        <meta name="author" content="">

        <title>IYNA - Member Dashboard</title>

        <!-- Load shared navigation -->
        <script src="js/jquery.min.js"></script>
        <script src="js/load-nav.js"></script>
        <script src="js/load-footer.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="js/database.js"></script>
       

        <!-- CSS FILES -->        
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
        
        <style>
          body, h1, h2, h3, h4, h5, h6, .btn, .navbar-brand, .nav-link, .accordion-button, .custom-block, .custom-btn, .site-footer, .site-footer-link, .copyright-text {
            font-family: 'Work Sans', sans-serif !important;
          }
          
          body {
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            box-sizing: border-box;
            width: 100%;
            max-width: 100vw;
          }

          html {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
          }

          *, *::before, *::after {
            box-sizing: border-box;
          }

          /* Prevent any element from causing horizontal scroll */
          .dashboard-container,
          .tab-content,
          .announcement-card,
          .notification-banner,
          .event-card,
          .task-card,
          .ranking-item,
          .chapter-of-season,
          .search-container,
          .search-box,
          .form-control,
          .modal-content,
          .toast {
            max-width: 100%;
            overflow-x: hidden;
            word-wrap: break-word;
            word-break: break-word;
          }

          /* Ensure modals don't cause horizontal scroll */
          .modal-overlay {
            max-width: 100vw;
            overflow-x: hidden;
          }

          /* Fix any potential table or grid issues */
          table, .grid, .flex {
            max-width: 100%;
            overflow-x: auto;
          }

          /* Loading styles */
          .loading-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            flex-direction: column;
          }
                
          .loading-spinner {
            text-align: center;
          }
                
          .spinner-border {
            color: #6db9c3;
            width: 3rem;
            height: 3rem;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
          }

          @keyframes spinner-border {
            to { transform: rotate(360deg); }
          }

          .error-container {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            margin: 2rem;
            max-width: 500px;
          }

          .retry-btn {
            background: #6db9c3;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 1rem;
          }

          .retry-btn:hover {
            background: #5a9ea7;
          }

          /* Dashboard Container */
          .dashboard-container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 2rem;
            background: white;
            min-height: auto;
            display: none; /* Hidden until loaded */
            box-sizing: border-box;
            overflow-x: hidden;
            overflow-y: visible;
          }

          .dashboard-container.loaded {
            display: block;
          }

          /* Header Section */
          .dashboard-header {
            margin-bottom: 2rem;
          }

          .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #000;
            margin: 0 0 0.5rem 0;
          }

          .dashboard-subtitle {
            color: #6c757d;
            font-size: 1rem;
            margin: 0;
          }

          /* Navigation Tabs */
          .dashboard-nav {
            display: flex;
            gap: 2rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
            flex-wrap: wrap;
          }

          .nav-tab {
            padding: 1rem 0;
            text-decoration: none;
            color: #6c757d;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            white-space: nowrap;
          }

          .nav-tab.active {
            color: #000;
            border-bottom-color: #6db9c3;
          }

          .nav-tab:hover {
            color: #000;
            text-decoration: none;
          }

          /* Tab Content */
          .tab-content {
            display: none;
            margin-top: 0;
            padding-top: 0;
          }

          .tab-content.active {
            display: block;
            margin-top: 0;
            padding-top: 0;
          }

          /* Notification Banner */
          .notification-banner {
            background: linear-gradient(135deg, #b8e9e5 0%, #a0d9d3 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
          }

          .notification-icon {
            width: 24px;
            height: 24px;
            background: #064c5c;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: white;
            font-weight: bold;
          }

          .notification-icon::before {
            content: "!";
            font-size: 14px;
          }

          .notification-text {
            flex: 1;
            color: #064c5c;
            font-weight: 500;
          }

          .view-announcements {
            color: #064c5c;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
          }

          .view-announcements:hover {
            text-decoration: underline;
          }

          /* Announcements Section */
          .announcements-header {
            margin-bottom: 1rem;
            margin-top: 0;
          }

          .announcements-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #000;
            margin: 0;
          }

          /* Announcements Tab */
          #announcements-tab {
            margin-top: -2rem;
            padding-top: 0;
            padding-left: 4rem;
            padding-right: 4rem;
            padding-bottom: 4rem;
          }

          #announcements-tab .search-container {
            margin-bottom: 1rem;
            margin-top: 0;
          }

          .announcements-list {
            margin-top: 1rem;
          }

          /* Announcement Cards */
          .announcement-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: none;
            border: 1px solid #e9ecef;
          }

          .announcement-header {
            font-size: 1.1rem;
            font-weight: 700;
            color: #000;
            margin: 0 0 0.75rem 0;
          }

          .announcement-separator {
            border: none;
            border-top: 2px dashed #e9ecef;
            margin: 0.75rem 0;
          }

          .announcement-text {
            color: #000;
            line-height: 1.6;
            margin: 0;
            font-size: 0.95rem;
          }

          .announcement-link {
            color: #0066cc;
            text-decoration: underline;
            word-break: break-all;
          }

          .announcement-link:hover {
            color: #0052a3;
          }

          .announcement-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 1rem;
          }

          .announcement-status {
            color: #6c757d;
            font-size: 0.85rem;
            font-weight: 500;
          }

          



          /* Section Headers */
          .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
          }

          .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #000;
            margin: 0;
          }

          .view-more {
            color: #6db9c3;
            text-decoration: none;
            font-weight: 500;
          }

          .view-more:hover {
            text-decoration: underline;
          }

          /* No Chapter Message */
          .no-chapter-message {
            text-align: center;
            padding: 3rem 2rem;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 2rem;
          }

          .no-chapter-message h2 {
            font-size: 1.5rem;
            color: #000;
            margin-bottom: 1rem;
          }

          .chapter-directory-btn {
            background: #6db9c3;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-top: 1rem;
          }

          .chapter-directory-btn:hover {
            background: #5a9ea7;
            color: white;
            text-decoration: none;
          }

          /* Rankings Section */
          .rankings-section {
            margin-top: 2rem;
          }

          .rankings-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #000;
            margin-bottom: 1.5rem;
          }

          /* Chapter of the Season Card */
          .chapter-of-season {
            background: linear-gradient(135deg, #2c5364 0%, #203a43 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 0.5rem;
          }

          .season-star {
            width: 48px;
            height: 48px;
            background: #6db9c3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
          }

          .season-star::before {
            content: "⭐";
          }

          .season-info {
            flex: 1;
          }

          .season-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: inline-block;
          }

          .season-school {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0.5rem 0 0.25rem 0;
          }

          .season-code {
            opacity: 0.8;
            font-size: 0.9rem;
          }

          .season-leader {
            opacity: 0.8;
            font-size: 0.9rem;
          }

          /* Search and Filter Section */
          .search-filter-section {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
          }

          /* Search Bar */
          .search-container {
            margin-bottom: 2rem;
            position: relative;
          }

          .search-box {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
          }

          .search-box:focus {
            outline: none;
            border-color: #6db9c3;
          }

          .filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
          }

          .filter-btn {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
          }

          .filter-btn.active {
            background: #6db9c3;
            color: white;
            border-color: #6db9c3;
          }

          .filter-dropdown {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            min-width: 120px;
          }

          .clear-filters {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
          }

          /* Rankings List */
          .rankings-list {
            background: white;
            border: 1px solid #e9ecef;
            overflow: hidden;
          }

          .ranking-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s ease;
          }

          .ranking-item:last-child {
            border-bottom: none;
          }

          .ranking-item:hover {
            background-color: #f8f9fa;
          }

          .ranking-item.featured {
            background: linear-gradient(135deg, #fff5e6 0%, #ffe9cc 100%);
            border-left: 4px solid #ff8c00;
          }

          .ranking-position {
            font-size: 1.2rem;
            font-weight: 700;
            color: #000;
            min-width: 40px;
            margin-right: 1rem;
          }

          .ranking-position.featured {
            color: #ff8c00;
          }

          .ranking-chapter-info {
            flex: 1;
            margin-right: 1rem;
          }

          .ranking-chapter-name {
            font-size: 1rem;
            font-weight: 600;
            color: #000;
            margin: 0 0 0.25rem 0;
          }

          .ranking-school-name {
            font-size: 0.9rem;
            color: #6c757d;
            margin: 0;
          }

          .ranking-points-section {
            text-align: right;
            margin-right: 1rem;
          }

          .ranking-points {
            font-size: 1.1rem;
            font-weight: 700;
            color: #000;
            margin: 0;
          }

          .ranking-points-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin: 0;
          }

          .request-join-btn {
            background: #6db9c3;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
          }

          .request-join-btn:hover {
            background: #5a9ea7;
          }

          .request-join-btn:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
          }

          /* Events and Tasks Styles */
          .events-grid, .tasks-list {
            display: grid;
            gap: 1.5rem;
            margin-top: 1rem;
          }

          .event-card, .task-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            transition: box-shadow 0.2s ease;
          }

          .event-card:hover, .task-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
          }

          .event-title, .task-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #000;
            margin: 0 0 0.5rem 0;
          }

          .event-subtitle {
            color: #6c757d;
            margin: 0 0 1rem 0;
            line-height: 1.5;
          }

          .task-description {
            color: #000;
            margin: 0 0 1rem 0;
            line-height: 1.5;
            font-size: 1rem;
          }

          .event-footer, .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
          }

          .event-date, .task-deadline {
            color: #6c757d;
            font-size: 0.9rem;
          }

          .event-button, .request-points-btn {
            background: #6db9c3;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
          }

          .event-button:hover, .request-points-btn:hover {
            background: #5a9ea7;
            text-decoration: none;
            color: white;
          }

          .task-meta {
            display: flex;
            gap: 1rem;
            margin: 0.5rem 0;
            flex-wrap: wrap;
          }

          .task-points {
            background: #6db9c3;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
          }

          .task-code, .task-deadline {
            color: #6c757d;
            font-size: 0.9rem;
          }

          /* Loading/Empty States */
          .loading-text {
            color: #6c757d;
            text-align: center;
            padding: 2rem;
            font-style: italic;
          }

          .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
          }

          .empty-state h3 {
            color: #6c757d;
            margin-bottom: 1rem;
          }

          /* Modal Styles */
          .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
            overflow-y: auto;
            padding: 20px;
          }

          .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            animation: modalSlideIn 0.3s ease;
          }

          @keyframes modalSlideIn {
            from {
              opacity: 0;
              transform: scale(0.9) translateY(-20px);
            }
            to {
              opacity: 1;
              transform: scale(1) translateY(0);
            }
          }

          /* Toast Styles */
          .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            display: none;
            z-index: 1001;
            font-weight: 500;
            min-width: 300px;
            max-width: calc(100vw - 40px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: toastSlideIn 0.3s ease;
          }

          .toast.error {
            background: #dc3545;
          }

          .toast.warning {
            background: #ffc107;
            color: #000;
          }

          .toast.info {
            background: #17a2b8;
          }

          @keyframes toastSlideIn {
            from {
              opacity: 0;
              transform: translateX(100%);
            }
            to {
              opacity: 1;
              transform: translateX(0);
            }
          }

          /* Form Elements */
          .form-group {
            margin-bottom: 1.5rem;
          }

          .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #000;
            font-weight: 600;
          }

          .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
          }

          .form-control:focus {
            outline: none;
            border-color: #6db9c3;
            box-shadow: 0 0 0 2px rgba(109, 185, 195, 0.1);
          }

          /* Button Loading State */
          .btn-loading {
            opacity: 0.7;
            cursor: not-allowed;
            position: relative;
          }

          .btn-loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid white;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spinner-border 0.75s linear infinite;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
          }

          /* Responsive Design */
          @media (max-width: 768px) {
            .dashboard-container {
              padding: 2rem;
              max-width: 100%;
            }

            .dashboard-nav {
              gap: 1rem;
            }

            .search-filter-section {
              flex-direction: column;
              align-items: stretch;
            }

            .search-box {
              min-width: auto;
            }

            .filter-group {
              justify-content: space-between;
            }

            .ranking-item {
              flex-direction: column;
              align-items: flex-start;
              gap: 0.5rem;
            }

            .ranking-position {
              min-width: auto;
              margin-right: 0;
            }

            .ranking-points-section {
              text-align: left;
              margin-right: 0;
            }

            .notification-banner {
              flex-direction: column;
              text-align: center;
              gap: 1rem;
            }

            .chapter-of-season {
              flex-direction: column;
              text-align: center;
            }

            .modal-content {
              margin: 1rem;
              padding: 1.5rem;
            }
          }

          /* Extra small screens */
          @media (max-width: 480px) {
            .dashboard-container {
              padding: 0.5rem;
            }
            
            .dashboard-title {
              font-size: 2rem;
            }
            
            .nav-tab {
              padding: 0.75rem 0;
              font-size: 0.9rem;
            }

            .toast {
              min-width: auto;
              max-width: calc(100vw - 20px);
              right: 10px;
              left: 10px;
            }
          }

          /* Force no horizontal scroll on all screen sizes */
          @media (max-width: 100vw) {
            body, html {
              overflow-x: hidden !important;
              width: 100% !important;
              max-width: 100vw !important;
            }
          }

          /* Chapter Dashboard Styles */
          
          /* Chapter Bio Section Styles */
          .chapter-bio-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-sizing: border-box;
            overflow: visible;
          }
          
          .bio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
          }
          
          .bio-actions {
            display: flex;
            gap: 0.5rem;
          }
          
          .bio-content {
            margin-bottom: 1.5rem;
          }
          
          .bio-content p {
            font-size: 1rem;
            line-height: 1.6;
            color: #333;
            margin: 0 0 1rem 0;
          }
          
          .bio-content .no-bio {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
          }
          
          .social-media-links {
            border-top: 1px solid #e9ecef;
            padding-top: 1.5rem;
          }
          
          .social-media-title {
            font-size: 1rem;
            font-weight: 600;
            color: #000;
            margin: 0 0 1rem 0;
          }
          
          .social-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.25rem;
          }
          
          .social-link-item {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 0.75rem;
            padding: 0.9rem 1rem;
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            text-decoration: none;
            color: #212529;
            transition: box-shadow 0.2s ease, transform 0.2s ease, border-color 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            width: 100%;
          }
          .social-link-item:hover {
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            transform: translateY(-1px);
            border-color: #dee2e6;
          }
          .social-link-item .label {
            font-weight: 600;
            letter-spacing: 0.2px;
            color: #0f172a;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
          }
          .social-link-item .icon {
            font-size: 1rem;
            color: #94a3b8;
            margin-left: .25rem;
            transition: transform 0.2s ease, color 0.2s ease;
          }
          .social-link-item:hover .icon {
            transform: translateX(2px);
            color: #1B4965;
          }
          .social-link-item.instagram .label { color: #e4405f; }
          .social-link-item.facebook .label { color: #1877f2; }
          .social-link-item.twitter .label { color: #1da1f2; }
          .social-link-item.linkedin .label { color: #0077b5; }
          .social-link-item.youtube .label { color: #ff0000; }
          .social-link-item.website .label { color: #1B4965; }
          
          .social-link-item:hover {
            background: #f8fafc;
            color: #212529;
            text-decoration: none;
          }
          
          /* Remove icon spacing since we no longer show icons */
          .social-link-item i { display: none; }
          
          .social-link-item.instagram { color: #e4405f; }
          .social-link-item.facebook { color: #1877f2; }
          .social-link-item.twitter { color: #1da1f2; }
          .social-link-item.linkedin { color: #0077b5; }
          .social-link-item.youtube { color: #ff0000; }
          .social-link-item.website { color: #6c757d; }
          
          .pending-join-message {
            margin-bottom: 1rem;
          }
          
          .chapter-dashboard-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1rem;
          }

          .chapter-directors-section {
            margin-bottom: 2rem;
          }

          .chapter-directors-section,
          .chapter-stats-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            box-sizing: border-box;
            overflow: visible;
            min-height: 300px;
          }

          .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #000;
            margin: 0 0 1.5rem 0;
          }

          .directors-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
          }

          .director-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
          }

          .director-icon {
            width: 40px;
            height: 40px;
            background: #1B4965;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
          }

          .director-info {
            flex: 1;
          }

          .director-name {
            font-size: 1rem;
            font-weight: 600;
            color: #000;
            margin: 0;
          }

          .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            width: 100%;
            box-sizing: border-box;
          }

          .stats-subsection {
            margin-bottom: 0;
          }

          .subsection-title {
            font-size: 1rem;
            font-weight: 600;
            color: #000;
            margin: 0 0 0.75rem 0;
          }

          .rank-card,
          .points-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            height: calc(100% - 2rem);
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-sizing: border-box;
            max-width: 100%;
            margin-bottom: 2rem;
          }

          .rank-number,
          .points-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1B4965;
            margin: 0;
          }

          .rank-divider {
            width: 100%;
            height: 1px;
            background: #1B4965;
            margin: 0.5rem 0;
          }

          .total-chapters {
            font-size: 2rem;
            font-weight: 700;
            color: #1B4965;
            margin: 0;
          }

          .request-points-link {
            display: block;
            margin-top: 0.75rem;
            color: #1B4965;
            text-decoration: underline;
            font-size: 0.9rem;
            font-weight: 500;
          }

          .request-points-link:hover {
            color: #0d2d3a;
            text-decoration: none;
          }

          /* Member Roster Styles */
          .member-roster-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            box-sizing: border-box;
            overflow: hidden;
            min-height: 400px;
          }

          .roster-header {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
          }

          .member-count {
            color: #6c757d;
            font-size: 1rem;
            font-weight: 400;
          }

          .member-table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e9ecef;
          }

          .member-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: white;
          }

          .member-table thead {
            background: white;
            border-bottom: 1px solid #e9ecef;
          }

          .member-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #000;
            border-bottom: 1px solid #e9ecef;
            position: relative;
          }

          .member-table th.sortable {
            cursor: pointer;
            user-select: none;
          }

          .member-table th.sortable:hover {
            background: #f8f9fa;
          }

          .sort-icon {
            font-size: 0.7rem;
            color: #6c757d;
            margin-left: 0.25rem;
          }

          .points-header {
            color: #1B4965 !important;
            text-align: center;
          }

          .member-table tbody tr {
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s ease;
            height: 60px;
          }

          .member-table tbody tr:hover {
            background: #f8f9fa;
          }

          .member-table tbody tr:last-child {
            border-bottom: none;
          }

          .member-table td {
            padding: 1rem;
            color: #495057;
            vertical-align: middle;
            line-height: 1.4;
            text-align: center;
          }

          .member-table td:first-child {
            font-weight: 500;
            color: #000;
          }

          .member-table td:nth-child(3) {
            font-weight: 500;
          }

          /* Global Rankings Styles */
          .global-rankings-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            box-sizing: border-box;
            overflow: hidden;
            min-height: 400px;
          }

          .chapter-of-season {
            background: #1B4965;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            text-align: center;
            color: white;
          }

          .season-label {
            font-size: 0.8rem;
            color: #b8c5cc;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0;
          }

          .season-chapter-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0;
          }

          .season-chapter-code {
            font-size: 0.9rem;
            color: #b8c5cc;
            margin-bottom: 0;
          }

          .season-leader {
            font-size: 0.8rem;
            color: #b8c5cc;
            margin-bottom: 0;
          }

          .rankings-list-container {
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            overflow: hidden;
          }

          .rankings-list {
            padding: 1rem;
          }

          .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #f8f9fa;
            font-size: 0.9rem;
          }

          .ranking-item:last-child {
            border-bottom: none;
          }

          .ranking-number {
            font-weight: 600;
            color: #000;
            min-width: 30px;
          }

          .ranking-chapter {
            flex: 1;
            margin: 0 1rem;
            color: #495057;
          }

          .ranking-points {
            font-weight: 500;
            color: #1B4965;
            min-width: 80px;
            text-align: right;
          }

          .view-directory-link {
            text-align: center;
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
          }

          .view-directory-link a {
            color: #1B4965;
            text-decoration: none;
            font-weight: 500;
          }

          .view-directory-link a:hover {
            text-decoration: underline;
          }

          /* Responsive design for chapter dashboard */
          @media (max-width: 768px) {
            .chapter-dashboard-container {
              grid-template-columns: 1fr;
              gap: 1rem;
            }
            
            .stats-row {
              grid-template-columns: 1fr;
              gap: 1rem;
            }
          }

          /* Events Section Styles */
          .events-section {
            margin-bottom: 0;
          }

          .events-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
          }

          .events-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #000;
            margin: 0;
          }

          .view-all-link {
            color: #6db9c3;
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
          }

          .view-all-link:hover {
            color: #5aa6b0;
            text-decoration: underline;
          }

          .event-filter-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
          }

          .event-filter-tab {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
          }

          .event-filter-tab.active {
            background: #6db9c3;
            color: white;
            border-color: #6db9c3;
          }

          .event-filter-tab:hover {
            background: #e9ecef;
          }

          .event-filter-tab.active:hover {
            background: #5aa6b0;
          }

          .events-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(350px, 1fr));
            gap: 2rem;
            justify-content: start;
          }

          .event-card {
            background: #DFE7EC;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            position: relative;
            transition: all 0.3s ease;
            aspect-ratio: 4/3;
            display: flex;
            flex-direction: column;
            min-height: 280px;
          }

          .event-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
          }

          .event-card.past {
            border: 2px dotted #e9ecef;
            background: white;
            /* Maintain same sizing and positioning */
            padding: 2rem;
            aspect-ratio: 4/3;
            min-height: 280px;
            display: flex;
            flex-direction: column;
          }

          .event-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #000;
            margin: 0 0 0.75rem 0;
          }

          .event-subtitle {
            font-size: 1rem;
            color: #495057;
            margin: 0 0 0.5rem 0;
          }

          .event-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 2rem;
            position: absolute;
            bottom: 2rem;
            left: 2rem;
            right: 2rem;
          }

          .event-date-time {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
          }

          .event-date {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
            color: #495057;
            font-size: 0.9rem;
          }

          .event-time {
            color: #495057;
            font-size: 0.9rem;
            font-weight: 500;
          }

          .calendar-icon {
            color: #6db9c3;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1;
          }

          .event-date-text {
            color: #495057;
            font-size: 0.9rem;
            font-weight: 500;
            line-height: 1;
          }

          .event-status {
            color: #6c757d;
            font-size: 0.85rem;
            font-style: italic;
          }

          .view-details-btn {
            background: #6db9c3;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: background-color 0.3s ease;
          }

          .view-details-btn:hover {
            background: #5aa6b0;
          }

          .timeline-connector {
            position: absolute;
            bottom: -10px;
            right: 20px;
            width: 60px;
            height: 20px;
            border-right: 2px dashed #e9ecef;
            border-bottom: 2px dashed #e9ecef;
          }

          /* Tasks Section Styles */
          .tasks-section {
            margin-top: 2rem;
            margin-bottom: 0;
          }

          .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 3rem;
          }

          .tasks-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #000;
            margin: 0;
          }

          .tasks-stats {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-top: 2rem;
          }

          .top-earner-badge {
            background: #6db9c3;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
          }

          .star-icon {
            font-size: 0.9rem;
          }

          .points-display {
            text-align: right;
          }

          .points-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #000;
            margin: 0;
          }

          .points-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin: 0;
          }

          .tasks-controls {
            display: flex;
            flex-direction: column;
            gap: 0rem;
            margin-bottom: 1rem;
            margin-top: -1rem;
          }

          .filter-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
          }

          /* Sub-tabs for New/Past filtering */
          .sub-tabs {
            display: flex;
            gap: 0.5rem;
            background: #f8f9fa;
            padding: 4px;
            border-radius: 8px;
          }

          .sub-tab {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            color: #6c757d;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            cursor: pointer;
          }

          .sub-tab:hover {
            color: #1B4965;
            background: rgba(27, 73, 101, 0.1);
          }

          .sub-tab.active {
            background: #1B4965;
            color: white;
          }

          /* Past point requests styling */
          .past-request {
            background: white;
          }

          .past-request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
          }

          .approved-badge {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
          }

          .evidence-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
          }

          .evidence-section strong {
            color: #1B4965;
            font-size: 0.9rem;
          }

          .evidence-text {
            margin: 0.5rem 0 0 0;
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.4;
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 6px;
          }

          .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
          }

          .filter-btn {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s ease;
          }

          .filter-btn:hover {
            background: #e9ecef;
          }

          .filter-btn.active {
            background: #6db9c3;
            color: white;
            border-color: #6db9c3;
          }

          .clear-filters {
            display: flex;
            align-items: center;
            gap: 0.25rem;
          }

          .clear-icon {
            font-size: 0.9rem;
          }

          .filter-toggle-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
          }

          .filter-toggle-btn:hover {
            background: #5a6268;
          }

          .filter-icon {
            font-size: 0.8rem;
          }

          .tasks-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
          }

          .task-card-personal {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
          }

          .task-card-personal:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          }

          .task-card-personal.expanded {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          }

          .task-header-personal {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
          }

          .task-title-personal {
            font-size: 1.1rem;
            font-weight: 600;
            color: #000;
            margin: 0 0 0.5rem 0;
            flex: 1;
          }

          .task-meta-personal {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
          }

          .task-points-personal {
            background: #6db9c3;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
          }

          .task-code-personal {
            font-weight: 600;
            color: #495057;
          }

          .task-description-personal {
            color: #495057;
            line-height: 1.6;
            margin: 1rem 0;
            display: none;
          }

          .task-description-personal.expanded {
            display: block;
          }

          .reward-breakdown {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            display: none;
          }

          .reward-breakdown.expanded {
            display: block;
          }

          .reward-breakdown ul {
            margin: 0;
            padding-left: 1.5rem;
          }

          .reward-breakdown li {
            margin-bottom: 0.5rem;
            color: #495057;
            line-height: 1.4;
          }

          .task-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 1rem;
            display: none;
          }

          .task-actions.expanded {
            display: flex;
          }

          .request-points-btn {
            background: #6db9c3;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: background-color 0.3s ease;
          }

          .request-points-btn:hover {
            background: #5aa6b0;
          }

          .completed-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
          }

          .task-connector {
            position: absolute;
            top: 50%;
            right: -20px;
            width: 20px;
            height: 2px;
            background: #e9ecef;
            border-top: 2px dotted #e9ecef;
          }

          /* Responsive design for tasks */
          @media (max-width: 768px) {
            .tasks-header {
              flex-direction: column;
              gap: 1rem;
            }

            .tasks-stats {
              justify-content: space-between;
              width: 100%;
            }

            .tasks-controls {
              flex-direction: column;
              gap: 0.25rem;
            }

            .filter-container {
              justify-content: space-between;
              width: 100%;
            }

            .filter-buttons {
              flex: 1;
            }
          }

          /* Responsive design for events */
          @media (max-width: 1024px) {
            .events-grid {
              grid-template-columns: repeat(2, 1fr);
            }
          }

          @media (max-width: 768px) {
            .events-grid {
              grid-template-columns: 1fr;
            }
          }

          /* Main Announcement Banner */
          .main-announcement-banner {
            background: #BEE9E8;
            border-radius: 12px;
            margin: 1.5rem 0;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(190, 233, 232, 0.3);
            border-left: 4px solid #6db9c3;
          }

          .announcement-content {
            padding: 1.5rem;
            color: #1B4965;
          }



          .announcement-content {
            display: flex;
            align-items: center;
            gap: 1rem;
          }

          /* No Chapter Message Styles */
          .no-chapter-message {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            margin-bottom: 2rem;
          }

          .no-chapter-content {
            max-width: 500px;
            margin: 0 auto;
          }

          .no-chapter-content .section-title {
            color: #1B4965;
            margin-bottom: 1rem;
            font-size: 1.8rem;
            font-weight: 700;
          }

          .no-chapter-text {
            color: #6c757d;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 2rem;
          }

          .no-chapter-actions {
            margin-top: 2rem;
          }

          .no-chapter-actions .btn {
            background: #1B4965;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-block;
          }

          .no-chapter-actions .btn:hover {
            background: #0f2d3f;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(27, 73, 101, 0.3);
          }

          /* Chapter Dashboard Row Layout */
          .chapter-dashboard-row {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
          }

          .chapter-dashboard-row:last-child {
            margin-bottom: 0;
          }

          .chapter-dashboard-row .chapter-directors-section,
          .chapter-dashboard-row .chapter-stats-section,
          .chapter-dashboard-row .member-roster-section,
          .chapter-dashboard-row .global-rankings-section {
            flex: 1;
            min-width: 0;
          }

          .announcement-icon {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
          }

          .announcement-text {
            flex: 1;
          }





          .announcement-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0 0 0.75rem 0;
            color: #1B4965;
          }

          .announcement-message {
            font-size: 1rem;
            line-height: 1.5;
            margin: 0;
            color: #1B4965;
          }

          @media (max-width: 768px) {
            .main-announcement-banner {
              margin: 1rem 0;
            }
            
            .announcement-content {
              padding: 1rem;
            }
            
            .announcement-title {
              font-size: 1.2rem;
            }
            
            .announcement-message {
              font-size: 0.9rem;
            }
          }

          /* Chapter Management Section */
          .chapter-management-section {
            padding: 1rem 0 2rem 0;
            margin-top: 1rem;
          }

          .chapter-actions {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            text-align: center;
          }

          .chapter-buttons {
            display: flex;
            gap: 2rem;
            justify-content: center;
            flex-wrap: wrap;
          }

          .chapter-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
          }

          .leave-chapter-btn {
            background: #dc3545;
            color: white;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
          }

          .leave-chapter-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
          }

          .new-chapter-btn {
            background: #28a745;
            color: white;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
          }

          .new-chapter-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
          }



          @media (max-width: 768px) {
            .chapter-buttons {
              flex-direction: column;
              align-items: center;
            }

            .chapter-btn {
              min-width: 250px;
            }
          }
        </style>
                        
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/bootstrap-icons.css" rel="stylesheet">
        <link href="css/templatemo-topic-listing.css" rel="stylesheet">      
    </head>
    
    <body>
        <!-- Navigation Placeholder -->
        <div id="nav-placeholder"></div>

        <!-- Loading Screen -->
        <div class="loading-container" id="loadingContainer">
            <div class="loading-spinner">
                <div class="spinner-border" role="status">
                    <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Loading...</span>
                </div>
                                        <h3 style="margin-top: 1rem;">Loading Member Dashboard...</h3>
                <p style="color: #6c757d;">Verifying your access and loading data</p>
            </div>
        </div>

        <div class="dashboard-container" id="dashboardContainer">
            <!-- Header -->
            <div class="dashboard-header">
                <h1 class="dashboard-title" id="dashboardTitle">Hi, <span id="userName">Loading...</span></h1>
                <p class="dashboard-subtitle" id="userSubtitle">Member • <span id="chapterInfo">Loading...</span></p>
            </div>

            <!-- Main Announcement Banner -->
            <div class="main-announcement-banner" id="mainAnnouncementBanner" style="display: none;">
                <div class="announcement-content">
                    <img src="images/icons/speaker.png" alt="Announcement" class="announcement-icon">
                    <div class="announcement-text">
                        <h3 class="announcement-title" id="bannerAnnouncementTitle">Loading...</h3>
                        <p class="announcement-message" id="bannerAnnouncementMessage">Loading...</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="dashboard-nav">
                <a class="nav-tab active" data-tab="personal">Member Dashboard</a>
                <a class="nav-tab" data-tab="chapter">Chapter Dashboard</a>
                <a class="nav-tab" data-tab="announcements">Announcements</a>
            </nav>

            <!-- Personal Dashboard Tab -->
            <div id="personal-tab" class="tab-content active">
                <div class="events-section">
                    <div class="events-header">
                        <h2 class="events-title">Events</h2>
                        <a href="events_landing.html" class="view-all-link">View all →</a>
                </div>

                    <div class="event-filter-tabs">
                        <button class="event-filter-tab active" data-filter="upcoming">Upcoming</button>
                        <button class="event-filter-tab" data-filter="past">Past</button>
                    </div>

                    <div class="events-grid" id="eventsGrid">
                        <div class="loading-text">Loading events...</div>
                    </div>
                </div>

                <div class="tasks-section">
                    <div class="tasks-header">
                        <h2 class="tasks-title">Tasks</h2>
                        <div class="tasks-stats">
                            <div class="top-earner-badge">
                                <span class="star-icon">★</span>
                                <span>top earner</span>
                            </div>
                        <div class="points-display">
                                <div class="points-value" id="personalTotalPoints">0</div>
                                <div class="points-label">Total points earned</div>
                            </div>
                        </div>
                    </div>

                    <div class="tasks-controls">
                        <div class="search-container">
                            <div class="search-input-wrapper">
                                <input type="text" class="search-box" placeholder="Search" id="personalTaskSearch">
                            </div>
                        </div>
                        <div class="filter-container">
                            <div class="event-filter-tabs">
                                <button class="event-filter-tab active" data-subtab="new">New</button>
                                <button class="event-filter-tab" data-subtab="past">Past</button>
                            </div>
                        </div>
                    </div>

                    <div class="tasks-grid" id="personalTasksGrid">
                        <div class="loading-text">Loading tasks...</div>
                    </div>
                </div>
            </div>

            <!-- Chapter Dashboard Tab -->
            <div id="chapter-tab" class="tab-content">
                <!-- No Chapter Message (shown when user has no chapter) -->
                <div id="noChapterMessage" class="no-chapter-message" style="display: none;">
                    <div class="no-chapter-content">
                        <h2 class="section-title">No Chapter Assigned</h2>
                        <p class="no-chapter-text">You're not currently part of a chapter. Join one to see chapter information, member rosters and chapter statistics.</p>
                        <div class="no-chapter-actions">
                            <a href="chapters.html" class="btn btn-primary">Explore Chapters</a>
                        </div>
                    </div>
                </div>

                                <!-- Chapter Dashboard Content (shown when user has a chapter) -->
                <div id="chapterDashboardContent">
                    <!-- Chapter Bio Section -->
                    <div class="chapter-bio-section">
                        <div class="bio-header">
                            <h2 class="section-title">Chapter Bio</h2>
                            <div class="bio-actions" id="bioActions" style="display: none;">
                                <button class="btn btn-sm" style="background:#1B4965; color:#fff; border:none;" onclick="editChapterBio()">
                                    Edit Bio
                                </button>
                            </div>
                        </div>
                        
                        <div class="bio-content" id="chapterBioContent">
                            <div class="loading-text">Loading chapter bio...</div>
                        </div>
                        
                        <div class="social-media-links" id="socialMediaLinks" style="display: none;">
                            <h4 class="social-media-title">Connect With Us</h4>
                            <div class="social-links-grid" id="socialLinksGrid">
                                <!-- Social media links will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Top Row: Chapter Directors and Chapter Stats -->
                    <div class="chapter-dashboard-row">
                        <div class="chapter-directors-section">
                            <h2 class="section-title">Chapter Director(s)</h2>
                            <div class="directors-list" id="directorsList">
                                <div class="loading-text">Loading chapter directors...</div>
                            </div>
                        </div>

                        <div class="chapter-stats-section">
                            <h2 class="section-title">Chapter Stats</h2>
                            
                            <div class="stats-row">
                                <!-- Rank Section -->
                                <div class="stats-subsection">
                                    <h3 class="subsection-title">Rank</h3>
                                    <div class="rank-card">
                                        <div class="rank-number" id="chapterRank">1</div>
                                        <div class="rank-divider"></div>
                                        <div class="total-chapters" id="totalChapters">1200</div>
                                    </div>
                                </div>

                                <!-- Points Section -->
                                <div class="stats-subsection">
                                    <h3 class="subsection-title">Points</h3>
                                    <div class="points-card">
                                        <div class="points-number" id="chapterPoints">60</div>
                                        <a href="#" class="request-points-link" onclick="openTaskSubmissionModal()">Request points for chapter</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Row: Member Roster and Global Rankings -->
                    <div class="chapter-dashboard-row">
                        <div class="member-roster-section">
                            <div class="roster-header">
                                <h2 class="section-title">Member Roster</h2>
                                <span class="member-count" id="memberCount">(0 members)</span>
                            </div>

                            <div class="search-container">
                                <div class="search-input-wrapper">
                                    <span class="search-icon">Search</span>
                                    <input type="text" class="search-box" placeholder="Search" id="memberSearch">
                            </div>
                        </div>

                            <div class="member-table-container">
                                <table class="member-table">
                                    <thead>
                                        <tr>
                                            <th class="sortable">
                                                Name<span class="sort-icon">▼</span>
                                            </th>
                                            <th class="sortable">
                                                Role<span class="sort-icon">▼</span>
                                            </th>
                                            <th class="sortable points-header">
                                                Points<span class="sort-icon">▼</span>
                                            </th>
                                            <th class="sortable">
                                                School<span class="sort-icon">▼</span>
                                            </th>
                                            <th class="sortable">
                                                Discord<span class="sort-icon">▼</span>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="memberTableBody">
                                        <tr>
                                            <td colspan="5" class="loading-text">Loading members...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="global-rankings-section">
                            <h2 class="section-title">Global Rankings</h2>
                            
                            <!-- Chapter of the Season -->
                            <div class="chapter-of-season">
                                <div class="season-label">CHAPTER OF THE SEASON</div>
                                <div class="season-chapter-name" id="seasonChapterName">Loading...</div>
                                <div class="season-chapter-code" id="seasonChapterCode">Loading...</div>
                                <div class="season-leader" id="seasonLeader">Loading...</div>
                        </div>

                            <!-- Global Rankings List -->
                            <div class="rankings-list-container">
                        <div class="rankings-list" id="rankingsList">
                                    <div class="loading-text">Loading global rankings...</div>
                                </div>
                                <div class="view-directory-link">
                                    <a href="#" onclick="viewDirectory()">View Directory</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>


                    </div>

            <!-- Announcements Tab -->
            <div id="announcements-tab" class="tab-content">
                <div class="search-container">
                    <input type="text" class="search-box" placeholder="Search announcements..." id="announcementSearch">
                </div>
                
                <div class="announcements-list" id="announcementsList">
                    <div class="loading-text">Loading announcements...</div>
                </div>
            </div>
        </div>
                
        <!-- Chapter Management Section -->
        <div class="chapter-management-section" id="chapterManagementSection" style="display: none;">
            <div class="chapter-actions">
                <div class="chapter-buttons">
                    <button class="chapter-btn leave-chapter-btn" onclick="showLeaveChapterModal()">
                        Leave Chapter
                    </button>

                </div>
            </div>
        </div>

        <!-- Footer Placeholder -->
        <div id="footer-placeholder"></div>

        <!-- Point Request Modal -->
        <div class="modal-overlay" id="pointRequestModal" style="display: none;">
            <div class="modal-content" style="max-width: 600px; background: white; border-radius: 16px; padding: 0; overflow: hidden; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);">
                <!-- Modal Header -->
                <div style="background: #1B4965; padding: 2rem 2rem 1.5rem 2rem; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: 1.8rem; font-weight: 700; color: white;">Request Points</h3>
                        <button onclick="closePointRequestModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: white; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</button>
                    </div>
                </div>
                
                <!-- Modal Body -->
                <div style="padding: 2rem; max-height: 60vh; overflow-y: auto;">
                    <div class="task-info-section" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid #e9ecef; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                        <h4 style="margin: 0 0 1rem 0; color: #1B4965; font-size: 1.4rem; font-weight: 700;" id="modalTaskTitle">Task Title</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div>
                                <strong style="color: #6c757d; font-size: 0.9rem;">Points:</strong>
                                <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalTaskPoints">0</div>
                            </div>
                            <div>
                                <strong style="color: #6c757d; font-size: 0.9rem;">Deadline:</strong>
                                <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalTaskDeadline">N/A</div>
                            </div>
                            <div>
                                <strong style="color: #6c757d; font-size: 0.9rem;">Code:</strong>
                                <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalTaskCode">N/A</div>
                            </div>
                        </div>
                        <div style="margin-top: 1.5rem;">
                            <strong style="color: #6c757d; font-size: 0.9rem;">Description:</strong>
                            <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalTaskDescription">Task description</div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #000; font-size: 0.9rem;">Task Name *</label>
                        <input 
                            type="text" 
                            id="taskNameInput" 
                            class="form-control"
                            placeholder="Enter task name (e.g., Lab Safety Training, Workshop Attendance)"
                            style="width: 300px; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 8px; font-size: 0.95rem; font-family: inherit; transition: border-color 0.2s, box-shadow 0.2s;"
                            onfocus="this.style.borderColor='#1B4965'; this.style.boxShadow='0 0 0 2px rgba(27, 73, 101, 0.1)'"
                            onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"
                            required>
                        <small style="color: #6c757d; font-size: 0.9rem; margin-top: 0.5rem; display: block;">Enter a descriptive name for the task or activity you completed.</small>
                    </div>
                
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #000; font-size: 0.9rem;">Task Code *</label>
                        <input 
                            type="text" 
                            id="taskCodeInput" 
                            class="form-control"
                            placeholder="Enter task code (e.g., SAF001, EDU002)"
                            style="width: 300px; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 8px; font-size: 0.95rem; font-family: inherit; transition: border-color 0.2s, box-shadow 0.2s;"
                            onfocus="this.style.borderColor='#1B4965'; this.style.boxShadow='0 0 0 2px rgba(27, 73, 101, 0.1)'"
                            onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"
                            required>
                        <small style="color: #6c757d; font-size: 0.9rem; margin-top: 0.5rem; display: block;">Enter the specific task code for the activity you completed.</small>
                </div>
                
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #000; font-size: 0.9rem;">Points Requested *</label>
                        <input 
                            type="number" 
                            id="pointsRequested" 
                            class="form-control"
                            placeholder="Enter points to request"
                            style="width: 200px; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 8px; font-size: 0.95rem; font-family: inherit; background-color: white; color: #1B4965; font-weight: 500; transition: border-color 0.2s, box-shadow 0.2s;"
                            onfocus="this.style.borderColor='#1B4965'; this.style.boxShadow='0 0 0 2px rgba(27, 73, 101, 0.1)'"
                            onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"
                            min="1" 
                            required>
                        <small style="color: #6c757d; font-size: 0.9rem; margin-top: 0.5rem; display: block;">You can request any number of points. Admins will review and may adjust the final points awarded based on your evidence.</small>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #000; font-size: 0.9rem;">Evidence of Completion *</label>
                        <textarea 
                            id="evidenceTextarea" 
                            class="form-control"
                            placeholder="Provide detailed evidence of your task completion. Include specific details, results, or describe what you accomplished..."
                            style="min-height: 120px; resize: vertical; width: 100%; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 8px; font-size: 0.95rem; font-family: inherit; transition: border-color 0.2s, box-shadow 0.2s;"
                            onfocus="this.style.borderColor='#1B4965'; this.style.boxShadow='0 0 0 2px rgba(27, 73, 101, 0.1)'"
                            onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"
                            required></textarea>
                        <small style="color: #6c757d; font-size: 0.9rem; margin-top: 0.5rem; display: block;">Be specific and detailed in your evidence to help with the review process.</small>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #000; font-size: 0.9rem;">File Evidence (Optional)</label>
                        <div class="file-upload-container" style="border: 2px dashed #e9ecef; border-radius: 8px; padding: 1.5rem; text-align: center; transition: border-color 0.2s;">
                        <input 
                                type="file" 
                                id="evidenceFiles" 
                            class="form-control"
                                multiple
                                accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.txt,.zip,.rar"
                                style="display: none;"
                                onchange="handleFileSelection()">
                            <label for="evidenceFiles" style="cursor: pointer; display: block;">
                                <div style="color: #6c757d; margin-bottom: 0.5rem;">
                                    <img src="images/upload.svg" alt="Upload" style="width: 32px; height: 32px; display: block; margin: 0 auto 0.5rem auto; opacity: 0.7;">
                                    <strong style="color: #1B4965;">Click to upload files</strong>
                                </div>
                                <small style="color: #6c757d; font-size: 0.85rem;">
                                    Drag and drop files here or click to browse<br>
                                    Supported: Images, PDFs, Documents, Archives (max 10MB each)
                                </small>
                            </label>
                        </div>
                        <div id="fileList" style="margin-top: 1rem; display: none;">
                            <div style="font-weight: 600; color: #1B4965; margin-bottom: 0.5rem; font-size: 0.9rem;">Selected Files:</div>
                            <div id="fileItems" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
                        </div>
                        <small style="color: #6c757d; font-size: 0.9rem; margin-top: 0.5rem; display: block;">Upload screenshots, documents, or other files that support your evidence.</small>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 1.5rem 2rem; border-top: 1px solid #e9ecef; display: flex; gap: 1rem; justify-content: flex-end; flex-shrink: 0;">
                    <button onclick="closePointRequestModal()" style="background: #6c757d; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; font-size: 0.95rem;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">Cancel</button>
                    <button id="submitPointsBtn" onclick="submitPointRequest()" style="background: #1B4965; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: 0.95rem; box-shadow: 0 2px 8px rgba(27, 73, 101, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(27, 73, 101, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(27, 73, 101, 0.3)'">Submit Request</button>
                </div>
            </div>
        </div>

        <!-- Join Chapter Confirmation Modal -->
        <div class="modal-overlay" id="joinChapterModal" style="display: none;">
            <div class="modal-content" style="max-width: 600px; text-align: left; background: white; border-radius: 16px; padding: 0; overflow: hidden; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);">
                <!-- Modal Header -->
                <div style="background: linear-gradient(135deg, #6db9c3 0%, #5aa6b0 100%); padding: 2rem 2rem 1.5rem 2rem; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: 1.8rem; font-weight: 700; color: white;">Join Chapter</h3>
                        <button onclick="closeJoinChapterModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: white; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</button>
                    </div>
                    <p style="margin: 0; font-size: 1rem; opacity: 0.9; font-weight: 400;">Become a member of this IYNA chapter</p>
                </div>
                
                <!-- Modal Body -->
                <div style="padding: 2rem;">
                    <!-- Chapter Info Card -->
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid #e9ecef;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #6db9c3 0%, #5aa6b0 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.2rem;" id="chapterIcon">I</div>
                            <div>
                                <h4 style="margin: 0 0 0.25rem 0; color: #1B4965; font-size: 1.3rem; font-weight: 700;" id="joinChapterName">Chapter Name</h4>
                                <p style="margin: 0; color: #6c757d; font-size: 1rem; font-weight: 500;" id="joinSchoolName">School Name</p>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #e9ecef;">
                                <div style="font-size: 1.1rem; font-weight: 700; color: #1B4965;" id="chapterPoints">0</div>
                                <div style="font-size: 0.8rem; color: #6c757d; font-weight: 500;">Season Points</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #e9ecef;">
                                <div style="font-size: 1.1rem; font-weight: 700; color: #1B4965;" id="chapterMembers">0</div>
                                <div style="font-size: 0.8rem; color: #6c757d; font-weight: 500;">Members</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #e9ecef;">
                                <div style="font-size: 1.1rem; font-weight: 700; color: #1B4965;" id="chapterRank">#1</div>
                                <div style="font-size: 0.8rem; color: #6c757d; font-weight: 500;">Ranking</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Benefits Section -->
                    <div style="margin-bottom: 2rem;">
                        <h5 style="margin: 0 0 1rem 0; color: #1B4965; font-size: 1.1rem; font-weight: 600;">What you'll get:</h5>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 20px; height: 20px; background: #6db9c3; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 700;">✓</div>
                                <span style="color: #495057; font-size: 0.95rem;">Access to chapter events and activities</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 20px; height: 20px; background: #6db9c3; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 700;">✓</div>
                                <span style="color: #495057; font-size: 0.95rem;">Collaborate with fellow neuroscience enthusiasts</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 20px; height: 20px; background: #6db9c3; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 700;">✓</div>
                                <span style="color: #495057; font-size: 0.95rem;">Earn points for your chapter in competitions</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 20px; height: 20px; background: #6db9c3; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 700;">✓</div>
                                <span style="color: #495057; font-size: 0.95rem;">Network with students and professionals</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Join Reason Section -->
                    <div style="margin-bottom: 2rem;">
                        <h5 style="margin: 0 0 1rem 0; color: #1B4965; font-size: 1.1rem; font-weight: 600;">Why do you want to join this chapter?</h5>
                        <textarea 
                            id="joinReason" 
                            placeholder="Tell us about your interest in neuroscience and why you'd like to join this chapter..."
                            style="width: 100%; min-height: 100px; padding: 1rem; border: 1px solid #e9ecef; border-radius: 8px; font-family: inherit; font-size: 0.95rem; resize: vertical; box-sizing: border-box;"
                        ></textarea>
                    </div>
                    
                    <!-- Confirmation Message -->
                    <div style="background: #e8f4f8; border-left: 4px solid #6db9c3; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
                        <p style="margin: 0; color: #1B4965; font-size: 0.95rem; line-height: 1.5; font-weight: 500;">
                            <strong>Ready to submit your request?</strong> Your join request will be sent to the chapter director for approval.
                        </p>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div style="background: #f8f9fa; padding: 1.5rem 2rem; border-top: 1px solid #e9ecef; display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeJoinChapterModal()" style="background: #6c757d; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; font-size: 0.95rem;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">Cancel</button>
                    <button id="joinBtn" onclick="confirmJoinChapter()" style="background: linear-gradient(135deg, #6db9c3 0%, #5aa6b0 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: 0.95rem; box-shadow: 0 2px 8px rgba(109, 185, 195, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(109, 185, 195, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(109, 185, 195, 0.3)'">Submit Request</button>
                </div>
            </div>
        </div>



        <!-- Event Details Modal -->
        <div class="modal-overlay" id="eventDetailsModal" style="display: none;">
            <div class="modal-content" style="max-width: 600px; max-height: 90vh; background: white; border-radius: 12px; padding: 0; overflow: hidden; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15); display: flex; flex-direction: column;">
                <!-- Modal Header -->
                <div style="background: #1B4965; padding: 2rem 2rem 1.5rem 2rem; color: white; flex-shrink: 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: 1.8rem; font-weight: 700; color: white;">Event Details</h3>
                        <button onclick="closeEventDetailsModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: white; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</button>
                    </div>
                </div>
                
                <!-- Modal Body -->
                <div style="padding: 2rem; overflow-y: auto; flex: 1;">
                    <div class="event-info-section" style="margin-bottom: 2rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #000; font-size: 1.4rem; font-weight: 600;" id="modalEventTitle">Event Title</h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div>
                                <strong style="color: #6c757d; font-size: 0.9rem;">Event Date:</strong>
                                <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalEventDate">Event Date</div>
                        </div>
                            <div>
                                <strong style="color: #6c757d; font-size: 0.9rem;">Time:</strong>
                                <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalEventTime">Event Time</div>
                        </div>
                            <div>
                                <strong style="color: #6c757d; font-size: 0.9rem;">Registration Deadline:</strong>
                                <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalEventRegistrationDeadline">No deadline set</div>
                            </div>
                            <div>
                                <strong style="color: #6c757d; font-size: 0.9rem;">Location:</strong>
                                <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalEventLocation">No location specified</div>
                            </div>
                            <div>
                                <strong style="color: #6c757d; font-size: 0.9rem;">Status:</strong>
                                <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalEventStatus">Event Status</div>
                        </div>
                    </div>
                    
                        <div style="margin-top: 1.5rem;">
                            <strong style="color: #6c757d; font-size: 0.9rem;">Description:</strong>
                            <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalEventDescription">Event description</div>
                    </div>
                    
                        <div style="margin-top: 1.5rem;">
                            <strong style="color: #6c757d; font-size: 0.9rem;">Event Link:</strong>
                            <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalEventLink">No link provided</div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div style="background: #f8f9fa; padding: 1.5rem 2rem; border-top: 1px solid #e9ecef; display: flex; gap: 1rem; justify-content: flex-end; flex-shrink: 0;">
                    <button onclick="closeEventDetailsModal()" style="background: #6c757d; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; font-size: 0.95rem;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">Close</button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="toast"></div>

        <!-- SCRIPTS -->
        <script src="js/jquery.min.js"></script>
        <script src="js/bootstrap.bundle.min.js"></script>

        <script>
            // Global variables
            let currentUser = null;
            let dashboardData = null;
            let currentTab = 'personal';
            let allChaptersData = [];
            let filteredChaptersData = [];
            let selectedTaskForPoints = null;
            let selectedChapterForJoin = null;

            // Add the missing getUserByEmail function to db object
            if (typeof window !== 'undefined' && window.db) {
                window.db.getUserByEmail = async function(email) {
                    try {
                        const { data, error } = await supabase
                            .from('users')
                            .select('*')
                            .eq('email', email.toLowerCase().trim())
                            .eq('is_active', true)
                            .single();
                        
                        if (error) {
                            console.error('Error getting user by email:', error);
                            return null;
                        }
                        
                        return data;
                    } catch (error) {
                        console.error('Error in getUserByEmail:', error);
                        return null;
                    }
                };
            }

            // Function to initialize the dashboard
            async function initializeDashboard() {
                try {
                    console.log('Member dashboard: Starting initialization...');
                    
                    // Wait for database to be ready
                    let retries = 0;
                    while ((!window.db || !window.supabase) && retries < 10) {
                        console.log('Waiting for database and supabase to load...', retries);
                        await new Promise(resolve => setTimeout(resolve, 500));
                        retries++;
                    }
                    
                    if (!window.db || !window.supabase) {
                        throw new Error('Database or Supabase not loaded after 5 seconds');
                    }
                    
                    console.log('✅ Database and Supabase loaded successfully');

                    // If director/lead, redirect to director dashboard
                    try {
                        const stored = JSON.parse(sessionStorage.getItem('iyna_user')) || {};
                        // refresh role from DB
                        const { data: freshRole, error: roleErr } = await supabase
                            .from('users')
                            .select('role, chapter_id')
                            .eq('id', stored.id || currentUser?.user?.id)
                            .single();
                        const effectiveRole = (!roleErr && freshRole) ? freshRole.role : (stored.role || currentUser?.user?.role);
                        const effectiveChapter = (!roleErr && freshRole) ? freshRole.chapter_id : (stored.chapter_id || currentUser?.user?.chapter_id);
                        if ((effectiveRole === 'chapter_director' || effectiveRole === 'chapter_lead') && effectiveChapter) {
                            console.log('Redirecting director/lead to chapter dashboard...');
                            window.location.href = 'chapter_director_dash.html';
                            return;
                        }
                    } catch (e) { console.warn('Director redirect check failed', e); }
                    
                    // Test database connection
                    try {
                        console.log('Testing database connection...');
                        const { data: testData, error: testError } = await supabase
                            .from('users')
                            .select('count')
                            .limit(1);
                        
                        if (testError) {
                            console.error('❌ Database connection test failed:', testError);
                        } else {
                            console.log('✅ Database connection test successful');
                        }
                    } catch (dbTestError) {
                        console.error('❌ Database connection test error:', dbTestError);
                    }
                    
                    console.log('Member dashboard: Checking authentication...');
                    
                    // Check if user is authenticated via sessionStorage
                    const userData = sessionStorage.getItem('iyna_user');
                    
                    if (!userData) {
                        console.log('No user data found in session');
                        redirectToLogin('No active session');
                        return;
                    }

                    let user;
                    try {
                        user = JSON.parse(userData);
                    } catch (parseError) {
                        console.error('Error parsing user data:', parseError);
                        redirectToLogin('Invalid session data');
                        return;
                    }

                    if (!user || !user.is_active) {
                        console.log('User data invalid or inactive');
                        sessionStorage.removeItem('iyna_user');
                        redirectToLogin('Account inactive or invalid');
                        return;
                    }

                    // Force refresh user data from database to get latest role
                    console.log('Force refreshing user data from database...');
                    try {
                        const { data: freshUserData, error: refreshError } = await supabase
                            .from('users')
                            .select('*')
                            .eq('email', user.email)
                            .single();
                        
                        if (refreshError) {
                            console.warn('Could not refresh user data from DB, using session data:', refreshError);
                        } else if (freshUserData) {
                            console.log('Fresh user data from DB:', freshUserData);
                            user = freshUserData; // Use fresh data from database
                            // Update session storage with fresh data
                            sessionStorage.setItem('iyna_user', JSON.stringify(freshUserData));
                        }
                    } catch (refreshErr) {
                        console.warn('Error refreshing user data, using session data:', refreshErr);
                    }

                    console.log('User authenticated:', user.email);
                    console.log('User role:', user.role);
                    console.log('User role type:', typeof user.role);
                    console.log('User role length:', user.role ? user.role.length : 'null');
                    console.log('User role trimmed:', user.role ? user.role.trim() : 'null');
                    console.log('Role comparison - chapter_lead:', user.role === 'chapter_lead');
                    console.log('Role comparison - admin:', user.role === 'admin');
                    console.log('Role comparison - chapter_director:', user.role === 'chapter_director');
                    console.log('Role comparison - member:', user.role === 'member');

                                    // Check if user should be redirected to a different dashboard
                    if (user.role === 'chapter_lead') {
                        console.log('Redirecting chapter lead to chapter lead dashboard...');
                        window.location.href = 'chapter_lead_dash.html';
                        return;
                    } else if (user.role === 'admin') {
                        console.log('Redirecting admin to admin dashboard...');
                        window.location.href = 'chapter_team_dash.html';
                        return;
                    } else if (user.role === 'chapter_director') {
                        console.log('Redirecting chapter director to chapter director dashboard...');
                        window.location.href = 'chapter_director_dash.html';
                        return;
                    } else if (user.role !== 'member') {
                        console.log(`Access denied. Invalid role: ${user.role}`);
                        redirectToLogin('Invalid role for this dashboard');
                        return;
                    }

                    // Store current user
                    currentUser = { user: user };
                    
                    console.log('Member access granted, loading dashboard...');
                    
                    // Initialize dashboard UI
                    await initializeDashboardUI();
                    setupEventHandlers();
                    await loadDashboardData();
                    
                    // Force refresh user's chapter status from database
                    await forceRefreshUserChapterStatus();
                    
                    // Hide loading and show dashboard
                    document.getElementById('loadingContainer').style.display = 'none';
                    document.getElementById('dashboardContainer').classList.add('loaded');
                    
                } catch (error) {
                    console.error('Error during authentication:', error);
                    showError('Authentication failed: ' + error.message);
                }
            }

            function redirectToLogin(reason) {
                console.log('Redirecting to login:', reason);
                // Clear session storage
                sessionStorage.removeItem('iyna_user');
                window.location.href = 'login.html';
            }

            function showError(message) {
                document.getElementById('loadingContainer').innerHTML = `
                    <div class="error-container">
                        <h3>Authentication Error</h3>
                        <p>${message}</p>
                        <button onclick="window.location.href='login.html'" class="retry-btn">Return to Login</button>
                        <button onclick="location.reload()" class="retry-btn">Try Again</button>
                    </div>
                `;
            }

            async function initializeDashboardUI() {
                const user = currentUser.user;
                
                // Set user info - use first name, fallback to 'User'
                const firstName = user.first_name || 'User';
                document.getElementById('userName').textContent = firstName;
                
                // Set initial chapter info
                if (user.chapter_id) {
                    document.getElementById('chapterInfo').textContent = 'Loading chapter information...';
                } else {
                    document.getElementById('chapterInfo').textContent = 'No Chapter Assigned';
                }
            }

            function handleMainAnnouncementBanner() {
                // Hide the main announcement banner since announcements tab is removed
                const mainBanner = document.getElementById('mainAnnouncementBanner');
                if (mainBanner) {
                    mainBanner.style.display = 'none';
                }
            }

            function setupEventHandlers() {
                // Navigation tabs
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', function(e) {
                        e.preventDefault();
                        const tabName = this.getAttribute('data-tab');
                        switchTab(tabName);
                    });
                });

                // Announcement search functionality
                const announcementSearch = document.getElementById('announcementSearch');
                if (announcementSearch) {
                    announcementSearch.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase();
                        document.querySelectorAll('.announcement-card').forEach(function(card) {
                            const announcementText = card.querySelector('.announcement-text').textContent.toLowerCase();
                            const matches = announcementText.includes(searchTerm);
                            card.style.display = matches ? 'block' : 'none';
                        });
                    });
                }

                // Member roster search functionality (for new chapter dashboard)
                const memberSearch = document.getElementById('memberSearch');
                if (memberSearch) {
                    memberSearch.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase();
                        const tableRows = document.querySelectorAll('#memberTableBody tr');
                        tableRows.forEach(function(row) {
                            const rowText = row.textContent.toLowerCase();
                            const matches = rowText.includes(searchTerm);
                            row.style.display = matches ? 'table-row' : 'none';
                        });
                    });
                }

                // Close modals when clicking overlay
                const pointRequestModal = document.getElementById('pointRequestModal');
                if (pointRequestModal) {
                    pointRequestModal.addEventListener('click', function(e) {
                    if (e.target === this) closePointRequestModal();
                });
                }

                const joinChapterModal = document.getElementById('joinChapterModal');
                if (joinChapterModal) {
                    joinChapterModal.addEventListener('click', function(e) {
                    if (e.target === this) closeJoinChapterModal();
                });
                }

                                const startChapterModal = document.getElementById('startChapterModal');
                if (startChapterModal) {
                    startChapterModal.addEventListener('click', function(e) {
                    if (e.target === this) closeStartChapterModal();
                });
                }

                // Close modals when clicking overlay
                const eventDetailsModal = document.getElementById('eventDetailsModal');
                if (eventDetailsModal) {
                    eventDetailsModal.addEventListener('click', function(e) {
                        if (e.target === this) closeEventDetailsModal();
                    });
                }

                // Escape key to close modals
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        closePointRequestModal();
                        closeJoinChapterModal();
                        closeStartChapterModal();
                        closeEventDetailsModal();
                    }
                });

                // Personal task search
                const personalTaskSearch = document.getElementById('personalTaskSearch');
                if (personalTaskSearch) {
                    personalTaskSearch.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase();
                        const taskCards = document.querySelectorAll('.task-card-personal');
                        taskCards.forEach(card => {
                            const text = card.textContent.toLowerCase();
                            card.style.display = text.includes(searchTerm) ? 'block' : 'none';
                        });
                    });
                }

                // Event filter tabs
                document.querySelectorAll('.event-filter-tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        // Remove active class from all tabs
                        document.querySelectorAll('.event-filter-tab').forEach(t => t.classList.remove('active'));
                        // Add active class to clicked tab
                        this.classList.add('active');
                        
                        const filter = this.getAttribute('data-filter');
                        
                        // Filter tasks based on selected tab
                        if (filter === 'new') {
                            renderPersonalTasks();
                        } else if (filter === 'past') {
                            renderPastPointRequests();
                        }
                    });
                });

                                // Set up chapter access monitoring
                setupChapterAccessMonitoring();
                
                // Add visibility change listener for immediate chapter access check
                document.addEventListener('visibilitychange', function() {
                    if (document.visibilityState === 'visible' && currentUser.user.chapter_id) {
                        console.log('Page became visible, checking chapter access...');
                        forceRefreshUserChapterStatus();
                    }
                });
                
                // Task filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (this.classList.contains('clear-filters')) {
                            // Clear all filters
                            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                            filterTasks('all');
                        } else {
                            // Toggle active state
                            this.classList.toggle('active');
                            const filter = this.getAttribute('data-filter');
                            filterTasks(filter);
                        }
                    });
                });

                // Task card click handlers
                document.addEventListener('click', function(e) {
                    if (e.target.closest('.task-card-personal')) {
                        const card = e.target.closest('.task-card-personal');
                        card.classList.toggle('expanded');
                        
                        const description = card.querySelector('.task-description-personal');
                        const rewardBreakdown = card.querySelector('.reward-breakdown');
                        const actions = card.querySelector('.task-actions');
                        
                        if (description) description.classList.toggle('expanded');
                        if (rewardBreakdown) rewardBreakdown.classList.toggle('expanded');
                        if (actions) actions.classList.toggle('expanded');
                    }
                });
            }

            async function loadDashboardData() {
                try {
                    console.log('Loading dashboard data from database...');
                    console.log('Database object available:', !!window.db);
                    console.log('Supabase available:', !!window.supabase);
                    
                    // Load all data from database using your db functions with detailed logging
                    console.log('Calling db.getEvents()...');
                    const events = await db.getEvents();
                    console.log('Events loaded from database:', events);
                    
                    console.log('Calling db.getTasks()...');
                    const tasks = await db.getTasks();
                    console.log('Tasks loaded from database:', tasks);
                    
                    console.log('Calling db.getChapters()...');
                    const chapters = await db.getChapters();
                    console.log('Chapters loaded from database:', chapters);
                    

                    
                    // Calculate real chapter rankings with points from database
                    console.log('Calculating chapter rankings...');
                    const chapterRankings = await calculateRealChapterRankings(chapters);
                    allChaptersData = chapterRankings;
                    filteredChaptersData = [...chapterRankings];
                    
                    // Get current user's chapter info from database
                    let userChapter = null;
                    let hasApprovedChapter = false;
                    
                    if (currentUser.user.chapter_id) {
                        // Directors and leads are always considered approved if they have a chapter_id
                        if (currentUser.user.role === 'chapter_director' || currentUser.user.role === 'chapter_lead') {
                            const chapterExists = chapters.find(c => c.id === currentUser.user.chapter_id);
                            if (chapterExists) {
                                userChapter = chapterExists;
                                hasApprovedChapter = true;
                                console.log('Director/Lead treated as approved with direct chapter access:', userChapter);
                            } else {
                                console.log('Director/Lead has invalid chapter_id, skipping clear and returning.');
                            }
                        } else {
                            // Determine access purely from users.chapter_id and chapters list
                            const chapterExists = chapters.find(c => c.id === currentUser.user.chapter_id);
                            if (chapterExists) {
                                userChapter = chapterExists;
                                hasApprovedChapter = true;
                                console.log('User has chapter access via users table:', userChapter);
                            } else {
                                // Don't immediately clear access - the chapter might just not be loaded yet
                                // Instead, try to fetch the specific chapter directly from database
                                console.log('Chapter not found in chapters list, verifying directly from database...');
                                try {
                                    const { data: chapterData, error: chapterError } = await supabase
                                        .from('chapters')
                                        .select('*')
                                        .eq('id', currentUser.user.chapter_id)
                                        .single();
                                    
                                    if (chapterError || !chapterData) {
                                        console.log('Chapter truly does not exist in database, clearing access...', chapterError);
                                        await clearUserChapterAccess();
                                        return;
                                    } else {
                                        // Chapter exists, use it
                                        userChapter = chapterData;
                                        hasApprovedChapter = true;
                                        console.log('User has chapter access via direct database query:', userChapter);
                                    }
                                } catch (directQueryError) {
                                    console.error('Error verifying chapter directly:', directQueryError);
                                    // Don't clear access on database errors - just proceed without chapter info
                                    hasApprovedChapter = false;
                                }
                            }
                        }
                    }

                    // Get user's personal points from database
                    console.log('Getting user points for user ID:', currentUser.user.id);
                    const userPoints = await getUserPoints(currentUser.user.id);
                    console.log('User points calculated:', userPoints);
                    
                    // Process the data
                    dashboardData = {
                        user: {
                            name: currentUser.user.first_name || 'Student',
                            hasChapter: hasApprovedChapter,
                            chapter: userChapter ? {
                                id: userChapter.chapter_code,
                                name: userChapter.name,
                                school: userChapter.school_name,
                            } : null,
                            points: userPoints
                        },
                        events: events || [],
                        tasks: tasks || [],
                        chapters: chapters || [],
                        chapterRankings: chapterRankings,

                    };
                    
                    console.log('Final dashboard data:', dashboardData);
                    renderDashboard();
                    
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    console.error('Error details:', error.message);
                    
                    // Fallback to basic structure
                    dashboardData = {
                        user: {
                            name: currentUser.user.first_name || 'Student',
                            hasChapter: false,
                            chapter: null,
                            points: 0
                        },
                        events: [],
                        tasks: [],
                        chapters: [],
                        chapterRankings: [],

                    };
                    
                    renderDashboard();
                }
            }

            async function getUserPoints(userId) {
                try {
                    const { data, error } = await supabase
                        .from('user_task_completions')
                        .select('points_awarded')
                        .eq('user_id', userId)
                        .in('status', ['completed', 'approved']);
                    
                    if (error) throw error;
                    
                    return data.reduce((total, completion) => total + (completion.points_awarded || 0), 0);
                } catch (error) {
                    console.error('Error getting user points:', error);
                    return 0;
                }
            }

            async function calculateRealChapterRankings(chapters) {
                try {
                    console.log('Calculating real chapter rankings...');
                    
                    // Get all users and their chapter memberships
                    const allUsers = await db.getAllUsers();
                    
                    // Get all completed task points
                    const { data: completions, error: completionsError } = await supabase
                        .from('user_task_completions')
                        .select('user_id, points_awarded')
                        .in('status', ['completed', 'approved']);
                    
                    if (completionsError) throw completionsError;
                    
                    // Calculate points for each chapter
                    const chapterStats = chapters.map(chapter => {
                        // Find all users in this chapter
                        const chapterUsers = allUsers.filter(u => u.chapter_id === chapter.id);
                        
                        // Calculate total points for this chapter
                        const totalPoints = chapterUsers.reduce((chapterTotal, user) => {
                            const userCompletions = completions.filter(c => c.user_id === user.id);
                            const userPoints = userCompletions.reduce((userTotal, completion) => 
                                userTotal + (completion.points_awarded || 0), 0);
                            return chapterTotal + userPoints;
                        }, 0);
                        
                        // Get director name from lead_user_id
                        const director = chapter.lead_user_id ? 
                            allUsers.find(u => u.id === chapter.lead_user_id) : null;
                        const directorName = director ? 
                            `${director.first_name} ${director.last_name}` : 'No Director';
                        
                        return {
                            id: chapter.id,
                            name: chapter.name,
                            school_name: chapter.school_name,
                            chapter_code: chapter.chapter_code,
                            points: totalPoints,
                            memberCount: chapterUsers.length,
                            director: directorName
                        };
                    });
                    
                    // Sort by points descending and add rank
                    chapterStats.sort((a, b) => b.points - a.points);
                    chapterStats.forEach((chapter, index) => {
                        chapter.rank = index + 1;
                    });
                    
                    console.log('Chapter rankings calculated:', chapterStats);
                    return chapterStats;
                } catch (error) {
                    console.error('Error calculating chapter rankings:', error);
                    return [];
                }
            }

            function renderDashboard() {
                // Update user info
                const userSubtitleElement = document.getElementById('userSubtitle');
                if (userSubtitleElement) {
                if (dashboardData.user.hasChapter) {
                        // Fetch fresh role to display correct title
                        const stored = JSON.parse(sessionStorage.getItem('iyna_user')) || {};
                        const roleTitle = (stored.role === 'chapter_director') ? 'Chapter Director' : (stored.role === 'chapter_lead') ? 'Co-Director' : 'Chapter Member';
                        userSubtitleElement.innerHTML = `${roleTitle} • ${dashboardData.user.chapter.school} ${dashboardData.user.chapter.id}`;
                } else {
                        userSubtitleElement.innerHTML = 'Member • No Chapter Assigned';
                    }
                }
                
                // Update user's total points
                const totalPointsElement = document.getElementById('totalPoints');
                if (totalPointsElement) {
                    totalPointsElement.textContent = `${dashboardData.user.points} pts`;
                }
                
                // Update personal dashboard points
                const personalTotalPointsElement = document.getElementById('personalTotalPoints');
                if (personalTotalPointsElement) {
                    personalTotalPointsElement.textContent = dashboardData.user.points;
                }
                
                // Render different sections
                renderEvents();
                renderPersonalTasks();
                renderAnnouncements();
                handleMainAnnouncementBanner();
                
                // Show/hide chapter dashboard content based on user's chapter status
                const noChapterMessage = document.getElementById('noChapterMessage');
                const chapterDashboardContent = document.getElementById('chapterDashboardContent');
                
                if (dashboardData.user.hasChapter) {
                    // User has a chapter - show full chapter dashboard
                    if (noChapterMessage) noChapterMessage.style.display = 'none';
                    if (chapterDashboardContent) chapterDashboardContent.style.display = 'block';
                    
                    // Load chapter dashboard data
                    loadChapterDashboard();
                } else {
                    // User has no chapter - show no chapter message
                    if (noChapterMessage) noChapterMessage.style.display = 'block';
                    if (chapterDashboardContent) chapterDashboardContent.style.display = 'none';
                    
                    // Load only global rankings
                    loadGlobalRankings();
                }
            }

            function renderEvents() {
                const events = dashboardData.events;
                const container = document.getElementById('eventsGrid');
                
                if (!container) {
                    console.warn('eventsGrid element not found');
                    return;
                }
                
                console.log('Rendering events:', events);
                
                if (!events || events.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No events available</h3>
                            <p>No events found in the database. Check the console for database connection details.</p>
                        </div>
                    `;
                    return;
                }
                
                // Separate upcoming and past events
                const currentDate = new Date();
                const upcomingEvents = [];
                const pastEvents = [];
                
                events.forEach(event => {
                    let eventDate = 'No date';
                    let eventTime = '';
                    let eventTimezone = '';
                    let isPast = false;
                    let eventDateObj = null;
                    
                    if (event.event_date) {
                        try {
                            eventDateObj = new Date(event.event_date);
                            
                            // Format date
                            eventDate = eventDateObj.toLocaleDateString();
                            
                            // Format time
                            eventTime = eventDateObj.toLocaleTimeString([], { 
                                hour: '2-digit', 
                                minute: '2-digit',
                                hour12: true 
                            });
                            
                            // Get timezone
                            eventTimezone = eventDateObj.toLocaleDateString([], { 
                                timeZoneName: 'short' 
                            }).split(', ').pop() || Intl.DateTimeFormat().resolvedOptions().timeZone;
                            
                            isPast = eventDateObj < currentDate;
                        } catch (e) {
                            eventDate = event.event_date;
                        }
                    }
                    
                    const eventWithDate = {
                        ...event,
                        eventDate,
                        eventTime,
                        eventTimezone,
                        isPast,
                        eventDateObj
                    };
                    
                    if (isPast) {
                        pastEvents.push(eventWithDate);
                    } else {
                        upcomingEvents.push(eventWithDate);
                    }
                });
                
                // Sort upcoming events by date (nearest first)
                upcomingEvents.sort((a, b) => {
                    if (!a.eventDateObj || !b.eventDateObj) return 0;
                    return a.eventDateObj - b.eventDateObj;
                });
                
                // Sort past events by date (most recent first)
                pastEvents.sort((a, b) => {
                    if (!a.eventDateObj || !b.eventDateObj) return 0;
                    return b.eventDateObj - a.eventDateObj;
                });
                
                // Render all events, but we'll control visibility through filters
                let eventsHtml = '<div class="events-grid">';
                
                // First, add upcoming events
                upcomingEvents.forEach(event => {
                    eventsHtml += `
                        <div class="event-card" data-type="upcoming">
                            <h3 class="event-title">${event.title || 'Untitled Event'}</h3>
                            <p class="event-subtitle">${event.description || 'No description available'}</p>
                            
                            <div class="event-footer">
                                <div class="event-date-time">
                                    <div class="event-date">${event.eventDate}</div>
                                    ${event.eventTime ? `<div class="event-time">${event.eventTime} ${event.eventTimezone}</div>` : ''}
                                </div>
                                <button class="event-button" onclick="showEventDetails(${JSON.stringify(event).replace(/"/g, '&quot;')})">View Details</button>
                            </div>
                        </div>
                    `;
                });
                
                // Then, add past events
                pastEvents.forEach(event => {
                    eventsHtml += `
                        <div class="event-card past" data-type="past">
                            <h3 class="event-title">${event.title || 'Untitled Event'}</h3>
                            <p class="event-subtitle">${event.description || 'No description available'}</p>
                            
                            <div class="event-footer">
                                <div class="event-date-time">
                                    <div class="event-date">${event.eventDate}</div>
                                    ${event.eventTime ? `<div class="event-time">${event.eventTime} ${event.eventTimezone}</div>` : ''}
                                </div>
                                <button class="event-button" onclick="showEventDetails(${JSON.stringify(event).replace(/"/g, '&quot;')})">View Details</button>
                            </div>
                        </div>
                    `;
                });
                eventsHtml += '</div>';
                
                container.innerHTML = eventsHtml;
                
                // Apply initial filter to show only first 3 upcoming events (or fill with past if needed)
                applyInitialEventFilter(upcomingEvents.length, pastEvents.length);
                
                console.log('Events rendered successfully');
            }

            function applyInitialEventFilter(upcomingCount, pastCount) {
                // Show first 3 upcoming events, or fill remaining slots with past events
                const upcomingCards = document.querySelectorAll('.event-card[data-type="upcoming"]');
                const pastCards = document.querySelectorAll('.event-card[data-type="past"]');
                
                // Hide all events initially
                upcomingCards.forEach(card => card.style.display = 'none');
                pastCards.forEach(card => card.style.display = 'none');
                
                // Show first 3 upcoming events
                const upcomingToShow = Math.min(3, upcomingCount);
                for (let i = 0; i < upcomingToShow; i++) {
                    if (upcomingCards[i]) {
                        upcomingCards[i].style.display = 'block';
                    }
                }
                
                // If less than 3 upcoming events, fill remaining slots with past events
                if (upcomingToShow < 3) {
                    const remainingSlots = 3 - upcomingToShow;
                    const pastToShow = Math.min(remainingSlots, pastCount);
                    for (let i = 0; i < pastToShow; i++) {
                        if (pastCards[i]) {
                            pastCards[i].style.display = 'block';
                        }
                    }
                }
            }

            function renderPersonalTasks() {
                const tasks = dashboardData.tasks;
                const container = document.getElementById('personalTasksGrid');
                
                if (!container) {
                    console.warn('personalTasksGrid element not found');
                    return;
                }
                
                console.log('Rendering personal tasks:', tasks);
                
                if (!tasks || tasks.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No tasks available</h3>
                            <p>No tasks found in the database. Check the console for database connection details.</p>
                        </div>
                    `;
                    return;
                }
                
                let tasksHtml = '<div class="tasks-list">';
                tasks.forEach(task => {
                    // Handle different date formats
                    let deadline = 'No deadline';
                    if (task.deadline) {
                        try {
                            deadline = new Date(task.deadline).toLocaleDateString();
                        } catch (e) {
                            deadline = task.deadline;
                        }
                    }
                    
                    tasksHtml += `
                        <div class="task-card">
                            <h3 class="task-title">${task.title || 'Untitled Task'}</h3>
                            <div class="task-meta">
                                <span class="task-points">${task.points || 0} points</span>
                                <span class="task-deadline">Deadline: ${deadline}</span>
                                <span class="task-code">Code: ${task.task_code || 'N/A'}</span>
                            </div>
                            <p class="task-description">${task.description || 'No description available'}</p>
                            <div class="task-footer">
                                <button class="request-points-btn" onclick="requestPoints(${task.id})">Request Points</button>
                            </div>
                        </div>
                    `;
                });
                tasksHtml += '</div>';
                
                container.innerHTML = tasksHtml;
                console.log('Tasks rendered successfully');
            }

            // Announcements Functions
            function renderAnnouncements() {
                const container = document.getElementById('announcementsList');
                
                if (!container) {
                    console.warn('announcementsList element not found');
                    return;
                }
                
                // Sample announcements data (you can replace this with actual data from your database)
                const announcements = [
                    {
                        title: "Spread the word! - Neuroscience Summer Program",
                        message: "Attend our upcoming Neuro&AI Webinar Panel with Anna Schapiro, Cristina Savin, and Konrad Kording on March 16th from 4-5:30 PM ET and encourage members of your chapter to do so as well! Participants may be eligible to receive the Neuro& Careers Certificate! Please register here: https://forms.gle/rJQoZAAz9EhtuBet6",
                        created_at: new Date(),
                        is_active: true
                    },
                    {
                        title: "Spread the word! - Neuroscience Summer Program",
                        message: "Attend our upcoming Neuro&AI Webinar Panel with Anna Schapiro, Cristina Savin, and Konrad Kording on March 16th from 4-5:30 PM ET and encourage members of your chapter to do so as well! Participants may be eligible to receive the Neuro& Careers Certificate! Please register here: https://forms.gle/rJQoZAAz9EhtuBet6",
                        created_at: new Date(),
                        is_active: true
                    }
                ];
                
                let announcementsHtml = '';
                announcements.forEach(announcement => {
                    const createdDate = new Date(announcement.created_at);
                    
                    // Convert URLs to clickable links
                    const urlRegex = /(https?:\/\/[^\s]+)/g;
                    const contentWithLinks = announcement.message.replace(urlRegex, '<a href="$1" class="announcement-link" target="_blank">$1</a>');
                    
                    announcementsHtml += `
                        <div class="announcement-card">
                            <h3 class="announcement-header">${announcement.title}</h3>
                            <hr class="announcement-separator">
                            <div class="announcement-text">
                                ${contentWithLinks}
                            </div>
                            <div class="announcement-actions">
                                <span class="announcement-status">Active • Posted on ${createdDate.toLocaleDateString()}</span>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = announcementsHtml;
            }

            // Chapter Dashboard Functions
            async function loadChapterDashboard() {
                try {
                    console.log('Loading chapter dashboard data...');
                    
                    if (!currentUser.user.chapter_id) {
                        renderChapterDirectors([]);
                        renderChapterStats({ rank: 0, totalChapters: 0, points: 0 });
                        renderMemberRoster([]);
                        renderGlobalRankings([]);
                        return;
                    }

                    // Load chapter directors
                    await loadChapterDirectors();
                    
                    // Load chapter bio
                    await loadChapterBio();
                    
                    // Check join request status
                    await checkJoinRequestStatus();
                    
                    // Check if user still has chapter access
                    await checkChapterAccess();
                    
                    // Check for pending join requests
                    await checkPendingJoinRequests();
                    
                    // Load chapter stats
                    await loadChapterStats();
                    
                    // Load member roster
                    await loadMemberRoster();
                    
                    // Load global rankings
                    await loadGlobalRankings();
                    
                } catch (error) {
                    console.error('Error loading chapter dashboard:', error);
                    renderChapterDirectors([]);
                    renderChapterStats({ rank: 0, totalChapters: 0, points: 0 });
                    renderMemberRoster([]);
                    renderGlobalRankings([]);
                }
            }

            async function loadChapterDirectors() {
                try {
                    if (!currentUser.user.chapter_id) {
                        renderChapterDirectors([]);
                        return;
                    }

                    // Fetch all users marked as directors or co-directors for this chapter
                    const { data: directors, error } = await supabase
                        .from('users')
                        .select('first_name, last_name')
                        .eq('chapter_id', currentUser.user.chapter_id)
                        .in('role', ['chapter_director', 'chapter_lead'])
                        .eq('is_active', true)
                        .order('first_name', { ascending: true });

                    if (error) throw error;

                    if (!directors || directors.length === 0) {
                        renderChapterDirectors([]);
                        return;
                    }

                    const cards = directors.map(d => `
                        <div class="director-card">
                            <div class="director-icon">
                                ${d.first_name ? d.first_name.charAt(0) : 'D'}
                            </div>
                            <div class="director-info">
                                <div class="director-name">${d.first_name} ${d.last_name}</div>
                            </div>
                        </div>
                    `);

                    renderChapterDirectors(cards);
                } catch (error) {
                    console.error('Error loading chapter directors:', error);
                    renderChapterDirectors([]);
                }
            }

            function renderChapterDirectors(directors) {
                const container = document.getElementById('directorsList');
                if (!container) {
                    console.warn('directorsList element not found');
                    return;
                }
                
                if (directors.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No chapter directors found</p></div>';
                } else {
                    container.innerHTML = directors.join('');
                }
            }

            async function loadChapterBio() {
                try {
                    if (!currentUser.user.chapter_id) {
                        renderChapterBio(null);
                        return;
                    }

                    // Get chapter bio from the chapter_bios table
                    const { data: chapterBio, error: bioError } = await supabase
                        .from('chapter_bios')
                        .select('*')
                        .eq('chapter_id', currentUser.user.chapter_id)
                        .eq('is_active', true)
                        .single();
                    
                    if (bioError && bioError.code !== 'PGRST116') { // PGRST116 = no rows returned
                        console.error('Error loading chapter bio:', bioError);
                    }

                    renderChapterBio(chapterBio);
                    
                    // Show edit button if user is chapter director
                    if (currentUser.user.role === 'chapter_director' || currentUser.user.role === 'chapter_lead') {
                        document.getElementById('bioActions').style.display = 'block';
                    }
                    
                } catch (error) {
                    console.error('Error loading chapter bio:', error);
                    renderChapterBio(null);
                }
            }

            // Check and display join request status - simplified version
            async function checkJoinRequestStatus() {
                // If user has chapter_id, they are already approved - no pending status to show
                // This function is no longer needed with our simplified approach
                return;
            }

            // Check if user still has access to their current chapter
            async function checkChapterAccess() {
                try {
                    if (!currentUser.user.chapter_id) return;
                    
                    // For chapter directors and leads, they don't need join requests - they have direct access
                    if (currentUser.user.role === 'chapter_director' || currentUser.user.role === 'chapter_lead') {
                        console.log('User is chapter director/lead, skipping join request check');
                        return;
                    }
                    
                    // Always fetch fresh role from DB
                    const { data: roleCheck, error: roleErr } = await supabase
                        .from('users')
                        .select('role')
                        .eq('id', currentUser.user.id)
                        .single();
                    if (!roleErr && roleCheck && (roleCheck.role === 'chapter_director' || roleCheck.role === 'chapter_lead')) {
                        console.log('Director/Lead detected from DB; skipping join-request based access check.');
                        return;
                    }

                    // Verify access directly from users.chapter_id (most reliable method)
                    const { data: fresh, error: freshErr } = await supabase
                        .from('users')
                        .select('chapter_id')
                        .eq('id', currentUser.user.id)
                        .single();
                    if (freshErr) {
                        console.error('Error verifying user chapter access:', freshErr);
                        return;
                    }

                    // Only clear access if the user truly doesn't have a chapter_id in the database
                    if (!fresh || fresh.chapter_id !== currentUser.user.chapter_id) {
                        console.log('User no longer has chapter access per users table, clearing access...', {
                            freshChapterId: fresh?.chapter_id,
                            sessionChapterId: currentUser.user.chapter_id,
                            userRole: currentUser.user.role
                        });
                        
                        // Extra safety: don't clear if session shows user as director/lead
                        if (currentUser.user.role === 'chapter_director' || currentUser.user.role === 'chapter_lead') {
                            console.log('Skipping removal - session shows user as director/lead');
                            return;
                        }
                        
                        await clearUserChapterAccess();
                    } else {
                        console.log('User still has valid chapter access in database');
                    }
                } catch (error) {
                    console.error('Error checking chapter access:', error);
                }
            }

            // Force refresh user's chapter status from database
            async function forceRefreshUserChapterStatus() {
                try {
                    if (!currentUser || !currentUser.user) return;
                    
                    console.log('Force refreshing user chapter status from database...');
                    
                    // Get fresh user data from database (always sync role too)
                    const { data: freshUserData, error } = await supabase
                        .from('users')
                        .select('chapter_id, role')
                        .eq('id', currentUser.user.id)
                        .single();
                    
                    if (error) {
                        console.error('Error fetching fresh user data:', error);
                        return;
                    }
                    
                    console.log('Fresh user data from database:', freshUserData);
                    console.log('Current session data:', currentUser.user);
                    
                    // Always sync role to session and storage
                    currentUser.user.role = freshUserData.role;
                    const storedUser = JSON.parse(sessionStorage.getItem('iyna_user')) || {};
                    storedUser.role = freshUserData.role;
                    sessionStorage.setItem('iyna_user', JSON.stringify(storedUser));
                    
                    // Check if there's a mismatch between session and database
                    if (currentUser.user.chapter_id !== freshUserData.chapter_id) {
                        console.log('Chapter ID mismatch detected:', {
                            session: currentUser.user.chapter_id,
                            database: freshUserData.chapter_id
                        });
                        
                        // Update session with database data
                        currentUser.user.chapter_id = freshUserData.chapter_id;
                        
                        // Update session storage
                        const userData = sessionStorage.getItem('iyna_user');
                        if (userData) {
                            const user = JSON.parse(userData);
                            user.chapter_id = freshUserData.chapter_id;
                            sessionStorage.setItem('iyna_user', JSON.stringify(user));
                        }
                        
                        // If user was removed from chapter, clear access
                        if (!freshUserData.chapter_id && dashboardData.user.hasChapter) {
                            // Do not auto-clear for directors/leads
                            if (currentUser.user.role === 'chapter_director' || currentUser.user.role === 'chapter_lead') {
                                console.log('Director/Lead has no chapter_id in DB, skipping auto clear.');
                            } else {
                                console.log('User was removed from chapter, clearing access...');
                                await clearUserChapterAccess();
                            }
                        } else if (freshUserData.chapter_id && !dashboardData.user.hasChapter) {
                            console.log('User was added to chapter, refreshing dashboard...');
                            // User was added to chapter, refresh dashboard
                            await loadDashboardData();
                        }
                        
                        // For chapter directors/leads, also check if they still have their role
                        if (freshUserData.chapter_id && (currentUser.user.role === 'chapter_director' || currentUser.user.role === 'chapter_lead')) {
                            // Verify they still have their role
                            if (freshUserData.role !== currentUser.user.role) {
                                console.log('Chapter director/lead role changed, updating session...');
                                currentUser.user.role = freshUserData.role;
                                
                                // Update session storage
                                const userData = sessionStorage.getItem('iyna_user');
                                if (userData) {
                                    const user = JSON.parse(userData);
                                    user.role = freshUserData.role;
                                    sessionStorage.setItem('iyna_user', JSON.stringify(user));
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error force refreshing user chapter status:', error);
                }
            }

            // Check if user has any pending join requests
            async function checkPendingJoinRequests() {
                try {
                    // Check if user has any pending join requests
                    const { data: pendingRequests, error } = await supabase
                        .from('chapter_join_request')
                        .select('chapter_id, status, join_reason')
                        .eq('user_id', currentUser.user.id)
                        .eq('status', 'pending');
                    
                    if (error && error.code !== 'PGRST116') {
                        console.error('Error checking pending join requests:', error);
                        return;
                    }
                    
                    if (pendingRequests && pendingRequests.length > 0) {
                        console.log('User has pending join requests:', pendingRequests);
                        
                        // Show pending status in chapters list
                        pendingRequests.forEach(request => {
                            const joinBtn = document.querySelector(`[data-chapter-id="${request.chapter_id}"] .join-btn`);
                            if (joinBtn) {
                                joinBtn.textContent = 'Requested';
                                joinBtn.style.backgroundColor = '#ffc107';
                                joinBtn.style.color = '#212529';
                                joinBtn.disabled = true;
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error checking pending join requests:', error);
                }
            }

            // Function to completely clear user's chapter access
            async function clearUserChapterAccess() {
                try {
                    // Always fetch fresh role from DB to avoid stale session role
                    const { data: roleCheck, error: roleError } = await supabase
                        .from('users')
                        .select('role')
                        .eq('id', currentUser.user.id)
                        .single();
                    if (!roleError && roleCheck && (roleCheck.role === 'chapter_director' || roleCheck.role === 'chapter_lead')) {
                        console.log('Preventing automatic removal (DB role indicates director/lead)');
                        return;
                    }
                    
                    // First, verify the user's current database state
                    const { data: currentUserData, error: userError } = await supabase
                        .from('users')
                        .select('chapter_id')
                        .eq('id', currentUser.user.id)
                        .single();
                    
                    if (userError) {
                        console.error('Error fetching current user data:', userError);
                    } else if (currentUserData && currentUserData.chapter_id) {
                        // User still has chapter_id in database - this means they're still a valid member
                        // Do NOT force removal from database - only clear local session
                        console.log('User still has chapter_id in database; only clearing local session (not database)');
                    }
                    
                    // Clear user's chapter access in current session
                    currentUser.user.chapter_id = null;
                    
                    // Update dashboard data
                    dashboardData.user.hasChapter = false;
                    dashboardData.user.chapter = null;
                    
                    // Update session storage to persist the change
                    const userData = sessionStorage.getItem('iyna_user');
                    if (userData) {
                        const user = JSON.parse(userData);
                        user.chapter_id = null;
                        sessionStorage.setItem('iyna_user', JSON.stringify(user));
                    }
                    
                    // Force refresh of dashboard data from database
                    await loadDashboardData();
                    
                    // Re-render dashboard to show no chapter message
                    renderDashboard();
                    
                    // Show notification
                    showToast('You have been removed from the chapter.', 'warning');
                    
                    console.log('User chapter access completely cleared');
                } catch (error) {
                    console.error('Error clearing user chapter access:', error);
                }
            }

            // Set up periodic chapter access check
            function setupChapterAccessMonitoring() {
                // Log user status periodically for debugging
                setInterval(() => {
                    if (currentUser && currentUser.user) {
                        console.log('User status check:', {
                            id: currentUser.user.id,
                            role: currentUser.user.role,
                            chapter_id: currentUser.user.chapter_id,
                            hasChapter: dashboardData?.user?.hasChapter
                        });
                    }
                }, 30000); // Log every 30 seconds
                
                // Check every 10 seconds if user still has chapter access (more aggressive)
                setInterval(async () => {
                    if (currentUser.user.chapter_id) {
                        await checkChapterAccess();
                    }
                }, 10000); // 10 seconds
                
                // Also check every 5 seconds for users actively using the dashboard
                setInterval(async () => {
                    if (document.visibilityState === 'visible') {
                        await forceRefreshUserChapterStatus();
                    }
                }, 5000); // 5 seconds when page is visible
                
                // Check every 3 seconds for users who might have been approved recently
                setInterval(async () => {
                    if (document.visibilityState === 'visible') {
                        await forceRefreshUserChapterStatus();
                    }
                }, 3000); // 3 seconds for recent approvals
            }

            // Function to immediately remove user from chapter (called when director removes member)
            async function removeUserFromChapter() {
                await clearUserChapterAccess();
            }

            function renderChapterBio(chapterBio) {
                const bioContent = document.getElementById('chapterBioContent');
                const socialMediaLinks = document.getElementById('socialMediaLinks');
                
                if (!bioContent) {
                    console.warn('chapterBioContent element not found');
                    return;
                }
                
                if (!chapterBio) {
                    // No bio available
                    bioContent.innerHTML = `
                        <div class="no-bio">
                            <p>No chapter bio has been written yet.</p>
                            ${currentUser.user.role === 'chapter_director' || currentUser.user.role === 'chapter_lead' 
                                ? '<p>As a chapter director, you can write a bio to describe your chapter.</p>' 
                                : '<p>Chapter directors can add a bio to describe this chapter.</p>'}
                        </div>
                    `;
                    socialMediaLinks.style.display = 'none';
                    return;
                }
                
                // Render bio text with line breaks preserved
                const safeBio = (chapterBio.bio_text || '').replace(/\n/g, '<br>');
                bioContent.innerHTML = `<p>${safeBio}</p>`;
                
                // Render social media links if available
                if (chapterBio.social_media_links && Object.keys(chapterBio.social_media_links).length > 0) {
                    renderSocialMediaLinks(chapterBio.social_media_links);
                    socialMediaLinks.style.display = 'block';
                } else {
                    socialMediaLinks.style.display = 'none';
                }
            }

            function renderSocialMediaLinks(socialMediaLinks) {
                const container = document.getElementById('socialLinksGrid');
                if (!container) return;
                
                const platformIcons = {
                    instagram: 'bi bi-instagram',
                    facebook: 'bi bi-facebook',
                    twitter: 'bi bi-twitter-x',
                    linkedin: 'bi bi-linkedin',
                    youtube: 'bi bi-youtube',
                    website: 'bi bi-globe'
                };
                
                const platformNames = {
                    instagram: 'Instagram',
                    facebook: 'Facebook',
                    twitter: 'Twitter',
                    linkedin: 'LinkedIn',
                    youtube: 'YouTube',
                    website: 'Website'
                };
                
                let linksHtml = '';
                Object.entries(socialMediaLinks).forEach(([platform, url]) => {
                    if (url && platformIcons[platform]) {
                        linksHtml += `
                            <a href="${url}" target="_blank" class="social-link-item ${platform}">
                                <span class="label">${platformNames[platform]}</span>
                                <span class="icon">→</span>
                            </a>
                        `;
                    }
                });
                
                container.innerHTML = linksHtml;
            }

            async function loadChapterStats() {
                try {
                    if (!currentUser.user.chapter_id) {
                        renderChapterStats({ rank: 0, totalChapters: 0, points: 0 });
                        return;
                    }

                    // Get all chapters for ranking
                    const { data: allChapters, error: chaptersError } = await supabase
                        .from('chapters')
                        .select('id, points')
                        .order('points', { ascending: false });
                    
                    if (chaptersError) throw chaptersError;

                    // Calculate chapter rank
                    const chapterRank = allChapters.findIndex(chapter => chapter.id === currentUser.user.chapter_id) + 1;
                    const totalChapters = allChapters.length;

                    // Get chapter points
                    const currentChapter = allChapters.find(chapter => chapter.id === currentUser.user.chapter_id);
                    const chapterPoints = currentChapter ? currentChapter.points || 0 : 0;

                    renderChapterStats({
                        rank: chapterRank,
                        totalChapters: totalChapters,
                        points: chapterPoints
                    });
                } catch (error) {
                    console.error('Error loading chapter stats:', error);
                    renderChapterStats({ rank: 0, totalChapters: 0, points: 0 });
                }
            }

            function renderChapterStats(stats) {
                const rankElement = document.getElementById('chapterRank');
                const totalElement = document.getElementById('totalChapters');
                const pointsElement = document.getElementById('chapterPoints');
                
                if (rankElement) rankElement.textContent = stats.rank;
                if (totalElement) totalElement.textContent = stats.totalChapters;
                if (pointsElement) pointsElement.textContent = stats.points;
            }

            async function loadMemberRoster() {
                try {
                    if (!currentUser.user.chapter_id) {
                        renderMemberRoster([]);
                        return;
                    }
                
                    // Get all approved members of the current chapter
                    const { data: members, error } = await supabase
                        .from('users')
                        .select(`
                            id,
                            first_name,
                            last_name,
                            role,
                            chapter_id,
                            discord_username
                        `)
                        .eq('chapter_id', currentUser.user.chapter_id)
                        .eq('is_active', true)
                        .order('first_name', { ascending: true });
                    
                    if (error) throw error;
                    
                    // All members with the chapter_id are approved members (simplified approach)
                    const approvedMembers = members;
                    console.log(`Found ${approvedMembers.length} approved members for chapter ${currentUser.user.chapter_id}`);
                    
                                        // Get chapter info for school name
                    const { data: chapter, error: chapterError } = await supabase
                        .from('chapters')
                        .select('school_name')
                        .eq('id', currentUser.user.chapter_id)
                        .single();
                    
                    if (chapterError) throw chapterError;

                    // Get points for each member
                    const membersWithPoints = await Promise.all(
                        approvedMembers.map(async (member) => {
                            const { data: completions, error: pointsError } = await supabase
                                .from('user_task_completions')
                                .select('points_awarded')
                                .eq('user_id', member.id)
                                .in('status', ['completed', 'approved']);
                            
                            const totalPoints = pointsError ? 0 : 
                                completions.reduce((sum, comp) => sum + (comp.points_awarded || 0), 0);
                            
                            return {
                                ...member,
                                points: totalPoints,
                                school: chapter.school_name
                            };
                        })
                    );

                    renderMemberRoster(membersWithPoints);
                } catch (error) {
                    console.error('Error loading member roster:', error);
                    renderMemberRoster([]);
                }
            }

            function renderMemberRoster(members) {
                const tbody = document.getElementById('memberTableBody');
                const memberCount = document.getElementById('memberCount');
                
                if (!tbody) {
                    console.warn('memberTableBody element not found');
                    return;
                }
                
                // Update member count
                if (memberCount) {
                    memberCount.textContent = `(${members.length} members)`;
                }
                
                if (members.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="loading-text">No members found</td></tr>';
                    return;
                }
                
                let tableHTML = '';
                members.forEach(member => {
                    const fullName = `${member.first_name} ${member.last_name}`;
                    const role = member.role === 'chapter_director' ? 'Director' : 
                                member.role === 'chapter_lead' ? 'Co-Director' : 'Member';
                    
                    tableHTML += `
                        <tr>
                            <td>${fullName}</td>
                            <td>${role}</td>
                            <td>${member.points}</td>
                            <td>${member.school}</td>
                            <td>${member.discord_username || '-'}</td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = tableHTML;
            }

            async function loadGlobalRankings() {
                try {
                    // Get all chapters ordered by points for ranking
                    const { data: allChapters, error: chaptersError } = await supabase
                        .from('chapters')
                        .select(`
                            id,
                            chapter_code,
                            school_name,
                            points,
                            director_id
                        `)
                        .order('points', { ascending: false })
                        .limit(10);
                    
                    if (chaptersError) throw chaptersError;

                    // Get chapter of the season (top ranked chapter)
                    const chapterOfSeason = allChapters[0];
                    if (chapterOfSeason) {
                        // Get director info for chapter of the season
                        const { data: director, error: directorError } = await supabase
                            .from('users')
                            .select('first_name, last_name')
                            .eq('id', chapterOfSeason.director_id)
                            .single();
                        
                        const directorName = director ? `${director.first_name} ${director.last_name}` : 'Unknown';
                        
                        const seasonNameElement = document.getElementById('seasonChapterName');
                        const seasonCodeElement = document.getElementById('seasonChapterCode');
                        const seasonLeaderElement = document.getElementById('seasonLeader');
                        
                        if (seasonNameElement) seasonNameElement.textContent = chapterOfSeason.school_name;
                        if (seasonCodeElement) seasonCodeElement.textContent = chapterOfSeason.chapter_code;
                        if (seasonLeaderElement) seasonLeaderElement.textContent = `Led by ${directorName}`;
                    }

                    // Render rankings list
                    renderGlobalRankings(allChapters);
                } catch (error) {
                    console.error('Error loading global rankings:', error);
                    renderGlobalRankings([]);
                }
            }

            function renderGlobalRankings(chapters) {
                const container = document.getElementById('rankingsList');
                
                if (!container) {
                    console.warn('rankingsList element not found');
                    return;
                }
                
                if (chapters.length === 0) {
                    container.innerHTML = '<div class="loading-text">No rankings available</div>';
                    return;
                }
                
                let rankingsHTML = '';
                chapters.forEach((chapter, index) => {
                    const rank = index + 1;
                    rankingsHTML += `
                        <div class="ranking-item">
                            <div class="ranking-number">${rank}</div>
                            <div class="ranking-chapter">${chapter.school_name || chapter.name || chapter.chapter_code}</div>
                            <div class="ranking-points">${chapter.points || 0} points</div>
                        </div>
                    `;
                });
                
                container.innerHTML = rankingsHTML;
            }

            function viewDirectory() {
                window.location.href = 'chapters.html';
            }

            function openTaskSubmissionModal() {
                // Function to handle task submission modal
                console.log('Opening point request modal for chapter');
                
                // Check if user is logged in
                if (!currentUser || !currentUser.user) {
                    alert('Please log in to request points.');
                    return;
                }
                
                // Show the point request modal
                document.getElementById('pointRequestModal').style.display = 'flex';
                
                // Clear any previous form data
                document.getElementById('evidenceTextarea').value = '';
                document.getElementById('evidenceFiles').value = '';
                document.getElementById('taskCodeInput').value = '';
                document.getElementById('taskNameInput').value = '';
                clearFileList();
                
                // Hide the task info section for chapter requests
                const taskInfoSection = document.querySelector('.task-info-section');
                if (taskInfoSection) {
                    taskInfoSection.style.display = 'none';
                }
                
                // Set up a custom task for chapter point request
                selectedTaskForPoints = {
                    id: 'chapter-request',
                    title: 'Chapter Point Request',
                    points: 0,
                    deadline: new Date().toLocaleDateString(),
                    task_code: 'CHAPTER-REQ',
                    description: 'Request points for chapter activities and achievements'
                };
                
                // Clear the points requested field
                document.getElementById('pointsRequested').value = '';
                
                // Setup drag and drop
                setupDragAndDrop();
            }

            function switchTab(tab) {
                currentTab = tab;
                console.log('Switching to tab:', tab);
                
                // Update tab navigation
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
                
                // Show/hide tab content
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                const targetTab = document.getElementById(`${tab}-tab`);
                if (targetTab) {
                    targetTab.classList.add('active');
                    console.log(`${tab}-tab element found and activated`);
                } else {
                    console.error(`${tab}-tab element not found!`);
                }
                
                // Update page title based on tab
                const titleSpan = document.getElementById('userName');
                const userName = titleSpan ? titleSpan.textContent : 'User';
                
                // Show/hide chapter management section based on active tab and user's chapter status
                const chapterManagementSection = document.getElementById('chapterManagementSection');
                if (chapterManagementSection) {
                    if (tab === 'chapter' && dashboardData.user.hasChapter) {
                        chapterManagementSection.style.display = 'block';
                    } else {
                        chapterManagementSection.style.display = 'none';
                    }
                }
                
                switch(tab) {
                    case 'personal':
                        document.getElementById('dashboardTitle').innerHTML = `Hi, <span id="userName">${userName}</span>`;
                        break;
                    case 'chapter':
                        document.getElementById('dashboardTitle').innerHTML = `Hi, <span id="userName">${userName}</span>`;
                        break;
                    case 'announcements':
                        document.getElementById('dashboardTitle').innerHTML = `Hi, <span id="userName">${userName}</span>`;
                        break;

                }
            }

            function filterEvents(filter) {
                const eventCards = document.querySelectorAll('.event-card');
                eventCards.forEach(card => {
                    if (filter === 'all') {
                        card.style.display = 'block';
                    } else if (filter === 'upcoming') {
                        card.style.display = card.classList.contains('past') ? 'none' : 'block';
                    } else if (filter === 'past') {
                        card.style.display = card.classList.contains('past') ? 'block' : 'none';
                    }
                });
            }

            function filterTasks(filter) {
                const taskCards = document.querySelectorAll('.task-card-personal');
                taskCards.forEach(card => {
                    if (filter === 'all') {
                        card.style.display = 'block';
                    } else if (filter === 'points') {
                        // Show tasks with points between 10-200
                        const pointsElement = card.querySelector('.task-points-personal');
                        if (pointsElement) {
                            const points = parseInt(pointsElement.textContent);
                            card.style.display = (points >= 10 && points <= 200) ? 'block' : 'none';
                        }
                    } else if (filter === 'sort') {
                        // This would need to be implemented with actual sorting logic
                        console.log('Sorting tasks by points...');
                    }
                });
            }

            // Point request functions
            function requestPoints(taskId) {
                const task = dashboardData.tasks.find(t => t.id === taskId);
                if (!task) return;
                
                selectedTaskForPoints = task;
                
                // Show the task info section for regular task requests
                const taskInfoSection = document.querySelector('.task-info-section');
                if (taskInfoSection) {
                    taskInfoSection.style.display = 'block';
                }
                
                // Populate modal with task information
                document.getElementById('modalTaskTitle').textContent = task.title;
                document.getElementById('modalTaskPoints').textContent = task.points || 0;
                document.getElementById('modalTaskDeadline').textContent = new Date(task.deadline).toLocaleDateString();
                document.getElementById('modalTaskCode').textContent = task.task_code || 'N/A';
                document.getElementById('modalTaskDescription').textContent = task.description || 'No description available';
                document.getElementById('pointsRequested').value = task.points || 0;
                
                // Clear previous evidence
                document.getElementById('evidenceTextarea').value = '';
                document.getElementById('evidenceFiles').value = '';
                clearFileList();
                
                // Setup drag and drop
                setupDragAndDrop();
                
                // Show modal
                document.getElementById('pointRequestModal').style.display = 'flex';
            }

            function setupDragAndDrop() {
                const uploadContainer = document.querySelector('.file-upload-container');
                
                uploadContainer.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadContainer.style.borderColor = '#1B4965';
                    uploadContainer.style.backgroundColor = '#f8f9fa';
                });
                
                uploadContainer.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadContainer.style.borderColor = '#e9ecef';
                    uploadContainer.style.backgroundColor = 'transparent';
                });
                
                uploadContainer.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadContainer.style.borderColor = '#e9ecef';
                    uploadContainer.style.backgroundColor = 'transparent';
                    
                    const files = Array.from(e.dataTransfer.files);
                    const fileInput = document.getElementById('evidenceFiles');
                    const dt = new DataTransfer();
                    
                    // Add existing files
                    Array.from(fileInput.files).forEach(file => dt.items.add(file));
                    
                    // Add new files
                    files.forEach(file => dt.items.add(file));
                    
                    fileInput.files = dt.files;
                    handleFileSelection();
                });
            }

            function closePointRequestModal() {
                document.getElementById('pointRequestModal').style.display = 'none';
                selectedTaskForPoints = null;
                
                // Reset form
                document.getElementById('evidenceTextarea').value = '';
                document.getElementById('evidenceFiles').value = '';
                document.getElementById('pointsRequested').value = '';
                document.getElementById('taskCodeInput').value = '';
                document.getElementById('taskNameInput').value = '';
                clearFileList();
                
                // Reset button state
                const submitBtn = document.getElementById('submitPointsBtn');
                submitBtn.classList.remove('btn-loading');
                submitBtn.disabled = false;
            }

            function handleFileSelection() {
                const fileInput = document.getElementById('evidenceFiles');
                const fileList = document.getElementById('fileList');
                const fileItems = document.getElementById('fileItems');
                const files = Array.from(fileInput.files);
                
                if (files.length === 0) {
                    fileList.style.display = 'none';
                    return;
                }

                // Clear previous file list
                fileItems.innerHTML = '';
                
                files.forEach((file, index) => {
                    // Check file size (10MB limit)
                    if (file.size > 10 * 1024 * 1024) {
                        showToast(`File "${file.name}" is too large. Maximum size is 10MB.`, 'error');
                        return;
                    }
                    
                    const fileItem = document.createElement('div');
                    fileItem.style.cssText = `
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 0.5rem;
                        background: #f8f9fa;
                        border-radius: 6px;
                        border: 1px solid #e9ecef;
                    `;
                    
                    const fileInfo = document.createElement('div');
                    fileInfo.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        flex: 1;
                    `;
                    
                    const fileIcon = getFileIcon(file.type);
                    const fileName = file.name.length > 30 ? file.name.substring(0, 27) + '...' : file.name;
                    const fileSize = formatFileSize(file.size);
                    
                    fileInfo.innerHTML = `
                        <span style="font-size: 1.2rem;">${fileIcon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #1B4965; font-size: 0.9rem;">${fileName}</div>
                            <div style="color: #6c757d; font-size: 0.8rem;">${fileSize}</div>
                        </div>
                    `;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.innerHTML = '×';
                    removeBtn.style.cssText = `
                        background: #dc3545;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 24px;
                        height: 24px;
                        cursor: pointer;
                        font-size: 1rem;
                        line-height: 1;
                        transition: background-color 0.2s;
                    `;
                    removeBtn.onclick = () => removeFile(index);
                    
                    fileItem.appendChild(fileInfo);
                    fileItem.appendChild(removeBtn);
                    fileItems.appendChild(fileItem);
                });
                
                fileList.style.display = files.length > 0 ? 'block' : 'none';
            }

            function removeFile(indexToRemove) {
                const fileInput = document.getElementById('evidenceFiles');
                const dt = new DataTransfer();
                
                Array.from(fileInput.files).forEach((file, index) => {
                    if (index !== indexToRemove) {
                        dt.items.add(file);
                    }
                });
                
                fileInput.files = dt.files;
                handleFileSelection();
            }

            function clearFileList() {
                document.getElementById('fileList').style.display = 'none';
                document.getElementById('fileItems').innerHTML = '';
            }

            function getFileIcon(fileType) {
                if (fileType.startsWith('image/')) return '🖼️';
                if (fileType === 'application/pdf') return '📄';
                if (fileType.includes('document') || fileType.includes('word')) return '📝';
                if (fileType.includes('spreadsheet') || fileType.includes('excel')) return '📊';
                if (fileType.includes('zip') || fileType.includes('rar')) return '📦';
                return '📎';
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            async function submitPointRequest() {
                if (!selectedTaskForPoints) return;
                
                const evidence = document.getElementById('evidenceTextarea').value.trim();
                const pointsRequested = document.getElementById('pointsRequested').value;
                const taskCode = document.getElementById('taskCodeInput').value.trim();
                const taskName = document.getElementById('taskNameInput').value.trim();
                
                if (!evidence) {
                    showToast('Please provide evidence of completion', 'error');
                    return;
                }

                if (!pointsRequested || pointsRequested < 1) {
                    showToast('Please enter a valid number of points to request', 'error');
                    return;
                }
                
                if (!taskCode) {
                    showToast('Please enter a task code', 'error');
                    return;
                }

                if (!taskName) {
                    showToast('Please enter a task name', 'error');
                    return;
                }
                
                const submitBtn = document.getElementById('submitPointsBtn');
                submitBtn.classList.add('btn-loading');
                submitBtn.disabled = true;
                
                try {
                    // Get file information and upload to storage
                    const fileInput = document.getElementById('evidenceFiles');
                    const files = Array.from(fileInput.files);
                    let uploadedFileUrls = [];
                    
                    // Upload files to Supabase storage if any files are selected
                    if (files.length > 0) {
                        for (let i = 0; i < files.length; i++) {
                            const file = files[i];
                            try {
                                // Create unique filename
                                const timestamp = Date.now();
                                const randomId = Math.random().toString(36).substring(2, 15);
                                const fileExtension = file.name.split('.').pop();
                                const uniqueFileName = `${currentUser.user.id}_${timestamp}_${randomId}.${fileExtension}`;
                                const filePath = `point-requests/${uniqueFileName}`;
                                
                                // Upload file to Supabase storage
                                console.log('Uploading file:', file.name, 'to path:', filePath);
                                
                                // Use existing Supabase client
                                if (!supabase) {
                                    console.error('Supabase client not available');
                                    continue;
                                }
                                
                                const { data: uploadData, error: uploadError } = await supabase.storage
                                    .from('image-test')
                                    .upload(filePath, file);
                                
                                console.log('Upload result:', { uploadData, uploadError });
                                
                                if (uploadError) {
                                    console.error('File upload error:', uploadError);
                                                } else {
                                    // Get public URL for the uploaded file
                                    const { data: urlData } = supabase.storage
                                        .from('image-test')
                                        .getPublicUrl(filePath);
                                    
                                    console.log('Public URL:', urlData.publicUrl);
                                    uploadedFileUrls.push(urlData.publicUrl);
                                }
                            } catch (fileError) {
                                console.error('Error uploading file:', fileError);
                            }
                        }
                    }
                    
                    // Create task completion record in user_task_completions table
                    console.log('Creating task completion with files:', uploadedFileUrls);
                    
                    const taskCompletionData = {
                        user_id: currentUser.user.id,
                        task_code: taskCode,
                        task_name: taskName,
                        points_awarded: parseInt(pointsRequested),
                        evidence: evidence,
                        file_urls: uploadedFileUrls.length > 0 ? uploadedFileUrls.join(',') : null,
                        status: 'pending',
                        completed_at: new Date().toISOString()
                    };
                    
                    console.log('Task completion data to insert:', taskCompletionData);
                    console.log('DEBUG - Points requested from form:', pointsRequested, typeof pointsRequested);
                    console.log('DEBUG - Points after parseInt:', parseInt(pointsRequested), typeof parseInt(pointsRequested));
                    
                    // Use the existing database connection instead of creating a new Supabase client
                    if (typeof db.createTaskCompletion === 'function') {
                        await db.createTaskCompletion(taskCompletionData);
                    } else {
                        // Fallback: use direct Supabase insertion with proper error handling
                        const { data, error } = await supabase
                            .from('user_task_completions')
                            .insert([taskCompletionData]);
                        
                        if (error) {
                            console.error('Error inserting task completion:', error);
                            console.error('Error details:', error.message, error.details, error.hint);
                            throw error;
                        }
                        
                        console.log('Task completion created successfully:', data);
                    }
                    
                    showToast('Point request submitted successfully! It will be reviewed by administrators.', 'success');
                    closePointRequestModal();
                    
                } catch (error) {
                    console.error('Error submitting point request:', error);
                    showToast('Failed to submit point request. Please try again.', 'error');
                    
                    // Reset button state
                    submitBtn.classList.remove('btn-loading');
                    submitBtn.disabled = false;
                }
            }

            // Chapter join functions
            function requestToJoin(chapterId) {
                const chapter = allChaptersData.find(c => c.id === chapterId);
                if (!chapter) return;
                
                selectedChapterForJoin = chapter;
                
                // Populate modal with chapter information
                document.getElementById('joinChapterName').textContent = chapter.chapter_code;
                document.getElementById('joinSchoolName').textContent = chapter.school_name;
                
                // Populate additional chapter stats
                document.getElementById('chapterPoints').textContent = chapter.points || 0;
                document.getElementById('chapterMembers').textContent = chapter.memberCount || 0;
                document.getElementById('chapterRank').textContent = `#${chapter.rank || 1}`;
                
                // Set chapter icon (first letter of chapter code)
                const chapterCode = chapter.chapter_code || 'I';
                document.getElementById('chapterIcon').textContent = chapterCode.charAt(0).toUpperCase();
                
                // Show modal
                document.getElementById('joinChapterModal').style.display = 'flex';
            }

            function closeJoinChapterModal() {
                document.getElementById('joinChapterModal').style.display = 'none';
                selectedChapterForJoin = null;
                
                // Reset button state
                const joinBtn = document.getElementById('joinChapterBtn');
                joinBtn.classList.remove('btn-loading');
                joinBtn.disabled = false;
            }

            async function confirmJoinChapter() {
                if (!selectedChapterForJoin) return;
                
                const joinBtn = document.getElementById('joinBtn');
                joinBtn.classList.add('btn-loading');
                joinBtn.disabled = true;
                
                try {
                    // Get join reason from modal
                    const joinReason = document.getElementById('joinReason')?.value?.trim() || 'No reason provided';
                    
                    // Create join request instead of directly joining
                    const { data: joinRequest, error } = await supabase
                        .from('chapter_join_request')
                        .insert({
                            user_id: currentUser.user.id,
                            chapter_id: selectedChapterForJoin.id,
                            user_name: `${currentUser.user.first_name} ${currentUser.user.last_name}`,
                            user_email: currentUser.user.email,
                            user_school: currentUser.user.school || '',
                            user_grade_level: currentUser.user.grade_level || '',
                            join_reason: joinReason,
                            status: 'pending'
                        })
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    showToast(`Join request submitted for ${selectedChapterForJoin.chapter_code}! Waiting for approval.`, 'success');
                    closeJoinChapterModal();
                    
                    // Refresh chapters list to show updated status
                    await loadChapters();
                    
                } catch (error) {
                    console.error('Error submitting join request:', error);
                    showToast('Failed to submit join request. Please try again.', 'error');
                    
                    // Reset button state
                    joinBtn.classList.remove('btn-loading');
                    joinBtn.disabled = false;
                }
            }

            // Start Chapter Modal Functions
            function showStartChapterModal() {
                // Pre-fill form with current user data
                document.getElementById('chapterRequestName').value = `${currentUser.user.first_name} ${currentUser.user.last_name}`.trim();
                document.getElementById('chapterRequestEmail').value = currentUser.user.email;
                
                // Clear other fields
                document.getElementById('chapterRequestSchool').value = '';
                document.getElementById('chapterRequestReason').value = '';
                
                // Show modal
                document.getElementById('startChapterModal').style.display = 'flex';
            }

            function closeStartChapterModal() {
                document.getElementById('startChapterModal').style.display = 'none';
                
                // Reset button state
                const submitBtn = document.getElementById('submitChapterBtn');
                submitBtn.classList.remove('btn-loading');
                submitBtn.disabled = false;
            }

            async function submitChapterRequest() {
                const name = document.getElementById('chapterRequestName').value.trim();
                const email = document.getElementById('chapterRequestEmail').value.trim();
                const school = document.getElementById('chapterRequestSchool').value.trim();
                const reason = document.getElementById('chapterRequestReason').value.trim();
                
                // Validate form
                if (!name || !email || !school || !reason) {
                    showToast('Please fill in all required fields', 'error');
                    return;
                }
                
                const submitBtn = document.getElementById('submitChapterBtn');
                submitBtn.classList.add('btn-loading');
                submitBtn.disabled = true;
                
                try {
                    // Create chapter request using database function
                    await db.createChapterRequest({
                        requester_name: name,
                        requester_email: email,
                        school_name: school,
                        reason: reason,
                        status: 'pending',
                        user_id: currentUser.user.id
                    });
                    
                    showToast('Chapter request submitted successfully! We will review your request and get back to you soon.', 'success');
                    closeStartChapterModal();
                    
                } catch (error) {
                    console.error('Error submitting chapter request:', error);
                    showToast('Failed to submit chapter request. Please try again.', 'error');
                    
                    // Reset button state
                    submitBtn.classList.remove('btn-loading');
                    submitBtn.disabled = false;
                }
            }

            // Toast notification function
            function showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.style.display = 'block';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 5000);
            }

            // Event Details Modal Functions
            function showEventDetails(event) {
                // Populate modal with event data
                document.getElementById('modalEventTitle').textContent = event.title || 'Untitled Event';
                
                // Populate date field (date only)
                document.getElementById('modalEventDate').textContent = event.eventDate || 'No date';
                
                // Populate time field (time and timezone)
                let timeText = 'No time specified';
                if (event.eventTime && event.eventTimezone) {
                    timeText = `${event.eventTime} ${event.eventTimezone}`;
                } else if (event.eventTime) {
                    timeText = event.eventTime;
                }
                document.getElementById('modalEventTime').textContent = timeText;
                
                document.getElementById('modalEventStatus').textContent = event.isPast ? 'Past Event' : 'Upcoming Event';
                document.getElementById('modalEventDescription').textContent = event.description || 'No description available';
                
                // Populate registration deadline field
                let registrationDeadlineText = 'No deadline set';
                if (event.registration_deadline) {
                    try {
                        const deadlineDate = new Date(event.registration_deadline);
                        registrationDeadlineText = deadlineDate.toLocaleDateString();
                    } catch (e) {
                        registrationDeadlineText = event.registration_deadline;
                    }
                }
                document.getElementById('modalEventRegistrationDeadline').textContent = registrationDeadlineText;
                
                // Populate location field
                let locationText = 'No location specified';
                if (event.location && event.location.trim() !== '') {
                    // If location is a URL, make it clickable, otherwise just display as text
                    if (event.location.startsWith('http')) {
                        document.getElementById('modalEventLocation').innerHTML = `<a href="${event.location}" target="_blank" style="color: #1B4965; text-decoration: underline;">${event.location}</a>`;
            } else {
                        locationText = event.location;
                        document.getElementById('modalEventLocation').textContent = locationText;
                    }
                } else {
                    document.getElementById('modalEventLocation').textContent = locationText;
                }
                
                // Populate event link field
                const eventLinkElement = document.getElementById('modalEventLink');
                
                // Check for various possible link property names, including location which might contain URLs
                const linkUrl = event.event_link || event.link || event.url || event.event_url || event.registration_link || event.join_link || 
                               (event.location && event.location.startsWith('http') ? event.location : null);
                
                if (linkUrl && linkUrl.trim() !== '') {
                    eventLinkElement.innerHTML = `<a href="${linkUrl}" target="_blank" style="color: #1B4965; text-decoration: underline;">${linkUrl}</a>`;
                } else {
                    eventLinkElement.textContent = 'No link provided';
                }
                
                // Show modal
                document.getElementById('eventDetailsModal').style.display = 'flex';
            }

            function closeEventDetailsModal() {
                document.getElementById('eventDetailsModal').style.display = 'none';
            }

            function viewEventFullDetails() {
                // Navigate to the full events page
                window.location.href = 'events.html';
            }

            // Chapter Management Functions
            function showLeaveChapterModal() {
                const confirmLeave = confirm(
                    "Are you sure you want to leave your current chapter?\n\n" +
                    "This action will:\n" +
                    "• Remove you from your chapter director role\n" +
                    "• Remove you from the chapter\n" +
                    "• Change your account to a regular member\n\n" +
                    "This action cannot be undone. Continue?"
                );
                
                if (confirmLeave) {
                    leaveChapter();
                }
            }



            async function leaveChapter() {
                try {
                    if (!currentUser || !currentUser.user) {
                        alert('User session not found. Please log in again.');
                        return;
                    }

                    // Update user role and remove chapter assignment
                    const updatedUser = await db.updateUser(currentUser.user.id, {
                        role: 'member',
                        chapter_id: null
                    });

                    // Update the global currentUser variable
                    currentUser.user = updatedUser;
                    
                    // Update session storage with the correct structure
                    sessionStorage.setItem('iyna_user', JSON.stringify(updatedUser));

                    alert('You have successfully left your chapter. You are now a regular member.');
                    
                    // Redirect to appropriate dashboard
                    window.location.href = 'personal_dash.html';
                    
                } catch (error) {
                    console.error('Error leaving chapter:', error);
                    alert('Failed to leave chapter. Please try again or contact support.');
                }
            }





            // Chapter Bio Edit Function
            function editChapterBio() {
                // Ensure modal exists or create it
                if (!document.getElementById('editChapterBioModal')) {
                    const modalHTML = `
                        <div class="modal-overlay" id="editChapterBioModal" style="display: none;">
                            <div class="modal-content" style="max-width: 700px; max-height: 90vh; text-align: left; background: white; border-radius: 16px; padding: 0; overflow: hidden; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15); display: flex; flex-direction: column;">
                                <div style="background: linear-gradient(135deg, #1B4965 0%, #2c5f7a 100%); padding: 1.25rem 1.5rem; color: white; flex-shrink: 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700; color: white;">Edit Chapter Bio</h3>
                                        <button onclick="(function(){document.getElementById('editChapterBioModal').style.display='none';})()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: white; opacity: 0.9;">&times;</button>
                                    </div>
                                    <p style="margin: .25rem 0 0; font-size: .95rem; opacity: .9;">Update your chapter's short bio and social media links</p>
                                </div>
                                <div style="padding: 1rem 1.5rem; overflow-y: auto; flex: 1;">
                                    <div class="form-group" style="margin-bottom: 1rem;">
                                        <label class="form-label" for="chapterBioText" style="display:block; font-weight:600; color:#1B4965; margin-bottom:.5rem;">Short Bio</label>
                                        <textarea id="chapterBioText" class="form-control" placeholder="Write a short bio for your chapter..." style="width:100%; min-height:120px; resize:vertical; padding:.75rem; border:2px solid #e9ecef; border-radius:8px; font-size:1rem;"></textarea>
                                    </div>
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                                        <div class="form-group">
                                            <label class="form-label" for="linkInstagram" style="display:block; font-weight:600; color:#1B4965; margin-bottom:.25rem;">Instagram</label>
                                            <input id="linkInstagram" class="form-control" placeholder="https://instagram.com/yourchapter" style="width:100%; padding:.6rem .75rem; border:2px solid #e9ecef; border-radius:8px; font-size:1rem;" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="linkTwitter" style="display:block; font-weight:600; color:#1B4965; margin-bottom:.25rem;">Twitter/X</label>
                                            <input id="linkTwitter" class="form-control" placeholder="https://x.com/yourchapter" style="width:100%; padding:.6rem .75rem; border:2px solid #e9ecef; border-radius:8px; font-size:1rem;" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="linkFacebook" style="display:block; font-weight:600; color:#1B4965; margin-bottom:.25rem;">Facebook</label>
                                            <input id="linkFacebook" class="form-control" placeholder="https://facebook.com/yourchapter" style="width:100%; padding:.6rem .75rem; border:2px solid #e9ecef; border-radius:8px; font-size:1rem;" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="linkWebsite" style="display:block; font-weight:600; color:#1B4965; margin-bottom:.25rem;">Website</label>
                                            <input id="linkWebsite" class="form-control" placeholder="https://yourchapter.org" style="width:100%; padding:.6rem .75rem; border:2px solid #e9ecef; border-radius:8px; font-size:1rem;" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="linkLinkedIn" style="display:block; font-weight:600; color:#1B4965; margin-bottom:.25rem;">LinkedIn</label>
                                            <input id="linkLinkedIn" class="form-control" placeholder="https://linkedin.com/company/yourchapter" style="width:100%; padding:.6rem .75rem; border:2px solid #e9ecef; border-radius:8px; font-size:1rem;" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="linkYouTube" style="display:block; font-weight:600; color:#1B4965; margin-bottom:.25rem;">YouTube</label>
                                            <input id="linkYouTube" class="form-control" placeholder="https://youtube.com/@yourchapter" style="width:100%; padding:.6rem .75rem; border:2px solid #e9ecef; border-radius:8px; font-size:1rem;" />
                                        </div>
                                    </div>
                                </div>
                                <div style="background:#f8f9fa; padding:1rem 1.5rem; border-top:1px solid #e9ecef; display:flex; gap:.5rem; justify-content:flex-end;">
                                    <button onclick="(function(){document.getElementById('editChapterBioModal').style.display='none';})()" style="background:#6c757d; color:white; border:none; padding:.6rem 1rem; border-radius:8px; cursor:pointer; font-weight:500;">Cancel</button>
                                    <button id="saveChapterBioBtn" style="background: linear-gradient(135deg, #1B4965 0%, #2c5f7a 100%); color:white; border:none; padding:.6rem 1rem; border-radius:8px; cursor:pointer; font-weight:600;">Save</button>
                                </div>
                            </div>
                        </div>`;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                }

                // Prefill existing values
                (async () => {
                    try {
                        const { data, error } = await supabase
                            .from('chapter_bios')
                            .select('bio_text, social_media_links')
                            .eq('chapter_id', currentUser.user.chapter_id)
                            .single();
                        if (!error && data) {
                            document.getElementById('chapterBioText').value = data.bio_text || '';
                            const links = data.social_media_links || {};
                            document.getElementById('linkInstagram').value = links.instagram || '';
                            document.getElementById('linkTwitter').value = links.twitter || links.x || '';
                            document.getElementById('linkFacebook').value = links.facebook || '';
                            document.getElementById('linkWebsite').value = links.website || '';
                            document.getElementById('linkLinkedIn').value = links.linkedin || '';
                            document.getElementById('linkYouTube').value = links.youtube || '';
                        }
                    } catch (e) { console.warn('Could not prefill chapter bio modal:', e); }
                })();

                // Wire save handler
                const saveBtn = document.getElementById('saveChapterBioBtn');
                saveBtn.onclick = async () => {
                    const bio = document.getElementById('chapterBioText').value.trim();
                    const social = {
                        instagram: document.getElementById('linkInstagram').value.trim() || null,
                        twitter: document.getElementById('linkTwitter').value.trim() || null,
                        facebook: document.getElementById('linkFacebook').value.trim() || null,
                        website: document.getElementById('linkWebsite').value.trim() || null,
                        linkedin: document.getElementById('linkLinkedIn').value.trim() || null,
                        youtube: document.getElementById('linkYouTube').value.trim() || null,
                    };
                    await updateChapterBio(bio, social);
                    document.getElementById('editChapterBioModal').style.display = 'none';
                };

                // Show modal
                document.getElementById('editChapterBioModal').style.display = 'flex';
            }

            async function updateChapterBio(bioText, socialLinks = undefined) {
                try {
                    if (!currentUser.user.chapter_id) {
                        alert('No chapter found. Please join a chapter first.');
                        return;
                    }

                    // Check if user has permission to edit bio
                    if (currentUser.user.role !== 'chapter_director' && currentUser.user.role !== 'chapter_lead') {
                        alert('Only chapter directors can edit chapter bios.');
                        return;
                    }

                    // Check if bio already exists
                    const { data: existingBio, error: checkError } = await supabase
                        .from('chapter_bios')
                        .select('id')
                        .eq('chapter_id', currentUser.user.chapter_id)
                        .single();

                    let result;
                    if (existingBio) {
                        // Update existing bio
                        result = await supabase
                            .from('chapter_bios')
                            .update({
                                bio_text: bioText,
                                updated_at: new Date().toISOString(),
                                ...(socialLinks ? { social_media_links: socialLinks } : {})
                            })
                            .eq('chapter_id', currentUser.user.chapter_id);
                    } else {
                        // Create new bio
                        result = await supabase
                            .from('chapter_bios')
                            .insert({
                                chapter_id: currentUser.user.chapter_id,
                                chapter_name: currentUser.user.chapter?.school || 'Unknown Chapter',
                                bio_text: bioText,
                                created_by: currentUser.user.id,
                                social_media_links: socialLinks || {}
                            });
                    }

                    if (result.error) throw result.error;

                    // Reload the bio
                    await loadChapterBio();
                    showToast('Chapter bio updated successfully!', 'success');
                } catch (error) {
                    console.error('Error updating chapter bio:', error);
                    alert('Failed to update chapter bio. Please try again.');
                }
            }

            // Sub-tab switching for tasks
            $(document).on('click', '.event-filter-tab[data-subtab]', function(e) {
                e.preventDefault();
                
                const subtab = $(this).data('subtab');
                
                // Update active state
                $('.event-filter-tab[data-subtab]').removeClass('active');
                $(this).addClass('active');
                
                // Filter tasks based on subtab
                filterTasks(subtab);
            });

            async function filterTasks(type) {
                console.log('Filtering tasks:', type);
                
                const container = document.getElementById('personalTasksGrid');
                if (!container) return;
                
                if (type === 'new') {
                    // Show regular tasks
                    renderPersonalTasks();
                } else if (type === 'past') {
                    // Show past approved point requests
                    await renderPastPointRequests();
                }
            }

            async function renderPastPointRequests() {
                const container = document.getElementById('personalTasksGrid');
                if (!container) return;

                // Show loading state
                container.innerHTML = '<div class="loading-text">Loading past point requests...</div>';

                try {
                    // Get all point requests
                    const allPointRequests = await db.getPointRequests();
                    
                    // Filter for current user's approved requests
                    const userApprovedRequests = allPointRequests.filter(request => 
                        request.user_id === currentUser.user.id && 
                        (request.status === 'approved' || request.status === 'completed')
                    );

                    console.log('User approved point requests:', userApprovedRequests);

                    if (!userApprovedRequests || userApprovedRequests.length === 0) {
                        container.innerHTML = `
                        <div class="empty-state">
                                <h3>No past point requests</h3>
                                <p>You haven't had any approved point requests yet.</p>
                        </div>
                        `;
                    return;
                }

                    let requestsHtml = '<div class="tasks-list">';
                    userApprovedRequests.forEach(request => {
                        // Handle different date formats
                        let completedDate = 'Unknown date';
                        if (request.completed_at || request.submitted_at) {
                            try {
                                const date = new Date(request.completed_at || request.submitted_at);
                                completedDate = date.toLocaleDateString();
                            } catch (e) {
                                completedDate = request.completed_at || request.submitted_at;
                            }
                        }

                        // Get task information
                        const taskTitle = request.task?.title || request.task_name || 'Custom Task';
                        const taskCode = request.task?.task_code || request.task_code || 'N/A';
                        const pointsAwarded = request.points_awarded || request.points || 0;
                        const evidence = request.evidence || 'No evidence provided';

                        requestsHtml += `
                            <div class="task-card past-request">
                                <div class="past-request-header">
                                    <h3 class="task-title">${taskTitle}</h3>
                                    <span class="approved-badge">✓ Approved</span>
                                    </div>
                                <div class="task-meta">
                                    <span class="task-points">${pointsAwarded} points awarded</span>
                                    <span class="task-deadline">Completed: ${completedDate}</span>
                                    <span class="task-code">Code: ${taskCode}</span>
                                </div>
                                <div class="evidence-section">
                                    <strong>Evidence submitted:</strong>
                                    <p class="evidence-text">${evidence.length > 200 ? evidence.substring(0, 200) + '...' : evidence}</p>
                            </div>
                        </div>
                    `;
                    });
                    requestsHtml += '</div>';
                    
                    container.innerHTML = requestsHtml;
                    console.log('Past point requests rendered successfully');

                } catch (error) {
                    console.error('Error loading past point requests:', error);
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>Error loading past requests</h3>
                            <p>Unable to load your past point requests. Please try again later.</p>
                        </div>
                    `;
                }
            }

            // Initialize when page loads
            if (typeof $ !== 'undefined') {
                $(document).ready(function() {
                    // Clear any existing banner closed flag
                    sessionStorage.removeItem('announcementBannerClosed');
                    initializeDashboard();
                });
            } else {
                document.addEventListener('DOMContentLoaded', function() {
                    // Clear any existing banner closed flag
                    sessionStorage.removeItem('announcementBannerClosed');
                    initializeDashboard();
                });
            }

            // Function to force refresh user's chapter status from database
            async function forceRefreshUserChapterStatus() {
                try {
                    if (!currentUser || !currentUser.user) return;
                    
                    console.log('Force refreshing user chapter status from database...');
                    
                    // Get fresh user data from database
                    const { data: freshUserData, error } = await supabase
                        .from('users')
                        .select('chapter_id, role')
                        .eq('id', currentUser.user.id)
                        .single();
                    
                    if (error) {
                        console.error('Error fetching fresh user data:', error);
                        return;
                    }
                    
                    // Check if there's a mismatch between session and database
                    if (currentUser.user.chapter_id !== freshUserData.chapter_id) {
                        console.log('Chapter ID mismatch detected:', {
                            session: currentUser.user.chapter_id,
                            database: freshUserData.chapter_id
                        });
                        
                        // Update session with database data
                        currentUser.user.chapter_id = freshUserData.chapter_id;
                        
                        // Update session storage
                        const userData = sessionStorage.getItem('iyna_user');
                        if (userData) {
                            const user = JSON.parse(userData);
                            user.chapter_id = freshUserData.chapter_id;
                            sessionStorage.setItem('iyna_user', JSON.stringify(user));
                        }
                        
                        // If user was removed from chapter, clear access
                        if (!freshUserData.chapter_id && dashboardData.user.hasChapter) {
                            console.log('User was removed from chapter, clearing access...');
                            await clearUserChapterAccess();
                        }
                    }
                } catch (error) {
                    console.error('Error force refreshing user chapter status:', error);
                }
            }
        </script>
    </body>
</html>
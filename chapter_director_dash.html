<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <meta name="description" content="">
        <meta name="author" content="">

        <title>IYNA - Personal Dashboard</title>

        <!-- Load shared navigation -->
        <script src="js/jquery.min.js"></script>
        <script src="js/load-nav.js"></script>
        <script src="js/load-footer.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="js/database.js"></script>
       

        <!-- CSS FILES -->        
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
        
        <style>
          body, h1, h2, h3, h4, h5, h6, .btn, .navbar-brand, .nav-link, .accordion-button, .custom-block, .custom-btn, .site-footer, .site-footer-link, .copyright-text {
            font-family: 'Work Sans', sans-serif !important;
          }
          
          body {
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            box-sizing: border-box;
            width: 100%;
            max-width: 100vw;
          }

          html {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
          }

          *, *::before, *::after {
            box-sizing: border-box;
          }

          /* Prevent any element from causing horizontal scroll */
          .dashboard-container,
          .tab-content,
          .announcement-card,
          .notification-banner,
          .event-card,
          .task-card,
          .ranking-item,
          .chapter-of-season,
          .search-container,
          .search-box,
          .form-control,
          .modal-content,
          .toast {
            max-width: 100%;
            overflow-x: hidden;
            word-wrap: break-word;
            word-break: break-word;
          }

          /* Ensure modals don't cause horizontal scroll */
          .modal-overlay {
            max-width: 100vw;
            overflow-x: hidden;
          }

          /* Fix any potential table or grid issues */
          table, .grid, .flex {
            max-width: 100%;
            overflow-x: auto;
          }

          /* Loading styles */
          .loading-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            flex-direction: column;
          }
                
          .loading-spinner {
            text-align: center;
          }
                
          .spinner-border {
            color: #6db9c3;
            width: 3rem;
            height: 3rem;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
          }

          @keyframes spinner-border {
            to { transform: rotate(360deg); }
          }

          .error-container {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            margin: 2rem;
            max-width: 500px;
          }

          .retry-btn {
            background: #6db9c3;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 1rem;
          }

          .retry-btn:hover {
            background: #5a9ea7;
          }

          /* Dashboard Container */
          .dashboard-container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 2rem;
            background: white;
            min-height: 100vh;
            display: none; /* Hidden until loaded */
            box-sizing: border-box;
            overflow-x: hidden;
          }

          .dashboard-container.loaded {
            display: block;
          }

          /* Header Section */
          .dashboard-header {
            margin-bottom: 2rem;
          }

          .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #000;
            margin: 0 0 0.5rem 0;
          }

          .dashboard-subtitle {
            color: #6c757d;
            font-size: 1rem;
            margin: 0;
          }

          /* Navigation Tabs */
          .dashboard-nav {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid #e9ecef;
            flex-wrap: wrap;
          }

          .nav-tab {
            padding: 1rem 0;
            text-decoration: none;
            color: #6c757d;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            white-space: nowrap;
          }

          .nav-tab.active {
            color: #000;
            border-bottom-color: #6db9c3;
          }

          .nav-tab:hover {
            color: #000;
            text-decoration: none;
          }

          /* Tab Content */
          .tab-content {
            display: none;
          }

          .tab-content.active {
            display: block;
          }

          /* Notification Banner */
          .notification-banner {
            background: linear-gradient(135deg, #b8e9e5 0%, #a0d9d3 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
          }

          .notification-icon {
            width: 24px;
            height: 24px;
            background: #064c5c;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: white;
            font-weight: bold;
          }

          .notification-icon::before {
            content: "!";
            font-size: 14px;
          }

          .notification-text {
            flex: 1;
            color: #064c5c;
            font-weight: 500;
          }

          .view-announcements {
            color: #064c5c;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
          }

          .view-announcements:hover {
            text-decoration: underline;
          }

          /* Announcement Cards */
          .announcement-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
          }

          .announcement-header {
            font-size: 1.1rem;
            font-weight: 700;
            color: #000;
            margin: 0 0 0.75rem 0;
          }

          .announcement-separator {
            border: none;
            border-top: 2px dashed #e9ecef;
            margin: 0.75rem 0;
          }

          .announcement-text {
            color: #000;
            line-height: 1.6;
            margin: 0;
            font-size: 0.95rem;
          }

          .announcement-link {
            color: #0066cc;
            text-decoration: underline;
            word-break: break-all;
          }

          .announcement-link:hover {
            color: #0052a3;
          }

          .announcement-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 1rem;
          }

          .announcement-status {
            color: #6c757d;
            font-size: 0.85rem;
            font-weight: 500;
          }

          /* Section Headers */
          .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
          }

          .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #000;
            margin: 0;
          }

          .view-more {
            color: #6db9c3;
            text-decoration: none;
            font-weight: 500;
          }

          .view-more:hover {
            text-decoration: underline;
          }

          /* No Chapter Message */
          .no-chapter-message {
            text-align: center;
            padding: 3rem 2rem;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 2rem;
          }

          .no-chapter-message h2 {
            font-size: 1.5rem;
            color: #000;
            margin-bottom: 1rem;
          }

          .chapter-directory-btn {
            background: #6db9c3;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-top: 1rem;
          }

          .chapter-directory-btn:hover {
            background: #5a9ea7;
            color: white;
            text-decoration: none;
          }

          /* Rankings Section */
          .rankings-section {
            margin-top: 2rem;
          }

          .rankings-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #000;
            margin-bottom: 1.5rem;
          }

          /* Chapter of the Season Card */
          .chapter-of-season {
            background: linear-gradient(135deg, #2c5364 0%, #203a43 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 0.5rem;
          }

          .season-star {
            width: 48px;
            height: 48px;
            background: #6db9c3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
          }

          .season-star::before {
            content: "‚≠ê";
          }

          .season-info {
            flex: 1;
          }

          .season-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: inline-block;
          }

          .season-school {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0.5rem 0 0.25rem 0;
          }

          .season-code {
            opacity: 0.8;
            font-size: 0.9rem;
          }

          .season-leader {
            opacity: 0.8;
            font-size: 0.9rem;
          }

          /* Search and Filter Section */
          .search-filter-section {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
          }

          /* Search Bar */
          .search-container {
            margin-bottom: 2rem;
            position: relative;
          }

          .search-box {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
          }

          .search-box:focus {
            outline: none;
            border-color: #6db9c3;
          }

          .filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
          }

          .filter-btn {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
          }

          .filter-btn.active {
            background: #6db9c3;
            color: white;
            border-color: #6db9c3;
          }

          .filter-dropdown {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            min-width: 120px;
          }

          .clear-filters {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
          }

          /* Rankings List */
          .rankings-list {
            background: white;
            border: 1px solid #e9ecef;
            overflow: hidden;
          }

          .ranking-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s ease;
          }

          .ranking-item:last-child {
            border-bottom: none;
          }

          .ranking-item:hover {
            background-color: #f8f9fa;
          }

          .ranking-item.featured {
            background: linear-gradient(135deg, #fff5e6 0%, #ffe9cc 100%);
            border-left: 4px solid #ff8c00;
          }

          .ranking-position {
            font-size: 1.2rem;
            font-weight: 700;
            color: #000;
            min-width: 40px;
            margin-right: 1rem;
          }

          .ranking-position.featured {
            color: #ff8c00;
          }

          .ranking-chapter-info {
            flex: 1;
            margin-right: 1rem;
          }

          .ranking-chapter-name {
            font-size: 1rem;
            font-weight: 600;
            color: #000;
            margin: 0 0 0.25rem 0;
          }

          .ranking-school-name {
            font-size: 0.9rem;
            color: #6c757d;
            margin: 0;
          }

          .ranking-points-section {
            text-align: right;
            margin-right: 1rem;
          }

          .ranking-points {
            font-size: 1.1rem;
            font-weight: 700;
            color: #000;
            margin: 0;
          }

          .ranking-points-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin: 0;
          }

          .request-join-btn {
            background: #6db9c3;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
          }

          .request-join-btn:hover {
            background: #5a9ea7;
          }

          .request-join-btn:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
          }

          /* Events and Tasks Styles */
          .events-grid, .tasks-list {
            display: grid;
            gap: 1.5rem;
            margin-top: 1rem;
          }

          .event-card, .task-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            transition: box-shadow 0.2s ease;
          }

          .event-card:hover, .task-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
          }

          .event-title, .task-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #000;
            margin: 0 0 0.5rem 0;
          }

          .event-subtitle {
            color: #6c757d;
            margin: 0 0 1rem 0;
            line-height: 1.5;
          }

          .task-description {
            color: #000;
            margin: 0 0 1rem 0;
            line-height: 1.5;
            font-size: 1rem;
          }

          .event-footer, .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
          }

          .event-date, .task-deadline {
            color: #6c757d;
            font-size: 0.9rem;
          }

          .event-button, .request-points-btn {
            background: #6db9c3;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
          }

          .event-button:hover, .request-points-btn:hover {
            background: #5a9ea7;
            text-decoration: none;
            color: white;
          }

          .task-meta {
            display: flex;
            gap: 1rem;
            margin: 0.5rem 0;
            flex-wrap: wrap;
          }

          .task-points {
            background: #6db9c3;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
          }

          .task-code, .task-deadline {
            color: #6c757d;
            font-size: 0.9rem;
          }

          /* Loading/Empty States */
          .loading-text {
            color: #6c757d;
            text-align: center;
            padding: 2rem;
            font-style: italic;
          }

          .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
          }

          .empty-state h3 {
            color: #6c757d;
            margin-bottom: 1rem;
          }

          /* Modal Styles */
          .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
            overflow-y: auto;
            padding: 20px;
          }

          .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            animation: modalSlideIn 0.3s ease;
          }

          @keyframes modalSlideIn {
            from {
              opacity: 0;
              transform: scale(0.9) translateY(-20px);
            }
            to {
              opacity: 1;
              transform: scale(1) translateY(0);
            }
          }

          /* Toast Styles */
          .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            display: none;
            z-index: 1001;
            font-weight: 500;
            min-width: 300px;
            max-width: calc(100vw - 40px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: toastSlideIn 0.3s ease;
          }

          .toast.error {
            background: #dc3545;
          }

          .toast.warning {
            background: #ffc107;
            color: #000;
          }

          .toast.info {
            background: #17a2b8;
          }

          @keyframes toastSlideIn {
            from {
              opacity: 0;
              transform: translateX(100%);
            }
            to {
              opacity: 1;
              transform: translateX(0);
            }
          }

          /* Form Elements */
          .form-group {
            margin-bottom: 1.5rem;
          }

          .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #000;
            font-weight: 600;
          }

          .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
          }

          .form-control:focus {
            outline: none;
            border-color: #6db9c3;
            box-shadow: 0 0 0 2px rgba(109, 185, 195, 0.1);
          }

          /* Button Loading State */
          .btn-loading {
            opacity: 0.7;
            cursor: not-allowed;
            position: relative;
          }

          .btn-loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid white;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spinner-border 0.75s linear infinite;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
          }

          /* Responsive Design */
          @media (max-width: 768px) {
            .dashboard-container {
              padding: 1rem;
              max-width: 100%;
            }

            .dashboard-nav {
              gap: 1rem;
            }

            .search-filter-section {
              flex-direction: column;
              align-items: stretch;
            }

            .search-box {
              min-width: auto;
            }

            .filter-group {
              justify-content: space-between;
            }

            .ranking-item {
              flex-direction: column;
              align-items: flex-start;
            gap: 0.5rem;
          }

            .ranking-position {
              min-width: auto;
              margin-right: 0;
            }

            .ranking-points-section {
              text-align: left;
              margin-right: 0;
            }

            .notification-banner {
              flex-direction: column;
            text-align: center;
              gap: 1rem;
            }

            .chapter-of-season {
              flex-direction: column;
              text-align: center;
            }

            .modal-content {
              margin: 1rem;
              padding: 1.5rem;
            }
          }

          /* Extra small screens */
          @media (max-width: 480px) {
            .dashboard-container {
              padding: 0.5rem;
            }
            
            .dashboard-title {
              font-size: 2rem;
            }
            
            .nav-tab {
              padding: 0.75rem 0;
              font-size: 0.9rem;
            }

            .toast {
              min-width: auto;
              max-width: calc(100vw - 20px);
              right: 10px;
              left: 10px;
            }
          }

          /* Force no horizontal scroll on all screen sizes */
          @media (max-width: 100vw) {
            body, html {
              overflow-x: hidden !important;
              width: 100% !important;
              max-width: 100vw !important;
            }
          }

          /* Chapter Dashboard Styles */
          .chapter-dashboard-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1rem;
          }

          .chapter-directors-section {
            margin-bottom: 2rem;
          }

          .chapter-directors-section,
          .chapter-stats-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            box-sizing: border-box;
            overflow: hidden;
            min-height: 300px;
          }

          .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #000;
            margin: 0 0 1.5rem 0;
          }

          .directors-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
          }

          .director-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
          }

          .director-icon {
            width: 40px;
            height: 40px;
            background: #1B4965;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
          }

          .director-info {
            flex: 1;
          }

          .director-name {
            font-size: 1rem;
            font-weight: 600;
            color: #000;
            margin: 0;
          }

          .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            width: 100%;
            box-sizing: border-box;
          }

          .stats-subsection {
            margin-bottom: 0;
          }

          .subsection-title {
            font-size: 1rem;
            font-weight: 600;
            color: #000;
            margin: 0 0 0.75rem 0;
          }

          .rank-card,
          .points-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            height: calc(100% - 2rem);
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-sizing: border-box;
            max-width: 100%;
            margin-bottom: 2rem;
          }

          .rank-number,
          .points-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1B4965;
            margin: 0;
          }

          .rank-divider {
            width: 100%;
            height: 1px;
            background: #1B4965;
            margin: 0.5rem 0;
          }

          .total-chapters {
            font-size: 2rem;
            font-weight: 700;
            color: #1B4965;
            margin: 0;
          }

          .request-points-link {
            display: block;
            margin-top: 0.75rem;
            color: #1B4965;
            text-decoration: underline;
            font-size: 0.9rem;
            font-weight: 500;
          }

          .request-points-link:hover {
            color: #0d2d3a;
            text-decoration: none;
          }

          /* Member Roster Styles */
          .member-roster-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            box-sizing: border-box;
            overflow: hidden;
            min-height: 400px;
          }

          .roster-header {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
          }

          .member-count {
            color: #6c757d;
            font-size: 1rem;
            font-weight: 400;
          }

          .member-table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e9ecef;
          }

          .member-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: white;
          }

          .member-table thead {
            background: white;
            border-bottom: 1px solid #e9ecef;
          }

          .member-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #000;
            border-bottom: 1px solid #e9ecef;
            position: relative;
          }

          .member-table th.sortable {
            cursor: pointer;
            user-select: none;
          }

          .member-table th.sortable:hover {
            background: #f8f9fa;
          }

          .sort-icon {
            font-size: 0.7rem;
            color: #6c757d;
            margin-left: 0.25rem;
          }

          .points-header {
            color: #1B4965 !important;
            text-align: center;
          }

          .member-table tbody tr {
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s ease;
            height: 60px;
          }

          .member-table tbody tr:hover {
            background: #f8f9fa;
          }

          .member-table tbody tr:last-child {
            border-bottom: none;
          }

          .member-table td {
            padding: 1rem;
            color: #495057;
            vertical-align: middle;
            line-height: 1.4;
            text-align: left;
          }
          .member-table td:nth-child(3),
          .member-table td:last-child { text-align: center; }

          /* Join Requests Styles */
          #joinRequestsSection {
            margin-top: 2rem;
          }

          .section-subtitle {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1B4965;
            margin: 0 0 1rem 0;
          }

          .requests-header {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
          }

          .request-count {
            color: #6c757d;
            font-size: 1rem;
            font-weight: 400;
          }

          .requests-table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e9ecef;
          }

          .requests-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: white;
          }

          .requests-table thead {
            background: white;
            border-bottom: 1px solid #e9ecef;
          }

          .requests-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #000;
            border-bottom: 1px solid #e9ecef;
            position: relative;
          }

          .requests-table th.sortable {
            cursor: pointer;
            user-select: none;
          }

          .requests-table th.sortable:hover {
            background: #f8f9fa;
          }

          .requests-table tbody tr {
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s ease;
            height: 60px;
          }

          .requests-table tbody tr:hover {
            background: #f8f9fa;
          }

          .requests-table tbody tr:last-child {
            border-bottom: none;
          }

          .requests-table td {
            padding: 1rem;
            color: #495057;
            vertical-align: middle;
            line-height: 1.4;
            text-align: left;
          }
          .requests-table td:last-child { text-align: center; }

          .request-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
          }

          .approve-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
          }

          .approve-btn:hover {
            background: #218838;
          }

          .deny-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
          }

          .deny-btn:hover {
            background: #c82333;
          }

          .view-reason-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
          }

          .view-reason-btn:hover {
            background: #138496;
          }

          .member-table td:first-child {
            font-weight: 500;
            color: #000;
          }

          .member-table td:nth-child(3) {
            font-weight: 500;
          }

          /* Global Rankings Styles */
          .global-rankings-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            box-sizing: border-box;
            overflow: hidden;
            min-height: 400px;
          }

          .chapter-of-season {
            background: #1B4965;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            text-align: center;
            color: white;
          }

          .season-label {
            font-size: 0.8rem;
            color: #b8c5cc;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0;
          }

          .season-chapter-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0;
          }

          .season-chapter-code {
            font-size: 0.9rem;
            color: #b8c5cc;
            margin-bottom: 0;
          }

          .season-leader {
            font-size: 0.8rem;
            color: #b8c5cc;
            margin-bottom: 0;
          }

          .rankings-list-container {
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            overflow: hidden;
          }

          .rankings-list {
            padding: 1rem;
          }

          .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #f8f9fa;
            font-size: 0.9rem;
          }

          .ranking-item:last-child {
            border-bottom: none;
          }

          .ranking-number {
            font-weight: 600;
            color: #000;
            min-width: 30px;
          }

          .ranking-chapter {
            flex: 1;
            margin: 0 1rem;
            color: #495057;
          }

          .ranking-points {
            font-weight: 500;
            color: #1B4965;
            min-width: 80px;
            text-align: right;
          }

          .view-directory-link {
            text-align: center;
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
          }

          .view-directory-link a {
            color: #1B4965;
            text-decoration: none;
            font-weight: 500;
          }

          .view-directory-link a:hover {
            text-decoration: underline;
          }

          /* Responsive design for chapter dashboard */
          @media (max-width: 768px) {
            .chapter-dashboard-container {
              grid-template-columns: 1fr;
              gap: 1rem;
            }
            
            .stats-row {
              grid-template-columns: 1fr;
              gap: 1rem;
            }
          }

          /* Events Section Styles */
          .events-section {
            margin-bottom: 2rem;
          }

          .events-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
          }

          .events-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #000;
            margin: 0;
          }

          .view-all-link {
            color: #6db9c3;
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
          }

          .view-all-link:hover {
            color: #5aa6b0;
            text-decoration: underline;
          }

          .event-filter-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
          }

          .event-filter-tab {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
          }

          .event-filter-tab.active {
            background: #6db9c3;
            color: white;
            border-color: #6db9c3;
          }

          .event-filter-tab:hover {
            background: #e9ecef;
          }

          .event-filter-tab.active:hover {
            background: #5aa6b0;
          }

          .events-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(350px, 1fr));
            gap: 2rem;
            justify-content: start;
          }

          .event-card {
            background: #DFE7EC;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            position: relative;
            transition: all 0.3s ease;
            aspect-ratio: 4/3;
            display: flex;
            flex-direction: column;
            min-height: 280px;
          }

          .event-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
          }

          .event-card.past {
            border: 2px dotted #e9ecef;
            background: white;
            /* Maintain same sizing and positioning */
            padding: 2rem;
            aspect-ratio: 4/3;
            min-height: 280px;
            display: flex;
            flex-direction: column;
          }

          .event-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #000;
            margin: 0 0 0.75rem 0;
          }

          .event-subtitle {
            font-size: 1rem;
            color: #495057;
            margin: 0 0 0.5rem 0;
          }

          .event-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 2rem;
            position: absolute;
            bottom: 2rem;
            left: 2rem;
            right: 2rem;
          }

          .event-date-time {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
          }

          .event-date {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
            color: #495057;
            font-size: 0.9rem;
          }

          .event-time {
            color: #495057;
            font-size: 0.9rem;
            font-weight: 500;
          }

          .calendar-icon {
            color: #6db9c3;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1;
          }

          .event-date-text {
            color: #495057;
            font-size: 0.9rem;
            font-weight: 500;
            line-height: 1;
          }

          .event-status {
            color: #6c757d;
            font-size: 0.85rem;
            font-style: italic;
          }

          .view-details-btn {
            background: #6db9c3;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: background-color 0.3s ease;
          }

          .view-details-btn:hover {
            background: #5aa6b0;
          }

          .timeline-connector {
            position: absolute;
            bottom: -10px;
            right: 20px;
            width: 60px;
            height: 20px;
            border-right: 2px dashed #e9ecef;
            border-bottom: 2px dashed #e9ecef;
          }

          /* Tasks Section Styles */
          .tasks-section {
            margin-top: 3rem;
            margin-bottom: 2rem;
          }

          .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
          }

          .tasks-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #000;
            margin: 0;
          }

          .tasks-stats {
            display: flex;
            align-items: center;
            gap: 2rem;
          }

          .top-earner-badge {
            background: #6db9c3;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
          }

          .star-icon {
            font-size: 0.9rem;
          }

          .points-display {
            text-align: right;
          }

          .points-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #000;
            margin: 0;
          }

          .points-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin: 0;
          }

          .tasks-controls {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-bottom: 1rem;
          }

          .filter-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
          }

          /* Sub-tabs for New/Past filtering */
          .sub-tabs {
            display: flex;
            gap: 0.5rem;
            background: #f8f9fa;
            padding: 4px;
            border-radius: 8px;
          }

          .sub-tab {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            color: #6c757d;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            cursor: pointer;
          }

          .sub-tab:hover {
            color: #1B4965;
            background: rgba(27, 73, 101, 0.1);
          }

          .sub-tab.active {
            background: #1B4965;
            color: white;
          }

          /* Past point requests styling */
          .past-request {
            background: white;
          }

          .past-request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
          }

          .approved-badge {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
          }

          .evidence-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
          }

          .evidence-section strong {
            color: #1B4965;
            font-size: 0.9rem;
          }

          .evidence-text {
            margin: 0.5rem 0 0 0;
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.4;
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 6px;
          }

          .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
          }

          .filter-btn {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s ease;
          }

          .filter-btn:hover {
            background: #e9ecef;
          }

          .filter-btn.active {
            background: #6db9c3;
            color: white;
            border-color: #6db9c3;
          }

          .clear-filters {
            display: flex;
            align-items: center;
            gap: 0.25rem;
          }

          .clear-icon {
            font-size: 0.9rem;
          }

          .filter-toggle-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
          }

          .filter-toggle-btn:hover {
            background: #5a6268;
          }

          .filter-icon {
            font-size: 0.8rem;
          }

          .tasks-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
          }

          .task-card-personal {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
          }

          .task-card-personal:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          }

          .task-card-personal.expanded {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          }

          .task-header-personal {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
          }

          .task-title-personal {
            font-size: 1.1rem;
            font-weight: 600;
            color: #000;
            margin: 0 0 0.5rem 0;
            flex: 1;
          }

          .task-meta-personal {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
          }

          .task-points-personal {
            background: #6db9c3;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
          }

          .task-code-personal {
            font-weight: 600;
            color: #495057;
          }

          .task-description-personal {
            color: #495057;
            line-height: 1.6;
            margin: 1rem 0;
            display: none;
          }

          .task-description-personal.expanded {
            display: block;
          }

          .reward-breakdown {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            display: none;
          }

          .reward-breakdown.expanded {
            display: block;
          }

          .reward-breakdown ul {
            margin: 0;
            padding-left: 1.5rem;
          }

          .reward-breakdown li {
            margin-bottom: 0.5rem;
            color: #495057;
            line-height: 1.4;
          }

          .task-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 1rem;
            display: none;
          }

          .task-actions.expanded {
            display: flex;
          }

          .request-points-btn {
            background: #6db9c3;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: background-color 0.3s ease;
          }

          .request-points-btn:hover {
            background: #5aa6b0;
          }

          .completed-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
          }

          .task-connector {
            position: absolute;
            top: 50%;
            right: -20px;
            width: 20px;
            height: 2px;
            background: #e9ecef;
            border-top: 2px dotted #e9ecef;
          }

          /* Responsive design for tasks */
          @media (max-width: 768px) {
            .tasks-header {
              flex-direction: column;
              gap: 1rem;
            }

            .tasks-stats {
              justify-content: space-between;
              width: 100%;
            }

            .tasks-controls {
              flex-direction: column;
              gap: 0.25rem;
            }

            .filter-container {
              justify-content: space-between;
              width: 100%;
            }

            .filter-buttons {
              flex: 1;
            }
          }

          /* Responsive design for events */
          @media (max-width: 1024px) {
            .events-grid {
              grid-template-columns: repeat(2, 1fr);
            }
          }

          @media (max-width: 768px) {
            .events-grid {
              grid-template-columns: 1fr;
            }
          }

          /* Main Announcement Banner */
          .main-announcement-banner {
            background: #BEE9E8;
            border-radius: 12px;
            margin: 1.5rem 0;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(190, 233, 232, 0.3);
            border-left: 4px solid #6db9c3;
          }

          .announcement-content {
            padding: 1.5rem;
            color: #1B4965;
            display: flex;
            align-items: center;
            gap: 1rem;
          }

          .announcement-icon {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
          }

          .announcement-text {
            flex: 1;
          }





          .announcement-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0 0 0.75rem 0;
            color: #1B4965;
          }

          .announcement-message {
            font-size: 1rem;
            line-height: 1.5;
            margin: 0;
            color: #1B4965;
          }

          @media (max-width: 768px) {
            .main-announcement-banner {
              margin: 1rem 0;
            }
            
            .announcement-content {
              padding: 1rem;
            }
            
            .announcement-title {
              font-size: 1.2rem;
            }
            
            .announcement-message {
              font-size: 0.9rem;
            }
          }

          /* Chapter Management Section */
          .chapter-management-section {
            padding: 1rem 0 2rem 0;
            margin-top: 1rem;
          }

          .chapter-actions {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            text-align: center;
          }

          .chapter-buttons {
            display: flex;
            gap: 2rem;
            justify-content: center;
            flex-wrap: wrap;
          }

          .chapter-btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
          }

          .leave-chapter-btn {
            background: #dc3545;
            color: white;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
          }

          .leave-chapter-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
          }

          .new-chapter-btn {
            background: #28a745;
            color: white;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
          }

          .new-chapter-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
          }



          @media (max-width: 768px) {
            .chapter-buttons {
              flex-direction: column;
              align-items: center;
            }

            .chapter-btn {
              min-width: 250px;
            }
          }

          /* Chapter Bio full-width card */
          .chapter-bio-section {
            grid-column: 1 / -1;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
          }
          .chapter-bio-section .bio-header { display:flex; align-items:center; justify-content: space-between; margin-bottom: 1.5rem; }
          .chapter-bio-section .bio-content { margin-bottom: 1.5rem; }
          .chapter-bio-section .bio-content p { font-size: 1rem; line-height: 1.6; color: #333; margin: 0 0 1rem 0; }
          .chapter-bio-section .bio-content .no-bio { color:#6c757d; font-style: italic; text-align:center; padding:2rem; background:#f8f9fa; border-radius:8px; border:2px dashed #dee2e6; }
          .chapter-bio-section .social-media-links { border-top:1px solid #e9ecef; padding-top:1.5rem; }
          .chapter-bio-section .social-media-title { font-size: 1rem; font-weight: 600; color: #000; margin: 0 0 1rem 0; }
          .chapter-bio-section .social-links-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 1.25rem; }
          .chapter-bio-section .social-link-item { display:flex; align-items:center; justify-content:flex-start; gap:.75rem; padding:.9rem 1rem; background:#fff; border:1px solid #e9ecef; border-radius:10px; text-decoration:none; color:#212529; transition: box-shadow .2s, transform .2s, border-color .2s; white-space:nowrap; overflow:hidden; width:100%; }
          .chapter-bio-section .social-link-item:hover { box-shadow:0 6px 18px rgba(0,0,0,0.08); transform: translateY(-1px); border-color:#dee2e6; }
          .chapter-bio-section .social-link-item .label { font-weight:600; letter-spacing:.2px; color:#0f172a; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
          .chapter-bio-section .social-link-item .icon { font-size:1rem; color:#94a3b8; margin-left:.25rem; transition: transform .2s ease, color .2s ease; }
          .chapter-bio-section .social-link-item:hover .icon { transform: translateX(2px); color:#1B4965; }

          /* Make Member Roster full-width */
          .member-roster-section { grid-column: 1 / -1; }
          .member-table-container { width: 100%; }

          /* Bottom row grid: 75% roster, 25% rankings */
                     .bottom-row {
            display: grid;
            grid-template-columns: 65% 35%;
            gap: 2rem;
            grid-column: 1 / -1;
          }
          .bottom-row .member-roster-section { grid-column: auto; }
          .bottom-row .global-rankings-section { grid-column: auto; }
        </style>
                        
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/bootstrap-icons.css" rel="stylesheet">
        <link href="css/templatemo-topic-listing.css" rel="stylesheet">      
    </head>
    
    <body>
        <!-- Navigation Placeholder -->
        <div id="nav-placeholder"></div>

        <!-- Loading Screen -->
        <div class="loading-container" id="loadingContainer">
            <div class="loading-spinner">
                <div class="spinner-border" role="status">
                    <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Loading...</span>
                </div>
                <h3 style="margin-top: 1rem;">Loading Chapter Director Dashboard...</h3>
                <p style="color: #6c757d;">Verifying your access and loading data</p>
            </div>
        </div>

        <div class="dashboard-container" id="dashboardContainer">
            <!-- Header -->
            <div class="dashboard-header">
                <h1 class="dashboard-title" id="dashboardTitle">Hi, <span id="userName">Loading...</span></h1>
                <p class="dashboard-subtitle" id="userSubtitle">Chapter Director ‚Ä¢ <span id="chapterInfo">Loading...</span></p>
            </div>

            <!-- Main Announcement Banner -->
            <div class="main-announcement-banner" id="mainAnnouncementBanner" style="display: none;">
                <div class="announcement-content">
                    <img src="images/icons/speaker.png" alt="Announcement" class="announcement-icon">
                    <div class="announcement-text">
                        <h3 class="announcement-title" id="bannerAnnouncementTitle">Loading...</h3>
                        <p class="announcement-message" id="bannerAnnouncementMessage">Loading...</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="dashboard-nav">
                <a class="nav-tab active" data-tab="personal">Personal Dashboard</a>
                <a class="nav-tab" data-tab="chapter">Chapter Dashboard</a>
                <a class="nav-tab" data-tab="announcements">Announcements</a>
            </nav>

                        <!-- Personal Dashboard Tab -->
            <div id="personal-tab" class="tab-content active">
                <div class="events-section">
                    <div class="events-header">
                        <h2 class="events-title">Events</h2>
                        <a href="events_landing.html" class="view-all-link">View all ‚Üí</a>
                </div>

                    <div class="event-filter-tabs">
                        <button class="event-filter-tab active" data-filter="upcoming">Upcoming</button>
                        <button class="event-filter-tab" data-filter="past">Past</button>
                    </div>
                    
                    <div class="events-grid" id="eventsGrid">
                        <div class="loading-text">Loading events...</div>
                </div>
            </div>

                <div class="tasks-section">
                    <div class="tasks-header">
                        <h2 class="tasks-title">Tasks</h2>
                        <div class="tasks-stats">
                            <div class="top-earner-badge">
                                <span class="star-icon">‚òÖ</span>
                                <span>top earner</span>
                            </div>
                            <div class="points-display">
                                <div class="points-value" id="personalTotalPoints">0</div>
                                <div class="points-label">Total points earned</div>
                            </div>
                    </div>
                </div>

                    <div class="tasks-controls">
                <div class="search-container">
                            <div class="search-input-wrapper">
                                <span class="search-icon">Search</span>
                                <input type="text" class="search-box" placeholder="Search" id="personalTaskSearch">
                </div>
                        </div>
                        <div class="filter-container">
                            <div class="event-filter-tabs">
                                <button class="event-filter-tab active" data-subtab="new">New</button>
                                <button class="event-filter-tab" data-subtab="past">Past</button>
                            </div>
                        </div>
                </div>

                    <div class="tasks-grid" id="personalTasksGrid">
                        <div class="loading-text">Loading tasks...</div>
                    </div>
                </div>
            </div>

            <!-- Chapter Dashboard Tab -->
            <div id="chapter-tab" class="tab-content">
                <div class="chapter-dashboard-container">
                    <!-- Chapter Bio Section -->
                    <div class="chapter-bio-section">
                        <div class="bio-header">
                            <h2 class="section-title">Chapter Bio</h2>
                            <div class="bio-actions" id="directorBioActions" style="display:none;">
                                <button class="btn btn-sm" style="background:#1B4965; color:#fff; border:none;" onclick="openEditChapterBioModal()">Edit Bio</button>
                            </div>
                        </div>
                        <div class="bio-content" id="directorChapterBioContent">
                            <div class="loading-text">Loading chapter bio...</div>
                        </div>
                        <div class="social-media-links" id="directorSocialMediaLinks" style="display:none;">
                            <h4 class="social-media-title">Connect With Us</h4>
                            <div class="social-links-grid" id="directorSocialLinksGrid"></div>
                        </div>
                    </div>
                     <!-- Top Row: Chapter Directors and Chapter Stats -->
                    <div class="chapter-directors-section">
                        <h2 class="section-title">Chapter Director(s)</h2>
                        <div class="directors-list" id="directorsList">
                            <div class="loading-text">Loading chapter directors...</div>
                        </div>
                </div>

                    <div class="chapter-stats-section">
                        <h2 class="section-title">Chapter Stats</h2>
                        
                        <div class="stats-row">
                            <!-- Rank Section -->
                            <div class="stats-subsection">
                                <h3 class="subsection-title">Rank</h3>
                                <div class="rank-card">
                                    <div class="rank-number" id="chapterRank">1</div>
                                    <div class="rank-divider"></div>
                                    <div class="total-chapters" id="totalChapters">1200</div>
                </div>
                </div>

                            <!-- Points Section -->
                            <div class="stats-subsection">
                                <h3 class="subsection-title">Points</h3>
                                <div class="points-card">
                                    <div class="points-number" id="chapterPoints">60</div>
                                    <a href="#" class="request-points-link" onclick="openTaskSubmissionModal()">Request points for chapter</a>
                    </div>
                </div>
            </div>
        </div>

                    <!-- Bottom Row: Member Roster and Global Rankings -->
                    <div class="bottom-row">
                        <div class="member-roster-section">
                        <div class="roster-header">
                            <h2 class="section-title">Member Roster</h2>
                            <span class="member-count" id="memberCount">(0 members)</span>
                        </div>

                        <div class="search-container">
                            <div class="search-input-wrapper">
                                <span class="search-icon">Search</span>
                                <input type="text" class="search-box" placeholder="Search" id="memberSearch">
                            </div>
                        </div>
                        
                        <div class="member-table-container">
                            <table class="member-table">
                                <thead>
                                    <tr>
                                        <th class="sortable">
                                            Name<span class="sort-icon">‚ñº</span>
                                        </th>
                                        <th class="sortable">
                                            Role<span class="sort-icon">‚ñº</span>
                                        </th>
                                        <th class="sortable points-header">
                                            Points<span class="sort-icon">‚ñº</span>
                                        </th>
                                        <th class="sortable">
                                            School<span class="sort-icon">‚ñº</span>
                                        </th>
                                        <th class="sortable">
                                            Discord<span class="sort-icon">‚ñº</span>
                                        </th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="memberTableBody">
                                    <tr>
                                        <td colspan="5" class="loading-text">Loading members...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Join Requests Section (Only visible to chapter directors) -->
                        <div id="joinRequestsSection" style="display: none;">
                            <div class="requests-header">
                                <h3 class="section-subtitle">Join Requests</h3>
                                <span class="request-count" id="requestCount">(0 requests)</span>
                            </div>
                            
                            <div class="requests-table-container">
                                <table class="requests-table">
                                    <thead>
                                        <tr>
                                            <th class="sortable">
                                                Name<span class="sort-icon">‚ñº</span>
                                            </th>
                                            <th class="sortable">
                                                School<span class="sort-icon">‚ñº</span>
                                            </th>
                                            <th class="sortable">
                                                Requested<span class="sort-icon">‚ñº</span>
                                            </th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="requestsTableBody">
                                        <tr>
                                            <td colspan="4" class="loading-text">Loading join requests...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                        <div class="global-rankings-section">
                            <h2 class="section-title">Global Rankings</h2>
                            
                            <!-- Chapter of the Season -->
                            <div class="chapter-of-season">
                                <div class="season-label">CHAPTER OF THE SEASON</div>
                                <div class="season-chapter-name" id="seasonChapterName">Loading...</div>
                                <div class="season-chapter-code" id="seasonChapterCode">Loading...</div>
                                <div class="season-leader" id="seasonLeader">Loading...</div>
                            </div>
                    
                            <!-- Global Rankings List -->
                            <div class="rankings-list-container">
                                <div class="rankings-list" id="rankingsList">
                                    <div class="loading-text">Loading global rankings...</div>
                                </div>
                                <div class="view-directory-link">
                                    <a href="#" onclick="viewDirectory()">View Directory</a>
                                </div>
                            </div>
                                                </div>
                    </div>
                </div>
            </div>
 
                <!-- Announcements Tab -->
            <div id="announcements-tab" class="tab-content">
                <div class="search-container">
                    <input type="text" class="search-box" placeholder="Search announcements..." id="announcementSearch">
                        </div>

                <div class="announcements-list" id="announcementsList">
                    <div class="loading-text">Loading announcements...</div>
                        </div>
                        </div>
                        </div>
        </div>
                
        <!-- Chapter Management Section -->
        <div class="chapter-management-section" id="chapterManagementSection" style="display: none;">
            <div class="chapter-actions">
                <div class="chapter-buttons">
                    <button class="chapter-btn leave-chapter-btn" onclick="showLeaveChapterModal()">
                        Leave Chapter
                    </button>

                        </div>
                        </div>
                        </div>
                
        <!-- Footer Placeholder -->
        <div id="footer-placeholder"></div>

        <!-- Point Request Modal -->
        <div class="modal-overlay" id="pointRequestModal" style="display: none;">
            <div class="modal-content" style="max-width: 600px; background: white; border-radius: 16px; padding: 0; overflow: hidden; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);">
                <!-- Modal Header -->
                <div style="background: #1B4965; padding: 2rem 2rem 1.5rem 2rem; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: 1.8rem; font-weight: 700; color: white;">Request Points</h3>
                        <button onclick="closePointRequestModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: white; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</button>
                    </div>
                </div>
                
                <!-- Modal Body -->
                <div style="padding: 2rem; max-height: 60vh; overflow-y: auto;">
                    <div class="task-info-section" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid #e9ecef; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);">
                        <h4 style="margin: 0 0 1rem 0; color: #1B4965; font-size: 1.4rem; font-weight: 700;" id="modalTaskTitle">Task Title</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div>
                                <strong style="color: #6c757d; font-size: 0.9rem;">Points:</strong>
                                <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalTaskPoints">0</div>
                            </div>
                            <div>
                                <strong style="color: #6c757d; font-size: 0.9rem;">Deadline:</strong>
                                <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalTaskDeadline">N/A</div>
                            </div>
                            <div>
                                <strong style="color: #6c757d; font-size: 0.9rem;">Code:</strong>
                                <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalTaskCode">N/A</div>
                            </div>
                        </div>
                        <div style="margin-top: 1.5rem;">
                            <strong style="color: #6c757d; font-size: 0.9rem;">Description:</strong>
                            <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalTaskDescription">Task description</div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #000; font-size: 0.9rem;">Task Name *</label>
                        <input 
                            type="text" 
                            id="taskNameInput" 
                            class="form-control"
                            placeholder="Enter task name (e.g., Lab Safety Training, Workshop Attendance)"
                            style="width: 300px; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 8px; font-size: 0.95rem; font-family: inherit; transition: border-color 0.2s, box-shadow 0.2s;"
                            onfocus="this.style.borderColor='#1B4965'; this.style.boxShadow='0 0 0 2px rgba(27, 73, 101, 0.1)'"
                            onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"
                            required>
                        <small style="color: #6c757d; font-size: 0.9rem; margin-top: 0.5rem; display: block;">Enter a descriptive name for the task or activity you completed.</small>
                    </div>
                
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #000; font-size: 0.9rem;">Task Code *</label>
                        <input 
                            type="text" 
                            id="taskCodeInput" 
                            class="form-control"
                            placeholder="Enter task code (e.g., SAF001, EDU002)"
                            style="width: 300px; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 8px; font-size: 0.95rem; font-family: inherit; transition: border-color 0.2s, box-shadow 0.2s;"
                            onfocus="this.style.borderColor='#1B4965'; this.style.boxShadow='0 0 0 2px rgba(27, 73, 101, 0.1)'"
                            onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"
                            required>
                        <small style="color: #6c757d; font-size: 0.9rem; margin-top: 0.5rem; display: block;">Enter the specific task code for the activity you completed.</small>
                </div>
                
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #000; font-size: 0.9rem;">Points Requested *</label>
                        <input 
                            type="number" 
                            id="pointsRequested" 
                            class="form-control"
                            placeholder="Enter points to request"
                            style="width: 200px; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 8px; font-size: 0.95rem; font-family: inherit; background-color: white; color: #1B4965; font-weight: 500; transition: border-color 0.2s, box-shadow 0.2s;"
                            onfocus="this.style.borderColor='#1B4965'; this.style.boxShadow='0 0 0 2px rgba(27, 73, 101, 0.1)'"
                            onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"
                            min="1" 
                            required>
                        <small style="color: #6c757d; font-size: 0.9rem; margin-top: 0.5rem; display: block;">You can request any number of points. Admins will review and may adjust the final points awarded based on your evidence.</small>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #000; font-size: 0.9rem;">Evidence of Completion *</label>
                        <textarea 
                            id="evidenceTextarea" 
                            class="form-control"
                            placeholder="Provide detailed evidence of your task completion. Include specific details, results, or describe what you accomplished..."
                            style="min-height: 120px; resize: vertical; width: 100%; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 8px; font-size: 0.95rem; font-family: inherit; transition: border-color 0.2s, box-shadow 0.2s;"
                            onfocus="this.style.borderColor='#1B4965'; this.style.boxShadow='0 0 0 2px rgba(27, 73, 101, 0.1)'"
                            onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='none'"
                            required></textarea>
                        <small style="color: #6c757d; font-size: 0.9rem; margin-top: 0.5rem; display: block;">Be specific and detailed in your evidence to help with the review process.</small>
                </div>
                
                    <div class="form-group" style="margin-bottom: 1.5rem;">
                        <label class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #000; font-size: 0.9rem;">File Evidence (Optional)</label>
                        <div class="file-upload-container" style="border: 2px dashed #e9ecef; border-radius: 8px; padding: 1.5rem; text-align: center; transition: border-color 0.2s;">
                            <input 
                                type="file" 
                                id="evidenceFiles" 
                                class="form-control"
                                multiple
                                accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.txt,.zip,.rar"
                                style="display: none;"
                                onchange="handleFileSelection()">
                            <label for="evidenceFiles" style="cursor: pointer; display: block;">
                                <div style="color: #6c757d; margin-bottom: 0.5rem;">
                                    <img src="images/upload.svg" alt="Upload" style="width: 32px; height: 32px; display: block; margin: 0 auto 0.5rem auto; opacity: 0.7;">
                                    <strong style="color: #1B4965;">Click to upload files</strong>
                                </div>
                                <small style="color: #6c757d; font-size: 0.85rem;">
                                    Drag and drop files here or click to browse<br>
                                    Supported: Images, PDFs, Documents, Archives (max 10MB each)
                                </small>
                            </label>
                        </div>
                        <div id="fileList" style="margin-top: 1rem; display: none;">
                            <div style="font-weight: 600; color: #1B4965; margin-bottom: 0.5rem; font-size: 0.9rem;">Selected Files:</div>
                            <div id="fileItems" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
                        </div>
                        <small style="color: #6c757d; font-size: 0.9rem; margin-top: 0.5rem; display: block;">Upload screenshots, documents, or other files that support your evidence.</small>
                    </div>
                    </div>
                    
                <!-- Modal Footer -->
                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 1.5rem 2rem; border-top: 1px solid #e9ecef; display: flex; gap: 1rem; justify-content: flex-end; flex-shrink: 0;">
                    <button onclick="closePointRequestModal()" style="background: #6c757d; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; font-size: 0.95rem;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">Cancel</button>
                    <button id="submitPointsBtn" onclick="submitPointRequest()" style="background: #1B4965; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: 0.95rem; box-shadow: 0 2px 8px rgba(27, 73, 101, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(27, 73, 101, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(27, 73, 101, 0.3)'">Submit Request</button>
                </div>
                </div>
                </div>
                
        <!-- Join Chapter Confirmation Modal -->
        <div class="modal-overlay" id="joinChapterModal" style="display: none;">
            <div class="modal-content" style="max-width: 600px; text-align: left; background: white; border-radius: 16px; padding: 0; overflow: hidden; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);">
                <!-- Modal Header -->
                <div style="background: linear-gradient(135deg, #6db9c3 0%, #5aa6b0 100%); padding: 2rem 2rem 1.5rem 2rem; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: 1.8rem; font-weight: 700; color: white;">Join Chapter</h3>
                        <button onclick="closeJoinChapterModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: white; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</button>
                </div>
                    <p style="margin: 0; font-size: 1rem; opacity: 0.9; font-weight: 400;">Become a member of this IYNA chapter</p>
                </div>
                
                <!-- Modal Body -->
                <div style="padding: 2rem;">
                    <!-- Chapter Info Card -->
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid #e9ecef;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #6db9c3 0%, #5aa6b0 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.2rem;" id="chapterIcon">I</div>
                            <div>
                                <h4 style="margin: 0 0 0.25rem 0; color: #1B4965; font-size: 1.3rem; font-weight: 700;" id="joinChapterName">Chapter Name</h4>
                                <p style="margin: 0; color: #6c757d; font-size: 1rem; font-weight: 500;" id="joinSchoolName">School Name</p>
                </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #e9ecef;">
                                <div style="font-size: 1.1rem; font-weight: 700; color: #1B4965;" id="chapterPoints">0</div>
                                <div style="font-size: 0.8rem; color: #6c757d; font-weight: 500;">Season Points</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #e9ecef;">
                                <div style="font-size: 1.1rem; font-weight: 700; color: #1B4965;" id="chapterMembers">0</div>
                                <div style="font-size: 0.8rem; color: #6c757d; font-weight: 500;">Members</div>
                            </div>
                            <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #e9ecef;">
                                <div style="font-size: 1.1rem; font-weight: 700; color: #1B4965;" id="chapterRank">#1</div>
                                <div style="font-size: 0.8rem; color: #6c757d; font-weight: 500;">Ranking</div>
                            </div>
            </div>
        </div>
                    
                    <!-- Benefits Section -->
                    <div style="margin-bottom: 2rem;">
                        <h5 style="margin: 0 0 1rem 0; color: #1B4965; font-size: 1.1rem; font-weight: 600;">What you'll get:</h5>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 20px; height: 20px; background: #6db9c3; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 700;">‚úì</div>
                                <span style="color: #495057; font-size: 0.95rem;">Access to chapter events and activities</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 20px; height: 20px; background: #6db9c3; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 700;">‚úì</div>
                                <span style="color: #495057; font-size: 0.95rem;">Collaborate with fellow neuroscience enthusiasts</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 20px; height: 20px; background: #6db9c3; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 700;">‚úì</div>
                                <span style="color: #495057; font-size: 0.95rem;">Earn points for your chapter in competitions</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 20px; height: 20px; background: #6db9c3; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; font-weight: 700;">‚úì</div>
                                <span style="color: #495057; font-size: 0.95rem;">Network with students and professionals</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Join Reason Section -->
                    <div style="margin-bottom: 2rem;">
                        <h5 style="margin: 0 0 1rem 0; color: #1B4965; font-size: 1.1rem; font-weight: 600;">Why do you want to join this chapter?</h5>
                        <textarea 
                            id="joinReason" 
                            placeholder="Tell us about your interest in neuroscience and why you'd like to join this chapter..."
                            style="width: 100%; min-height: 100px; padding: 1rem; border: 1px solid #e9ecef; border-radius: 8px; font-family: inherit; font-size: 0.95rem; resize: vertical; box-sizing: border-box;"
                        ></textarea>
                    </div>
                    
                    <!-- Confirmation Message -->
                    <div style="background: #e8f4f8; border-left: 4px solid #6db9c3; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
                        <p style="margin: 0; color: #1B4965; font-size: 0.95rem; line-height: 1.5; font-weight: 500;">
                            <strong>Ready to submit your request?</strong> Your join request will be sent to the chapter director for approval.
                        </p>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div style="background: #f8f9fa; padding: 1.5rem 2rem; border-top: 1px solid #e9ecef; display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeJoinChapterModal()" style="background: #6c757d; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; font-size: 0.95rem;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">Cancel</button>
                    <button id="joinChapterBtn" onclick="confirmJoinChapter()" style="background: linear-gradient(135deg, #6db9c3 0%, #5aa6b0 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: 0.95rem; box-shadow: 0 2px 8px rgba(109, 185, 195, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(109, 185, 195, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(109, 185, 195, 0.3)'">Submit Request</button>
                </div>
            </div>
        </div>



        <!-- Event Details Modal -->
        <div class="modal-overlay" id="eventDetailsModal" style="display: none;">
            <div class="modal-content" style="max-width: 600px; max-height: 90vh; background: white; border-radius: 12px; padding: 0; overflow: hidden; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15); display: flex; flex-direction: column;">
                <!-- Modal Header -->
                <div style="background: #1B4965; padding: 2rem 2rem 1.5rem 2rem; color: white; flex-shrink: 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: 1.8rem; font-weight: 700; color: white;">Event Details</h3>
                        <button onclick="closeEventDetailsModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: white; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</button>
                    </div>
                </div>
                
                <!-- Modal Body -->
                <div style="padding: 2rem; overflow-y: auto; flex: 1;">
                    <div class="event-info-section" style="margin-bottom: 2rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #000; font-size: 1.4rem; font-weight: 600;" id="modalEventTitle">Event Title</h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div>
                                <strong style="color: #6c757d; font-size: 0.9rem;">Event Date:</strong>
                                <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalEventDate">Event Date</div>
                            </div>
                            <div>
                                <strong style="color: #6c757d; font-size: 0.9rem;">Time:</strong>
                                <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalEventTime">Event Time</div>
                            </div>
                            <div>
                                <strong style="color: #6c757d; font-size: 0.9rem;">Registration Deadline:</strong>
                                <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalEventRegistrationDeadline">No deadline set</div>
                            </div>
                            <div>
                                <strong style="color: #6c757d; font-size: 0.9rem;">Location:</strong>
                                <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalEventLocation">No location specified</div>
                            </div>
                            <div>
                                <strong style="color: #6c757d; font-size: 0.9rem;">Status:</strong>
                                <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalEventStatus">Event Status</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1.5rem;">
                            <strong style="color: #6c757d; font-size: 0.9rem;">Description:</strong>
                            <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalEventDescription">Event description</div>
                        </div>
                        
                        <div style="margin-top: 1.5rem;">
                            <strong style="color: #6c757d; font-size: 0.9rem;">Event Link:</strong>
                            <div style="color: #000; font-weight: 500; margin-top: 0.25rem;" id="modalEventLink">No link provided</div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div style="background: #f8f9fa; padding: 1.5rem 2rem; border-top: 1px solid #e9ecef; display: flex; gap: 1rem; justify-content: flex-end; flex-shrink: 0;">
                    <button onclick="closeEventDetailsModal()" style="background: #6c757d; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; font-size: 0.95rem;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">Close</button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="toast"></div>

        <!-- SCRIPTS -->
        <script src="js/jquery.min.js"></script>
        <script src="js/bootstrap.bundle.min.js"></script>

        <script>
            // Global variables
            let currentUser = null;
            let dashboardData = null;
            let currentTab = 'personal';
            let allChaptersData = [];
            let filteredChaptersData = [];
            let selectedTaskForPoints = null;
            let selectedChapterForJoin = null;

            // Add the missing getUserByEmail function to db object
            if (typeof window !== 'undefined' && window.db) {
                window.db.getUserByEmail = async function(email) {
                    try {
                        const { data, error } = await supabase
                            .from('users')
                            .select('*')
                            .eq('email', email.toLowerCase().trim())
                            .eq('is_active', true)
                            .single();
                        
                        if (error) {
                            console.error('Error getting user by email:', error);
                            return null;
                        }
                        
                        return data;
                    } catch (error) {
                        console.error('Error in getUserByEmail:', error);
                        return null;
                    }
                };
            }

            // Function to initialize the dashboard
            async function initializeDashboard() {
                try {
                    console.log('Chapter Director dashboard: Starting initialization...');
                    
                    // Wait for database to be ready
                    let retries = 0;
                    while ((!window.db || !window.supabase) && retries < 10) {
                        console.log('Waiting for database and supabase to load...', retries);
                        await new Promise(resolve => setTimeout(resolve, 500));
                        retries++;
                    }
                    
                    if (!window.db || !window.supabase) {
                        throw new Error('Database or Supabase not loaded after 5 seconds');
                    }
                    
                    console.log('‚úÖ Database and Supabase loaded successfully');
                    
                    // Test database connection
                    try {
                        console.log('Testing database connection...');
                        const { data: testData, error: testError } = await supabase
                            .from('users')
                            .select('count')
                            .limit(1);
                        
                        if (testError) {
                            console.error('‚ùå Database connection test failed:', testError);
                        } else {
                            console.log('‚úÖ Database connection test successful');
                        }
                    } catch (dbTestError) {
                        console.error('‚ùå Database connection test error:', dbTestError);
                    }
                    
                    console.log('Chapter Director dashboard: Checking authentication...');
                    
                    // Check if user is authenticated via sessionStorage
                    const userData = sessionStorage.getItem('iyna_user');
                    
                    if (!userData) {
                        console.log('No user data found in session');
                        redirectToLogin('No active session');
                        return;
                    }

                    let user;
                    try {
                        user = JSON.parse(userData);
                    } catch (parseError) {
                        console.error('Error parsing user data:', parseError);
                        redirectToLogin('Invalid session data');
                        return;
                    }

                    if (!user || !user.is_active) {
                        console.log('User data invalid or inactive');
                        sessionStorage.removeItem('iyna_user');
                        redirectToLogin('Account inactive or invalid');
                        return;
                    }

                    console.log('User authenticated:', user.email);

                    // Refresh role from DB to avoid stale session
                    try {
                        const { data: freshRole, error: roleErr } = await supabase
                            .from('users')
                            .select('role, chapter_id')
                            .eq('id', user.id)
                            .single();
                        if (!roleErr && freshRole) {
                            user.role = freshRole.role;
                            user.chapter_id = freshRole.chapter_id;
                            const stored = JSON.parse(sessionStorage.getItem('iyna_user')) || {};
                            stored.role = user.role;
                            stored.chapter_id = user.chapter_id;
                            sessionStorage.setItem('iyna_user', JSON.stringify(stored));
                        }
                    } catch (e) { console.warn('Role refresh failed', e); }

                    console.log('User role:', user.role);

                    // Check if user has chapter director role (only chapter directors should access this dashboard)
                    if (user.role === 'chapter_lead' || user.role === 'chapter_director') {
                        // Enforce: directors/leads must have a valid chapter. If not, demote and redirect.
                        // Exception: chapter_id -1 means they are exempt (chapter leads/admins without specific chapters)
                        if (!user.chapter_id && user.chapter_id !== -1) {
                            try {
                                console.warn('Director/Lead has no chapter_id and is not exempt. Demoting to member and redirecting...');
                                await supabase.from('users').update({ role: 'member', chapter_id: null }).eq('id', user.id);
                                // Update session
                                const stored = JSON.parse(sessionStorage.getItem('iyna_user')) || {};
                                stored.role = 'member';
                                stored.chapter_id = null;
                                sessionStorage.setItem('iyna_user', JSON.stringify(stored));
                            } catch (demoteErr) {
                                console.error('Error demoting user role:', demoteErr);
                            }
                            window.location.href = 'personal_dash.html';
                            return;
                        }
                        
                        // Also check if the chapter actually exists (skip for exempt users with chapter_id -1)
                        if (user.chapter_id !== -1) {
                            try {
                                const { data: chapterExists, error: chapterErr } = await supabase
                                    .from('chapters')
                                    .select('id')
                                    .eq('id', user.chapter_id)
                                    .maybeSingle();
                                
                                if (chapterErr && chapterErr.code !== 'PGRST116') {
                                    console.warn('Error checking chapter existence:', chapterErr);
                                }
                                
                                if (!chapterExists) {
                                    console.warn(`Director/Lead's chapter (ID: ${user.chapter_id}) no longer exists. Demoting to member and redirecting...`);
                                    await supabase.from('users').update({ role: 'member', chapter_id: null }).eq('id', user.id);
                                    // Update session
                                    const stored = JSON.parse(sessionStorage.getItem('iyna_user')) || {};
                                    stored.role = 'member';
                                    stored.chapter_id = null;
                                    sessionStorage.setItem('iyna_user', JSON.stringify(stored));
                                    window.location.href = 'personal_dash.html';
                                    return;
                                }
                            } catch (chapterCheckErr) {
                                console.error('Error verifying chapter existence:', chapterCheckErr);
                                // If we can't verify, assume chapter doesn't exist and demote
                                console.warn('Cannot verify chapter existence. Demoting to member and redirecting...');
                                try {
                                    await supabase.from('users').update({ role: 'member', chapter_id: null }).eq('id', user.id);
                                    const stored = JSON.parse(sessionStorage.getItem('iyna_user')) || {};
                                    stored.role = 'member';
                                    stored.chapter_id = null;
                                    sessionStorage.setItem('iyna_user', JSON.stringify(stored));
                                } catch (demoteErr) {
                                    console.error('Error demoting user after chapter check failure:', demoteErr);
                                }
                            }
                        } else {
                            console.log('User has exempt chapter_id (-1), skipping chapter existence check');
                        }
                        
                        console.log('Chapter Director access granted, loading dashboard...');
                    } else {
                        console.log(`Access denied. Chapter Director privileges required. Current role: ${user.role}`);
                        
                        // Redirect to appropriate dashboard based on role
                        if (user.role === 'chapter_lead') {
                            window.location.href = 'chapter_lead_dash.html';
                        } else if (user.role === 'admin') {
                            window.location.href = 'chapter_team_dash.html';
                        } else if (user.role === 'member') {
                            window.location.href = 'personal_dash.html';
                        } else {
                            // For any other role, redirect to login
                            redirectToLogin('Invalid role for this dashboard');
                        }
                        return;
                    }

                    // Store current user
                    currentUser = { user: user };
                    
                    // Initialize dashboard UI
                    await initializeDashboardUI();
                    setupEventHandlers();
                    await loadDashboardData();
                    
                    // Hide loading and show dashboard
                    document.getElementById('loadingContainer').style.display = 'none';
                    document.getElementById('dashboardContainer').classList.add('loaded');
                    
                } catch (error) {
                    console.error('Error during authentication:', error);
                    showError('Authentication failed: ' + error.message);
                }
            }

            function redirectToLogin(reason) {
                console.log('Redirecting to login:', reason);
                // Clear session storage
                sessionStorage.removeItem('iyna_user');
                window.location.href = 'login.html';
            }

            function showError(message) {
                document.getElementById('loadingContainer').innerHTML = `
                    <div class="error-container">
                        <h3>Authentication Error</h3>
                        <p>${message}</p>
                        <button onclick="window.location.href='login.html'" class="retry-btn">Return to Login</button>
                        <button onclick="location.reload()" class="retry-btn">Try Again</button>
                    </div>
                `;
            }

            async function initializeDashboardUI() {
                const user = currentUser.user;
                
                // Set user info
                document.getElementById('userName').textContent = user.first_name || 'User';
                
                // Set initial chapter info
                if (user.chapter_id) {
                    document.getElementById('chapterInfo').textContent = 'Loading chapter information...';
                                    } else {
                    document.getElementById('chapterInfo').textContent = 'No Chapter Assigned';
                }
            }

            function setupEventHandlers() {
                // Navigation tabs
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', function(e) {
                        e.preventDefault();
                        const tabName = this.getAttribute('data-tab');
                        switchTab(tabName);
                    });
                });

                // Announcement search functionality
                const announcementSearch = document.getElementById('announcementSearch');
                if (announcementSearch) {
                    announcementSearch.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase();
                        document.querySelectorAll('.announcement-card').forEach(function(card) {
                            const announcementText = card.querySelector('.announcement-text').textContent.toLowerCase();
                            const matches = announcementText.includes(searchTerm);
                            card.style.display = matches ? 'block' : 'none';
                        });
                    });
                }

                // Member roster search functionality (for new chapter dashboard)
                const memberSearch = document.getElementById('memberSearch');
                if (memberSearch) {
                    memberSearch.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase();
                        const tableRows = document.querySelectorAll('#memberTableBody tr');
                        tableRows.forEach(function(row) {
                            const rowText = row.textContent.toLowerCase();
                            const matches = rowText.includes(searchTerm);
                            row.style.display = matches ? 'table-row' : 'none';
                        });
                    });
                }

                // Close modals when clicking overlay
                const pointRequestModal = document.getElementById('pointRequestModal');
                if (pointRequestModal) {
                    pointRequestModal.addEventListener('click', function(e) {
                    if (e.target === this) closePointRequestModal();
                });
                }

                const joinChapterModal = document.getElementById('joinChapterModal');
                if (joinChapterModal) {
                    joinChapterModal.addEventListener('click', function(e) {
                    if (e.target === this) closeJoinChapterModal();
                });
                }

                const startChapterModal = document.getElementById('startChapterModal');
                if (startChapterModal) {
                    startChapterModal.addEventListener('click', function(e) {
                    if (e.target === this) closeStartChapterModal();
                });
                }

                // Close modals when clicking overlay
                const eventDetailsModal = document.getElementById('eventDetailsModal');
                if (eventDetailsModal) {
                    eventDetailsModal.addEventListener('click', function(e) {
                        if (e.target === this) closeEventDetailsModal();
                    });
                }

                // Escape key to close modals
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        closePointRequestModal();
                        closeJoinChapterModal();
                        closeStartChapterModal();
                        closeEventDetailsModal();
                    }
                });

                // Personal task search
                const personalTaskSearch = document.getElementById('personalTaskSearch');
                if (personalTaskSearch) {
                    personalTaskSearch.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase();
                        const taskCards = document.querySelectorAll('.task-card-personal');
                        taskCards.forEach(card => {
                            const text = card.textContent.toLowerCase();
                            card.style.display = text.includes(searchTerm) ? 'block' : 'none';
                        });
                    });
                }

                // Event filter tabs
                document.querySelectorAll('.event-filter-tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        // Remove active class from all tabs
                        document.querySelectorAll('.event-filter-tab').forEach(t => t.classList.remove('active'));
                        // Add active class to clicked tab
                        this.classList.add('active');
                        
                        const filter = this.getAttribute('data-filter');
                        filterEvents(filter);
                    });
                });

                // Task filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (this.classList.contains('clear-filters')) {
                            // Clear all filters
                            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                            filterTasks('all');
                            } else {
                            // Toggle active state
                            this.classList.toggle('active');
                            const filter = this.getAttribute('data-filter');
                            filterTasks(filter);
                        }
                    });
                });

                // Task card click handlers
                document.addEventListener('click', function(e) {
                    if (e.target.closest('.task-card-personal')) {
                        const card = e.target.closest('.task-card-personal');
                        card.classList.toggle('expanded');
                        
                        const description = card.querySelector('.task-description-personal');
                        const rewardBreakdown = card.querySelector('.reward-breakdown');
                        const actions = card.querySelector('.task-actions');
                        
                        if (description) description.classList.toggle('expanded');
                        if (rewardBreakdown) rewardBreakdown.classList.toggle('expanded');
                        if (actions) actions.classList.toggle('expanded');
                    }
                });
            }

            async function loadDashboardData() {
                try {
                    console.log('Loading dashboard data from database...');
                    console.log('Database object available:', !!window.db);
                    console.log('Supabase available:', !!window.supabase);
                    
                    // Load all data from database using your db functions with detailed logging
                    console.log('Calling db.getEvents()...');
                    const events = await db.getEvents();
                    console.log('Events loaded from database:', events);
                    
                    console.log('Calling db.getTasks()...');
                    const tasks = await db.getTasks();
                    console.log('Tasks loaded from database:', tasks);
                    
                    console.log('Calling db.getChapters()...');
                    const chapters = await db.getChapters();
                    console.log('Chapters loaded from database:', chapters);
                    
                    console.log('Calling db.getAnnouncements()...');
                    const announcements = await db.getAnnouncements();
                    console.log('Announcements loaded from database:', announcements);
                    
                    // Calculate real chapter rankings with points from database
                    console.log('Calculating chapter rankings...');
                    const chapterRankings = await calculateRealChapterRankings(chapters);
                    allChaptersData = chapterRankings;
                    filteredChaptersData = [...chapterRankings];
                    
                    // Get current user's chapter info from database
                    let userChapter = null;
                    if (currentUser.user.chapter_id) {
                        userChapter = chapters.find(c => c.id === currentUser.user.chapter_id);
                        console.log('User chapter found:', userChapter);
                    }

                    // Get user's personal points from database
                    console.log('Getting user points for user ID:', currentUser.user.id);
                    const userPoints = await getUserPoints(currentUser.user.id);
                    console.log('User points calculated:', userPoints);
                    
                    // Process the data
                    dashboardData = {
                        user: {
                            name: currentUser.user.first_name || 'Student',
                            hasChapter: !!currentUser.user.chapter_id,
                            chapter: userChapter ? {
                                id: userChapter.chapter_code,
                                name: userChapter.name,
                                school: userChapter.school_name,
                            } : null,
                            points: userPoints
                        },
                        events: events || [],
                        tasks: tasks || [],
                        chapters: chapters || [],
                        chapterRankings: chapterRankings,
                        announcements: announcements || []
                    };
                    
                    console.log('Final dashboard data:', dashboardData);
                    renderDashboard();
                    
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    console.error('Error details:', error.message);
                    
                    // Fallback to basic structure
                    dashboardData = {
                        user: {
                            name: currentUser.user.first_name || 'Student',
                            hasChapter: false,
                            chapter: null,
                            points: 0
                        },
                        events: [],
                        tasks: [],
                        chapters: [],
                        chapterRankings: [],
                        announcements: []
                    };
                    
                    renderDashboard();
                }
            }

            async function getUserPoints(userId) {
                try {
                    const { data, error } = await supabase
                        .from('user_task_completions')
                        .select('points_awarded')
                        .eq('user_id', userId)
                        .in('status', ['completed', 'approved']);
                    
                    if (error) throw error;
                    
                    return data.reduce((total, completion) => total + (completion.points_awarded || 0), 0);
                } catch (error) {
                    console.error('Error getting user points:', error);
                    return 0;
                }
            }

            async function calculateRealChapterRankings(chapters) {
                try {
                    console.log('Calculating real chapter rankings...');
                    
                    // Get all users and their chapter memberships
                    const allUsers = await db.getAllUsers();
                    
                    // Get all completed task points
                    const { data: completions, error: completionsError } = await supabase
                        .from('user_task_completions')
                        .select('user_id, points_awarded')
                        .in('status', ['completed', 'approved']);
                    
                    if (completionsError) throw completionsError;
                    
                    // Calculate points for each chapter
                    const chapterStats = chapters.map(chapter => {
                        // Find all users in this chapter
                        const chapterUsers = allUsers.filter(u => u.chapter_id === chapter.id);

                    // Calculate total points for this chapter
                        const totalPoints = chapterUsers.reduce((chapterTotal, user) => {
                            const userCompletions = completions.filter(c => c.user_id === user.id);
                            const userPoints = userCompletions.reduce((userTotal, completion) => 
                                userTotal + (completion.points_awarded || 0), 0);
                            return chapterTotal + userPoints;
                        }, 0);
                        
                        // Get director name from lead_user_id
                        const director = chapter.lead_user_id ? 
                            allUsers.find(u => u.id === chapter.lead_user_id) : null;
                        const directorName = director ? 
                            `${director.first_name} ${director.last_name}` : 'No Director';

                    return {
                            id: chapter.id,
                            name: chapter.name,
                            school_name: chapter.school_name,
                            chapter_code: chapter.chapter_code,
                            points: totalPoints,
                            memberCount: chapterUsers.length,
                            director: directorName
                        };
                    });
                    
                    // Sort by points descending and add rank
                    chapterStats.sort((a, b) => b.points - a.points);
                    chapterStats.forEach((chapter, index) => {
                        chapter.rank = index + 1;
                    });
                    
                    console.log('Chapter rankings calculated:', chapterStats);
                    return chapterStats;
                } catch (error) {
                    console.error('Error calculating chapter rankings:', error);
                    return [];
                }
            }

            function renderDashboard() {
                // Update user info
                const userSubtitleElement = document.getElementById('userSubtitle');
                if (userSubtitleElement) {
                if (dashboardData.user.hasChapter) {
                        const stored = JSON.parse(sessionStorage.getItem('iyna_user')) || {};
                        const roleTitle = (stored.role === 'chapter_director') ? 'Chapter Director' : (stored.role === 'chapter_lead') ? 'Co-Director' : 'Chapter Member';
                        userSubtitleElement.innerHTML = `${roleTitle} ‚Ä¢ ${dashboardData.user.chapter.school} ${dashboardData.user.chapter.id}`;
                } else {
                        userSubtitleElement.innerHTML = 'Chapter Director ‚Ä¢ No Chapter Assigned';
                    }
                }
                
                // Update user's total points
                const totalPointsElement = document.getElementById('totalPoints');
                if (totalPointsElement) {
                    totalPointsElement.textContent = `${dashboardData.user.points} pts`;
                }
                
                // Update personal dashboard points
                const personalTotalPointsElement = document.getElementById('personalTotalPoints');
                if (personalTotalPointsElement) {
                    personalTotalPointsElement.textContent = dashboardData.user.points;
                }
                
                // Render different sections
                renderEvents();
                renderPersonalTasks();
                renderAnnouncements();
                
                // Load chapter dashboard data
                loadChapterDashboard();
            }

            function renderEvents() {
                const events = dashboardData.events;
                const container = document.getElementById('eventsGrid');
                
                if (!container) {
                    console.warn('eventsGrid element not found');
                    return;
                }
                
                console.log('Rendering events:', events);
                
                if (!events || events.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No events available</h3>
                            <p>No events found in the database. Check the console for database connection details.</p>
                        </div>
                    `;
                    return;
                }
                
                // Separate upcoming and past events
                const currentDate = new Date();
                const upcomingEvents = [];
                const pastEvents = [];
                
                events.forEach(event => {
                    let eventDate = 'No date';
                    let eventTime = '';
                    let eventTimezone = '';
                    let isPast = false;
                    let eventDateObj = null;
                    
                    if (event.event_date) {
                        try {
                            eventDateObj = new Date(event.event_date);
                            
                            // Format date
                            eventDate = eventDateObj.toLocaleDateString();
                            
                            // Format time
                            eventTime = eventDateObj.toLocaleTimeString([], { 
                                hour: '2-digit', 
                                minute: '2-digit',
                                hour12: true 
                            });
                            
                            // Get timezone
                            eventTimezone = eventDateObj.toLocaleDateString([], { 
                                timeZoneName: 'short' 
                            }).split(', ').pop() || Intl.DateTimeFormat().resolvedOptions().timeZone;
                            
                            isPast = eventDateObj < currentDate;
                        } catch (e) {
                            eventDate = event.event_date;
                        }
                    }
                    
                    const eventWithDate = {
                        ...event,
                        eventDate,
                        eventTime,
                        eventTimezone,
                        isPast,
                        eventDateObj
                    };
                    
                    if (isPast) {
                        pastEvents.push(eventWithDate);
                    } else {
                        upcomingEvents.push(eventWithDate);
                    }
                });
                
                // Sort upcoming events by date (nearest first)
                upcomingEvents.sort((a, b) => {
                    if (!a.eventDateObj || !b.eventDateObj) return 0;
                    return a.eventDateObj - b.eventDateObj;
                });
                
                // Sort past events by date (most recent first)
                pastEvents.sort((a, b) => {
                    if (!a.eventDateObj || !b.eventDateObj) return 0;
                    return b.eventDateObj - a.eventDateObj;
                });
                
                // Render all events, but we'll control visibility through filters
                let eventsHtml = '<div class="events-grid">';
                
                // First, add upcoming events
                upcomingEvents.forEach(event => {
                    eventsHtml += `
                        <div class="event-card" data-type="upcoming">
                            <h3 class="event-title">${event.title || 'Untitled Event'}</h3>
                            <p class="event-subtitle">${event.description || 'No description available'}</p>
                            
                            <div class="event-footer">
                                <div class="event-date-time">
                                    <div class="event-date">${event.eventDate}</div>
                                    ${event.eventTime ? `<div class="event-time">${event.eventTime} ${event.eventTimezone}</div>` : ''}
                                </div>
                                <button class="event-button" onclick="showEventDetails(${JSON.stringify(event).replace(/"/g, '&quot;')})">View Details</button>
                            </div>
                        </div>
                    `;
                });
                
                // Then, add past events
                pastEvents.forEach(event => {
                    eventsHtml += `
                        <div class="event-card past" data-type="past">
                            <h3 class="event-title">${event.title || 'Untitled Event'}</h3>
                            <p class="event-subtitle">${event.description || 'No description available'}</p>
                            
                            <div class="event-footer">
                                <div class="event-date-time">
                                    <div class="event-date">${event.eventDate}</div>
                                    ${event.eventTime ? `<div class="event-time">${event.eventTime} ${event.eventTimezone}</div>` : ''}
                                </div>
                                <button class="event-button" onclick="showEventDetails(${JSON.stringify(event).replace(/"/g, '&quot;')})">View Details</button>
                            </div>
                        </div>
                    `;
                });
                eventsHtml += '</div>';
                
                container.innerHTML = eventsHtml;
                
                // Apply initial filter to show only first 3 upcoming events (or fill with past if needed)
                applyInitialEventFilter(upcomingEvents.length, pastEvents.length);
                
                console.log('Events rendered successfully');
            }

            function applyInitialEventFilter(upcomingCount, pastCount) {
                // Show first 3 upcoming events, or fill remaining slots with past events
                const upcomingCards = document.querySelectorAll('.event-card[data-type="upcoming"]');
                const pastCards = document.querySelectorAll('.event-card[data-type="past"]');
                
                // Hide all events initially
                upcomingCards.forEach(card => card.style.display = 'none');
                pastCards.forEach(card => card.style.display = 'none');
                
                // Show first 3 upcoming events
                const upcomingToShow = Math.min(3, upcomingCount);
                for (let i = 0; i < upcomingToShow; i++) {
                    if (upcomingCards[i]) {
                        upcomingCards[i].style.display = 'block';
                    }
                }
                
                // If less than 3 upcoming events, fill remaining slots with past events
                if (upcomingToShow < 3) {
                    const remainingSlots = 3 - upcomingToShow;
                    const pastToShow = Math.min(remainingSlots, pastCount);
                    for (let i = 0; i < pastToShow; i++) {
                        if (pastCards[i]) {
                            pastCards[i].style.display = 'block';
                        }
                    }
                }
            }

            function renderPersonalTasks() {
                const tasks = dashboardData.tasks;
                const container = document.getElementById('personalTasksGrid');
                
                if (!container) {
                    console.warn('personalTasksGrid element not found');
                    return;
                }

                console.log('Rendering personal tasks:', tasks);
                
                if (!tasks || tasks.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No tasks available</h3>
                            <p>No tasks found in the database. Check the console for database connection details.</p>
                        </div>
                    `;
                    return;
                }

                let tasksHtml = '<div class="tasks-list">';
                tasks.forEach(task => {
                    // Handle different date formats
                    let deadline = 'No deadline';
                    if (task.deadline) {
                        try {
                            deadline = new Date(task.deadline).toLocaleDateString();
                        } catch (e) {
                            deadline = task.deadline;
                        }
                    }
                    
                    tasksHtml += `
                        <div class="task-card">
                            <h3 class="task-title">${task.title || 'Untitled Task'}</h3>
                                    <div class="task-meta">
                                <span class="task-points">${task.points || 0} points</span>
                                <span class="task-deadline">Deadline: ${deadline}</span>
                                <span class="task-code">Code: ${task.task_code || 'N/A'}</span>
                                    </div>
                            <p class="task-description">${task.description || 'No description available'}</p>
                            <div class="task-footer">
                                <button class="request-points-btn" onclick="requestPoints(${task.id})">Request Points</button>
                                </div>
                        </div>
                    `;
                });
                tasksHtml += '</div>';
                
                container.innerHTML = tasksHtml;
                console.log('Tasks rendered successfully');
            }



            function renderAnnouncements() {
                const announcements = dashboardData.announcements;
                
                // Update main announcement banner
                const mainBanner = document.getElementById('mainAnnouncementBanner');
                console.log('Checking announcements for banner:', announcements);
                
                // Find the main announcement (priority = 1) or fall back to first active one
                const mainAnnouncement = announcements.find(a => (a.priority === 1 || a.priority === '1') && a.is_active) || 
                                        announcements.find(a => a.is_active);
                
                if (mainAnnouncement) {
                    console.log('Main announcement found:', mainAnnouncement);
                    console.log('Is active?', mainAnnouncement.is_active);
                    console.log('Priority:', mainAnnouncement.priority);
                    
                    if (mainAnnouncement.is_active) {
                        // Just use the full message content, no title
                        const content = mainAnnouncement.message;
                        
                        // Always hide the title element
                        const titleElement = document.getElementById('bannerAnnouncementTitle');
                        titleElement.style.display = 'none';
                        
                        // Show the full message in the message area
                        document.getElementById('bannerAnnouncementMessage').textContent = content;
                        
                        // Always show the banner when there's an active announcement
                        console.log('Showing announcement banner');
                        mainBanner.style.display = 'block';
                    } else {
                        console.log('Main announcement is not active, hiding banner');
                        mainBanner.style.display = 'none';
                    }
                } else {
                    console.log('No announcements found, hiding banner');
                    mainBanner.style.display = 'none';
                }
                
                // TEMPORARY: Force show banner for testing (remove this later)
                if (mainBanner && announcements.length === 0) {
                    console.log('TESTING: Force showing banner with sample content');
                    document.getElementById('bannerAnnouncementTitle').textContent = 'Test Announcement';
                    document.getElementById('bannerAnnouncementMessage').textContent = 'This is a test announcement to verify the banner is working correctly.';
                    mainBanner.style.display = 'block';
                }
                
                // Update notification banners
                const notificationTextElement = document.getElementById('notificationText');
                const chapterNotificationTextElement = document.getElementById('chapterNotificationText');
                
                if (announcements.length > 0) {
                    const latestAnnouncement = announcements[0];
                    if (notificationTextElement) notificationTextElement.textContent = latestAnnouncement.message;
                    if (chapterNotificationTextElement) chapterNotificationTextElement.textContent = latestAnnouncement.message;
                } else {
                    if (notificationTextElement) notificationTextElement.textContent = 'No announcements at this time.';
                    if (chapterNotificationTextElement) chapterNotificationTextElement.textContent = 'No announcements at this time.';
                }

                // Update announcements tab
                const container = document.getElementById('announcementsList');
                
                if (!container) {
                    console.warn('announcementsList element not found');
                    return;
                }
                
                if (announcements.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No announcements</h3>
                            <p>No active announcements found in the database.</p>
                        </div>
                    `;
                    return;
                }
                
                let announcementsHtml = '';
                announcements.forEach(announcement => {
                    const createdDate = new Date(announcement.created_at);
                    
                    // Extract title and content from the message
                    let title = 'Announcement';
                    let content = announcement.message;
                    
                    // Try to extract a title if the message starts with one
                    if (announcement.message.includes('!')) {
                        const firstExclamation = announcement.message.indexOf('!');
                        title = announcement.message.substring(0, firstExclamation + 1);
                        content = announcement.message.substring(firstExclamation + 1).trim();
                    }
                    
                    // Convert URLs to clickable links
                    const urlRegex = /(https?:\/\/[^\s]+)/g;
                    const contentWithLinks = content.replace(urlRegex, '<a href="$1" class="announcement-link" target="_blank">$1</a>');
                    
                    announcementsHtml += `
                        <div class="announcement-card">
                            <h3 class="announcement-header">${title}</h3>
                            <hr class="announcement-separator">
                            <div class="announcement-text">
                                ${contentWithLinks}
                                </div>
                            <div class="announcement-actions">
                                <span class="announcement-status">Active ‚Ä¢ Posted on ${createdDate.toLocaleDateString()}</span>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = announcementsHtml;
            }

            // Chapter Dashboard Functions
            async function loadChapterDashboard() {
                try {
                    console.log('Loading chapter dashboard data...');
                    
                    if (!currentUser.user.chapter_id) {
                        renderChapterDirectors([]);
                        renderChapterStats({ rank: 0, totalChapters: 0, points: 0 });
                        renderMemberRoster([]);
                        renderGlobalRankings([]);
                    return;
                }

                    // Load chapter bio
                    await loadDirectorChapterBio();

                    // Load chapter directors
                    await loadChapterDirectors();
                    
                    // Load chapter stats
                    await loadChapterStats();
                    
                    // Load member roster
                    await loadMemberRoster();
                    
                    // Load join requests (for chapter directors)
                    await loadJoinRequests();
                    
                    // Load global rankings
                    await loadGlobalRankings();

                    // Periodically refresh member roster to reflect DB changes
                    if (!window.__rosterRefreshInterval) {
                        window.__rosterRefreshInterval = setInterval(() => {
                            if (document.visibilityState === 'visible') {
                                loadMemberRoster();
                            }
                        }, 10000);
                    }

                    // Refresh roster when page/tab becomes visible
                    if (!window.__rosterVisibilityHandlerAttached) {
                        document.addEventListener('visibilitychange', () => {
                            if (!document.hidden) loadMemberRoster();
                        });
                        window.__rosterVisibilityHandlerAttached = true;
                    }
                    
                } catch (error) {
                    console.error('Error loading chapter dashboard:', error);
                    renderChapterDirectors([]);
                    renderChapterStats({ rank: 0, totalChapters: 0, points: 0 });
                    renderMemberRoster([]);
                    renderGlobalRankings([]);
                }
            }

            async function loadChapterDirectors() {
                try {
                    if (!currentUser.user.chapter_id) {
                        renderChapterDirectors([]);
                        return;
                    }

                    // Get chapter info
                    const { data: chapter, error: chapterError } = await supabase
                        .from('chapters')
                        .select('*')
                        .eq('id', currentUser.user.chapter_id)
                        .single();
                    
                    if (chapterError) throw chapterError;

                    // Get director info
                    const { data: director, error: directorError } = await supabase
                        .from('users')
                        .select('first_name, last_name')
                        .eq('id', chapter.director_id)
                        .single();
                    
                    if (directorError) throw directorError;

                    const directorCard = `
                        <div class="director-card">
                            <div class="director-icon">
                                ${director.first_name ? director.first_name.charAt(0) : 'D'}
                                    </div>
                            <div class="director-info">
                                <div class="director-name">${director.first_name} ${director.last_name}</div>
                            </div>
                        </div>
                    `;
                    
                    renderChapterDirectors([directorCard]);
                } catch (error) {
                    console.error('Error loading chapter directors:', error);
                    renderChapterDirectors([]);
                }
            }

            function renderChapterDirectors(directors) {
                const container = document.getElementById('directorsList');
                if (!container) {
                    console.warn('directorsList element not found');
                    return;
                }
                
                if (directors.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No chapter directors found</p></div>';
                } else {
                    container.innerHTML = directors.join('');
                }
            }

            async function loadChapterStats() {
                try {
                    if (!currentUser.user.chapter_id) {
                        renderChapterStats({ rank: 0, totalChapters: 0, points: 0 });
                        return;
                    }

                    // Get all chapters for ranking
                    const { data: allChapters, error: chaptersError } = await supabase
                        .from('chapters')
                        .select('id, points')
                        .order('points', { ascending: false });
                    
                    if (chaptersError) throw chaptersError;

                    // Calculate chapter rank
                    const chapterRank = allChapters.findIndex(chapter => chapter.id === currentUser.user.chapter_id) + 1;
                    const totalChapters = allChapters.length;

                    // Get chapter points
                    const currentChapter = allChapters.find(chapter => chapter.id === currentUser.user.chapter_id);
                    const chapterPoints = currentChapter ? currentChapter.points || 0 : 0;

                    renderChapterStats({
                        rank: chapterRank,
                        totalChapters: totalChapters,
                        points: chapterPoints
                    });
                } catch (error) {
                    console.error('Error loading chapter stats:', error);
                    renderChapterStats({ rank: 0, totalChapters: 0, points: 0 });
                }
            }

            function renderChapterStats(stats) {
                const rankElement = document.getElementById('chapterRank');
                const totalElement = document.getElementById('totalChapters');
                const pointsElement = document.getElementById('chapterPoints');
                
                if (rankElement) rankElement.textContent = stats.rank;
                if (totalElement) totalElement.textContent = stats.totalChapters;
                if (pointsElement) pointsElement.textContent = stats.points;
            }

            async function loadMemberRoster() {
                try {
                    if (!currentUser.user.chapter_id) {
                        renderMemberRoster([]);
                    return;
                }
                
                    // Get all users with this chapter_id
                    const { data: allUsers, error } = await supabase
                        .from('users')
                        .select(`
                            id,
                            first_name,
                            last_name,
                            role,
                            chapter_id,
                            discord_username
                        `)
                        .eq('chapter_id', currentUser.user.chapter_id)
                        .eq('is_active', true)
                        .order('first_name', { ascending: true });
                    
                    if (error) throw error;

                    // Roster = all active users with this chapter_id
                    const approvedMembers = allUsers;

                    // Get chapter info for school name
                    const { data: chapter, error: chapterError } = await supabase
                        .from('chapters')
                        .select('school_name')
                        .eq('id', currentUser.user.chapter_id)
                        .single();
                    
                    if (chapterError) throw chapterError;

                    // Get points for each approved member
                    const membersWithPoints = await Promise.all(
                        approvedMembers.map(async (member) => {
                            const { data: completions, error: pointsError } = await supabase
                                .from('user_task_completions')
                                .select('points_awarded')
                                .eq('user_id', member.id)
                                .in('status', ['completed', 'approved']);
                            
                            const totalPoints = pointsError ? 0 : 
                                completions.reduce((sum, comp) => sum + (comp.points_awarded || 0), 0);
                            
                            return {
                                ...member,
                                points: totalPoints,
                                school: chapter.school_name
                            };
                        })
                    );

                    renderMemberRoster(membersWithPoints);
                } catch (error) {
                    console.error('Error loading member roster:', error);
                    renderMemberRoster([]);
                }
            }

            // Load join requests for chapter directors
            async function loadJoinRequests() {
                try {
                    // Only show join requests section if user is a chapter director
                    const joinRequestsSection = document.getElementById('joinRequestsSection');
                    if (!joinRequestsSection) return;

                    if ((currentUser.user.role !== 'chapter_director' && currentUser.user.role !== 'chapter_lead') || !currentUser.user.chapter_id) {
                        joinRequestsSection.style.display = 'none';
                        return;
                    }

                    // Show the section for chapter directors
                    joinRequestsSection.style.display = 'block';

                    // Get pending join requests for this chapter
                    const { data: requests, error } = await supabase
                        .from('chapter_join_request')
                        .select(`
                            id,
                            user_id,
                            user_name,
                            user_email,
                            user_school,
                            user_grade_level,
                            join_reason,
                            status,
                            requested_at
                        `)
                        .eq('chapter_id', currentUser.user.chapter_id)
                        .eq('status', 'pending')
                        .order('requested_at', { ascending: false });
                    
                    if (error) throw error;

                    renderJoinRequests(requests);
                } catch (error) {
                    console.error('Error loading join requests:', error);
                    renderJoinRequests([]);
                }
            }

            function renderJoinRequests(requests) {
                const tbody = document.getElementById('requestsTableBody');
                const requestCount = document.getElementById('requestCount');
                
                if (!tbody) {
                    console.warn('requestsTableBody element not found');
                    return;
                }
                
                // Update request count
                if (requestCount) {
                    requestCount.textContent = `(${requests.length} requests)`;
                }
                
                if (requests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="loading-text">No pending join requests</td></tr>';
                    return;
                }
                
                let tableHTML = '';
                requests.forEach(request => {
                    const requestedDate = new Date(request.requested_at).toLocaleDateString();
                    
                    tableHTML += `
                        <tr>
                            <td>${request.user_name}</td>
                            <td>${request.user_school}</td>
                            <td>${requestedDate}</td>
                            <td class="request-actions">
                                <button class="view-reason-btn" onclick="viewJoinReason(${request.id}, '${request.user_name}', '${request.join_reason.replace(/'/g, "\\'")}')">
                                    View Reason
                                </button>
                                <button class="approve-btn" onclick="approveJoinRequest(${request.id}, ${request.user_id})">
                                    Approve
                                </button>
                                <button class="deny-btn" onclick="denyJoinRequest(${request.id}, ${request.user_id})">
                                    Deny
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = tableHTML;
            }

            // View join reason modal
            function viewJoinReason(requestId, userName, reason) {
                const modalHTML = `
                    <div class="modal-overlay" id="reasonModal" style="display: flex;">
                        <div class="modal-content" style="max-width: 500px; background: white; border-radius: 16px; padding: 0; overflow: hidden; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);">
                            <div style="background: #1B4965; padding: 2rem 2rem 1.5rem 2rem; color: white;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h3 style="margin: 0; font-size: 1.8rem; font-weight: 700; color: white;">Join Request Reason</h3>
                                    <button onclick="closeReasonModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: white; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</button>
                                </div>
                                <p style="margin: 0; font-size: 1rem; opacity: 0.9; font-weight: 400;">Request from ${userName}</p>
                            </div>
                            <div style="padding: 2rem;">
                                <div style="background: #f8f9fa; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                                    <h4 style="margin: 0 0 1rem 0; color: #1B4965; font-size: 1.1rem;">Reason for Joining</h4>
                                    <p style="margin: 0; color: #495057; line-height: 1.6; white-space: pre-wrap;">${reason}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            function closeReasonModal() {
                const modal = document.getElementById('reasonModal');
                if (modal) {
                    modal.remove();
                }
            }

            // Approve join request
            async function approveJoinRequest(requestId, userId) {
                if (!confirm('Are you sure you want to approve this join request?')) {
                    return;
                }

                try {
                    // Get the join request details to find the chapter_id
                    const { data: joinRequest, error: requestDataError } = await supabase
                        .from('chapter_join_request')
                        .select('chapter_id')
                        .eq('id', requestId)
                        .single();
                    
                    if (requestDataError) throw requestDataError;

                    // Update the join request status
                    const { error: requestError } = await supabase
                        .from('chapter_join_request')
                        .update({
                            status: 'approved',
                            processed_at: new Date().toISOString(),
                            processed_by: currentUser.user.id
                        })
                        .eq('id', requestId);

                    if (requestError) throw requestError;

                    // Update the user's chapter_id to officially add them to the chapter
                    const { error: userError } = await supabase
                        .from('users')
                        .update({ chapter_id: joinRequest.chapter_id })
                        .eq('id', userId);

                    if (userError) throw userError;

                    console.log('User chapter_id updated successfully:', userId, '->', joinRequest.chapter_id);

                    // Verify the update was successful
                    const { data: verifyUser, error: verifyError } = await supabase
                        .from('users')
                        .select('chapter_id')
                        .eq('id', userId)
                        .single();
                    
                    if (verifyError) {
                        console.error('Error verifying user update:', verifyError);
                    } else {
                        console.log('User verification successful:', verifyUser);
                    }

                    alert('Join request approved successfully! User has been added to the chapter.');
                    loadJoinRequests(); // Refresh the list
                    loadMemberRoster(); // Refresh the member roster
                } catch (error) {
                    console.error('Error approving join request:', error);
                    alert('Error approving join request. Please try again.');
                }
            }

            // Deny join request
            async function denyJoinRequest(requestId, userId) {
                const reason = prompt('Please provide a reason for denying this request (optional):');
                
                try {
                    // Update the join request status
                    const requestUpdate = await supabase
                        .from('chapter_join_request')
                        .update({
                            status: 'rejected',
                            processed_at: new Date().toISOString(),
                            processed_by: currentUser.user.id,
                            admin_notes: reason || null
                        })
                        .eq('id', requestId);

                    if (requestUpdate.error) throw requestUpdate.error;

                    // Check if user is currently in the chapter and remove them if so
                    const { data: user, error: userCheckError } = await supabase
                        .from('users')
                        .select('chapter_id')
                        .eq('id', userId)
                        .single();
                    
                    if (userCheckError) throw userCheckError;

                    // If user is in the chapter, remove them
                    if (user.chapter_id) {
                        const { error: userError } = await supabase
                            .from('users')
                            .update({ chapter_id: null })
                            .eq('id', userId);

                        if (userError) throw userError;
                    }

                    alert('Join request denied successfully!');
                    loadJoinRequests(); // Refresh the list
                    loadMemberRoster(); // Refresh the member roster
                } catch (error) {
                    console.error('Error denying join request:', error);
                    alert('Error denying join request. Please try again.');
                }
            }

            function renderMemberRoster(members) {
                const tbody = document.getElementById('memberTableBody');
                const memberCount = document.getElementById('memberCount');
                
                if (!tbody) {
                    console.warn('memberTableBody element not found');
                    return;
                }
                
                // Update member count
                if (memberCount) {
                memberCount.textContent = `(${members.length} members)`;
                }
                
                if (members.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="loading-text">No members found</td></tr>';
                    return;
                }
                
                let tableHTML = '';
                members.forEach(member => {
                    const fullName = `${member.first_name} ${member.last_name}`;
                    const role = member.role === 'chapter_director' ? 'Director' : 
                                member.role === 'chapter_lead' ? 'Co-Director' : 'Member';
                    
                    // Only show remove button for regular members, not directors
                    const actionButtons = (member.role === 'member') ? 
                        `<button class="btn btn-danger btn-sm" onclick="removeMemberFromChapter(${member.id}, '${fullName}')">
                            Remove
                        </button>` : 
                        '<span class="text-muted">-</span>';
                    
                    tableHTML += `
                        <tr>
                            <td>${fullName}</td>
                            <td>${role}</td>
                            <td>${member.points}</td>
                            <td>${member.school}</td>
                            <td>${member.discord_username || '-'}</td>
                            <td>${actionButtons}</td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = tableHTML;
            }

            // Remove member from chapter
            async function removeMemberFromChapter(userId, userName) {
                if (!confirm(`Are you sure you want to remove ${userName} from the chapter? This action cannot be undone.`)) {
                    return;
                }

                try {
                    // Update the join request status to rejected
                    const { error: requestError } = await supabase
                        .from('chapter_join_request')
                        .update({
                            status: 'rejected',
                            processed_at: new Date().toISOString(),
                            processed_by: currentUser.user.id,
                            admin_notes: 'Removed by chapter director'
                        })
                        .eq('user_id', userId)
                        .eq('chapter_id', currentUser.user.chapter_id);

                    if (requestError) throw requestError;

                    // Remove the user from the chapter
                    const { error: userError } = await supabase
                        .from('users')
                        .update({ chapter_id: null })
                        .eq('id', userId);

                    if (userError) throw userError;

                    alert(`${userName} has been removed from the chapter successfully.`);
                    
                    // Refresh the member roster
                    loadMemberRoster();
                    
                } catch (error) {
                    console.error('Error removing member from chapter:', error);
                    alert('Error removing member from chapter. Please try again.');
                }
            }

            async function loadGlobalRankings() {
                try {
                    // Get all chapters ordered by points for ranking
                    const { data: allChapters, error: chaptersError } = await supabase
                        .from('chapters')
                        .select(`
                            id,
                            chapter_code,
                            school_name,
                            points,
                            director_id
                        `)
                        .order('points', { ascending: false })
                        .limit(10);
                    
                    if (chaptersError) throw chaptersError;

                    // Get chapter of the season (top ranked chapter)
                    const chapterOfSeason = allChapters[0];
                    if (chapterOfSeason) {
                        // Get director info for chapter of the season
                        const { data: director, error: directorError } = await supabase
                            .from('users')
                            .select('first_name, last_name')
                            .eq('id', chapterOfSeason.director_id)
                            .single();
                        
                        const directorName = director ? `${director.first_name} ${director.last_name}` : 'Unknown';
                        
                        const seasonNameElement = document.getElementById('seasonChapterName');
                        const seasonCodeElement = document.getElementById('seasonChapterCode');
                        const seasonLeaderElement = document.getElementById('seasonLeader');
                        
                        if (seasonNameElement) seasonNameElement.textContent = chapterOfSeason.school_name;
                        if (seasonCodeElement) seasonCodeElement.textContent = chapterOfSeason.chapter_code;
                        if (seasonLeaderElement) seasonLeaderElement.textContent = `Led by ${directorName}`;
                    }

                    // Render rankings list
                    renderGlobalRankings(allChapters);
                } catch (error) {
                    console.error('Error loading global rankings:', error);
                    renderGlobalRankings([]);
                }
            }

            function renderGlobalRankings(chapters) {
                const container = document.getElementById('rankingsList');
                
                if (!container) {
                    console.warn('rankingsList element not found');
                    return;
                }
                
                if (chapters.length === 0) {
                    container.innerHTML = '<div class="loading-text">No rankings available</div>';
                    return;
                }
                
                let rankingsHTML = '';
                chapters.forEach((chapter, index) => {
                    const rank = index + 1;
                    rankingsHTML += `
                        <div class="ranking-item">
                            <div class="ranking-number">${rank}</div>
                            <div class="ranking-chapter">${chapter.school_name || chapter.name || chapter.chapter_code}</div>
                            <div class="ranking-points">${chapter.points || 0} points</div>
                        </div>
                    `;
                });
                
                container.innerHTML = rankingsHTML;
            }

            function viewDirectory() {
                window.location.href = 'chapters.html';
            }

            function openTaskSubmissionModal() {
                // Function to handle task submission modal
                console.log('Opening point request modal for chapter');
                
                // Check if user is logged in
                if (!currentUser || !currentUser.user) {
                    alert('Please log in to request points.');
                    return;
                }
                
                // Show the point request modal
                document.getElementById('pointRequestModal').style.display = 'flex';
                
                // Clear any previous form data
                document.getElementById('evidenceTextarea').value = '';
                document.getElementById('evidenceFiles').value = '';
                document.getElementById('taskCodeInput').value = '';
                document.getElementById('taskNameInput').value = '';
                clearFileList();
                
                // Hide the task info section for chapter requests
                const taskInfoSection = document.querySelector('.task-info-section');
                if (taskInfoSection) {
                    taskInfoSection.style.display = 'none';
                }
                
                // Set up a custom task for chapter point request
                selectedTaskForPoints = {
                    id: 'chapter-request',
                    title: 'Chapter Point Request',
                    points: 0,
                    deadline: new Date().toLocaleDateString(),
                    task_code: 'CHAPTER-REQ',
                    description: 'Request points for chapter activities and achievements'
                };
                
                // Clear the points requested field
                document.getElementById('pointsRequested').value = '';
                
                // Setup drag and drop
                setupDragAndDrop();
            }

            function switchTab(tab) {
                currentTab = tab;
                
                // Update tab navigation
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
                
                // Show/hide tab content
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.getElementById(`${tab}-tab`).classList.add('active');
                
                // Update page title based on tab
                const titleSpan = document.getElementById('userName');
                const userName = titleSpan ? titleSpan.textContent : 'User';
                
                // Show/hide chapter management section based on active tab
                const chapterManagementSection = document.getElementById('chapterManagementSection');
                if (chapterManagementSection) {
                    if (tab === 'chapter') {
                        chapterManagementSection.style.display = 'block';
                    } else {
                        chapterManagementSection.style.display = 'none';
                    }
                }
                
                switch(tab) {
                    case 'personal':
                        document.getElementById('dashboardTitle').innerHTML = `Hi, <span id="userName">${userName}</span>`;
                        break;
                    case 'chapter':
                        document.getElementById('dashboardTitle').textContent = 'Chapter Dashboard';
                        break;
                    case 'announcements':
                        document.getElementById('dashboardTitle').textContent = 'Announcements';
                        break;
                }
            }

            function filterEvents(filter) {
                const eventCards = document.querySelectorAll('.event-card');
                eventCards.forEach(card => {
                    if (filter === 'all') {
                        card.style.display = 'block';
                    } else if (filter === 'upcoming') {
                        card.style.display = card.classList.contains('past') ? 'none' : 'block';
                    } else if (filter === 'past') {
                        card.style.display = card.classList.contains('past') ? 'block' : 'none';
                    }
                });
            }

            function filterTasks(filter) {
                const taskCards = document.querySelectorAll('.task-card-personal');
                taskCards.forEach(card => {
                    if (filter === 'all') {
                        card.style.display = 'block';
                    } else if (filter === 'points') {
                        // Show tasks with points between 10-200
                        const pointsElement = card.querySelector('.task-points-personal');
                        if (pointsElement) {
                            const points = parseInt(pointsElement.textContent);
                            card.style.display = (points >= 10 && points <= 200) ? 'block' : 'none';
                        }
                    } else if (filter === 'sort') {
                        // This would need to be implemented with actual sorting logic
                        console.log('Sorting tasks by points...');
                    }
                });
            }

            // Point request functions
            function requestPoints(taskId) {
                const task = dashboardData.tasks.find(t => t.id === taskId);
                if (!task) return;
                
                selectedTaskForPoints = task;
                
                // Show the task info section for regular task requests
                const taskInfoSection = document.querySelector('.task-info-section');
                if (taskInfoSection) {
                    taskInfoSection.style.display = 'block';
                }
                
                // Populate modal with task information
                document.getElementById('modalTaskTitle').textContent = task.title;
                document.getElementById('modalTaskPoints').textContent = task.points || 0;
                document.getElementById('modalTaskDeadline').textContent = new Date(task.deadline).toLocaleDateString();
                document.getElementById('modalTaskCode').textContent = task.task_code || 'N/A';
                document.getElementById('modalTaskDescription').textContent = task.description || 'No description available';
                document.getElementById('pointsRequested').value = task.points || 0;
                
                // Clear previous evidence
                document.getElementById('evidenceTextarea').value = '';
                document.getElementById('evidenceFiles').value = '';
                clearFileList();
                
                // Setup drag and drop
                setupDragAndDrop();
                
                // Show modal
                document.getElementById('pointRequestModal').style.display = 'flex';
            }

            function setupDragAndDrop() {
                const uploadContainer = document.querySelector('.file-upload-container');
                
                uploadContainer.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadContainer.style.borderColor = '#1B4965';
                    uploadContainer.style.backgroundColor = '#f8f9fa';
                });
                
                uploadContainer.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadContainer.style.borderColor = '#e9ecef';
                    uploadContainer.style.backgroundColor = 'transparent';
                });
                
                uploadContainer.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadContainer.style.borderColor = '#e9ecef';
                    uploadContainer.style.backgroundColor = 'transparent';
                    
                    const files = Array.from(e.dataTransfer.files);
                    const fileInput = document.getElementById('evidenceFiles');
                    const dt = new DataTransfer();
                    
                    // Add existing files
                    Array.from(fileInput.files).forEach(file => dt.items.add(file));
                    
                    // Add new files
                    files.forEach(file => dt.items.add(file));
                    
                    fileInput.files = dt.files;
                    handleFileSelection();
                });
            }

            function closePointRequestModal() {
                document.getElementById('pointRequestModal').style.display = 'none';
                selectedTaskForPoints = null;
                
                // Reset form
                document.getElementById('evidenceTextarea').value = '';
                document.getElementById('evidenceFiles').value = '';
                document.getElementById('pointsRequested').value = '';
                document.getElementById('taskCodeInput').value = '';
                document.getElementById('taskNameInput').value = '';
                clearFileList();
                
                // Reset button state
                const submitBtn = document.getElementById('submitPointsBtn');
                submitBtn.classList.remove('btn-loading');
                submitBtn.disabled = false;
            }

            function handleFileSelection() {
                const fileInput = document.getElementById('evidenceFiles');
                const fileList = document.getElementById('fileList');
                const fileItems = document.getElementById('fileItems');
                const files = Array.from(fileInput.files);
                
                if (files.length === 0) {
                    fileList.style.display = 'none';
                    return;
                }

                // Clear previous file list
                fileItems.innerHTML = '';
                
                files.forEach((file, index) => {
                    // Check file size (10MB limit)
                    if (file.size > 10 * 1024 * 1024) {
                        showToast(`File "${file.name}" is too large. Maximum size is 10MB.`, 'error');
                        return;
                    }
                    
                    const fileItem = document.createElement('div');
                    fileItem.style.cssText = `
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 0.5rem;
                        background: #f8f9fa;
                        border-radius: 6px;
                        border: 1px solid #e9ecef;
                    `;
                    
                    const fileInfo = document.createElement('div');
                    fileInfo.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        flex: 1;
                    `;
                    
                    const fileIcon = getFileIcon(file.type);
                    const fileName = file.name.length > 30 ? file.name.substring(0, 27) + '...' : file.name;
                    const fileSize = formatFileSize(file.size);
                    
                    fileInfo.innerHTML = `
                        <span style="font-size: 1.2rem;">${fileIcon}</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #1B4965; font-size: 0.9rem;">${fileName}</div>
                            <div style="color: #6c757d; font-size: 0.8rem;">${fileSize}</div>
                        </div>
                    `;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.innerHTML = '√ó';
                    removeBtn.style.cssText = `
                        background: #dc3545;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 24px;
                        height: 24px;
                        cursor: pointer;
                        font-size: 1rem;
                        line-height: 1;
                        transition: background-color 0.2s;
                    `;
                    removeBtn.onclick = () => removeFile(index);
                    
                    fileItem.appendChild(fileInfo);
                    fileItem.appendChild(removeBtn);
                    fileItems.appendChild(fileItem);
                });
                
                fileList.style.display = files.length > 0 ? 'block' : 'none';
            }

            function removeFile(indexToRemove) {
                const fileInput = document.getElementById('evidenceFiles');
                const dt = new DataTransfer();
                
                Array.from(fileInput.files).forEach((file, index) => {
                    if (index !== indexToRemove) {
                        dt.items.add(file);
                    }
                });
                
                fileInput.files = dt.files;
                handleFileSelection();
            }

            function clearFileList() {
                document.getElementById('fileList').style.display = 'none';
                document.getElementById('fileItems').innerHTML = '';
            }

            function getFileIcon(fileType) {
                if (fileType.startsWith('image/')) return 'üñºÔ∏è';
                if (fileType === 'application/pdf') return 'üìÑ';
                if (fileType.includes('document') || fileType.includes('word')) return 'üìù';
                if (fileType.includes('spreadsheet') || fileType.includes('excel')) return 'üìä';
                if (fileType.includes('zip') || fileType.includes('rar')) return 'üì¶';
                return 'üìé';
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            async function submitPointRequest() {
                if (!selectedTaskForPoints) return;
                
                const evidence = document.getElementById('evidenceTextarea').value.trim();
                const pointsRequested = document.getElementById('pointsRequested').value;
                const taskCode = document.getElementById('taskCodeInput').value.trim();
                const taskName = document.getElementById('taskNameInput').value.trim();
                
                if (!evidence) {
                    showToast('Please provide evidence of completion', 'error');
                    return;
                }

                if (!pointsRequested || pointsRequested < 1) {
                    showToast('Please enter a valid number of points to request', 'error');
                    return;
                }
                
                if (!taskCode) {
                    showToast('Please enter a task code', 'error');
                    return;
                }

                if (!taskName) {
                    showToast('Please enter a task name', 'error');
                    return;
                }
                
                const submitBtn = document.getElementById('submitPointsBtn');
                submitBtn.classList.add('btn-loading');
                submitBtn.disabled = true;
                
                try {
                    // Get file information and upload to storage
                    const fileInput = document.getElementById('evidenceFiles');
                    const files = Array.from(fileInput.files);
                    let uploadedFileUrls = [];
                    
                    // Upload files to Supabase storage if any files are selected
                    if (files.length > 0) {
                        for (let i = 0; i < files.length; i++) {
                            const file = files[i];
                            try {
                                // Create unique filename
                                const timestamp = Date.now();
                                const randomId = Math.random().toString(36).substring(2, 15);
                                const fileExtension = file.name.split('.').pop();
                                const uniqueFileName = `${currentUser.user.id}_${timestamp}_${randomId}.${fileExtension}`;
                                const filePath = `point-requests/${uniqueFileName}`;
                                
                                // Upload file to Supabase storage
                                console.log('Uploading file:', file.name, 'to path:', filePath);
                                
                                // Use existing Supabase client
                                if (!supabase) {
                                    console.error('Supabase client not available');
                                    continue;
                                }
                                
                                const { data: uploadData, error: uploadError } = await supabase.storage
                                    .from('image-test')
                                    .upload(filePath, file);
                                
                                console.log('Upload result:', { uploadData, uploadError });
                                
                                if (uploadError) {
                                    console.error('File upload error:', uploadError);
                                                } else {
                                    // Get public URL for the uploaded file
                                    const { data: urlData } = supabase.storage
                                        .from('image-test')
                                        .getPublicUrl(filePath);
                                    
                                    console.log('Public URL:', urlData.publicUrl);
                                    uploadedFileUrls.push(urlData.publicUrl);
                                }
                            } catch (fileError) {
                                console.error('Error uploading file:', fileError);
                            }
                        }
                    }
                    
                    // Create task completion record in user_task_completions table
                    console.log('Creating task completion with files:', uploadedFileUrls);
                    
                    const taskCompletionData = {
                        user_id: currentUser.user.id,
                        task_code: taskCode,
                        task_name: taskName,
                        points_awarded: parseInt(pointsRequested),
                        evidence: evidence,
                        file_urls: uploadedFileUrls.length > 0 ? uploadedFileUrls.join(',') : null,
                        status: 'pending',
                        completed_at: new Date().toISOString()
                    };
                    
                    console.log('Task completion data to insert:', taskCompletionData);
                    console.log('DEBUG - Points requested from form:', pointsRequested, typeof pointsRequested);
                    console.log('DEBUG - Points after parseInt:', parseInt(pointsRequested), typeof parseInt(pointsRequested));
                    
                    // Use the existing database connection instead of creating a new Supabase client
                    if (typeof db.createTaskCompletion === 'function') {
                        await db.createTaskCompletion(taskCompletionData);
                    } else {
                        // Fallback: use direct Supabase insertion with proper error handling
                        const { data, error } = await supabase
                            .from('user_task_completions')
                            .insert([taskCompletionData]);
                        
                        if (error) {
                            console.error('Error inserting task completion:', error);
                            console.error('Error details:', error.message, error.details, error.hint);
                            throw error;
                        }
                        
                        console.log('Task completion created successfully:', data);
                    }
                    
                    showToast('Point request submitted successfully! It will be reviewed by administrators.', 'success');
                    closePointRequestModal();
                    
                } catch (error) {
                    console.error('Error submitting point request:', error);
                    showToast('Failed to submit point request. Please try again.', 'error');
                    
                    // Reset button state
                    submitBtn.classList.remove('btn-loading');
                    submitBtn.disabled = false;
                }
            }

            // Chapter join functions
            function requestToJoin(chapterId) {
                const chapter = allChaptersData.find(c => c.id === chapterId);
                if (!chapter) return;
                
                selectedChapterForJoin = chapter;
                
                // Populate modal with chapter information
                document.getElementById('joinChapterName').textContent = chapter.chapter_code;
                document.getElementById('joinSchoolName').textContent = chapter.school_name;
                
                // Populate additional chapter stats
                document.getElementById('chapterPoints').textContent = chapter.points || 0;
                document.getElementById('chapterMembers').textContent = chapter.memberCount || 0;
                document.getElementById('chapterRank').textContent = `#${chapter.rank || 1}`;
                
                // Set chapter icon (first letter of chapter code)
                const chapterCode = chapter.chapter_code || 'I';
                document.getElementById('chapterIcon').textContent = chapterCode.charAt(0).toUpperCase();
                
                // Show modal
                document.getElementById('joinChapterModal').style.display = 'flex';
            }

            function closeJoinChapterModal() {
                document.getElementById('joinChapterModal').style.display = 'none';
                selectedChapterForJoin = null;
                
                // Reset button state
                const joinBtn = document.getElementById('joinChapterBtn');
                joinBtn.classList.remove('btn-loading');
                joinBtn.disabled = false;
            }

            async function confirmJoinChapter() {
                if (!selectedChapterForJoin) return;
                
                const joinBtn = document.getElementById('joinChapterBtn');
                joinBtn.classList.add('btn-loading');
                joinBtn.disabled = true;
                
                try {
                    // Get join reason from modal
                    const joinReason = document.getElementById('joinReason')?.value?.trim() || 'No reason provided';
                    
                    // Create join request instead of directly joining
                    const { data: joinRequest, error } = await supabase
                        .from('chapter_join_request')
                        .insert({
                            user_id: currentUser.user.id,
                            chapter_id: selectedChapterForJoin.id,
                            user_name: `${currentUser.user.first_name} ${currentUser.user.last_name}`,
                            user_email: currentUser.user.email,
                            user_school: currentUser.user.school || '',
                            user_grade_level: currentUser.user.grade_level || '',
                            join_reason: joinReason,
                            status: 'pending'
                        })
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    showToast(`Join request submitted for ${selectedChapterForJoin.chapter_code}! Waiting for approval.`, 'success');
                    closeJoinChapterModal();
                    
                    // Refresh chapters list to show updated status
                    await loadChapters();
                    
                } catch (error) {
                    console.error('Error submitting join request:', error);
                    showToast('Failed to submit join request. Please try again.', 'error');
                    
                    // Reset button state
                    joinBtn.classList.remove('btn-loading');
                    joinBtn.disabled = false;
                }
            }

            // Start Chapter Modal Functions
            function showStartChapterModal() {
                // Pre-fill form with current user data
                document.getElementById('chapterRequestName').value = `${currentUser.user.first_name} ${currentUser.user.last_name}`.trim();
                document.getElementById('chapterRequestEmail').value = currentUser.user.email;
                
                // Clear other fields
                document.getElementById('chapterRequestSchool').value = '';
                document.getElementById('chapterRequestReason').value = '';
                
                // Show modal
                document.getElementById('startChapterModal').style.display = 'flex';
            }

            function closeStartChapterModal() {
                document.getElementById('startChapterModal').style.display = 'none';
                
                // Reset button state
                const submitBtn = document.getElementById('submitChapterBtn');
                submitBtn.classList.remove('btn-loading');
                submitBtn.disabled = false;
            }

            async function submitChapterRequest() {
                const name = document.getElementById('chapterRequestName').value.trim();
                const email = document.getElementById('chapterRequestEmail').value.trim();
                const school = document.getElementById('chapterRequestSchool').value.trim();
                const reason = document.getElementById('chapterRequestReason').value.trim();
                
                // Validate form
                if (!name || !email || !school || !reason) {
                    showToast('Please fill in all required fields', 'error');
                    return;
                }

                const submitBtn = document.getElementById('submitChapterBtn');
                submitBtn.classList.add('btn-loading');
                submitBtn.disabled = true;
                
                try {
                    // Create chapter request using database function
                    await db.createChapterRequest({
                        requester_name: name,
                        requester_email: email,
                        school_name: school,
                        reason: reason,
                        status: 'pending',
                        user_id: currentUser.user.id
                    });
                    
                    showToast('Chapter request submitted successfully! We will review your request and get back to you soon.', 'success');
                    closeStartChapterModal();
                    
                } catch (error) {
                    console.error('Error submitting chapter request:', error);
                    showToast('Failed to submit chapter request. Please try again.', 'error');
                    
                    // Reset button state
                    submitBtn.classList.remove('btn-loading');
                    submitBtn.disabled = false;
                }
            }

            // Toast notification function
            function showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.style.display = 'block';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 5000);
            }

            // Event Details Modal Functions
            function showEventDetails(event) {
                // Populate modal with event data
                document.getElementById('modalEventTitle').textContent = event.title || 'Untitled Event';
                
                // Populate date field (date only)
                document.getElementById('modalEventDate').textContent = event.eventDate || 'No date';
                
                // Populate time field (time and timezone)
                let timeText = 'No time specified';
                if (event.eventTime && event.eventTimezone) {
                    timeText = `${event.eventTime} ${event.eventTimezone}`;
                } else if (event.eventTime) {
                    timeText = event.eventTime;
                }
                document.getElementById('modalEventTime').textContent = timeText;
                
                document.getElementById('modalEventStatus').textContent = event.isPast ? 'Past Event' : 'Upcoming Event';
                document.getElementById('modalEventDescription').textContent = event.description || 'No description available';
                
                // Populate registration deadline field
                let registrationDeadlineText = 'No deadline set';
                if (event.registration_deadline) {
                    try {
                        const deadlineDate = new Date(event.registration_deadline);
                        registrationDeadlineText = deadlineDate.toLocaleDateString();
                    } catch (e) {
                        registrationDeadlineText = event.registration_deadline;
                    }
                }
                document.getElementById('modalEventRegistrationDeadline').textContent = registrationDeadlineText;
                
                // Populate location field
                let locationText = 'No location specified';
                if (event.location && event.location.trim() !== '') {
                    // If location is a URL, make it clickable, otherwise just display as text
                    if (event.location.startsWith('http')) {
                        document.getElementById('modalEventLocation').innerHTML = `<a href="${event.location}" target="_blank" style="color: #1B4965; text-decoration: underline;">${event.location}</a>`;
                } else {
                        locationText = event.location;
                        document.getElementById('modalEventLocation').textContent = locationText;
                    }
                } else {
                    document.getElementById('modalEventLocation').textContent = locationText;
                }
                
                // Populate event link field
                const eventLinkElement = document.getElementById('modalEventLink');
                
                // Check for various possible link property names, including location which might contain URLs
                const linkUrl = event.event_link || event.link || event.url || event.event_url || event.registration_link || event.join_link || 
                               (event.location && event.location.startsWith('http') ? event.location : null);
                
                if (linkUrl && linkUrl.trim() !== '') {
                    eventLinkElement.innerHTML = `<a href="${linkUrl}" target="_blank" style="color: #1B4965; text-decoration: underline;">${linkUrl}</a>`;
                } else {
                    eventLinkElement.textContent = 'No link provided';
                }
                
                // Show modal
                document.getElementById('eventDetailsModal').style.display = 'flex';
            }

            function closeEventDetailsModal() {
                document.getElementById('eventDetailsModal').style.display = 'none';
            }

            function viewEventFullDetails() {
                // Navigate to the full events page
                window.location.href = 'events.html';
            }

            // Chapter Management Functions
            function showLeaveChapterModal() {
                const confirmLeave = confirm(
                    "Are you sure you want to leave your current chapter?\n\n" +
                    "This action will:\n" +
                    "‚Ä¢ Remove you from your chapter director role\n" +
                    "‚Ä¢ Remove you from the chapter\n" +
                    "‚Ä¢ Change your account to a regular member\n\n" +
                    "This action cannot be undone. Continue?"
                );
                
                if (confirmLeave) {
                    leaveChapter();
                }
            }



            async function leaveChapter() {
                try {
                    const stored = sessionStorage.getItem('iyna_user');
                    const user = stored ? JSON.parse(stored) : null;
                    if (!user || !user.id) {
                        alert('User session not found. Please log in again.');
                        return;
                    }

                    // Update user role and remove chapter assignment
                    const updatedUser = await db.updateUser(user.id, {
                        role: 'member',
                        chapter_id: null
                    });

                    // Update session storage (keep same shape used across app)
                    const newSessionUser = { ...user, role: 'member', chapter_id: null };
                    sessionStorage.setItem('iyna_user', JSON.stringify(newSessionUser));

                    alert('You have successfully left your chapter. You are now a regular member.');
                    
                    // Redirect to appropriate dashboard
                    window.location.href = 'personal_dash.html';
                    
                } catch (error) {
                    console.error('Error leaving chapter:', error);
                    alert('Failed to leave chapter. Please try again or contact support.');
                }
            }





            // Sub-tab switching for tasks
            $(document).on('click', '.event-filter-tab[data-subtab]', function(e) {
                e.preventDefault();
                
                const subtab = $(this).data('subtab');
                
                // Update active state
                $('.event-filter-tab[data-subtab]').removeClass('active');
                $(this).addClass('active');
                
                // Filter tasks based on subtab
                filterTasks(subtab);
            });

            async function filterTasks(type) {
                console.log('Filtering tasks:', type);
                
                const container = document.getElementById('personalTasksGrid');
                if (!container) return;
                
                if (type === 'new') {
                    // Show regular tasks
                    renderPersonalTasks();
                } else if (type === 'past') {
                    // Show past approved point requests
                    await renderPastPointRequests();
                }
            }

            async function renderPastPointRequests() {
                const container = document.getElementById('personalTasksGrid');
                if (!container) return;

                // Show loading state
                container.innerHTML = '<div class="loading-text">Loading past point requests...</div>';

                try {
                    // Get all point requests
                    const allPointRequests = await db.getPointRequests();
                    
                    // Filter for current user's approved requests
                    const userApprovedRequests = allPointRequests.filter(request => 
                        request.user_id === currentUser.user.id && 
                        (request.status === 'approved' || request.status === 'completed')
                    );

                    console.log('User approved point requests:', userApprovedRequests);

                    if (!userApprovedRequests || userApprovedRequests.length === 0) {
                        container.innerHTML = `
                        <div class="empty-state">
                                <h3>No past point requests</h3>
                                <p>You haven't had any approved point requests yet.</p>
                        </div>
                        `;
                    return;
                }

                    let requestsHtml = '<div class="tasks-list">';
                    userApprovedRequests.forEach(request => {
                        // Handle different date formats
                        let completedDate = 'Unknown date';
                        if (request.completed_at || request.submitted_at) {
                            try {
                                const date = new Date(request.completed_at || request.submitted_at);
                                completedDate = date.toLocaleDateString();
                            } catch (e) {
                                completedDate = request.completed_at || request.submitted_at;
                            }
                        }

                        // Get task information
                        const taskTitle = request.task?.title || request.task_name || 'Custom Task';
                        const taskCode = request.task?.task_code || request.task_code || 'N/A';
                        const pointsAwarded = request.points_awarded || request.points || 0;
                        const evidence = request.evidence || 'No evidence provided';

                        requestsHtml += `
                            <div class="task-card past-request">
                                <div class="past-request-header">
                                    <h3 class="task-title">${taskTitle}</h3>
                                    <span class="approved-badge">‚úì Approved</span>
                                    </div>
                                <div class="task-meta">
                                    <span class="task-points">${pointsAwarded} points awarded</span>
                                    <span class="task-deadline">Completed: ${completedDate}</span>
                                    <span class="task-code">Code: ${taskCode}</span>
                                </div>
                                <div class="evidence-section">
                                    <strong>Evidence submitted:</strong>
                                    <p class="evidence-text">${evidence.length > 200 ? evidence.substring(0, 200) + '...' : evidence}</p>
                            </div>
                        </div>
                    `;
                    });
                    requestsHtml += '</div>';
                    
                    container.innerHTML = requestsHtml;
                    console.log('Past point requests rendered successfully');

                } catch (error) {
                    console.error('Error loading past point requests:', error);
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>Error loading past requests</h3>
                            <p>Unable to load your past point requests. Please try again later.</p>
                        </div>
                    `;
                }
            }

            // Initialize when page loads
            if (typeof $ !== 'undefined') {
                $(document).ready(function() {
                    // Clear any existing banner closed flag
                    sessionStorage.removeItem('announcementBannerClosed');
                    initializeDashboard();
                });
            } else {
                document.addEventListener('DOMContentLoaded', function() {
                    // Clear any existing banner closed flag
                    sessionStorage.removeItem('announcementBannerClosed');
                    initializeDashboard();
                });
            }

            // ... existing code ...
            async function loadDirectorChapterBio() {
                try {
                    if (!currentUser.user.chapter_id) {
                        document.getElementById('directorChapterBioContent').innerHTML = '<div class="empty-state"><p>No chapter selected</p></div>';
                        return;
                    }
                    const { data, error } = await supabase
                        .from('chapter_bios')
                        .select('bio_text, social_media_links')
                        .eq('chapter_id', currentUser.user.chapter_id)
                        .single();
                    if (error && error.code !== 'PGRST116') throw error;

                    const content = document.getElementById('directorChapterBioContent');
                    const linksWrap = document.getElementById('directorSocialMediaLinks');
                    const linksGrid = document.getElementById('directorSocialLinksGrid');

                    if (!data) {
                        content.innerHTML = '<div class="empty-state"><p>No chapter bio has been written yet.</p></div>';
                        linksWrap.style.display = 'none';
                    } else {
                        content.innerHTML = `<p>${(data.bio_text || '').replace(/\n/g,'<br>')}</p>`;
                        const links = data.social_media_links || {};
                        const entries = Object.entries(links).filter(([k,v]) => !!v);
                        if (entries.length) {
                            linksWrap.style.display = 'block';
                            linksGrid.innerHTML = entries.map(([platform, url]) => `
                                <a href="${url}" target="_blank" class="social-link-item ${platform}">
                                    <span class="label">${platform.charAt(0).toUpperCase()+platform.slice(1)}</span>
                                    <span class="icon">‚Üí</span>
                                </a>
                            `).join('');
                        } else {
                            linksWrap.style.display = 'none';
                        }
                    }

                    // Show edit if director/lead
                    const canEdit = currentUser.user.role === 'chapter_director' || currentUser.user.role === 'chapter_lead';
                    document.getElementById('directorBioActions').style.display = canEdit ? 'block' : 'none';
                } catch (e) {
                    console.error('Error loading chapter bio:', e);
                    const content = document.getElementById('directorChapterBioContent');
                    if (content) content.innerHTML = '<div class="empty-state"><p>Error loading bio</p></div>';
                }
            }

            function openEditChapterBioModal() {
                // Build modal if not present
                if (!document.getElementById('editChapterBioModal')) {
                    const modalHTML = `
                        <div class="modal-overlay" id="editChapterBioModal" style="display: none;">
                            <div class="modal-content" style="max-width: 700px; max-height: 90vh; text-align: left; background: white; border-radius: 16px; padding: 0; overflow: hidden; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15); display: flex; flex-direction: column;">
                                <div style="background: linear-gradient(135deg, #1B4965 0%, #2c5f7a 100%); padding: 1.25rem 1.5rem; color: white; flex-shrink: 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700; color: white;">Edit Chapter Bio</h3>
                                        <button onclick="(function(){document.getElementById('editChapterBioModal').style.display='none';})()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: white; opacity: 0.9;">&times;</button>
                                    </div>
                                    <p style="margin: .25rem 0 0; font-size: .95rem; opacity: .9;">Update your chapter's short bio and social media links</p>
                                </div>
                                <div style="padding: 1rem 1.5rem; overflow-y: auto; flex: 1;">
                                    <div class="form-group" style="margin-bottom: 1rem;">
                                        <label class="form-label" for="chapterBioTextDir" style="display:block; font-weight:600; color:#1B4965; margin-bottom:.5rem;">Short Bio</label>
                                        <textarea id="chapterBioTextDir" class="form-control" placeholder="Write a short bio for your chapter..." style="width:100%; min-height:120px; resize:vertical; padding:.75rem; border:2px solid #e9ecef; border-radius:8px; font-size:1rem;"></textarea>
                                    </div>
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                                        <div class="form-group">
                                            <label class="form-label" for="linkInstagramDir" style="display:block; font-weight:600; color:#1B4965; margin-bottom:.25rem;">Instagram</label>
                                            <input id="linkInstagramDir" class="form-control" placeholder="https://instagram.com/yourchapter" style="width:100%; padding:.6rem .75rem; border:2px solid #e9ecef; border-radius:8px; font-size:1rem;" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="linkTwitterDir" style="display:block; font-weight:600; color:#1B4965; margin-bottom:.25rem;">Twitter/X</label>
                                            <input id="linkTwitterDir" class="form-control" placeholder="https://x.com/yourchapter" style="width:100%; padding:.6rem .75rem; border:2px solid #e9ecef; border-radius:8px; font-size:1rem;" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="linkFacebookDir" style="display:block; font-weight:600; color:#1B4965; margin-bottom:.25rem;">Facebook</label>
                                            <input id="linkFacebookDir" class="form-control" placeholder="https://facebook.com/yourchapter" style="width:100%; padding:.6rem .75rem; border:2px solid #e9ecef; border-radius:8px; font-size:1rem;" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="linkWebsiteDir" style="display:block; font-weight:600; color:#1B4965; margin-bottom:.25rem;">Website</label>
                                            <input id="linkWebsiteDir" class="form-control" placeholder="https://yourchapter.org" style="width:100%; padding:.6rem .75rem; border:2px solid #e9ecef; border-radius:8px; font-size:1rem;" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="linkLinkedInDir" style="display:block; font-weight:600; color:#1B4965; margin-bottom:.25rem;">LinkedIn</label>
                                            <input id="linkLinkedInDir" class="form-control" placeholder="https://linkedin.com/company/yourchapter" style="width:100%; padding:.6rem .75rem; border:2px solid #e9ecef; border-radius:8px; font-size:1rem;" />
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" for="linkYouTubeDir" style="display:block; font-weight:600; color:#1B4965; margin-bottom:.25rem;">YouTube</label>
                                            <input id="linkYouTubeDir" class="form-control" placeholder="https://youtube.com/@yourchapter" style="width:100%; padding:.6rem .75rem; border:2px solid #e9ecef; border-radius:8px; font-size:1rem;" />
                                        </div>
                                    </div>
                                </div>
                                <div style="background:#f8f9fa; padding:1rem 1.5rem; border-top:1px solid #e9ecef; display:flex; gap:.5rem; justify-content:flex-end;">
                                    <button onclick="(function(){document.getElementById('editChapterBioModal').style.display='none';})()" style="background:#6c757d; color:white; border:none; padding:.6rem 1rem; border-radius:8px; cursor:pointer; font-weight:500;">Cancel</button>
                                    <button id="saveChapterBioDirBtn" style="background: linear-gradient(135deg, #1B4965 0%, #2c5f7a 100%); color:white; border:none; padding:.6rem 1rem; border-radius:8px; cursor:pointer; font-weight:600;">Save</button>
                                </div>
                            </div>
                        </div>`;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                }

                // Prefill values
                (async () => {
                    try {
                        const { data, error } = await supabase
                            .from('chapter_bios')
                            .select('bio_text, social_media_links')
                            .eq('chapter_id', currentUser.user.chapter_id)
                            .single();
                        if (!error && data) {
                            document.getElementById('chapterBioTextDir').value = data.bio_text || '';
                            const links = data.social_media_links || {};
                            document.getElementById('linkInstagramDir').value = links.instagram || '';
                            document.getElementById('linkTwitterDir').value = links.twitter || links.x || '';
                            document.getElementById('linkFacebookDir').value = links.facebook || '';
                            document.getElementById('linkWebsiteDir').value = links.website || '';
                            document.getElementById('linkLinkedInDir').value = links.linkedin || '';
                            document.getElementById('linkYouTubeDir').value = links.youtube || '';
                        }
                    } catch (e) { console.warn('Could not prefill chapter bio modal (director):', e); }
                })();

                // Wire save
                document.getElementById('saveChapterBioDirBtn').onclick = async () => {
                    const bio = document.getElementById('chapterBioTextDir').value.trim();
                    const social = {
                        instagram: document.getElementById('linkInstagramDir').value.trim() || null,
                        twitter: document.getElementById('linkTwitterDir').value.trim() || null,
                        facebook: document.getElementById('linkFacebookDir').value.trim() || null,
                        website: document.getElementById('linkWebsiteDir').value.trim() || null,
                        linkedin: document.getElementById('linkLinkedInDir').value.trim() || null,
                        youtube: document.getElementById('linkYouTubeDir').value.trim() || null,
                    };
                    await updateDirectorChapterBio({ bio_text: bio, social_media_links: social });
                    document.getElementById('editChapterBioModal').style.display = 'none';
                };

                // Show modal
                document.getElementById('editChapterBioModal').style.display = 'flex';
            }

            async function updateDirectorChapterBio({ bio_text, social_media_links }) {
                try {
                    const { data: existing, error: chk } = await supabase
                        .from('chapter_bios')
                        .select('id')
                        .eq('chapter_id', currentUser.user.chapter_id)
                        .single();
                    if (chk && chk.code !== 'PGRST116') throw chk;

                    let resp;
                    if (existing) {
                        resp = await supabase.from('chapter_bios').update({ bio_text, social_media_links, updated_at: new Date().toISOString() }).eq('chapter_id', currentUser.user.chapter_id);
                    } else {
                        resp = await supabase.from('chapter_bios').insert({ chapter_id: currentUser.user.chapter_id, chapter_name: '', bio_text, social_media_links: social_media_links || {}, created_by: currentUser.user.id });
                    }
                    if (resp.error) throw resp.error;
                    await loadDirectorChapterBio();
                } catch (e) {
                    console.error('Error updating chapter bio:', e);
                    alert('Failed to update bio.');
                }
            }
            // ... existing code ...
        </script>
    </body>
</html>
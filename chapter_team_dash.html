<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <meta name="description" content="">
        <meta name="author" content="">

        <title>IYNA - Admin Dashboard</title>

        <!-- Load shared navigation -->
        <script src="js/jquery.min.js"></script>
        <script src="js/nav-login-state.js"></script>
        <script src="js/load-nav.js"></script>
        <script src="js/load-footer.js"></script>

        <!-- CSS FILES -->        
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
        
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="js/database.js"></script>
        <script src="js/load-nav.js"></script>
        
        <style>
          body, h1, h2, h3, h4, h5, h6, .btn, .navbar-brand, .nav-link, .accordion-button, .custom-block, .custom-btn, .site-footer, .site-footer-link, .copyright-text {
            font-family: 'Work Sans', sans-serif !important;
          }
          
          body {
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
          }

          /* Loading styles */
          .loading-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            flex-direction: column;
          }
                
          .loading-spinner {
            text-align: center;
          }
                
          .spinner-border {
            color: #6db9c3;
            width: 3rem;
            height: 3rem;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
          }

          @keyframes spinner-border {
            to { transform: rotate(360deg); }
          }

          .error-container {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            margin: 2rem;
            max-width: 500px;
          }

          .retry-btn {
            background: #6db9c3;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 1rem;
          }

          .retry-btn:hover {
            background: #5a9ea7;
          }

          /* Stats Grid */
          .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
          }

          .stat-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
          }

          .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #5aa6b0;
            margin: 0;
          }

          .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 0.5rem;
          }

          .view-details-btn {
            background: #6db9c3;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            margin-top: 1rem;
            transition: background-color 0.2s;
          }

          .view-details-btn:hover {
            background: #5a9ea7;
          }

          /* Dashboard Container */
          .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            background: white;
            min-height: 100vh;
            display: none; /* Hidden until loaded */
            flex-direction: column;
          }

          .dashboard-container.loaded {
            display: flex;
          }

          /* Header Section */
          .dashboard-header {
            margin-bottom: 2rem;
          }

          .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #000;
            margin: 0 0 0.5rem 0;
          }

          .dashboard-subtitle {
            color: #6c757d;
            font-size: 1rem;
            margin: 0;
          }

          /* Navigation Tabs */
          .dashboard-nav {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid #e9ecef;
            flex-wrap: wrap;
          }

          .nav-tab {
            padding: 1rem 0;
            text-decoration: none;
            color: #6c757d;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            white-space: nowrap;
          }

          .nav-tab.active {
            color: #000;
            border-bottom-color: #5aa6b0;
          }

          .nav-tab:hover {
            color: #000;
            text-decoration: none;
          }

          /* Tab Content */
          .tab-content {
            display: none;
            flex: 1;
          }

          .tab-content.active {
            display: block;
          }

          /* Main Content Layout */
          .main-content {
            display: flex;
            gap: 2rem;
            flex: 1;
          }

          .content-area {
            flex: 1;
          }

          /* Search Bar */
          .search-container {
            margin-bottom: 2rem;
            position: relative;
          }

          .search-box {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
          }

          .filter-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 0.9rem;
          }

          /* Add Button */
          .add-btn {
            background: #5aa6b0;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
          }

          .add-btn:hover {
            background: #4a939d;
          }

          /* Task Cards */
          .task-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
          }

          .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
          }

          .task-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #000;
            margin: 0 0 0.5rem 0;
          }

          .task-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #6c757d;
          }

          .task-points {
            background: #5aa6b0;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
          }

          .task-actions {
            display: flex;
            gap: 0.5rem;
          }

          .action-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1rem;
          }

          .action-btn:hover {
            color: #000;
          }

          .task-description {
            color: #495057;
            line-height: 1.6;
            margin: 0.5rem 0;
          }

          /* Request Cards */
          .request-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 120px;
            transition: all 0.3s ease;
            overflow: hidden;
          }

          .request-card.approved {
            transform: translateX(100%);
            opacity: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
            min-height: 0;
          }

          .request-card.declined {
            transform: translateX(-100%);
            opacity: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
            min-height: 0;
          }

          /* Toast notification styles */
          .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            pointer-events: none;
          }

          .toast-container.modal-open {
            position: absolute;
            top: 20px;
            right: 20px;
          }

          .toast {
            background: white;
            color: #333;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            border: 1px solid #e3e6ea;
            margin-bottom: 12px;
            min-width: 320px;
            max-width: 400px;
            transform: translateX(450px);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 0.875rem;
            font-weight: 500;
            font-size: 0.95rem;
            backdrop-filter: blur(10px);
          }

          .toast.show {
            transform: translateX(0);
          }

          .toast.success {
            border-left: 4px solid #1B4965;
            background: linear-gradient(135deg, #ffffff 0%, #f8fbff 100%);
          }

          .toast.success .toast-icon {
            color: #1B4965;
            background: #e6f2ff;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
          }

          .toast.error {
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, #ffffff 0%, #fefcfc 100%);
          }

          .toast.error .toast-icon {
            color: #ef4444;
            background: #fee2e2;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
          }

          .toast .toast-message {
            flex: 1;
            line-height: 1.4;
            color: #374151;
            font-weight: 500;
          }

          .toast .toast-close {
            background: #f3f4f6;
            border: none;
            color: #6b7280;
            font-size: 1rem;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 6px;
            transition: all 0.2s ease;
            line-height: 1;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
          }

          .toast .toast-close:hover {
            background: #e5e7eb;
            color: #374151;
          }

          .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 2rem;
          }

          .request-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #000;
            margin: 0;
          }

          .request-meta {
            color: #6c757d;
            font-size: 0.9rem;
            margin: 0.5rem 0;
          }

          .evidence-actions-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            margin-top: auto;
          }

          .evidence-text {
            flex: 1;
            margin: 0;
          }

          /* Chapter Dashboard Styles */
          .chapter-selection-header {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
          }

          .chapter-selector {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: nowrap;
            max-width: 520px;
          }

          .chapter-selector label {
            font-weight: 600;
            color: #000;
            margin: 0;
            white-space: nowrap;
          }

          .chapter-dropdown {
            padding: 0.5rem 0.75rem;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.95rem;
            min-width: 180px;
            max-width: 260px;
            background: white;
            max-height: 300px;
            overflow-y: auto;
            white-space: nowrap;
          }

          .chapter-dropdown:focus {
            outline: none;
            border-color: #5aa6b0;
          }

          .load-chapter-btn {
            background: #5aa6b0;
            color: white;
            border: none;
            padding: 0.6rem 1.1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            white-space: nowrap;
          }

          .load-chapter-btn:hover:not(:disabled) {
            background: #4a939d;
          }

          .load-chapter-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
          }

          .refresh-chapters-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
          }

          .refresh-chapters-btn:hover {
            background: #138496;
          }

          .test-database-btn {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
          }

          .test-database-btn:hover {
            background: #5a32a3;
          }

          .chapter-dashboard-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1rem;
          }

          .chapter-directors-section {
            margin-bottom: 2rem;
          }

          .chapter-directors-section,
          .chapter-stats-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            box-sizing: border-box;
            overflow: hidden;
            min-height: 300px;
          }

          .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #000;
            margin: 0 0 1.5rem 0;
          }

          .directors-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
          }

          .change-director-btn {
            background: #1B4965;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
          }

          .change-director-btn:hover {
            background: #0f2d3d;
          }

          .change-director-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
          }

          .change-director-btn:disabled:hover {
            background: #6c757d;
          }

          .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
          }

          .radio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
          }

          .radio-label input[type="radio"] {
            margin: 0;
          }

          .current-directors-list {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
          }

          .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
          }

          .cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
          }

          .cancel-btn:hover {
            background: #5a6268;
          }

          .directors-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
          }

          .director-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
          }

          .director-icon {
            width: 40px;
            height: 40px;
            background: #1B4965;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
          }

          .director-info {
            flex: 1;
          }

          .director-name {
            font-size: 1rem;
            font-weight: 600;
            color: #000;
            margin: 0;
          }

          .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            width: 100%;
            box-sizing: border-box;
          }

          .stats-subsection {
            margin-bottom: 0;
          }

          .subsection-title {
            font-size: 1rem;
            font-weight: 600;
            color: #000;
            margin: 0 0 0.75rem 0;
          }

          .rank-card,
          .points-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            height: calc(100% - 2rem);
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-sizing: border-box;
            max-width: 100%;
            margin-bottom: 2rem;
          }

          .rank-number,
          .points-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1B4965;
            margin: 0;
          }

          .rank-divider {
            width: 100%;
            height: 1px;
            background: #1B4965;
            margin: 0.5rem 0;
          }

          .total-chapters {
            font-size: 2rem;
            font-weight: 700;
            color: #1B4965;
            margin: 0;
          }

          .request-points-link {
            display: block;
            margin-top: 0.75rem;
            color: #1B4965;
            text-decoration: underline;
            font-size: 0.9rem;
            font-weight: 500;
          }

          .request-points-link:hover {
            color: #0d2d3a;
            text-decoration: none;
          }

          /* Member Roster Styles */
          .member-roster-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            box-sizing: border-box;
            overflow: hidden;
            min-height: 400px;
          }

          .roster-header {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
          }

          .member-count {
            color: #6c757d;
            font-size: 1rem;
            font-weight: 400;
          }

          .member-table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e9ecef;
          }

          .member-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: white;
          }

          .member-table thead {
            background: white;
            border-bottom: 1px solid #e9ecef;
          }

          .member-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #000;
            border-bottom: 1px solid #e9ecef;
            position: relative;
          }

          .member-table th.sortable {
            cursor: pointer;
            user-select: none;
          }

          .member-table th.sortable:hover {
            background: #f8f9fa;
          }

          .sort-icon {
            font-size: 0.7rem;
            color: #6c757d;
            margin-left: 0.25rem;
          }

          .points-header {
            color: #1B4965 !important;
            text-align: center;
          }

          .member-table tbody tr {
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s ease;
            height: 60px;
          }

          .member-table tbody tr:hover {
            background: #f8f9fa;
          }

          .member-table tbody tr:last-child {
            border-bottom: none;
          }

          .member-table td {
            padding: 1rem;
            color: #495057;
            vertical-align: middle;
            line-height: 1.4;
            text-align: center;
          }

          /* Join Requests Styles */
          #joinRequestsSection {
            margin-top: 2rem;
          }

          .section-subtitle {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1B4965;
            margin: 0 0 1rem 0;
          }

          .requests-header {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
          }

          .request-count {
            color: #6c757d;
            font-size: 1rem;
            font-weight: 400;
          }

          .requests-table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e9ecef;
          }

          .requests-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: white;
          }

          .requests-table thead {
            background: white;
            border-bottom: 1px solid #e9ecef;
          }

          .requests-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #000;
            border-bottom: 1px solid #e9ecef;
            tab-size: 4;
            position: relative;
          }

          .requests-table th.sortable {
            cursor: pointer;
            user-select: none;
          }

          .requests-table th.sortable:hover {
            background: #f8f9fa;
          }

          .requests-table tbody tr {
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s ease;
            height: 60px;
          }

          .requests-table tbody tr:hover {
            background: #f8f9fa;
          }

          .requests-table tbody tr:last-child {
            border-bottom: none;
          }

          .requests-table td {
            padding: 1rem;
            color: #495057;
            vertical-align: middle;
            line-height: 1.4;
            text-align: center;
          }

          .request-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
          }

          .approve-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
          }

          .approve-btn:hover {
            background: #218838;
          }

          .deny-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
          }

          .deny-btn:hover {
            background: #c82333;
          }

          .view-reason-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
          }

          .view-reason-btn:hover {
            background: #138496;
          }

          .member-table td:first-child {
            font-weight: 500;
            color: #000;
          }

          .member-table td:nth-child(3) {
            font-weight: 500;
          }

          /* Global Rankings Styles */
          .global-rankings-section {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 2rem;
            box-sizing: border-box;
            overflow: hidden;
            min-height: 400px;
          }

          .chapter-of-season {
            background: #1B4965;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            text-align: center;
            color: white;
          }

          .season-label {
            font-size: 0.8rem;
            color: #b8c5cc;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0;
          }

          .season-chapter-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0;
          }

          .season-chapter-code {
            font-size: 0.9rem;
            color: #b8c5cc;
            margin-bottom: 0;
          }

          .season-leader {
            font-size: 0.8rem;
            color: #b8c5cc;
            margin-bottom: 0;
          }

          .rankings-list-container {
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            overflow: hidden;
          }

          .rankings-list {
            padding: 1rem;
          }

          .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #f8f9fa;
            font-size: 0.9rem;
          }

          .ranking-item:last-child {
            border-bottom: none;
          }

          .ranking-number {
            font-weight: 600;
            color: #000;
            min-width: 30px;
          }

          .ranking-chapter {
            flex: 1;
            margin: 0 1rem;
            color: #495057;
          }

          .ranking-points {
            font-weight: 500;
            color: #1B4965;
            min-width: 80px;
            text-align: right;
          }

          .view-directory-link {
            text-align: center;
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
          }

          .view-directory-link a {
            color: #1B4965;
            text-decoration: none;
            font-weight: 500;
          }

          .view-directory-link a:hover {
            text-decoration: underline;
          }

          /* Responsive design for chapter dashboard */
          @media (max-width: 768px) {
            .chapter-selection-header {
              flex-direction: column;
              align-items: stretch;
              text-align: center;
            }

            .chapter-selector {
              justify-content: center;
            }

            .chapter-dropdown {
              min-width: 150px;
            }

            .chapter-dashboard-container {
              grid-template-columns: 1fr;
              gap: 1rem;
            }
            
            .stats-row {
              grid-template-columns: 1fr;
              gap: 1rem;
            }
          }

          .loading-text {
            color: #6c757d;
            text-align: center;
            padding: 2rem;
            font-style: italic;
          }

          .request-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            flex-shrink: 0;
          }

          .btn-approve {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
          }

          .btn-approve:hover {
            background: #218838;
          }

          .btn-reject {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
          }

          .btn-reject:hover {
            background: #c82333;
          }

          .btn-modify {
            background: #1B4965;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
          }

          .btn-modify:hover {
            background: #143a52;
          }

          /* Chapter Request Cards - Updated to match point requests */
          .chapter-request-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 0px;
            transition: all 0.3s ease;
            overflow: hidden;
          }

          .chapter-request-card.approved {
            transform: translateX(100%);
            opacity: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
            min-height: 0;
          }

          .chapter-request-card.declined {
            transform: translateX(-100%);
            opacity: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
            min-height: 0;
          }

          .chapter-request-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #000;
            margin: 0 0 1rem 0;
          }

          .chapter-request-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex: 1;
          }

          .chapter-detail {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            text-align: left;
          }

          .chapter-detail strong {
            color: #6c757d;
            font-weight: 600;
            margin-right: 0.5rem;
          }

          .chapter-detail span {
            color: #000;
            font-weight: 500;
          }

          /* Announcement Cards */
          .announcement-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem 1.5rem 4rem 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
            min-height: 120px;
          }

          .announcement-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
          }

          .announcement-icon {
            font-size: 1.5rem;
            color: #064c5c;
          }

          .announcement-text {
            flex: 1;
            color: #495057;
            font-weight: 500;
            font-size: 1rem;
          }

          .announcement-actions {
            display: flex;
            gap: 0.5rem;
          }

          .edit-btn {
            background: #064c5c;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
          }

          /* Form Styles */
          .form-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
          }

          .form-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #000;
            margin: 0 0 1.5rem 0;
          }

          .form-group {
            margin-bottom: 1rem;
          }

          .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #000;
            font-weight: 500;
          }

          .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
          }

          .form-control:focus {
            outline: none;
            border-color: #5aa6b0;
          }

          .form-control[readonly] {
            background: #f8f9fa;
            color: #6c757d;
          }

          .form-textarea {
            resize: vertical;
            min-height: 150px;
          }

          .submit-btn {
            background: #5aa6b0;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            width: 100%;
          }

          .submit-btn:hover {
            background: #4a939d;
          }

          /* Sub-tabs */
          .sub-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
          }

          .sub-tab {
            padding: 0.5rem 1rem;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            color: #6c757d;
            font-weight: 500;
            text-decoration: none;
          }

          .sub-tab.active {
            background: #5aa6b0;
            color: white;
            border-color: #5aa6b0;
          }

          /* Modal Styles */
          .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
          }

          .modal-content {
            background-color: #ffffff !important;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border: 2px solid #e9ecef;
            position: relative;
            opacity: 1 !important;
          }

          .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #000;
            margin: 0 0 1rem 0;
          }

          .modal-text {
            color: #6c757d;
            margin-bottom: 2rem;
            line-height: 1.6;
          }

          .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
          }

          .modal-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
          }

          .modal-btn.cancel {
            background: #6c757d;
            color: white;
          }

          .modal-btn.confirm {
            background: #dc3545;
            color: white;
          }

          /* Add Task Modal Styles */
          .add-task-modal .modal-content {
            max-width: 600px;
            text-align: left;
            background: white;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border: 2px solid #e9ecef;
          }

          .add-task-modal .modal-title {
            text-align: center;
            margin-bottom: 2rem;
            color: #000;
            font-size: 1.8rem;
          }

          .points-input-group {
            display: flex;
            align-items: stretch;
            gap: 0;
          }

          .points-input {
            flex: 1;
            border-radius: 6px 0 0 6px;
            border-right: none;
          }

          .points-dropdown {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-left: none;
            padding: 0.75rem;
            border-radius: 0 6px 6px 0;
            color: #6c757d;
            font-size: 0.9rem;
            min-width: 120px;
            cursor: pointer;
          }

          .points-dropdown:focus {
            outline: none;
            border-color: #5aa6b0;
          }

          /* Add Admin Section */
          .add-admin-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #e9ecef;
          }

          .add-admin-button {
            background: #5aa6b0;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
          }

          /* Empty State */
          .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #6c757d;
          }

          .empty-state h3 {
            color: #000;
            margin-bottom: 1rem;
          }

          /* Responsive Design */
          @media (max-width: 768px) {
            .dashboard-container {
              padding: 1rem;
            }

            .main-content {
              flex-direction: column;
            }

            .dashboard-nav {
              gap: 1rem;
            }

            .chapter-request-details {
              grid-template-columns: 1fr;
            }

            .add-task-modal .modal-content {
              max-width: 90%;
              margin: 1rem;
            }
          }
          .remove-admin-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 1.1rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-right: 0.5rem;
          }
          .remove-admin-btn:hover {
            background: #b52a37;
          }
#addEventModal .modal-content {
  max-height: 80vh;
  overflow-y: auto;
  box-sizing: border-box;
          }
          .event-status-label {
            display: inline-block;
            font-size: 0.95em;
            font-weight: 600;
            padding: 0.2em 0.9em;
            border-radius: 12px;
            margin-left: 0.5em;
            vertical-align: middle;
          }
          .event-status-upcoming {
            background: #eaf6f8;
            color: #1B4965;
          }
          .event-status-past {
            background: #f0f0f0;
            color: #888;
          }
          .event-status-cancelled {
            background: #ffe5b4;
            color: #b26a00;
          }
          .event-status-filter-bar {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
          }
          .event-status-filter-btn {
            background: #eaf6f8;
            color: #1B4965;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            padding: 0.4rem 1.1rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.18s, color 0.18s;
          }
          .event-status-filter-btn.active, .event-status-filter-btn:focus {
            background: #b8e9e5;
            color: #153e56;
            outline: none;
          }
          #editEventModal .modal-content {
            max-height: 80vh;
            overflow-y: auto;
            box-sizing: border-box;
          }
          
          /* Edit Chapter Modal Styles */
          #editChapterModal .modal-content {
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-sizing: border-box;
          }
          
          .delete-btn {
            background: #dc3545 !important;
            color: white !important;
            border: none !important;
            padding: 0.75rem 1.5rem !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-weight: 500 !important;
            transition: background-color 0.2s !important;
          }
          
          .delete-btn:hover {
            background: #c82333 !important;
          }
          
          .update-btn {
            background: #28a745 !important;
            color: white !important;
            border: none !important;
            padding: 0.75rem 1.5rem !important;
            border-radius: 6px !important;
            cursor: pointer !important;
            font-weight: 500 !important;
            transition: background-color 0.2s !important;
          }
          
          .update-btn:hover {
            background: #218838 !important;
          }
        </style>
                        
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/bootstrap-icons.css" rel="stylesheet">
        <link href="css/templatemo-topic-listing.css" rel="stylesheet">      
    </head>
    
    <body>
        <!-- Navigation Placeholder -->
        <div id="nav-placeholder"></div>

        <!-- Loading Screen -->
        <div class="loading-container" id="loadingContainer">
            <div class="loading-spinner">
                <div class="spinner-border" role="status">
                    <span style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;">Loading...</span>
                </div>
                <h3 style="margin-top: 1rem;">Loading Admin Dashboard...</h3>
                <p style="color: #6c757d;">Verifying your administrative access</p>
            </div>
        </div>

        <div class="dashboard-container" id="dashboardContainer">
            <!-- Header -->
            <div class="dashboard-header">
                <h1 class="dashboard-title">Hi, <span id="adminName">Loading...</span></h1>
                <p class="dashboard-subtitle"><span id="adminRole">Loading...</span> • <span id="adminChapterInfo">Loading...</span></p>
            </div>

            <!-- Navigation -->
            <nav class="dashboard-nav">
                <a class="nav-tab" data-tab="overview">Admin Dashboard</a>
                <a class="nav-tab active" data-tab="tasks">Tasks</a>
                <a class="nav-tab" data-tab="events">Events</a>
                <a class="nav-tab" data-tab="point-requests">Point Requests</a>
                <a class="nav-tab" data-tab="chapter-requests">Chapter Requests</a>
                <a class="nav-tab" data-tab="chapter-dashboard">Chapter Dashboard</a>
                <a class="nav-tab" data-tab="announcements">Announcements</a>
            </nav>

            <!-- Overview Tab -->
            <div id="overview-tab" class="tab-content">
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                        <button class="view-details-btn" onclick="showUsersModal()">View Users</button>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUsers">0</div>
                        <div class="stat-label">Active Users</div>
                        <button class="view-details-btn" onclick="showActiveUsersModal()">View Active Users</button>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalEvents">0</div>
                        <div class="stat-label">Total Events</div>
                        <button class="view-details-btn" onclick="showEventsModal()">View Events</button>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalTasks">0</div>
                        <div class="stat-label">Total Tasks</div>
                        <button class="view-details-btn" onclick="showTasksModal()">View Tasks</button>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalChapters">0</div>
                        <div class="stat-label">Total Chapters</div>
                        <button class="view-details-btn" onclick="showChaptersModal()">View Chapters</button>
                    </div>
                </div>
            </div>

            <!-- Tasks Tab -->
            <div id="tasks-tab" class="tab-content active">
                <div class="search-container">
                    <input type="text" class="search-box" placeholder="Search tasks..." id="taskSearch">
                    <button class="filter-btn">Filter</button>
                </div>

                <button class="add-btn" onclick="showAddTaskForm()">
                    <span>+</span> Add
                </button>

                <div class="tasks-list" id="tasksList">
                    <!-- Tasks will be loaded here -->
                </div>
            </div>

            <!-- Events Tab (duplicate of Tasks Tab) -->
            <div id="events-tab" class="tab-content">
                <div class="search-container">
                    <input type="text" class="search-box" placeholder="Search events..." id="eventSearch">
                    <button class="filter-btn">Filter</button>
                </div>

                <button class="add-btn" onclick="showAddEventForm()">
                    <span>+</span> Add Event
                </button>

                <!-- Event Status Filter Bar -->
                <div class="event-status-filter-bar" style="display: flex; gap: 1rem; margin: 1rem 0;">
                    <button class="event-status-filter-btn" data-status="all">All</button>
                    <button class="event-status-filter-btn" data-status="upcoming">Upcoming</button>
                    <button class="event-status-filter-btn" data-status="past">Past</button>
                    <button class="event-status-filter-btn" data-status="cancelled">Cancelled</button>
                </div>

                <div class="tasks-list" id="eventsList">
                    <!-- Events will be loaded here -->
                </div>
            </div>

            <!-- Point Requests Tab -->
            <div id="point-requests-tab" class="tab-content">
                <div class="sub-tabs">
                                    <a class="sub-tab active" data-subtab="active">New</a>
                <a class="sub-tab" data-subtab="inactive">Past</a>
                </div>

                <div class="search-container">
                    <input type="text" class="search-box" placeholder="Search point requests..." id="pointRequestSearch">
                </div>

                <div class="point-requests-list" id="pointRequestsList">
                    <!-- Point requests will be loaded here -->
                </div>
            </div>

            <!-- Chapter Requests Tab -->
            <div id="chapter-requests-tab" class="tab-content">
                <div class="chapter-requests-list" id="chapterRequestsList">
                    <!-- Chapter requests will be loaded here -->
                </div>
            </div>

            <!-- Announcements Tab -->
            <div id="announcements-tab" class="tab-content">
                <div class="search-container">
                    <input type="text" class="search-box" placeholder="Search announcements..." id="announcementSearch">
                </div>

                <div class="announcements-list" id="announcementsList">
                    <!-- Announcements will be loaded here -->
                </div>

                <button class="add-btn" onclick="showAddAnnouncementForm()">
                    <span>+</span> Add
                </button>

                <div class="add-admin-section">
                    <button class="add-admin-button">
                        <span>+</span> Add Admin
                    </button>
                </div>
            </div>

            <!-- Chapter Dashboard Tab -->
            <div id="chapter-dashboard-tab" class="tab-content">
                <!-- Chapter Selection Header -->
                <div class="chapter-selection-header">
                    <h2 class="section-title">Chapter Dashboard</h2>
                    <div class="chapter-selector">
                        <label for="chapterSelect">Choose Chapter:</label>
                        <select id="chapterSelect" class="chapter-dropdown">
                            <option value="">Select a chapter...</option>
                        </select>
                                        <button id="loadChapterBtn" class="load-chapter-btn" disabled>Load Chapter</button>
                    </div>
                </div>

                <div class="chapter-dashboard-container" id="chapterDashboardContent" style="display: none;">
                    <!-- Top Row: Chapter Directors and Chapter Stats -->
                    <div class="chapter-directors-section">
                        <div class="directors-header">
                            <h2 class="section-title">Chapter Director(s)</h2>
                            <button id="changeDirectorBtn" class="change-director-btn" onclick="showChangeDirectorModal()" disabled>
                                <span>Change Director</span>
                            </button>
                        </div>
                        <div class="directors-list" id="directorsList">
                            <div class="loading-text">Loading chapter directors...</div>
                        </div>
                    </div>

                    <div class="chapter-stats-section">
                        <h2 class="section-title">Chapter Stats</h2>
                        
                        <div class="stats-row">
                            <!-- Rank Section -->
                            <div class="stats-subsection">
                                <h3 class="subsection-title">Rank</h3>
                                <div class="rank-card">
                                    <div class="rank-number" id="chapterRank">-</div>
                                    <div class="rank-divider"></div>
                                    <div class="total-chapters" id="chapterTotalChapters">-</div>
                                </div>
                            </div>

                            <!-- Points Section -->
                            <div class="stats-subsection">
                                <h3 class="subsection-title">Points</h3>
                                <div class="points-card">
                                    <div class="points-number" id="chapterPoints">-</div>
                                    <a href="#" class="request-points-link" onclick="openTaskSubmissionModal()">Request points for chapter</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Row: Member Roster and Global Rankings -->
                    <div class="member-roster-section">
                        <div class="roster-header">
                            <h2 class="section-title">Member Roster</h2>
                            <span class="member-count" id="memberCount">(0 members)</span>
                        </div>

                        <div class="search-container">
                            <div class="search-input-wrapper">
                                <span class="search-icon">Search</span>
                                <input type="text" class="search-box" placeholder="Search" id="memberSearch">
                            </div>
                        </div>
                        
                        <div class="member-table-container">
                            <table class="member-table">
                                <thead>
                                    <tr>
                                        <th class="sortable">
                                            Name<span class="sort-icon">▼</span>
                                        </th>
                                        <th class="sortable">
                                            Role<span class="sort-icon">▼</span>
                                        </th>
                                        <th class="sortable points-header">
                                            Points<span class="sort-icon">▼</span>
                                        </th>
                                        <th class="sortable">
                                            School<span class="sort-icon">▼</span>
                                        </th>
                                        <th class="sortable">
                                            Discord<span class="sort-icon">▼</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="memberTableBody">
                                    <tr>
                                        <td colspan="5" class="loading-text">Loading members...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Join Requests Section (Only visible to chapter directors) -->
                        <div id="joinRequestsSection" style="display: none;">
                            <div class="requests-header">
                                <h3 class="section-subtitle">Join Requests</h3>
                                <span class="request-count" id="requestCount">(0 requests)</span>
                            </div>
                            
                            <div class="requests-table-container">
                                <table class="requests-table">
                                    <thead>
                                        <tr>
                                            <th class="sortable">
                                                Name<span class="sort-icon">▼</span>
                                            </th>
                                            <th class="sortable">
                                                School<span class="sort-icon">▼</span>
                                            </th>
                                            <th class="sortable">
                                                Requested<span class="sort-icon">▼</span>
                                            </th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="requestsTableBody">
                                        <tr>
                                            <td colspan="4" class="loading-text">Loading join requests...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                    
                <div class="global-rankings-section">
                    <h2 class="section-title">Global Rankings</h2>
                    
                    <!-- Chapter of the Season -->
                    <div class="chapter-of-season">
                        <div class="season-label">CHAPTER OF THE SEASON</div>
                        <div class="season-chapter-name" id="seasonChapterName">Loading...</div>
                        <div class="season-chapter-code" id="seasonChapterCode">Loading...</div>
                        <div class="season-leader" id="seasonLeader">Loading...</div>
                    </div>
            
                    <!-- Global Rankings List -->
                    <div class="rankings-list-container">
                        <div class="rankings-list" id="rankingsList">
                            <div class="loading-text">Loading global rankings...</div>
                        </div>
                        <div class="view-directory-link">
                            <a href="#" onclick="viewDirectory()">View Directory</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Detail View Modals -->
        <!-- Users Modal -->
        <div class="modal-overlay" id="usersModal">
            <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow: hidden;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e9ecef;">
                    <h3 style="margin: 0; color: #000; font-size: 1.5rem; font-weight: 700;">All Users</h3>
                    <button type="button" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;" onclick="closeDetailModal('usersModal')">&times;</button>
                </div>
                <div style="max-height: 60vh; overflow-y: auto; padding-right: 0.5rem;">
                    <div id="usersList" style="display: grid; gap: 1rem;">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Users Modal -->
        <div class="modal-overlay" id="activeUsersModal">
            <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow: hidden;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e9ecef;">
                    <h3 style="margin: 0; color: #000; font-size: 1.5rem; font-weight: 700;">Active Users</h3>
                    <button type="button" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;" onclick="closeDetailModal('activeUsersModal')">&times;</button>
                </div>
                <div style="max-height: 60vh; overflow-y: auto; padding-right: 0.5rem;">
                    <div id="activeUsersList" style="display: grid; gap: 1rem;">
                        <!-- Active users will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Events Modal -->
        <div class="modal-overlay" id="eventsModal">
            <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow: hidden;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e9ecef;">
                    <h3 style="margin: 0; color: #000; font-size: 1.5rem; font-weight: 700;">All Events</h3>
                    <button type="button" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;" onclick="closeDetailModal('eventsModal')">&times;</button>
                </div>
                <div style="max-height: 60vh; overflow-y: auto; padding-right: 0.5rem;">
                    <div id="eventsList" style="display: grid; gap: 1rem;">
                        <!-- Events will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks Modal -->
        <div class="modal-overlay" id="tasksModal">
            <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow: hidden;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e9ecef;">
                    <h3 style="margin: 0; color: #000; font-size: 1.5rem; font-weight: 700;">All Tasks</h3>
                    <button type="button" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;" onclick="closeDetailModal('tasksModal')">&times;</button>
                </div>
                <div style="max-height: 60vh; overflow-y: auto; padding-right: 0.5rem;">
                    <div id="tasksList" style="display: grid; gap: 1rem;">
                        <!-- Tasks will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Chapters Modal -->
        <div class="modal-overlay" id="chaptersModal">
            <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow: hidden;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e9ecef;">
                    <h3 style="margin: 0; color: #000; font-size: 1.5rem; font-weight: 700;">All Chapters</h3>
                    <button type="button" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;" onclick="closeDetailModal('chaptersModal')">&times;</button>
                </div>
                <div style="max-height: 60vh; overflow-y: auto; padding-right: 0.5rem;">
                    <div id="chaptersList" style="display: grid; gap: 1rem;">
                        <!-- Chapters will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div class="modal-overlay" id="deleteModal">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 class="modal-title" style="margin: 0;">Delete Task</h3>
                    <button type="button" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;" onclick="closeModal()">&times;</button>
                </div>
                <p class="modal-text">Are you sure you want to delete the following Task? This cannot be undone.</p>
                <div class="modal-actions">
                    <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
                    <button class="modal-btn confirm" onclick="confirmDelete()">Delete Task</button>
                </div>
            </div>
        </div>

        <!-- Delete Event Modal -->
        <div class="modal-overlay" id="deleteEventModal">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 class="modal-title" style="margin: 0;">Delete Event</h3>
                    <button type="button" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;" onclick="closeModal()">&times;</button>
                </div>
                <p class="modal-text">Are you sure you want to delete the following Event? This cannot be undone.</p>
                <div class="modal-actions">
                    <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
                    <button class="modal-btn confirm" onclick="confirmDeleteEvent()">Delete Event</button>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="rejectModal">
            <div class="modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 class="modal-title" style="margin: 0;">Reject Chapter</h3>
                    <button type="button" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6c757d;" onclick="closeModal()">&times;</button>
                </div>
                <p class="modal-text">Are you sure you want to reject the following chapter? This cannot be undone.</p>
                <div class="modal-actions">
                    <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
                    <button class="modal-btn confirm" onclick="confirmReject()">Reject Chapter</button>
                </div>
            </div>
        </div>

        <!-- Modify Request Modal -->
        <div class="modal-overlay" id="modifyRequestModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center; z-index: 2000;">
          <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh; overflow-y: auto; background: #fff; border-radius: 12px; padding: 0; position: relative; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);">
            <div style="background: #1B4965; color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
              <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: white; text-align: left;">Modify Point Request</h2>
              <button type="button" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: white; cursor: pointer;" onclick="closeModifyRequestModal()">&times;</button>
            </div>
            
            <div style="padding: 1.5rem;">
              <!-- Request Details Section -->
              <div class="request-info-section" style="margin-bottom: 2rem; text-align: left; display: flex; flex-direction: column; gap: 0.75rem;">
                <h3 style="color: #1B4965; margin: 0 0 1rem 0; font-size: 1.2rem;">Request Details</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                  <div style="flex: 1; min-width: 200px;">
                    <strong>Submitted by:</strong><span id="modifySubmittedBy" style="margin-left: 0.5rem;"></span>
                  </div>
                  <div style="flex: 1; min-width: 200px;">
                    <strong>Role:</strong><span id="modifyRole" style="margin-left: 0.5rem;"></span>
                  </div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                  <div style="flex: 1; min-width: 200px;">
                    <strong>Task Code:</strong><span id="modifyTaskCode" style="margin-left: 0.5rem;"></span>
                  </div>
                  <div style="flex: 1; min-width: 200px;">
                    <strong>Task Name:</strong><span id="modifyTaskName" style="margin-left: 0.5rem;"></span>
                  </div>
                </div>
                <div>
                  <strong>Submitted:</strong><span id="modifySubmittedDate" style="margin-left: 0.5rem;"></span>
                </div>
                
                <!-- Evidence Section -->
                <div style="margin-top: 1rem;">
                  <strong>Evidence:</strong>
                  <div id="modifyEvidence" style="margin-top: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; white-space: pre-wrap;"></div>
                </div>
                
                <!-- Attached Files Section -->
                <div id="modifyAttachedFiles" style="margin-top: 1rem; display: none;">
                  <strong>Attached Files:</strong>
                  <div id="modifyFilesList" style="margin-top: 0.5rem;"></div>
                </div>
              </div>
              
              <!-- Modification Form -->
              <form id="modifyRequestForm">
                <div class="form-group" style="margin-bottom: 1rem; text-align: left;">
                  <label for="modifyPointsToAward" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #1B4965;">Points to Award *</label>
                  <input type="number" id="modifyPointsToAward" class="form-control" min="0" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; text-align: left;">
                  <small style="color: #6c757d; text-align: left; display: block; margin-top: 0.25rem;">Adjust the points based on the evidence provided</small>
                </div>
                
                
                <div class="modal-actions" style="display: flex; gap: 1rem; justify-content: flex-end;">
                  <button type="button" class="modal-btn cancel" onclick="closeModifyRequestModal()" style="background: #6c757d; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">Cancel</button>
                  <button type="submit" class="modal-btn confirm" style="background: #1B4965; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600;">Update Request</button>
                </div>
              </form>
                </div>
            </div>
        </div>

        <!-- Add Admin Modal -->
        <div class="modal-overlay" id="addAdminModal" style="display:none; align-items: center; justify-content: center; z-index: 2000;">
          <div class="modal-content" style="max-width: 600px; width: 95%; background: #fff; border-radius: 12px; padding: 2rem; position: relative;">
            <button type="button" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: #6c757d; cursor: pointer;" onclick="closeAddAdminModal()">&times;</button>
            <h2 style="font-size: 1.5rem; font-weight: 700; color: #1B4965; margin-bottom: 1.5rem; text-align: center;">Add Admin</h2>
            <input type="text" class="form-control" id="adminUserSearch" placeholder="Search users by name or email..." style="margin-bottom: 1rem;">
            <div id="adminUserList" style="max-height: 300px; overflow-y: auto;"></div>
            <div class="modal-actions" style="margin-top: 1.5rem;">
              <button class="modal-btn cancel" onclick="closeAddAdminModal()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Add Task Modal -->
        <div class="modal-overlay add-task-modal" id="addTaskModal">
            <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh; overflow-y: auto; background: #fff; border-radius: 12px; padding: 0; position: relative; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);">
                <div style="background: #1B4965; color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
                    <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: white; text-align: left;">Add Task</h2>
                    <button type="button" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: white; cursor: pointer;" onclick="closeModal()">&times;</button>
                </div>
                <div style="padding: 1.5rem;">
                <form id="addTaskForm">
                    <div class="form-group">
                        <label class="form-label">Task Name</label>
                        <input type="text" class="form-control" id="taskName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Task Code</label>
                        <input type="text" class="form-control" id="taskCode">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Points</label>
                        <div class="points-input-group">
                            <input type="number" class="form-control points-input" id="taskPoints" value="10" min="1">
                            <select class="points-dropdown" id="pointsType">
                                <option value="per_member">per member</option>
                                <option value="per_chapter">per chapter</option>
                                <option value="total">total points</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Deadline</label>
                        <input type="datetime-local" class="form-control" id="taskDeadline" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-control form-textarea" id="taskDescription"></textarea>
                    </div>
                    <button type="submit" class="submit-btn">Submit New Task</button>
                </form>
                </div>
            </div>
        </div>

        <!-- Edit Task Modal -->
        <div class="modal-overlay add-task-modal" id="editTaskModal">
            <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh; overflow-y: auto; background: #fff; border-radius: 12px; padding: 0; position: relative; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2); border: none;">
                <div style="background: #1B4965; color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
                    <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: white; text-align: left;">Edit Task</h2>
                    <button type="button" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: white; cursor: pointer;" onclick="closeEditTaskModal()">&times;</button>
                </div>
                <div style="padding: 1.5rem;">
                <form id="editTaskForm">
                    <div class="form-group">
                        <label class="form-label">Task Name</label>
                        <input type="text" class="form-control" id="editTaskName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Task Code</label>
                        <input type="text" class="form-control" id="editTaskCode">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Points</label>
                        <div class="points-input-group">
                            <input type="number" class="form-control points-input" id="editTaskPoints" value="10" min="1">
                            <select class="points-dropdown" id="editPointsType">
                                <option value="per_member">per member</option>
                                <option value="per_chapter">per chapter</option>
                                <option value="total">total points</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Deadline</label>
                        <input type="datetime-local" class="form-control" id="editTaskDeadline" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-control form-textarea" id="editTaskDescription"></textarea>
                    </div>
                    <button type="submit" class="submit-btn">Update Task</button>
                </form>
                </div>
            </div>
        </div>

        <!-- Edit Event Modal -->
        <div class="modal-overlay add-task-modal" id="editEventModal">
            <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh; overflow-y: auto; background: #fff; border-radius: 12px; padding: 0; position: relative; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2); border: none;">
                <div style="background: #1B4965; color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
                    <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: white; text-align: left;">Edit Event</h2>
                    <button type="button" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: white; cursor: pointer;" onclick="closeEditEventModal()">&times;</button>
                </div>
                <div style="padding: 1.5rem;">
                <form id="editEventForm">
                    <input type="hidden" id="editEventId">
                    <div class="form-group">
                        <label class="form-label">Event Title</label>
                        <input type="text" class="form-control" id="editEventTitle" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Event Date & Time</label>
                        <input type="datetime-local" class="form-control" id="editEventDateTime" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Registration Deadline</label>
                        <input type="datetime-local" class="form-control" id="editEventRegistrationDeadline">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-control" id="editEventLocation">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Participants</label>
                        <input type="number" class="form-control" id="editEventMaxParticipants" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-control" id="editEventStatus">
                            <option value="upcoming">Upcoming</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-control form-textarea" id="editEventDescription"></textarea>
                    </div>
                    
                    <!-- Task Integration Section -->
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="editEventToTaskCheckbox"> Convert to Task
                        </label>
                    </div>
                    <div id="editEventTaskFields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Task Code</label>
                            <input type="text" class="form-control" id="editTaskCode">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Task Points</label>
                            <input type="number" class="form-control" id="editTaskPoints" min="1">
                        </div>
                    </div>
                    
                    <div id="editEventSuccess" style="display: none; color: green; margin: 1rem 0;">
                        Event updated successfully!
                    </div>
                    
                    <button type="submit" class="submit-btn">Update Event</button>
                </form>
                </div>
            </div>
        </div>

        <!-- Add Event Modal -->
        <div class="modal-overlay add-task-modal" id="addEventModal">
            <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh; overflow-y: auto; background: #fff; border-radius: 12px; padding: 0; position: relative; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);">
                <div style="background: #1B4965; color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
                    <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: white; text-align: left;">Add Event</h2>
                    <button type="button" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: white; cursor: pointer;" onclick="closeAddEventModal()">&times;</button>
                </div>
                <div style="padding: 1.5rem;">
                <form id="addEventForm">
                    <div class="form-group">
                        <label class="form-label">Event Title</label>
                        <input type="text" class="form-control" id="eventTitle" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Event Date & Time</label>
                        <input type="datetime-local" class="form-control" id="eventDateTime" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Registration Deadline</label>
                        <input type="datetime-local" class="form-control" id="eventRegistrationDeadline" placeholder="Optional registration deadline">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-control" id="eventLocation" placeholder="Enter event location or URL">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-control form-textarea" id="eventDescription" placeholder="Enter event description..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Event Link (Optional)</label>
                        <input type="url" class="form-control" id="eventLink" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="eventActive" checked>
                            Active (visible to users)
                        </label>
                    </div>
                    <div id="addEventSuccess" style="display: none; background: #d4edda; color: #155724; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                        Event created successfully!
                    </div>
                    <button type="submit" class="submit-btn">Create Event</button>
                </form>
                </div>
            </div>
        </div>

        <!-- Edit Chapter Modal -->
        <div class="modal-overlay add-task-modal" id="editChapterModal">
            <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh; overflow-y: auto; background: #fff; border-radius: 12px; padding: 0; position: relative; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);">
                <div style="background: #1B4965; color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
                    <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: white; text-align: left;">Edit Chapter</h2>
                    <button type="button" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: white; cursor: pointer;" onclick="closeModal()">&times;</button>
                </div>
                <div style="padding: 1.5rem;">
                <form id="editChapterForm">
                    <input type="hidden" id="editChapterId">
                    <div class="form-group">
                        <label class="form-label">Chapter Code</label>
                        <input type="text" class="form-control" id="editChapterCode" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">School Name</label>
                        <input type="text" class="form-control" id="editSchoolName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Director</label>
                        <select class="form-control" id="editDirectorId">
                            <option value="">No Director</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Points</label>
                        <input type="number" class="form-control" id="editChapterPoints" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-control" id="editChapterStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">School Address</label>
                        <textarea class="form-control form-textarea" id="editSchoolAddress"></textarea>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="delete-btn" style="flex: 1;" onclick="deleteChapter()">Delete Chapter</button>
                        <button type="submit" class="update-btn" style="flex: 2;">Update Chapter</button>
                    </div>
                </form>
                </div>
            </div>
        </div>

        <!-- Edit Announcement Modal -->
        <div class="modal-overlay add-task-modal" id="editAnnouncementModal">
            <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh; overflow-y: auto; background: #fff; border-radius: 12px; padding: 0; position: relative; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2); border: none;">
                <div style="background: #1B4965; color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
                    <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: white; text-align: left;">Edit Announcement</h2>
                    <button type="button" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: white; cursor: pointer;" onclick="closeModal()">&times;</button>
                </div>
                <div style="padding: 1.5rem;">
                <form id="editAnnouncementForm">
                    <div class="form-group">
                        <label class="form-label">Announcement Message</label>
                        <textarea class="form-control form-textarea" id="editAnnouncementMessage" required></textarea>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="editAnnouncementActive" checked>
                            Active (visible to users)
                        </label>
                    </div>
                    <button type="submit" class="submit-btn">Update Announcement</button>
                </form>
                </div>
            </div>
        </div>

        <!-- Change Chapter Director Modal -->
        <div class="modal-overlay add-task-modal" id="changeDirectorModal">
            <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh; overflow-y: auto; background: #fff; border-radius: 12px; padding: 0; position: relative; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2); border: none;">
                <div style="background: #1B4965; color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
                    <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: white; text-align: left;">Change Chapter Director</h2>
                    <button type="button" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: white; cursor: pointer;" onclick="closeChangeDirectorModal()">&times;</button>
                </div>
                <div style="padding: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Chapter Status</label>
                        <div id="chapterStatusInfo" class="chapter-status-info" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div class="loading-text">Loading chapter status...</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Current Director(s)</label>
                        <div id="currentDirectorsList" class="current-directors-list">
                            <div class="loading-text">Loading current directors...</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Select New Director</label>
                        <select id="newDirectorSelect" class="form-control" required>
                            <option value="">Choose a member...</option>
                        </select>
                        <small class="form-text" id="directorSelectionHelp">Select a member from this chapter to promote to Chapter Director</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Action</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="directorAction" value="replace" checked>
                                Replace current director(s)
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="directorAction" value="add">
                                Add to existing directors
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Reason for Change</label>
                        <textarea id="changeReason" class="form-control form-textarea" placeholder="Optional: Provide a reason for this change..." rows="3"></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button type="button" class="submit-btn" onclick="confirmChangeDirector()">Confirm Change</button>
                        <button type="button" class="cancel-btn" onclick="closeChangeDirectorModal()">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Placeholder -->
        <div id="footer-placeholder"></div>

        <!-- Toast notification container -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- SCRIPTS -->
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="js/database.js"></script>
        <script src="js/jquery.min.js"></script>
        <script src="js/bootstrap.bundle.min.js"></script>

        <script>
            console.log('Admin dashboard script started');
            
            // Detail Modal Functions
            function closeDetailModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            async function showUsersModal() {
                try {
                    const users = await db.getAllUsers();
                    const container = document.getElementById('usersList');
                    
                    if (!users || users.length === 0) {
                        container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 2rem;">No users found</div>';
                    } else {
                        let usersHtml = '';
                        users.forEach(user => {
                            const status = user.is_active ? 'Active' : 'Inactive';
                            const statusColor = user.is_active ? '#28a745' : '#dc3545';
                            usersHtml += `
                                <div style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; text-align: left;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <h4 style="margin: 0; color: #000; font-size: 1rem; text-align: left;">${user.first_name} ${user.last_name}</h4>
                                        <span style="background: ${statusColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${status}</span>
                                    </div>
                                    <div style="color: #6c757d; font-size: 0.9rem; margin-bottom: 0.5rem; text-align: left;">${user.email}</div>
                                    <div style="color: #6c757d; font-size: 0.8rem; text-align: left;">Role: ${user.role} • Chapter: ${user.chapter_id || 'None'}</div>
                                </div>
                            `;
                        });
                        container.innerHTML = usersHtml;
                    }
                    
                    document.getElementById('usersModal').style.display = 'flex';
                } catch (error) {
                    console.error('Error loading users:', error);
                    alert('Error loading users data');
                }
            }

            async function showActiveUsersModal() {
                try {
                    const users = await db.getAllUsers();
                    const activeUsers = users.filter(user => user.is_active);
                    const container = document.getElementById('activeUsersList');
                    
                    if (!activeUsers || activeUsers.length === 0) {
                        container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 2rem;">No active users found</div>';
                    } else {
                        let usersHtml = '';
                        activeUsers.forEach(user => {
                            usersHtml += `
                                <div style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; text-align: left;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <h4 style="margin: 0; color: #000; font-size: 1rem; text-align: left;">${user.first_name} ${user.last_name}</h4>
                                        <span style="background: #28a745; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">Active</span>
                                    </div>
                                    <div style="color: #6c757d; font-size: 0.9rem; margin-bottom: 0.5rem; text-align: left;">${user.email}</div>
                                    <div style="color: #6c757d; font-size: 0.8rem; text-align: left;">Role: ${user.role} • Chapter: ${user.chapter_id || 'None'}</div>
                                </div>
                            `;
                        });
                        container.innerHTML = usersHtml;
                    }
                    
                    document.getElementById('activeUsersModal').style.display = 'flex';
                } catch (error) {
                    console.error('Error loading active users:', error);
                    alert('Error loading active users data');
                }
            }

            async function showEventsModal() {
                try {
                    console.log('Opening events modal...');
                    console.log('Database object available:', !!window.db);
                    console.log('getEvents function available:', typeof db.getEvents);
                    
                    // Test database connection first
                    try {
                        const { data: testData, error: testError } = await supabase
                            .from('events')
                            .select('count')
                            .limit(1);
                        
                        if (testError) {
                            console.error('Database connection test failed:', testError);
                            throw new Error('Database connection failed: ' + testError.message);
                        } else {
                            console.log('Database connection test successful');
                        }
                    } catch (dbTestError) {
                        console.error('Database connection test error:', dbTestError);
                        throw dbTestError;
                    }
                    
                    const events = await db.getEvents();
                    console.log('Events loaded:', events);
                    
                    const container = document.getElementById('eventsList');
                    console.log('Events container found:', !!container);
                    
                    if (!events || events.length === 0) {
                        console.log('No events found, showing empty state');
                        container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 2rem;">No events found in database</div>';
                    } else {
                        console.log('Rendering', events.length, 'events');
                        let eventsHtml = '';
                        events.forEach((event, index) => {
                            console.log('Processing event', index + 1, ':', event);
                            const eventDate = event.event_date ? new Date(event.event_date).toLocaleDateString() : 'No date';
                            const status = event.status || 'upcoming';
                            const statusColor = status === 'upcoming' ? '#17a2b8' : status === 'past' ? '#6c757d' : '#ffc107';
                            
                            eventsHtml += `
                                <div style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; text-align: left;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <h4 style="margin: 0; color: #000; font-size: 1rem; text-align: left;">${event.title}</h4>
                                        <span style="background: ${statusColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${status}</span>
                                    </div>
                                    <div style="color: #6c757d; font-size: 0.9rem; margin-bottom: 0.5rem; text-align: left;">${event.description || 'No description'}</div>
                                    <div style="color: #6c757d; font-size: 0.8rem; text-align: left;">Date: ${eventDate} • Location: ${event.location || 'TBD'}</div>
                                </div>
                            `;
                        });
                        container.innerHTML = eventsHtml;
                        console.log('Events HTML rendered');
                    }
                    
                    document.getElementById('eventsModal').style.display = 'flex';
                    console.log('Events modal displayed');
                } catch (error) {
                    console.error('Error loading events:', error);
                    console.error('Error details:', error.message);
                    alert('Error loading events data: ' + error.message);
                }
            }

            async function showTasksModal() {
                try {
                    console.log('Opening tasks modal...');
                    console.log('Database object available:', !!window.db);
                    console.log('getTasks function available:', typeof db.getTasks);
                    
                    // Test database connection first
                    try {
                        const { data: testData, error: testError } = await supabase
                            .from('tasks')
                            .select('count')
                            .limit(1);
                        
                        if (testError) {
                            console.error('Database connection test failed:', testError);
                            throw new Error('Database connection failed: ' + testError.message);
                        } else {
                            console.log('Database connection test successful');
                        }
                    } catch (dbTestError) {
                        console.error('Database connection test error:', dbTestError);
                        throw dbTestError;
                    }
                    
                    const tasks = await db.getTasks();
                    console.log('Tasks loaded:', tasks);
                    
                    const container = document.getElementById('tasksList');
                    console.log('Tasks container found:', !!container);
                    
                    if (!tasks || tasks.length === 0) {
                        console.log('No tasks found, showing empty state');
                        container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 2rem;">No tasks found in database</div>';
                    } else {
                        console.log('Rendering', tasks.length, 'tasks');
                        let tasksHtml = '';
                        tasks.forEach((task, index) => {
                            console.log('Processing task', index + 1, ':', task);
                            const deadline = task.deadline ? new Date(task.deadline).toLocaleDateString() : 'No deadline';
                            
                            tasksHtml += `
                                <div style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; text-align: left;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <h4 style="margin: 0; color: #000; font-size: 1rem; text-align: left;">${task.title}</h4>
                                        <span style="background: #6db9c3; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${task.points} pts</span>
                                    </div>
                                    <div style="color: #6c757d; font-size: 0.9rem; margin-bottom: 0.5rem; text-align: left;">${task.description || 'No description'}</div>
                                    <div style="color: #6c757d; font-size: 0.8rem; text-align: left;">Deadline: ${deadline} • Code: ${task.task_code || 'N/A'}</div>
                                </div>
                            `;
                        });
                        container.innerHTML = tasksHtml;
                        console.log('Tasks HTML rendered');
                    }
                    
                    document.getElementById('tasksModal').style.display = 'flex';
                    console.log('Tasks modal displayed');
                } catch (error) {
                    console.error('Error loading tasks:', error);
                    console.error('Error details:', error.message);
                    alert('Error loading tasks data: ' + error.message);
                }
            }

            async function showChaptersModal() {
                try {
                    console.log('Opening chapters modal...');
                    console.log('Database object available:', !!window.db);
                    console.log('getChapters function available:', typeof db.getChapters);
                    
                    const chapters = await db.getChapters();
                    console.log('Chapters loaded:', chapters);
                    
                    const container = document.getElementById('chaptersList');
                    console.log('Chapters container found:', !!container);
                    
                    if (!chapters || chapters.length === 0) {
                        console.log('No chapters found, showing empty state');
                        container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 2rem;">No chapters found in database</div>';
                    } else {
                        console.log('Rendering', chapters.length, 'chapters');
                        let chaptersHtml = '';
                        chapters.forEach((chapter, index) => {
                            console.log('Processing chapter', index + 1, ':', chapter);
                            const status = chapter.status || 'active';
                            const statusColor = status === 'active' ? '#28a745' : status === 'pending' ? '#ffc107' : '#dc3545';
                            
                            chaptersHtml += `
                                <div style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; text-align: left;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <h4 style="margin: 0; color: #000; font-size: 1rem; text-align: left;">${chapter.chapter_code || 'N/A'}</h4>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="background: ${statusColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">${status}</span>
                                            <button onclick="editChapter(${chapter.id})" style="background: #6db9c3; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">Edit</button>
                                        </div>
                                    </div>
                                    <div style="color: #6c757d; font-size: 0.9rem; margin-bottom: 0.5rem; text-align: left;">${chapter.school_name || chapter.name || 'N/A'}</div>
                                    <div style="color: #6c757d; font-size: 0.8rem; text-align: left;">Director: ${chapter.director_name || 'No Director Assigned'}</div>
                                    <div style="color: #6c757d; font-size: 0.8rem; text-align: left;">Points: ${chapter.points || 0}</div>
                                </div>
                            `;
                        });
                        container.innerHTML = chaptersHtml;
                        console.log('Chapters HTML rendered');
                    }
                    
                    document.getElementById('chaptersModal').style.display = 'flex';
                    console.log('Chapters modal displayed');
                } catch (error) {
                    console.error('Error loading chapters:', error);
                    console.error('Error details:', error.message);
                    alert('Error loading chapters data: ' + error.message);
                }
            }



            // Chapter editing functions
            async function editChapter(chapterId) {
                try {
                    console.log('Editing chapter:', chapterId);
                    
                    // Get the chapter data
                    const chapters = await db.getChapters();
                    const chapter = chapters.find(c => c.id === chapterId);
                    
                    if (!chapter) {
                        alert('Chapter not found');
                        return;
                    }
                    
                    // Get all users for director selection
                    const users = await db.getAllUsers();
                    
                    // Populate the form
                    document.getElementById('editChapterId').value = chapter.id;
                    document.getElementById('editChapterCode').value = chapter.chapter_code || '';
                    document.getElementById('editSchoolName').value = chapter.school_name || '';
                    document.getElementById('editChapterPoints').value = chapter.points || 0;
                    document.getElementById('editChapterStatus').value = chapter.status || 'active';
                    document.getElementById('editSchoolAddress').value = chapter.school_address || '';
                    
                    // Populate director dropdown
                    const directorSelect = document.getElementById('editDirectorId');
                    directorSelect.innerHTML = '<option value="">No Director</option>';
                    
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.first_name} ${user.last_name} (${user.email})`;
                        if (user.id === chapter.director_id) {
                            option.selected = true;
                        }
                        directorSelect.appendChild(option);
                    });
                    
                    // Show the modal
                    document.getElementById('editChapterModal').style.display = 'flex';
                    
                        } catch (error) {
                    console.error('Error loading chapter for editing:', error);
                    alert('Error loading chapter data: ' + error.message);
                }
            }

            async function deleteChapter() {
                const chapterId = document.getElementById('editChapterId').value;
                
                if (!chapterId) {
                    alert('No chapter selected');
                    return;
                }
                
                if (!confirm('Are you sure you want to delete this chapter? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    await db.deleteChapter(chapterId);
                    alert('Chapter deleted successfully');
                    closeModal();
                    
                    // Refresh the chapters modal
                    await showChaptersModal();
                    
                    // Also refresh stats
                    const stats = await db.getStats();
                    updateStatsDisplay(stats);
                    
                        } catch (error) {
                    console.error('Error deleting chapter:', error);
                    alert('Error deleting chapter: ' + error.message);
                }
            }

            // Handle chapter form submission
            document.getElementById('editChapterForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    const chapterId = document.getElementById('editChapterId').value;
                    const newDirectorId = document.getElementById('editDirectorId').value || null;
                    
                    // Get current chapter data to find old director
                    const chapters = await db.getChapters();
                    const currentChapter = chapters.find(c => c.id === parseInt(chapterId));
                    const oldDirectorId = currentChapter ? currentChapter.director_id : null;
                    
                    const chapterData = {
                        school_name: document.getElementById('editSchoolName').value,
                        director_id: newDirectorId,
                        points: parseInt(document.getElementById('editChapterPoints').value) || 0,
                        status: document.getElementById('editChapterStatus').value,
                        school_address: document.getElementById('editSchoolAddress').value
                    };
                    
                    console.log('Submitting chapter data:', chapterData);
                    console.log('Old director ID:', oldDirectorId);
                    console.log('New director ID:', newDirectorId);
                    
                    // Update the chapter first
                    await db.updateChapter(chapterId, chapterData);
                    
                    // Handle role changes for directors
                    if (oldDirectorId !== newDirectorId) {
                        console.log('Director changed, updating user roles...');
                        
                        // If there was an old director, change their role to member
                        if (oldDirectorId) {
                            console.log('Demoting old director to member...');
                            await db.updateUserRole(oldDirectorId, 'member');
                        }
                        
                        // If there's a new director, change their role to chapter_director
                        if (newDirectorId) {
                            console.log('Promoting new director...');
                            await db.updateUserRole(newDirectorId, 'chapter_director');
                        }
                    }
                    
                    alert('Chapter updated successfully');
                    closeModal();
                    
                    // Refresh the chapters modal
                    await showChaptersModal();
                    
                    // Also refresh stats
                    const stats = await db.getStats();
                    updateStatsDisplay(stats);
                    
                } catch (error) {
                    console.error('Error updating chapter:', error);
                    alert('Error updating chapter: ' + error.message);
                }
            });
            
            let currentUser = null;
            let allTasks = [];
            let allUsers = [];
            let allChapters = [];
            let currentModal = null;

            // Function to initialize the dashboard
            async function initializeDashboard() {
                try {
                    console.log('Admin dashboard: Checking authentication...');
                    
                    // Check if user is authenticated via sessionStorage
                    const userData = sessionStorage.getItem('iyna_user');
                    
                    if (!userData) {
                        console.log('No user data found in session');
                        redirectToLogin('No active session');
                        return;
                    }

                    let user;
                    try {
                        user = JSON.parse(userData);
                    } catch (parseError) {
                        console.error('Error parsing user data:', parseError);
                        redirectToLogin('Invalid session data');
                        return;
                    }

                    if (!user || !user.is_active) {
                        console.log('User data invalid or inactive');
                        sessionStorage.removeItem('iyna_user');
                        redirectToLogin('Account inactive or invalid');
                        return;
                    }

                    console.log('User authenticated:', user.email);
                    console.log('User role:', user.role);

                    // Check for role updates from database to ensure current role
                    try {
                        console.log('Checking for role updates from database...');
                        const freshUser = await db.getUserByEmail(user.email);
                        
                        if (freshUser && freshUser.role !== user.role) {
                            console.log(`Role change detected: ${user.role} -> ${freshUser.role}`);
                            
                            // Update session with fresh data
                            sessionStorage.setItem('iyna_user', JSON.stringify(freshUser));
                            user = freshUser;
                            
                            console.log('Session updated with new role:', freshUser.role);
                        }
                    } catch (error) {
                        console.error('Error checking for role updates:', error);
                        // Continue with session data if database check fails
                    }

                    // Check if user has admin privileges
                    const adminRoles = ['admin', 'deputy_chapter_lead', 'regional_lead'];
                    if (!adminRoles.includes(user.role)) {
                        console.log(`Access denied. Admin privileges required. Current role: ${user.role}`);
                        
                        // Redirect to appropriate dashboard based on role
                        if (user.role === 'chapter_lead') {
                            window.location.href = 'chapter_lead_dash.html';
                        } else if (user.role === 'chapter_director') {
                            window.location.href = 'chapter_director_dash.html';
                        } else if (user.role === 'member') {
                            window.location.href = 'personal_dash.html';
                        } else {
                            // For any other role, redirect to login
                            redirectToLogin('Invalid role for this dashboard');
                        }
                        return;
                    }

                    console.log('Admin access granted, initializing dashboard...');
                    
                    // Store current user
                    currentUser = user;
                    
                    // Initialize dashboard
                    await initializeAdminInfo();
                    setupEventHandlers();
                    await loadAllData();
                    
                    // Hide loading and show dashboard
                    document.getElementById('loadingContainer').style.display = 'none';
                    document.getElementById('dashboardContainer').classList.add('loaded');
                    
                } catch (error) {
                    console.error('Error during authentication:', error);
                    showError('Authentication failed. Please try logging in again.');
                }
            }

            function redirectToLogin(reason) {
                console.log('Redirecting to login:', reason);
                // Clear session storage
                sessionStorage.removeItem('iyna_user');
                window.location.href = 'login.html';
            }

            function showError(message) {
                document.getElementById('loadingContainer').innerHTML = `
                    <div class="error-container">
                        <h3>Authentication Error</h3>
                        <p>${message}</p>
                        <button onclick="window.location.href='login.html'" class="retry-btn">Return to Login</button>
                        <button onclick="location.reload()" class="retry-btn">Try Again</button>
                    </div>
                `;
            }

            // Initialize when page loads
            if (typeof $ !== 'undefined') {
                console.log('Using jQuery ready');
                $(document).ready(function() {
                    console.log('jQuery document ready fired');
                    initializeDashboard();
                    checkForRoleUpdate();
                    startPeriodicRoleCheck();
                });
            } else {
                console.log('jQuery not available, using window.onload');
                window.onload = function() {
                    console.log('Window onload fired');
                    initializeDashboard();
                    checkForRoleUpdate();
                    startPeriodicRoleCheck();
                };
            }

            async function initializeAdminInfo() {
                try {
                    console.log('Starting initializeAdminInfo...');
                    console.log('Current user:', currentUser);
                    
                    // Set admin name
                    const firstName = currentUser.first_name || '';
                    const lastName = currentUser.last_name || '';
                    const fullName = `${firstName} ${lastName}`.trim();
                    const adminName = fullName || currentUser.name || currentUser.username || 'Admin';
                    
                    console.log('Setting admin name to:', adminName);
                    $('#adminName').text(adminName);
                    
                    // Set role
                    let roleDisplay;
                    switch(currentUser.role) {
                        case 'deputy_chapter_lead':
                            roleDisplay = 'Deputy Chapter Lead';
                            break;
                        case 'regional_lead':
                            roleDisplay = 'Regional Lead';
                            break;
                        case 'admin':
                            roleDisplay = 'Admin';
                            break;
                        case 'chapter_lead':
                            roleDisplay = 'Chapter Lead';
                            break;
                        case 'chapter_director':
                            roleDisplay = 'Chapter Director';
                            break;
                        default:
                            roleDisplay = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
                    }
                    console.log('Setting role to:', roleDisplay);
                    $('#adminRole').text(roleDisplay);
                    
                    // Load chapter info
                    const chapterId = currentUser.chapter_id;
                    console.log('User chapter_id:', chapterId);
                    
                    if (chapterId) {
                        try {
                            console.log('Fetching chapters...');
                            const chapters = await db.getChapters();
                            console.log('Chapters received:', chapters);
                            
                            const userChapter = chapters.find(c => c.id === chapterId);
                            console.log('Found user chapter:', userChapter);
                            
                            if (userChapter) {
                                const chapterInfo = `${userChapter.school_name} ${userChapter.chapter_code}`;
                                console.log('Setting chapter info to:', chapterInfo);
                                $('#adminChapterInfo').text(chapterInfo);
                            } else {
                                console.log('No matching chapter found, setting to No Chapter Assigned');
                                $('#adminChapterInfo').text('No Chapter Assigned');
                            }
                        } catch (chapterError) {
                            console.error('Error loading chapter info:', chapterError);
                            $('#adminChapterInfo').text('Chapter Info Unavailable');
                        }
                    } else {
                        console.log('No chapter_id, setting to No Chapter Assigned');
                        $('#adminChapterInfo').text('No Chapter Assigned');
                    }
                    
                    console.log('initializeAdminInfo completed successfully');
                } catch (error) {
                    console.error('Error in initializeAdminInfo:', error);
                    $('#adminName').text('Admin');
                    $('#adminRole').text('Admin');
                    $('#adminChapterInfo').text('Loading Failed');
                }
            }

            async function loadAllData() {
                try {
                    console.log('Loading all admin data...');
                    
                    // Load all data from database with individual error handling
                    let users = [];
                    let chapters = [];
                    let stats = {};
                    
                    try {
                        users = await db.getAllUsers();
                        console.log('Users loaded successfully:', users.length);
                    } catch (error) {
                        console.error('Error loading users:', error);
                        users = [];
                    }
                    
                    try {
                        chapters = await db.getChapters();
                        console.log('Chapters loaded successfully:', chapters.length);
                    } catch (error) {
                        console.error('Error loading chapters:', error);
                        chapters = [];
                    }
                    
                    try {
                        stats = await db.getStats();
                        console.log('Stats loaded successfully:', stats);
                    } catch (error) {
                        console.error('Error loading stats:', error);
                        stats = {
                            totalUsers: 0,
                            activeUsers: 0,
                            totalEvents: 0,
                            totalTasks: 0,
                            totalChapters: 0
                        };
                    }
                    
                    allUsers = users || [];
                    allChapters = chapters || [];
                    
                    // Update stats display
                    updateStatsDisplay(stats);
                    
                    // Load individual sections
                    await loadTasks();
                    await loadPointRequests();
                    await loadChapterRequests();
                    await loadAnnouncements();
                    renderEvents(); // Render events after loading tasks
                    
                } catch (error) {
                    console.error('Error loading admin data:', error);
                }
            }

            function updateStatsDisplay(stats) {
                console.log('Updating stats display with:', stats);
                
                const totalUsers = stats.totalUsers || 0;
                const activeUsers = stats.activeUsers || 0;
                const totalEvents = stats.totalEvents || 0;
                const totalTasks = stats.totalTasks || 0;
                const totalChapters = stats.totalChapters || 0;
                
                console.log('Setting stats:', {
                    totalUsers,
                    activeUsers,
                    totalEvents,
                    totalTasks,
                    totalChapters
                });
                
                $('#totalUsers').text(totalUsers);
                $('#activeUsers').text(activeUsers);
                $('#totalEvents').text(totalEvents);
                $('#totalTasks').text(totalTasks);
                $('#totalChapters').text(totalChapters);
            }

            function setupEventHandlers() {
                // Tab navigation
                $('.nav-tab').on('click', function(e) {
                    e.preventDefault();
                    const tab = $(this).data('tab');
                    switchTab(tab);
                });

                // Sub-tab navigation
                $('.sub-tab').on('click', function(e) {
                    e.preventDefault();
                    const subtab = $(this).data('subtab');
                    switchSubTab(subtab);
                });

                // Form submission
                $('#addTaskForm').on('submit', handleTaskSubmit);
            $('#editTaskForm').on('submit', handleEditTaskSubmit);
                $('#editAnnouncementForm').on('submit', handleAnnouncementEdit);

                // Modal close on overlay click
                $(document).on('click', '.modal-overlay', function(e) {
                    if (e.target === this) {
                        closeModal();
                    }
                });

                // Modal close on escape key
                $(document).on('keydown', function(e) {
                    if (e.key === 'Escape') {
                        closeModal();
                        // Close detail modals
                        const detailModals = ['usersModal', 'activeUsersModal', 'eventsModal', 'tasksModal', 'chaptersModal'];
                        detailModals.forEach(modalId => {
                            const modal = document.getElementById(modalId);
                            if (modal && modal.style.display === 'flex') {
                                closeDetailModal(modalId);
                            }
                        });
                    }
                });

                // Close detail modals when clicking overlay
                const detailModals = ['usersModal', 'activeUsersModal', 'eventsModal', 'tasksModal', 'chaptersModal'];
                detailModals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.addEventListener('click', function(e) {
                            if (e.target === this) {
                                closeDetailModal(modalId);
                            }
                        });
                    }
                });
            }

            function switchTab(tab) {
                // Update navigation
                $('.nav-tab').removeClass('active');
                $(`.nav-tab[data-tab="${tab}"]`).addClass('active');
                
                // Show/hide content
                $('.tab-content').removeClass('active');
                $(`#${tab}-tab`).addClass('active');
            }

            function switchSubTab(subtab) {
                $('.sub-tab').removeClass('active');
                $(`.sub-tab[data-subtab="${subtab}"]`).addClass('active');
                
                // Filter point requests based on subtab
                filterPointRequests(subtab);
            }

            async function loadTasks() {
                try {
                    const tasks = await db.getTasks();
                    allTasks = tasks || [];
                    renderTasks();
                } catch (error) {
                    console.error('Error loading tasks:', error);
                    $('#tasksList').html('<div class="empty-state"><p>Error loading tasks. Please refresh the page.</p></div>');
                }
            }

            function renderTasks() {
                const container = $('#tasksList');
                container.empty();

                if (allTasks.length === 0) {
                    container.html('<div class="empty-state"><h3>No tasks found</h3><p>Create your first task using the Add button above.</p></div>');
                    return;
                }

                allTasks.forEach(task => {
                    // Find the creator's name
                    const creator = allUsers.find(u => u.id === task.created_by);
                    const creatorName = creator ? `${creator.first_name} ${creator.last_name}` : 'Unknown';
                    
                    const taskCard = `
                        <div class="task-card" style="position: relative; padding-bottom: 5rem;">
                            <div class="task-header">
                                <div>
                                    <h3 class="task-title">${task.title}</h3>
                                    <div class="task-meta">
                                        <span class="task-points">${task.points} points per member</span>
                                        <span>Deadline: ${new Date(task.deadline).toLocaleDateString()}</span>
                                        <span>Created by ${creatorName}</span>
                                        <span>Task Code: ${task.task_code || 'N/A'}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="task-description">${task.description || ''}</div>
                            <div class="task-actions" style="position: absolute; bottom: 35px; right: 35px; display: flex; align-items: center; gap: 0.5rem; z-index: 10;">
                                <button class="btn-modify" onclick="editTask(${task.id})" title="Edit">Edit</button>
                                <button class="btn-decline" onclick="deleteTask(${task.id})" title="Delete" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">Delete</button>
                            </div>
                        </div>
                    `;
                    container.append(taskCard);
                });
            }

            async function handleTaskSubmit(e) {
                e.preventDefault();
                
                try {
                    const taskData = {
                        title: $('#taskName').val(),
                        task_code: $('#taskCode').val(),
                        points: parseInt($('#taskPoints').val()) || 0,
                        deadline: $('#taskDeadline').val(),
                        description: $('#taskDescription').val(),
                        created_by: currentUser.id
                    };

                    await db.createTask(taskData);
                    
                    // Clear form
                    $('#addTaskForm')[0].reset();
                    
                    // Close modal
                    closeModal();
                    
                    // Reload tasks
                    await loadTasks();
                    
                    console.log('Task created successfully!');
                } catch (error) {
                    console.error('Error creating task:', error);
                    console.log('Error creating task. Please try again.');
                }
            }

            async function handleEditTaskSubmit(e) {
                e.preventDefault();
                
                try {
                    const taskId = $('#editTaskForm').data('task-id');
                    
                    if (!taskId) {
                        console.error('No task ID found');
                        alert('Error: No task ID found. Please close and try again.');
                        return;
                    }
                    
                    const taskData = {
                        title: $('#editTaskName').val(),
                        task_code: $('#editTaskCode').val(),
                        points: parseInt($('#editTaskPoints').val()) || 0,
                        deadline: $('#editTaskDeadline').val(),
                        description: $('#editTaskDescription').val()
                    };

                    // Update task in database
                    const { data, error } = await supabase
                        .from('tasks')
                        .update(taskData)
                        .eq('id', taskId)
                        .select();

                    if (error) {
                        console.error('Error updating task:', error);
                        alert('Error updating task. Please try again.');
                        return;
                    }
                    
                    console.log('Task updated successfully:', data);
                    
                    // Close modal
                    closeEditTaskModal();
                    
                    // Reload tasks
                    await loadTasks();
                    
                    alert('Task updated successfully!');
                } catch (error) {
                    console.error('Error updating task:', error);
                    alert('Error updating task. Please try again.');
                }
            }

            async function handleAnnouncementEdit(e) {
                e.preventDefault();
                
                try {
                    const announcementId = $('#editAnnouncementForm').data('announcement-id');
                    console.log('Announcement ID from form data:', announcementId);
                    
                    const announcementData = {
                        message: $('#editAnnouncementMessage').val(),
                        is_active: $('#editAnnouncementActive').is(':checked')
                    };

                    console.log('Updating announcement with data:', announcementData);

                    if (typeof db.updateAnnouncement === 'function') {
                        await db.updateAnnouncement(announcementId, announcementData);
                        
                        // Clear form and close modal
                        $('#editAnnouncementForm')[0].reset();
                        closeModal();
                        
                        // Reload announcements
                        await loadAnnouncements();
                        
                        console.log('Announcement updated successfully!');
                    } else {
                        // Update the stored announcements for demo purposes
                        if (window.currentAnnouncements) {
                            const announcementIndex = window.currentAnnouncements.findIndex(a => a.id === announcementId);
                            if (announcementIndex !== -1) {
                                window.currentAnnouncements[announcementIndex].message = announcementData.message;
                                window.currentAnnouncements[announcementIndex].is_active = announcementData.is_active;
                                
                                // Re-render with updated data
                                renderAnnouncements(window.currentAnnouncements);
                                
                                // Clear form and close modal
                                $('#editAnnouncementForm')[0].reset();
                                closeModal();
                                
                                console.log('Announcement updated successfully (demo mode)!');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error updating announcement:', error);
                    alert('Error updating announcement: ' + (error.message || 'Please try again.'));
                }
            }

            async function loadPointRequests(preserveCurrentTab = false) {
                try {
                    // Store current tab state if preserving
                    let currentTabType = 'active'; // default to "New"
                    if (preserveCurrentTab) {
                        const activeTab = document.querySelector('.sub-tab.active');
                        currentTabType = activeTab ? activeTab.getAttribute('data-subtab') : 'active';
                    }
                    
                    // Try to load point requests from database
                    let pointRequests = [];
                    
                    if (typeof db.getPointRequests === 'function') {
                        pointRequests = await db.getPointRequests();
                    } else {
                        console.log('Point requests system not yet implemented in database');
                    }
                    
                    // Store all requests for filtering
                    allPointRequests = pointRequests;
                    
                    // Show requests based on preserved tab or default to "New"
                    if (currentTabType === 'inactive') {
                        // Show "Past" requests (approved or declined)
                        const pastRequests = pointRequests.filter(request => 
                            request.status === 'approved' || request.status === 'declined'
                        );
                        console.log(`Loaded ${pointRequests.length} total requests, showing ${pastRequests.length} past requests`);
                        await renderPointRequests(pastRequests);
                    } else {
                        // Show "New" requests (pending)
                        const pendingRequests = pointRequests.filter(request => 
                            request.status === 'pending' || !request.status
                        );
                        console.log(`Loaded ${pointRequests.length} total requests, showing ${pendingRequests.length} pending requests`);
                        await renderPointRequests(pendingRequests);
                    }
                } catch (error) {
                    console.error('Error loading point requests:', error);
                    allPointRequests = [];
                    await renderPointRequests([]);
                }
            }

            // File viewing and download functions
            function getFileIconClass(extension) {
                const iconMap = {
                    'pdf': 'bi-file-earmark-pdf',
                    'doc': 'bi-file-earmark-word',
                    'docx': 'bi-file-earmark-word',
                    'xls': 'bi-file-earmark-excel',
                    'xlsx': 'bi-file-earmark-excel',
                    'ppt': 'bi-file-earmark-ppt',
                    'pptx': 'bi-file-earmark-ppt',
                    'jpg': 'bi-file-earmark-image',
                    'jpeg': 'bi-file-earmark-image',
                    'png': 'bi-file-earmark-image',
                    'gif': 'bi-file-earmark-image',
                    'svg': 'bi-file-earmark-image',
                    'mp4': 'bi-file-earmark-play',
                    'avi': 'bi-file-earmark-play',
                    'mov': 'bi-file-earmark-play',
                    'mp3': 'bi-file-earmark-music',
                    'wav': 'bi-file-earmark-music',
                    'txt': 'bi-file-earmark-text',
                    'zip': 'bi-file-earmark-zip',
                    'rar': 'bi-file-earmark-zip'
                };
                return iconMap[extension] || 'bi-file-earmark';
            }

            async function viewFile(fileUrl, fileName) {
                try {
                    // Create modal for file viewing
                    const modal = document.createElement('div');
                    modal.className = 'file-view-modal';
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 2rem;
                    `;

                    const fileExtension = fileName.split('.').pop().toLowerCase();
                    let modalContent = '';

                    if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(fileExtension)) {
                        // Image preview
                        modalContent = `
                            <div style="background: white; border-radius: 12px; max-width: 90vw; max-height: 90vh; overflow: hidden; position: relative;">
                                <div style="padding: 1rem; border-bottom: 1px solid #e9ecef; display: flex; justify-content: between; align-items: center;">
                                    <h3 style="margin: 0; color: #1B4965;">${fileName}</h3>
                                    <button onclick="this.closest('.file-view-modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; position: absolute; right: 1rem;">&times;</button>
                                </div>
                                <div style="padding: 1rem; text-align: center;">
                                    <img src="${fileUrl}" alt="${fileName}" style="max-width: 100%; max-height: 70vh; object-fit: contain;">
                                </div>
                                <div style="padding: 1rem; border-top: 1px solid #e9ecef; text-align: center;">
                                    <button onclick="downloadFile('${fileUrl}', '${fileName}')" style="background: #1B4965; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">Download</button>
                                </div>
                            </div>
                        `;
                    } else if (fileExtension === 'pdf') {
                        // PDF preview
                        modalContent = `
                            <div style="background: white; border-radius: 12px; width: 90vw; height: 90vh; overflow: hidden; position: relative;">
                                <div style="padding: 1rem; border-bottom: 1px solid #e9ecef; display: flex; justify-content: between; align-items: center;">
                                    <h3 style="margin: 0; color: #1B4965;">${fileName}</h3>
                                    <button onclick="this.closest('.file-view-modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; position: absolute; right: 1rem;">&times;</button>
                                </div>
                                <iframe src="${fileUrl}" style="width: 100%; height: calc(100% - 120px); border: none;"></iframe>
                                <div style="padding: 1rem; border-top: 1px solid #e9ecef; text-align: center;">
                                    <button onclick="downloadFile('${fileUrl}', '${fileName}')" style="background: #1B4965; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">Download</button>
                                </div>
                            </div>
                        `;
                    } else {
                        // Generic file preview
                        modalContent = `
                            <div style="background: white; border-radius: 12px; max-width: 500px; padding: 2rem; position: relative; text-align: center;">
                                <button onclick="this.closest('.file-view-modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; position: absolute; right: 1rem; top: 1rem;">&times;</button>
                                <i class="${getFileIconClass(fileExtension)}" style="font-size: 4rem; color: #1B4965; margin-bottom: 1rem;"></i>
                                <h3 style="color: #1B4965; margin-bottom: 0.5rem;">${fileName}</h3>
                                <p style="color: #6c757d; margin-bottom: 2rem;">This file type cannot be previewed. Click download to view the file.</p>
                                <button onclick="downloadFile('${fileUrl}', '${fileName}')" style="background: #1B4965; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-weight: 600;">Download File</button>
                            </div>
                        `;
                    }

                    modal.innerHTML = modalContent;
                    document.body.appendChild(modal);

                    // Close modal when clicking outside
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });

                    // Close modal with Escape key
                    document.addEventListener('keydown', function escapeHandler(e) {
                        if (e.key === 'Escape') {
                            modal.remove();
                            document.removeEventListener('keydown', escapeHandler);
                        }
                    });

                } catch (error) {
                    console.error('Error viewing file:', error);
                    alert('Error loading file preview. Please try downloading the file instead.');
                }
            }

            async function downloadFile(fileUrl, fileName) {
                try {
                    const link = document.createElement('a');
                    link.href = fileUrl;
                    link.download = fileName;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } catch (error) {
                    console.error('Error downloading file:', error);
                    // Fallback: open in new tab
                    window.open(fileUrl, '_blank');
                }
            }

            async function renderPointRequests(requests) {
                const container = $('#pointRequestsList');
                container.empty();

                if (requests.length === 0) {
                    container.html(`
                        <div class="empty-state">
                            <h3>No point requests found</h3>
                            <p>Point requests will appear here when users submit them.</p>
                        </div>
                    `);
                    return;
                }

                for (const request of requests) {
                    // Fetch complete user data from database
                    let user = request.user;
                    let userName = 'Unknown User';
                    let userRole = 'Unknown Role';
                    let chapterName = 'No Chapter';
                    
                    // If we don't have complete user data, fetch it from database
                    if (!user || !user.role) {
                        try {
                            const { data: userData, error: userError } = await supabase
                                .from('users')
                                .select('id, first_name, last_name, role, chapter_id')
                                .eq('id', request.user_id)
                                .single();
                            
                            if (!userError && userData) {
                                user = userData;
                            }
                        } catch (error) {
                            console.error('Error fetching user data:', error);
                        }
                    }
                    
                    // Set user name
                    if (user) {
                        userName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Unknown User';
                        
                        // Get user role
                        userRole = user.role || 'Unknown Role';
                        const roleDisplay = userRole === 'chapter_director' ? 'Chapter Director' : 
                                           userRole === 'chapter_lead' ? 'Chapter Lead' : 
                                           userRole === 'deputy_chapter_lead' ? 'Deputy Chapter Lead' :
                                           userRole === 'regional_lead' ? 'Regional Lead' :
                                           userRole === 'member' ? 'Member' : 
                                           userRole === 'admin' ? 'Admin' : userRole;
                        userRole = roleDisplay;
                        
                        // Get chapter information
                        if (user.chapter_id) {
                            try {
                                const { data: chapter, error } = await supabase
                                    .from('chapters')
                                    .select('school_name, chapter_code')
                                    .eq('id', user.chapter_id)
                                    .single();
                                
                                if (!error && chapter) {
                                    chapterName = `${chapter.school_name} (${chapter.chapter_code})`;
                                }
                            } catch (error) {
                                console.error('Error fetching chapter info:', error);
                            }
                        }
                    }
                    
                    // Use the task code from the request (user-entered) or fall back to joined task data
                    const task = request.task;
                    const taskCode = request.task_code || (task ? task.task_code : 'N/A');
                    const taskName = request.task_name || (task ? task.title || task.name : null) || 'Unknown Task';
                    
                    // Get chapter code for header
                    let chapterCode = 'N/A';
                    if (user && user.chapter_id) {
                        try {
                            const { data: chapter, error } = await supabase
                                .from('chapters')
                                .select('chapter_code')
                                .eq('id', user.chapter_id)
                                .single();
                            
                            if (!error && chapter) {
                                chapterCode = chapter.chapter_code;
                            }
                        } catch (error) {
                            console.error('Error fetching chapter code:', error);
                        }
                    }
                    
                    console.log('DEBUG - Request points_awarded value:', request.points_awarded, typeof request.points_awarded);
                    console.log('DEBUG - Full request object for debugging:', request);
                    
                    const requestCard = `
                        <div class="request-card">
                            <div class="request-header">
                                <h3 class="request-title">${chapterCode} - ${taskName}</h3>
                                <span class="task-points">${request.points_awarded} points requested</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div class="request-meta" style="flex: 1;">
                                    <div><strong>Submitted by:</strong> ${userName}</div>
                                    <div><strong>Role:</strong> ${userRole}</div>
                                    <div><strong>Task Code:</strong> ${taskCode}</div>
                                    <div><strong>Submitted:</strong> ${new Date(request.completed_at || request.submitted_at || request.created_at).toLocaleDateString()}</div>
                            </div>
                                <div class="request-actions" style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                                    ${(request.status === 'pending' || !request.status) ? `
                                <button class="btn-approve" onclick="approveRequest(${request.id}, '${request.submission_type || 'task_completion'}')">Approve</button>
                                        <button class="btn-decline" onclick="declineRequest(${request.id}, '${request.submission_type || 'task_completion'}')" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">Decline</button>
                                    ` : ''}
                                    <button class="btn-modify" onclick="modifyRequest(${request.id})">View Request</button>
                                </div>
                            </div>
                            <!-- Hidden evidence and files data for modal access -->
                            <div class="request-meta evidence-text" style="display: none;">
                                <strong>Evidence:</strong> ${request.evidence}
                                ${request.file_urls && request.file_urls.trim() ? `
                                    <div class="attached-files" style="margin-top: 1rem;">
                                        <strong>Attached Files:</strong>
                                        <div class="file-list" style="margin-top: 0.5rem;">
                                            ${request.file_urls.split(',').filter(url => url.trim()).map(fileUrl => {
                                                const cleanUrl = fileUrl.trim();
                                                const fileName = cleanUrl.split('/').pop() || 'unknown_file';
                                                const fileExtension = fileName.includes('.') ? fileName.split('.').pop().toLowerCase() : 'unknown';
                                                return `
                                                    <div class="file-item" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                                                        <i class="file-icon ${getFileIconClass(fileExtension)}"></i>
                                                        <span class="file-name" style="flex: 1; font-size: 0.9rem;">${fileName}</span>
                                                        <button onclick="viewFile('${cleanUrl}', '${fileName}')" class="btn-view-file" style="background: #1B4965; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">View</button>
                                                        <button onclick="downloadFile('${cleanUrl}', '${fileName}')" class="btn-download-file" style="background: #6c757d; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">Download</button>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    container.append(requestCard);
                }
            }

            async function loadChapterRequests() {
                try {
                    console.log('Loading chapter requests...');
                    console.log('Database object available:', !!window.db);
                    console.log('getChapterRequests function available:', typeof db.getChapterRequests);
                    
                    // Try to load chapter requests from database
                    let chapterRequests = [];
                    
                    if (typeof db.getChapterRequests === 'function') {
                        console.log('Calling db.getChapterRequests(pending)...');
                        chapterRequests = await db.getChapterRequests('pending');
                        console.log('Chapter requests loaded:', chapterRequests);
                    } else {
                        console.log('Chapter requests system not yet implemented in database');
                    }
                    
                    console.log('Rendering chapter requests:', chapterRequests.length, 'requests');
                    renderChapterRequests(chapterRequests);
                } catch (error) {
                    console.error('Error loading chapter requests:', error);
                    console.error('Error details:', error.message);
                    renderChapterRequests([]);
                }
            }

            function renderChapterRequests(requests) {
                const container = $('#chapterRequestsList');
                container.empty();

                if (requests.length === 0) {
                    container.html(`
                        <div class="empty-state">
                            <h3>No chapter requests found</h3>
                            <p>Chapter requests will appear here when they are submitted.</p>
                        </div>
                    `);
                    return;
                }

                requests.forEach(request => {
                    const requestCard = `
                        <div class="request-card">
                            <div class="request-header">
                                <h3 class="request-title">New Chapter Request</h3>
                                <span class="task-points">Chapter Creation Request</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                                <div class="request-meta" style="flex: 1;">
                                    <div><strong>Submitted by:</strong> ${request.user_name || 'Not specified'}</div>
                                    <div><strong>School:</strong> ${request.school_name || 'Not specified'}</div>
                                    <div><strong>Submitted:</strong> ${new Date(request.requested_at || request.created_at).toLocaleDateString()}</div>
                                </div>
                                <div class="request-actions" style="display: flex; gap: 0.5rem; margin-left: 1rem;">
                                    ${(request.status === 'pending' || !request.status) ? `
                                        <button class="btn-approve" onclick="approveChapterRequest(${request.id})">Approve</button>
                                        <button class="btn-decline" onclick="rejectChapterRequest(${request.id})" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">Decline</button>
                                    ` : ''}
                                    <button class="btn-modify" onclick="viewChapterRequest(${request.id})">View Request</button>
                                </div>
                            </div>
                            <!-- Hidden reason data for modal access -->
                            <div class="request-meta evidence-text" style="display: none;">
                                <strong>Reason:</strong> ${request.reason || 'Not specified'}
                            </div>
                        </div>
                    `;
                    container.append(requestCard);
                });
            }

            async function approveChapterRequest(requestId) {
                // Show the chapter code input modal
                showChapterCodeModal(requestId);
            }

            function showChapterCodeModal(requestId) {
                // Get the request data to show school name
                db.getChapterRequests().then(requests => {
                    const request = requests.find(r => r.id === requestId);
                    if (!request) {
                        showToast('Chapter request not found', 'error');
                        return;
                    }

                    // Generate a suggested code
                    const schoolAbbrev = request.school_name.split(' ').map(word => word[0]).join('').toUpperCase();
                    const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                    const suggestedCode = `${schoolAbbrev}${randomNum}`;

                    // Create and show the modal
                    const modalHtml = `
                        <div class="modal-overlay" id="chapterCodeModal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;">
                            <div class="modal-content" style="background: white; border-radius: 16px; padding: 0; overflow: hidden; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15); max-width: 500px; width: 90%;">
                                <!-- Modal Header -->
                                <div style="background: linear-gradient(135deg, #1B4965 0%, #2c5f7a 100%); padding: 1.5rem; color: white;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                        <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: white; text-align: left;">Approve Chapter Request</h3>
                                        <button onclick="closeChapterCodeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: white; opacity: 0.8; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">&times;</button>
                                    </div>
                                    <p style="margin: 0; font-size: 1rem; opacity: 0.9; font-weight: 400; text-align: left;">Set chapter code for ${request.school_name}</p>
                                </div>
                                
                                <!-- Modal Body -->
                                <div style="padding: 1.5rem; text-align: left;">
                                    <div style="background: #e8f4f8; border-left: 4px solid #1B4965; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
                                        <p style="margin: 0; color: #1B4965; font-size: 0.95rem; line-height: 1.5; font-weight: 500; text-align: left;">
                                            <strong>Request Details:</strong><br>
                                            • Requester: ${request.user_name || 'N/A'}<br>
                                            • School: ${request.school_name}<br>
                                            • Email: ${request.user_email || 'N/A'}
                                        </p>
                                    </div>
                                    
                                    <div class="form-group" style="text-align: left;">
                                        <label class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333; text-align: left;">Chapter Code *</label>
                                        <input type="text" id="customChapterCode" class="form-control" placeholder="Enter chapter code" value="${suggestedCode}" style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s; text-align: left;" onfocus="this.style.borderColor='#1B4965'" onblur="this.style.borderColor='#e9ecef'">
                                        <small style="color: #6c757d; font-size: 0.9rem; margin-top: 0.5rem; display: block; text-align: left;">Suggested code: ${suggestedCode} (you can modify this)</small>
                                    </div>
                                    
                                    <div style="margin-top: 1rem; text-align: left;">
                                        <label style="display: flex; align-items: flex-start; margin-bottom: 0.5rem; text-align: left;">
                                            <input type="checkbox" id="confirmApproval" style="margin-right: 0.5rem; margin-top: 0.2rem;">
                                            <span style="font-size: 0.9rem; color: #333; text-align: left;">I confirm that I want to approve this chapter request and promote the user to Chapter Director</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Modal Footer -->
                                <div style="background: #f8f9fa; padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; gap: 1rem; justify-content: flex-end;">
                                    <button onclick="closeChapterCodeModal()" style="background: #6c757d; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; font-size: 0.95rem;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">Cancel</button>
                                    <button onclick="confirmChapterApproval(${requestId})" style="background: linear-gradient(135deg, #1B4965 0%, #2c5f7a 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: 0.95rem; box-shadow: 0 2px 8px rgba(27, 73, 101, 0.3);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(27, 73, 101, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(27, 73, 101, 0.3)'">Approve Chapter</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Add modal to page
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    
                    // Focus on the input
                    setTimeout(() => {
                        document.getElementById('customChapterCode').focus();
                    }, 100);
                }).catch(error => {
                    console.error('Error getting request data:', error);
                    showToast('Error loading request data', 'error');
                });
            }

            function closeChapterCodeModal() {
                const modal = document.getElementById('chapterCodeModal');
                if (modal) {
                    modal.remove();
                }
            }

            async function confirmChapterApproval(requestId) {
                const customCode = document.getElementById('customChapterCode').value.trim();
                const isConfirmed = document.getElementById('confirmApproval').checked;
                
                if (!customCode) {
                    showToast('Please enter a chapter code', 'error');
                    return;
                }
                
                if (!isConfirmed) {
                    showToast('Please confirm the approval', 'error');
                    return;
                }
                
                try {
                    console.log('Approving chapter request with custom code:', requestId, customCode);
                    
                    // Find the request card element
                    const requestCard = $(`.request-card`).filter(function() {
                        return $(this).find('.btn-approve').attr('onclick') && $(this).find('.btn-approve').attr('onclick').includes(`approveChapterRequest(${requestId})`);
                    });
                    
                    if (requestCard.length === 0) {
                        console.error('Could not find chapter request card for ID:', requestId);
                        showToast('Error: Could not find the request card', 'error');
                        return;
                    }
                    
                    // Disable the approve button to prevent multiple clicks
                    const approveBtn = requestCard.find('.btn-approve');
                    approveBtn.prop('disabled', true).text('Approving...');
                    
                    const result = await db.approveChapterRequest(requestId, customCode);
                    console.log('Approval result:', result);
                    
                    // Show success message based on the result structure
                    let message = 'Chapter request approved successfully!';
                    if (result && result.chapter) {
                        message = `Chapter request approved successfully! 
                        • New chapter created: ${result.chapter.chapter_code || 'N/A'}
                        • User promoted to Chapter Director
                        • School added to rankings: ${result.chapter.school_name || 'N/A'}`;
                    } else if (result && result.success) {
                        message = 'Chapter request approved successfully! User promoted to Chapter Director.';
                    }
                    
                    showToast(message, 'success');
                    
                    // Close the modal
                    closeChapterCodeModal();
                    
                    // Add approved class for animation
                    console.log('Adding approved class to request card:', requestCard);
                    requestCard.addClass('approved');
                    
                    // Remove the card from DOM after animation completes
                    setTimeout(() => {
                        console.log('Removing request card from DOM');
                        requestCard.remove();
                    }, 300);
                    
                    // Also reload stats since we now have a new chapter
                    const stats = await db.getStats();
                    updateStatsDisplay(stats);
                    
                    // Success - no automatic redirect or popup for admin
                    
                } catch (error) {
                    console.error('Error approving chapter request:', error);
                    showToast('Error approving chapter request: ' + error.message, 'error');
                    
                    // Re-enable button on error
                    const requestCard = $(`.request-card`).filter(function() {
                        return $(this).find('.btn-approve').attr('onclick') && $(this).find('.btn-approve').attr('onclick').includes(`approveChapterRequest(${requestId})`);
                    });
                    if (requestCard.length > 0) {
                        const approveBtn = requestCard.find('.btn-approve');
                        approveBtn.prop('disabled', false).text('Approve');
                    }
                }
            }

            async function rejectChapterRequest(requestId) {
                try {
                    // Show confirmation dialog
                    if (!confirm('Are you sure you want to reject this chapter request? This action cannot be undone.')) {
                        return;
                    }

                    console.log('Rejecting chapter request:', requestId);
                    
                    // Find the request card element
                    const requestCard = $(`.request-card`).filter(function() {
                        return $(this).find('.btn-decline').attr('onclick') && $(this).find('.btn-decline').attr('onclick').includes(`rejectChapterRequest(${requestId})`);
                    });
                    
                    if (requestCard.length === 0) {
                        console.error('Could not find chapter request card for ID:', requestId);
                        showToast('Error: Could not find the request card', 'error');
                        return;
                    }
                    
                    // Disable the decline button to prevent multiple clicks
                    const declineBtn = requestCard.find('.btn-decline');
                    declineBtn.prop('disabled', true).text('Rejecting...');
                    
                    const result = await db.rejectChapterRequest(requestId);
                    console.log('Rejection result:', result);
                    
                    showToast('Chapter request rejected successfully! User remains a regular member.', 'success');
                    
                    // Add declined class for animation (slide left)
                    console.log('Adding declined class to request card:', requestCard);
                    requestCard.addClass('declined');
                    
                    // Remove the card from DOM after animation completes
                    setTimeout(() => {
                        console.log('Removing request card from DOM');
                        requestCard.remove();
                    }, 300);
                    
                } catch (error) {
                    console.error('Error rejecting chapter request:', error);
                    showToast('Error rejecting chapter request: ' + error.message, 'error');
                    
                    // Re-enable button on error
                    const requestCard = $(`.request-card`).filter(function() {
                        return $(this).find('.btn-decline').attr('onclick') && $(this).find('.btn-decline').attr('onclick').includes(`rejectChapterRequest(${requestId})`);
                    });
                    if (requestCard.length > 0) {
                        const declineBtn = requestCard.find('.btn-decline');
                        declineBtn.prop('disabled', false).text('Decline');
                    }
                }
            }

            // Function removed - no longer redirecting or showing popups for chapter director approvals

            function closeChapterDirectorRedirectModal() {
                const modal = document.getElementById('chapterDirectorRedirectModal');
                if (modal) {
                    modal.remove();
                }
            }

            function openChapterDirectorDashboard() {
                // Open chapter dashboard in new tab
                // The session has already been updated with the new role
                window.open('chapter_director_dash.html', '_blank');
                closeChapterDirectorRedirectModal();
            }

            // Function to check if user's role has been updated in the database
            async function checkForRoleUpdate() {
                try {
                    const userData = sessionStorage.getItem('iyna_user');
                    if (!userData) return;
                    
                    const user = JSON.parse(userData);
                    console.log('Checking for role update for user:', user.email);
                    
                    // Get fresh user data from database
                    const freshUser = await db.getUserByEmail(user.email);
                    
                    if (freshUser && freshUser.role !== user.role) {
                        console.log('Role change detected:', user.role, '->', freshUser.role);
                        
                        // Update session with fresh data
                        sessionStorage.setItem('iyna_user', JSON.stringify(freshUser));
                        
                        // User role changed - no automatic redirect for admin dashboard
                    }
                } catch (error) {
                    console.error('Error checking for role update:', error);
                }
            }

            // Function to periodically check for role changes
            function startPeriodicRoleCheck() {
                setInterval(async () => {
                    try {
                        if (!currentUser || !currentUser.email) return;
                        
                        console.log('Performing periodic role check...');
                        const freshUser = await db.getUserByEmail(currentUser.email);
                        
                        if (freshUser && freshUser.role !== currentUser.role) {
                            console.log(`Role change detected during periodic check: ${currentUser.role} -> ${freshUser.role}`);
                            
                            // Update session with fresh data
                            sessionStorage.setItem('iyna_user', JSON.stringify(freshUser));
                            currentUser = freshUser;
                            
                            // Check if user still has admin access
                            if (freshUser.role !== 'admin') {
                                console.log('User no longer has admin privileges, redirecting...');
                                
                                // Show notification to user
                                showRoleChangeNotification(freshUser.role);
                                
                                // Redirect after a short delay
                                setTimeout(() => {
                                    if (freshUser.role === 'chapter_lead' || freshUser.role === 'chapter_director') {
                                        window.location.href = 'chapter_director_dash.html';
                                    } else if (freshUser.role === 'member') {
                                        window.location.href = 'personal_dash.html';
                                    } else {
                                        window.location.href = 'login.html';
                                    }
                                }, 3000);
                            }
                        }
                    } catch (error) {
                        console.error('Error in periodic role check:', error);
                    }
                }, 10000); // Check every 10 seconds
            }

            // Function to show role change notification
            function showRoleChangeNotification(newRole) {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #f8d7da;
                    border: 1px solid #f5c6cb;
                    color: #721c24;
                    padding: 1rem;
                    border-radius: 8px;
                    z-index: 1000;
                    max-width: 300px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                `;
                
                let dashboardName = 'personal dashboard';
                if (newRole === 'chapter_lead' || newRole === 'chapter_director') {
                    dashboardName = 'chapter dashboard';
                }
                
                notification.innerHTML = `
                    <h4 style="margin: 0 0 0.5rem 0;">Role Change Detected</h4>
                    <p style="margin: 0 0 1rem 0;">Your role has been changed to <strong>${newRole}</strong>. You will be redirected to your ${dashboardName} in 3 seconds.</p>
                    <button onclick="this.parentElement.remove()" style="background: #6db9c3; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Close</button>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }

            async function loadAnnouncements() {
                try {
                    console.log('Loading announcements...');
                    // Try to load announcements from database
                    let announcements = [];
                    
                    if (typeof db.getAnnouncements === 'function') {
                        announcements = await db.getAnnouncements();
                        console.log('Loaded announcements from database:', announcements);
                    } else {
                        console.log('Announcements system not yet implemented in database');
                        // For testing, create some sample data
                        announcements = [
                            {
                                id: 1,
                                message: "Welcome to the IYNA Admin Dashboard!",
                                is_active: true,
                                created_at: new Date().toISOString()
                            },
                            {
                                id: 2,
                                message: "Please submit your tasks on time.",
                                is_active: false,
                                created_at: new Date().toISOString()
                            }
                        ];
                    }
                    
                    // Store globally for edit functionality
                    window.currentAnnouncements = announcements;
                    console.log('Stored announcements globally:', window.currentAnnouncements);
                    
                    renderAnnouncements(announcements);
                } catch (error) {
                    console.error('Error loading announcements:', error);
                    renderAnnouncements([]);
                }
            }

            function renderAnnouncements(announcements) {
                const container = $('#announcementsList');
                container.empty();

                if (announcements.length === 0) {
                    container.html(`
                        <div class="empty-state">
                            <h3>No announcements found</h3>
                            <p>Create your first announcement using the Add button below.</p>
                        </div>
                    `);
                    return;
                }

                announcements.forEach((announcement, index) => {
                    const status = announcement.is_active ? 'Active' : 'Inactive';
                    const statusColor = announcement.is_active ? '#5aa6b0' : '#6c757d';
                    
                                    // Check if this is the main announcement (priority = 1)
                const isMainAnnouncement = (announcement.priority === 1 || announcement.priority === '1') && announcement.is_active;
                    const mainLabel = isMainAnnouncement ? '<span style="background: #28a745; color: white; padding: 0.5rem 0.75rem; border-radius: 4px; font-size: 0.9rem; font-weight: 500; min-width: 60px; text-align: center; display: inline-block;">MAIN</span>' : '';
                    const setMainButton = !isMainAnnouncement && announcement.is_active ? 
                        `<button class="edit-btn" onclick="setAsMainAnnouncement(${announcement.id})" style="background: #28a745; margin: 0; padding: 0.5rem 0.75rem; min-width: 80px; text-align: center;">Set as Main</button>` : '';
                    
                    const announcementCard = `
                        <div class="announcement-card" data-announcement-id="${announcement.id}" style="position: relative;">
                            <div class="announcement-text">${announcement.message || announcement.text}</div>
                            <div class="announcement-actions" style="position: absolute; bottom: 35px; right: 35px; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; z-index: 10;">
                                ${mainLabel}
                                ${setMainButton}
                                <span style="color: ${statusColor}; font-size: 0.9rem; font-weight: 500; padding: 0.5rem 0.75rem; background: #f8f9fa; border-radius: 4px; border: 1px solid #e9ecef;">${status}</span>
                                <button class="edit-btn" onclick="editAnnouncement(${announcement.id})" style="margin: 0; padding: 0.5rem 0.75rem; min-width: 60px; text-align: center;">Edit</button>
                                <button class="edit-btn" onclick="deleteAnnouncement(${announcement.id})" style="background: #dc3545; margin: 0; padding: 0.5rem 0.75rem; min-width: 60px; text-align: center;">Delete</button>
                            </div>
                        </div>
                    `;
                    container.append(announcementCard);
                });
            }

            function deleteTask(taskId) {
                currentModal = { type: 'delete', id: taskId };
                $('#deleteModal').css('display', 'flex');
            }

            function deleteEvent(eventId) {
                currentModal = { type: 'deleteEvent', id: eventId };
                $('#deleteEventModal').css('display', 'flex');
            }

            function rejectChapter(chapterId) {
                currentModal = { type: 'reject', id: chapterId };
                $('#rejectModal').css('display', 'flex');
            }

            function closeModal() {
                $('.modal-overlay').css('display', 'none');
                currentModal = null;
            }

            async function confirmDelete() {
                if (currentModal && currentModal.type === 'delete') {
                    try {
                        const result = await db.deleteTask(currentModal.id);
                        await loadTasks();
                        alert('Task deleted successfully!');
                    } catch (error) {
                        console.error('Error deleting task:', error);
                        
                        // Check if it's a foreign key constraint error
                        if (error.message.includes('user(s) have submitted completions')) {
                            const forceDelete = confirm(
                                error.message + '\n\n' +
                                'Do you want to FORCE DELETE this task?\n' +
                                'WARNING: This will permanently delete the task AND all user submissions for it.\n' +
                                'This action cannot be undone.\n\n' +
                                'Click OK to force delete, or Cancel to keep the task.'
                            );
                            
                            if (forceDelete) {
                                try {
                                    const forceResult = await db.forceDeleteTask(currentModal.id);
                                    await loadTasks();
                                    alert('Task and all related submissions deleted successfully!');
                                } catch (forceError) {
                                    console.error('Error force deleting task:', forceError);
                                    alert('Error force deleting task: ' + forceError.message);
                                }
                            }
                        } else {
                            alert('Error deleting task: ' + error.message);
                        }
                    }
                }
                closeModal();
            }

            async function confirmDeleteEvent() {
                if (currentModal && currentModal.type === 'deleteEvent') {
                    try {
                        const result = await db.deleteEvent(currentModal.id);
                        await loadEvents();
                        alert('Event deleted successfully!');
                    } catch (error) {
                        console.error('Error deleting event:', error);
                        alert('Error deleting event: ' + error.message);
                    }
                }
                closeModal();
            }

            async function confirmReject() {
                if (currentModal && currentModal.type === 'reject') {
                    try {
                        // This would need to be implemented in database.js
                        if (typeof db.rejectChapterRequest === 'function') {
                            await db.rejectChapterRequest(currentModal.id);
                            await loadChapterRequests();
                            console.log('Chapter rejected successfully!');
                        } else {
                            console.log('Chapter rejection functionality not yet implemented in database');
                        }
                    } catch (error) {
                        console.error('Error rejecting chapter:', error);
                        console.log('Error rejecting chapter.');
                    }
                }
                closeModal();
            }

            function editTask(taskId) {
                console.log('Editing task ID:', taskId);
                
                // Find the task data
                const task = allTasks.find(t => t.id === taskId);
                
                if (task) {
                    console.log('Found task data:', task);
                    
                    // Pre-fill the edit form
                    $('#editTaskName').val(task.title || '');
                    $('#editTaskCode').val(task.task_code || '');
                    $('#editTaskPoints').val(task.points || 10);
                    $('#editPointsType').val('per_member'); // Default to per_member
                    $('#editTaskDescription').val(task.description || '');
                    
                    // Format deadline for datetime-local input
                    if (task.deadline) {
                        const deadline = new Date(task.deadline);
                        const formattedDeadline = deadline.toISOString().slice(0, 16);
                        $('#editTaskDeadline').val(formattedDeadline);
                    }
                    
                    // Store the task ID for form submission
                    $('#editTaskForm').data('task-id', taskId);
                    
                    // Show the modal
                    $('#editTaskModal').css('display', 'flex');
                    
                    // Focus on the task name field
                    $('#editTaskName').focus();
                } else {
                    console.error('Task not found:', taskId);
                    alert('Task not found. Please refresh the page and try again.');
                }
            }

            function closeEditTaskModal() {
                $('#editTaskModal').css('display', 'none');
                
                // Clear form
                $('#editTaskForm')[0].reset();
                $('#editTaskForm').removeData('task-id');
            }

            function editAnnouncement(announcementId) {
                console.log('Editing announcement ID:', announcementId);
                console.log('Available announcements:', window.currentAnnouncements);
                
                // Find the announcement data
                const announcementData = window.currentAnnouncements?.find(a => a.id === announcementId);
                
                if (announcementData) {
                    console.log('Found announcement data:', announcementData);
                    
                    // Pre-fill the edit form
                    $('#editAnnouncementMessage').val(announcementData.message || announcementData.text || '');
                    $('#editAnnouncementActive').prop('checked', announcementData.is_active !== false);
                    
                    // Store the ID for form submission
                    $('#editAnnouncementForm').data('announcement-id', announcementId);
                    
                    // Show the modal
                    $('#editAnnouncementModal').css('display', 'flex');
                    
                    // Focus on the message field
                    setTimeout(() => {
                        $('#editAnnouncementMessage').focus();
                    }, 100);
                } else {
                    console.error('Could not find announcement with ID:', announcementId);
                    console.error('Available announcement IDs:', window.currentAnnouncements?.map(a => a.id));
                    console.log('Error: Could not find announcement data. Please refresh the page and try again.');
                }
            }

            async function deleteAnnouncement(announcementId) {
                if (confirm('Are you sure you want to delete this announcement? This cannot be undone.')) {
                    try {
                        if (typeof db.deleteAnnouncement === 'function') {
                            await db.deleteAnnouncement(announcementId);
                            await loadAnnouncements();
                            console.log('Announcement deleted successfully!');
                        } else {
                            // Remove from stored announcements for demo purposes
                            if (window.currentAnnouncements) {
                                window.currentAnnouncements = window.currentAnnouncements.filter(a => a.id !== announcementId);
                                renderAnnouncements(window.currentAnnouncements);
                                console.log('Announcement deleted successfully (demo mode)!');
                            }
                        }
                    } catch (error) {
                        console.error('Error deleting announcement:', error);
                        console.log('Error deleting announcement.');
                    }
                }
            }

            async function setAsMainAnnouncement(announcementId) {
                try {
                    console.log('Setting announcement as main:', announcementId);
                    
                    // Try to update with priority field, but handle gracefully if it doesn't exist
                    try {
                        // First, set all announcements priority to 0 (not main)
                    if (window.currentAnnouncements) {
                            for (const announcement of window.currentAnnouncements) {
                                if (announcement.id !== announcementId) {
                                    await db.updateAnnouncement(announcement.id, { priority: 0 });
                                }
                            }
                        }
                        
                        // Set the selected announcement as main (priority: 1)
                        await db.updateAnnouncement(announcementId, { priority: 1 });
                        
                        console.log(`Announcement ${announcementId} set as main in database with priority!`);
                    } catch (priorityError) {
                        console.warn('Priority field might not exist, using fallback method:', priorityError);
                        
                        // Fallback: Update the created_at timestamp to make it the newest
                        const now = new Date().toISOString();
                        await db.updateAnnouncement(announcementId, { created_at: now });
                        console.log(`Announcement ${announcementId} set as main using timestamp method!`);
                    }
                    
                    // Reload announcements from database to reflect the change
                    await loadAnnouncements();
                    
                    alert('Announcement set as main! This will now be displayed at the top of the dashboard.');
                    
                } catch (error) {
                    console.error('Error setting announcement as main:', error);
                    alert('Error setting announcement as main. Please try again.');
                }
            }



            async function approveRequest(requestId, submissionType = 'task_completion') {
                try {
                    // Find the request card element
                    const requestCard = $(`.request-card`).filter(function() {
                        return $(this).find('.btn-approve').attr('onclick').includes(`approveRequest(${requestId},`);
                    });
                    
                    // Disable the button to prevent multiple clicks
                    const approveBtn = requestCard.find('.btn-approve');
                    approveBtn.prop('disabled', true).text('Approving...');
                    
                    if (typeof db.approvePointRequest === 'function') {
                        await db.approvePointRequest(requestId, submissionType);
                        
                        // Add approved class for animation
                        requestCard.addClass('approved');
                        
                        // Remove the card from DOM after animation completes
                        setTimeout(() => {
                            requestCard.remove();
                        }, 300);
                        
                        console.log('Request approved successfully!');
                    } else {
                        console.log('Point request approval functionality not yet implemented in database');
                        
                        // Still animate the card for demo purposes
                        requestCard.addClass('approved');
                        setTimeout(() => {
                            requestCard.remove();
                        }, 300);
                    }
                } catch (error) {
                    console.error('Error approving request:', error);
                    
                    // Re-enable button on error
                    const requestCard = $(`.request-card`).filter(function() {
                        return $(this).find('.btn-approve').attr('onclick').includes(`approveRequest(${requestId},`);
                    });
                    const approveBtn = requestCard.find('.btn-approve');
                    approveBtn.prop('disabled', false).text('Approve');
                    
                    alert('Error approving request. Please try again.');
                }
            }

            async function declineRequest(requestId, submissionType = 'task_completion') {
                try {
                    // Show confirmation dialog
                    if (!confirm('Are you sure you want to decline this point request? This action cannot be undone.')) {
                        return;
                    }

                    // Find the request card element
                    const requestCard = $(`.request-card`).filter(function() {
                        return $(this).find('.btn-decline').attr('onclick').includes(`declineRequest(${requestId},`);
                    });
                    
                    // Disable the button to prevent multiple clicks
                    const declineBtn = requestCard.find('.btn-decline');
                    declineBtn.prop('disabled', true).text('Declining...');
                    
                    if (typeof db.declinePointRequest === 'function') {
                        await db.declinePointRequest(requestId, submissionType);
                        console.log('Request declined successfully!');
                    } else {
                        console.log('Point request decline functionality not yet implemented in database');
                        
                        // For now, update the status to 'declined' manually
                        try {
                            const { error } = await supabase
                                .from('user_task_completions')
                                .update({ status: 'declined' })
                                .eq('id', requestId);
                            
                            if (error) throw error;
                            console.log('Request marked as declined in database');
                        } catch (dbError) {
                            console.error('Error updating request status:', dbError);
                            throw dbError;
                        }
                    }
                    
                    // Add declined class for animation (slide left)
                    requestCard.addClass('declined');
                    
                    // Remove the card from DOM after animation completes
                    setTimeout(() => {
                        requestCard.remove();
                    }, 300);
                    
                } catch (error) {
                    console.error('Error declining request:', error);
                    
                    // Re-enable button on error
                    const requestCard = $(`.request-card`).filter(function() {
                        return $(this).find('.btn-decline').attr('onclick').includes(`declineRequest(${requestId},`);
                    });
                    const declineBtn = requestCard.find('.btn-decline');
                    declineBtn.prop('disabled', false).text('Decline');
                    
                    alert('Error declining request. Please try again.');
                }
            }

            let currentModifyRequestId = null;
            let originalPointsAwarded = null;

            function modifyRequest(requestId) {
                currentModifyRequestId = requestId;
                
                // Find the request card to extract data
                const requestCard = document.querySelector(`[onclick*="modifyRequest(${requestId})"]`).closest('.request-card');
                if (!requestCard) {
                    console.error('Request card not found');
                    return;
                }
                
                // Extract data from the card
                const titleElement = requestCard.querySelector('.request-title');
                const metaElements = requestCard.querySelectorAll('.request-meta > div');
                const evidenceElement = requestCard.querySelector('.evidence-text');
                const pointsElement = requestCard.querySelector('.task-points');
                
                // Parse the title (format: "THA005 - Lab Safety Training")
                const titleText = titleElement?.textContent || '';
                const dashIndex = titleText.indexOf(' - ');
                const taskCode = dashIndex !== -1 ? titleText.substring(0, dashIndex) : titleText;
                const taskName = dashIndex !== -1 ? titleText.substring(dashIndex + 3) : '';
                
                // Extract meta information
                let submittedBy = '', role = '', submittedDate = '', actualTaskCode = '';
                metaElements.forEach(element => {
                    const text = element.textContent;
                    if (text.includes('Submitted by:')) {
                        submittedBy = text.replace('Submitted by:', '').trim();
                    } else if (text.includes('Role:')) {
                        role = text.replace('Role:', '').trim();
                    } else if (text.includes('Task Code:')) {
                        actualTaskCode = text.replace('Task Code:', '').trim();
                    } else if (text.includes('Submitted:')) {
                        submittedDate = text.replace('Submitted:', '').trim();
                    }
                });
                
                // Extract evidence text (remove "Evidence:" prefix and file information)
                let evidenceText = '';
                if (evidenceElement) {
                    // Clone the element to manipulate it without affecting the original
                    const evidenceClone = evidenceElement.cloneNode(true);
                    
                    // Remove the "Attached Files" section if it exists
                    const attachedFilesDiv = evidenceClone.querySelector('.attached-files');
                    if (attachedFilesDiv) {
                        attachedFilesDiv.remove();
                    }
                    
                    // Get the text content and clean it
                    let fullText = evidenceClone.textContent || '';
                    evidenceText = fullText.replace('Evidence:', '').trim();
                    
                    // Remove any remaining file-related text patterns
                    evidenceText = evidenceText
                        .replace(/Attached Files:[\s\S]*$/i, '') // Remove "Attached Files:" and everything after
                        .replace(/--- Attached Files ---[\s\S]*$/i, '') // Remove old format
                        .replace(/\s*View\s*Download\s*$/i, '') // Remove trailing View/Download buttons
                        .replace(/\d+\.\s*[\w\-_\.]+\s*\(\d+[\.\d]*\s*[KMGT]?B\)[\s\S]*$/i, '') // Remove file listings
                        .trim();
                }
                
                // Extract points (remove "points requested" suffix)
                const pointsText = pointsElement?.textContent || '';
                const currentPoints = pointsText.replace(/\s*points?\s*requested/i, '').trim();
                
                // Store original points for later comparison
                originalPointsAwarded = parseInt(currentPoints) || 0;
                
                // Extract file information
                const attachedFilesDiv = requestCard.querySelector('.attached-files');
                const fileItems = attachedFilesDiv ? attachedFilesDiv.querySelectorAll('.file-item') : [];
                
                // Populate the modal
                document.getElementById('modifySubmittedBy').textContent = submittedBy;
                document.getElementById('modifyRole').textContent = role;
                document.getElementById('modifyTaskCode').textContent = actualTaskCode || 'N/A';
                document.getElementById('modifyTaskName').textContent = taskName || 'N/A';
                document.getElementById('modifySubmittedDate').textContent = submittedDate;
                document.getElementById('modifyEvidence').textContent = evidenceText;
                document.getElementById('modifyPointsToAward').value = currentPoints;
                
                // Handle attached files
                const attachedFilesSection = document.getElementById('modifyAttachedFiles');
                const filesListDiv = document.getElementById('modifyFilesList');
                
                if (fileItems.length > 0) {
                    attachedFilesSection.style.display = 'block';
                    filesListDiv.innerHTML = '';
                    
                    fileItems.forEach((item, index) => {
                        const fileName = item.querySelector('.file-name')?.textContent || `File ${index + 1}`;
                        const viewButton = item.querySelector('.btn-view-file');
                        const downloadButton = item.querySelector('.btn-download-file');
                        
                        const fileItemHtml = `
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px;">
                                <i class="file-icon ${item.querySelector('.file-icon')?.className.split(' ')[1] || 'bi-file-earmark'}"></i>
                                <span style="flex: 1; font-size: 0.9rem;">${fileName}</span>
                                ${viewButton ? `<button onclick="${viewButton.getAttribute('onclick')}" style="background: #1B4965; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">View</button>` : ''}
                                ${downloadButton ? `<button onclick="${downloadButton.getAttribute('onclick')}" style="background: #6c757d; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">Download</button>` : ''}
                            </div>
                        `;
                        filesListDiv.innerHTML += fileItemHtml;
                    });
                } else {
                    attachedFilesSection.style.display = 'none';
                }
                
                // Show the modal
                document.getElementById('modifyRequestModal').style.display = 'flex';
            }

            function closeModifyRequestModal() {
                document.getElementById('modifyRequestModal').style.display = 'none';
                currentModifyRequestId = null;
                originalPointsAwarded = null;
            }

            // Handle form submission
            document.getElementById('modifyRequestForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!currentModifyRequestId) return;
                
                const pointsToAward = document.getElementById('modifyPointsToAward').value;
                
                console.log('Form values:', { 
                    pointsToAward, 
                    pointsToAwardType: typeof pointsToAward,
                    originalPointsAwarded,
                    originalPointsAwardedType: typeof originalPointsAwarded 
                });
                
                try {
                    const newPoints = parseInt(pointsToAward);
                    const pointsDifference = newPoints - originalPointsAwarded;
                    
                    console.log('Parsed values:', { newPoints, pointsDifference });
                    
                    console.log('Starting request update:', {
                        requestId: currentModifyRequestId,
                        originalPoints: originalPointsAwarded,
                        newPoints: newPoints,
                        pointsDifference: pointsDifference
                    });
                    
                    // Validate inputs
                    if (!currentModifyRequestId) {
                        throw new Error('No request ID found');
                    }
                    if (isNaN(newPoints) || newPoints < 0) {
                        throw new Error('Invalid points value');
                    }
                    
                    // Find the request to get user information
                    console.log('Looking for request in allPointRequests array:', allPointRequests.length, 'requests');
                    const request = allPointRequests.find(r => r.id == currentModifyRequestId);
                    console.log('Found request:', request);
                    
                    if (!request) {
                        throw new Error(`Request with ID ${currentModifyRequestId} not found in loaded requests`);
                    }
                    
                    // Update the request in the database
                    console.log('Updating request in database...');
                    const updateData = { 
                        points_awarded: newPoints
                    };
                    

                    
                    console.log('Update data:', updateData);
                    
                    const { data: updateResult, error: updateError } = await supabase
                        .from('user_task_completions')
                        .update(updateData)
                        .eq('id', currentModifyRequestId)
                        .select();
                    
                    console.log('Database update result:', { updateResult, updateError });
                    
                    if (updateError) {
                        throw new Error(`Database update failed: ${updateError.message}`);
                    }
                    
                    // Verify what was actually saved to the database
                    if (updateResult && updateResult.length > 0) {
                        console.log('Database confirmed points_awarded:', updateResult[0].points_awarded);
                    }
                    
                    // Update the local request data to reflect the change immediately
                    const localRequest = allPointRequests.find(r => r.id == currentModifyRequestId);
                    if (localRequest) {
                        console.log('Before update - local request points:', localRequest.points_awarded);
                        console.log('New points to set:', newPoints, typeof newPoints);
                        localRequest.points_awarded = newPoints;
                        console.log('After update - local request points:', localRequest.points_awarded);
                    } else {
                        console.error('Could not find local request with ID:', currentModifyRequestId);
                    }
                    
                    // Update user's total points if there's a difference
                    if (pointsDifference !== 0) {
                        console.log(`Points difference: ${pointsDifference} (would adjust user points if 'points' column existed)`);
                        
                        try {
                            console.log('Checking if users table has points column...');
                            
                            // First check if the points column exists
                            const { data: columnCheck, error: columnError } = await supabase
                                .from('users')
                                .select('points')
                                .eq('id', request.user_id)
                                .limit(1);
                            
                            if (columnError && columnError.message.includes('does not exist')) {
                                console.log('Users table does not have a points column. Skipping user points update.');
                                console.log('To enable point tracking, add a points column: ALTER TABLE users ADD COLUMN points INTEGER DEFAULT 0;');
                            } else if (columnError) {
                                console.error('Error checking points column:', columnError);
                            } else {
                                // Points column exists, proceed with update
                                console.log('Points column exists, updating user points...');
                                
                                const { data: userData, error: userError } = await supabase
                                    .from('users')
                                    .select('points')
                                    .eq('id', request.user_id)
                                    .single();
                                
                                if (userError) {
                                    console.error('Error fetching user points:', userError);
                                } else {
                                    const currentUserPoints = userData?.points || 0;
                                    const newUserPoints = currentUserPoints + pointsDifference;
                                    
                                    console.log(`User points adjustment: ${currentUserPoints} + ${pointsDifference} = ${newUserPoints}`);
                                    
                                    const { data: pointsUpdateResult, error: pointsUpdateError } = await supabase
                                        .from('users')
                                        .update({ points: newUserPoints })
                                        .eq('id', request.user_id)
                                        .select();
                                    
                                    if (pointsUpdateError) {
                                        console.error('Error updating user points:', pointsUpdateError);
                                    } else {
                                        console.log('User points updated successfully');
                                    }
                                }
                            }
                        } catch (pointsError) {
                            console.log('User points update failed (points column may not exist):', pointsError.message);
                        }
                    }
                    
                    closeModifyRequestModal();
                    
                    // Show success toast notification
                    showUpdateSuccessToast(`Points updated to ${newPoints} points`);
                    
                    // Reload the point requests while preserving the current tab
                    await loadPointRequests(true);
                    
                } catch (error) {
                    console.error('Error updating request:', error);
                    console.error('Error details:', {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    });
                    alert(`Error updating request: ${error.message}. Please check the console for details.`);
                }
            });

            // Close modal when clicking outside
            document.getElementById('modifyRequestModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModifyRequestModal();
                }
            });

            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.getElementById('modifyRequestModal').style.display === 'flex') {
                    closeModifyRequestModal();
                }
            });

            async function approveChapter(chapterId) {
                try {
                    if (typeof db.approveChapterRequest === 'function') {
                        await db.approveChapterRequest(chapterId);
                        await loadChapterRequests();
                        console.log('Chapter approved successfully!');
                    } else {
                        console.log('Chapter approval functionality not yet implemented in database');
                    }
                } catch (error) {
                    console.error('Error approving chapter:', error);
                    console.log('Error approving chapter.');
                }
            }

            // View chapter request details
            function viewChapterRequest(requestId) {
                // Find the request card and get the hidden reason data
                const requestCard = document.querySelector(`[onclick*="viewChapterRequest(${requestId})"]`).closest('.request-card');
                const reasonElement = requestCard.querySelector('.evidence-text');
                const reason = reasonElement ? reasonElement.textContent.replace('Reason: ', '') : 'No reason provided';
                
                // Get other request details from the visible elements
                const requesterName = requestCard.querySelector('.request-meta div:nth-child(1)').textContent.replace('Submitted by: ', '');
                const schoolName = requestCard.querySelector('.request-meta div:nth-child(2)').textContent.replace('School: ', '');
                const submittedDate = requestCard.querySelector('.request-meta div:nth-child(3)').textContent.replace('Submitted: ', '');
                
                // Create and show modal
                const modalHtml = `
                    <div class="modal-overlay" id="viewChapterRequestModal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; justify-content: center; align-items: center;">
                        <div class="modal-content" style="max-width: 600px; width: 95%; max-height: 80vh; overflow-y: auto; background: #fff; border-radius: 12px; padding: 0; position: relative; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);">
                            <div style="background: #1B4965; color: white; padding: 1.5rem; border-radius: 12px 12px 0 0;">
                                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: white; text-align: left;">View Chapter Request</h2>
                                <button type="button" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; color: white; cursor: pointer;" onclick="closeViewChapterRequestModal()">&times;</button>
                            </div>
                            
                            <div style="padding: 1.5rem;">
                                <!-- Request Details Section -->
                                <div class="request-info-section" style="margin-bottom: 2rem; text-align: left; display: flex; flex-direction: column; gap: 0.75rem;">
                                    <h3 style="color: #1B4965; margin: 0 0 1rem 0; font-size: 1.2rem;">Request Details</h3>
                                    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                                        <div style="flex: 1; min-width: 200px;">
                                            <strong>Submitted by:</strong><span style="margin-left: 0.5rem;">${requesterName}</span>
                                        </div>
                                        <div style="flex: 1; min-width: 200px;">
                                            <strong>School:</strong><span style="margin-left: 0.5rem;">${schoolName}</span>
                                        </div>
                                    </div>
                                    <div>
                                        <strong>Submitted:</strong><span style="margin-left: 0.5rem;">${submittedDate}</span>
                                    </div>
                                    
                                    <!-- Reason Section -->
                                    <div style="margin-top: 1rem;">
                                        <strong>Reason for Starting Chapter:</strong>
                                        <div style="margin-top: 0.5rem; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; text-align: left; white-space: normal; line-height: 1.5;">${reason}</div>
                                    </div>
                                </div>
                                
                                <div class="modal-actions" style="display: flex; gap: 1rem; justify-content: flex-end;">
                                    <button type="button" class="modal-btn cancel" onclick="closeViewChapterRequestModal()" style="background: #6c757d; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Close modal when clicking outside
                document.getElementById('viewChapterRequestModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeViewChapterRequestModal();
                    }
                });
                
                // Close modal with Escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && document.getElementById('viewChapterRequestModal').style.display === 'flex') {
                        closeViewChapterRequestModal();
                    }
                });
            }

            function closeViewChapterRequestModal() {
                const modal = document.getElementById('viewChapterRequestModal');
                if (modal) {
                    modal.remove();
                }
            }

            let allPointRequests = []; // Store all requests for filtering

            // Toast notification function
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toastContainer');
                
                // Check if any modal is open and position toast relative to modal
                const openModal = document.querySelector('.modal-overlay[style*="display: flex"]');
                if (openModal) {
                    // Move toast container inside the modal for proper positioning
                    toastContainer.classList.add('modal-open');
                    if (toastContainer.parentElement !== openModal) {
                        openModal.appendChild(toastContainer);
                    }
                } else {
                    toastContainer.classList.remove('modal-open');
                    if (toastContainer.parentElement !== document.body) {
                        document.body.appendChild(toastContainer);
                    }
                }
                
                // Create toast element
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <span class="toast-icon">${type === 'success' ? '✓' : '✕'}</span>
                    <span class="toast-message">${message}</span>
                    <button class="toast-close" onclick="removeToast(this.parentElement)">&times;</button>
                `;
                
                // Add to container
                toastContainer.appendChild(toast);
                
                // Show toast
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    removeToast(toast);
                }, 5000);
                
                // Reset container position after toast is gone
                setTimeout(() => {
                    if (toastContainer.children.length === 0) {
                        toastContainer.classList.remove('modal-open');
                        if (toastContainer.parentElement !== document.body) {
                            document.body.appendChild(toastContainer);
                        }
                    }
                }, 5500);
            }

            function showUpdateSuccessToast(message) {
                const toastContainer = document.getElementById('toastContainer');
                
                // Check if any modal is open and position toast relative to modal
                const openModal = document.querySelector('.modal-overlay[style*="display: flex"], .modal-overlay[style*="display:flex"]');
                if (openModal) {
                    // Move toast container inside the modal for proper positioning
                    toastContainer.classList.add('modal-open');
                    if (toastContainer.parentElement !== openModal) {
                        openModal.appendChild(toastContainer);
                    }
                } else {
                    // Reset to normal positioning
                    toastContainer.classList.remove('modal-open');
                    if (toastContainer.parentElement !== document.body) {
                        document.body.appendChild(toastContainer);
                    }
                }
                
                // Create toast element
                const toast = document.createElement('div');
                toast.className = 'toast success';
                toast.innerHTML = `
                    <span class="toast-icon">✓</span>
                    <span class="toast-message">${message}</span>
                    <button class="toast-close" onclick="removeToast(this.parentElement)">&times;</button>
                `;
                
                // Add to container
                toastContainer.appendChild(toast);
                
                // Trigger animation
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);
                
                // Auto-remove after 4 seconds
                setTimeout(() => {
                    removeToast(toast);
                }, 4000);
                
                // Reset container position after toast is gone
                setTimeout(() => {
                    if (toastContainer.children.length === 0) {
                        toastContainer.classList.remove('modal-open');
                        if (toastContainer.parentElement !== document.body) {
                            document.body.appendChild(toastContainer);
                        }
                    }
                }, 4500);
            }

            function removeToast(toast) {
                if (toast && toast.parentElement) {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.parentElement.removeChild(toast);
                        }
                    }, 300);
                }
            }

            function filterPointRequests(type) {
                console.log('Filtering point requests:', type);
                
                if (!allPointRequests || allPointRequests.length === 0) {
                    console.log('No requests to filter');
                    return;
                }
                
                let filteredRequests = [];
                
                if (type === 'active') {
                    // "New" requests - show pending requests
                    filteredRequests = allPointRequests.filter(request => 
                        request.status === 'pending' || !request.status
                    );
                } else if (type === 'inactive') {
                    // "Past" requests - show approved or declined requests
                    filteredRequests = allPointRequests.filter(request => 
                        request.status === 'approved' || request.status === 'declined'
                    );
                }
                
                console.log(`Showing ${filteredRequests.length} ${type} requests`);
                renderPointRequests(filteredRequests);
            }

            // Search functionality
            $('#taskSearch').on('input', function() {
                const searchTerm = $(this).val().toLowerCase();
                $('.task-card').each(function() {
                    const taskTitle = $(this).find('.task-title').text().toLowerCase();
                    const taskDescription = $(this).find('.task-description').text().toLowerCase();
                    const matches = taskTitle.includes(searchTerm) || taskDescription.includes(searchTerm);
                    $(this).toggle(matches);
                });
            });

            $('#pointRequestSearch').on('input', function() {
                const searchTerm = $(this).val().toLowerCase();
                $('.request-card').each(function() {
                    const requestTitle = $(this).find('.request-title').text().toLowerCase();
                    const matches = requestTitle.includes(searchTerm);
                    $(this).toggle(matches);
                });
            });

            $('#announcementSearch').on('input', function() {
                const searchTerm = $(this).val().toLowerCase();
                $('.announcement-card').each(function() {
                    const announcementText = $(this).find('.announcement-text').text().toLowerCase();
                    const matches = announcementText.includes(searchTerm);
                    $(this).toggle(matches);
                });
            });

            // Show Add Task Modal
            function showAddTaskForm() {
                // Reset form
                $('#addTaskForm')[0].reset();
                $('#taskPoints').val('10'); // Set default points
                $('#pointsType').val('per_member'); // Set default points type
                
                // Show modal
                $('#addTaskModal').css('display', 'flex');
                
                // Focus on first input
                setTimeout(() => {
                    $('#taskName').focus();
                }, 100);
            }

            function showAddAnnouncementForm() {
                // For now, just show a prompt for announcement text
                const announcementText = prompt('Enter announcement text:');
                if (announcementText && announcementText.trim()) {
                    createAnnouncement(announcementText.trim());
                }
            }

            async function createAnnouncement(message) {
                try {
                    const announcementData = {
                        message: message,
                        created_by: currentUser.id,
                        is_active: true
                    };

                    if (typeof db.createAnnouncement === 'function') {
                        await db.createAnnouncement(announcementData);
                        await loadAnnouncements();
                        console.log('Announcement created successfully!');
                    } else {
                        console.log('Announcement creation not yet implemented in database');
                    }
                } catch (error) {
                    console.error('Error creating announcement:', error);
                    console.log('Error creating announcement.');
                }
            }

            // Add Admin button functionality
            $('.add-admin-button').on('click', function() {
                showAddAdminModal();
            });

            function showAddAdminModal() {
                loadAdminUserList();
                $('#addAdminModal').css('display', 'flex');
                setTimeout(() => {
                    $('#adminUserSearch').focus();
                }, 100);
            }

            function closeAddAdminModal() {
                $('#addAdminModal').css('display', 'none');
                $('#adminUserSearch').val('');
                $('#adminUserList').empty();
            }

            async function loadAdminUserList() {
                let users = allUsers;
                if (!users || users.length === 0) {
                    try {
                        users = await db.getAllUsers();
                    } catch (e) {
                        users = [];
                    }
                }
                renderAdminUserList(users);
            }

            function renderAdminUserList(users) {
                const container = $('#adminUserList');
                container.empty();
                if (!users || users.length === 0) {
                    container.html('<div style="padding: 1rem; color: #6c757d;">No users found.</div>');
                    return;
                }
                users.forEach(user => {
                    const isAdmin = user.role === 'admin';
                    const removeBtn = isAdmin ? `<button class="remove-admin-btn" title="Remove Admin" onclick="removeAdminPrompt('${user.id}', event)">−</button>` : '';
                    const userRow = $(
                        `<div style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e9ecef;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 0;">
                                ${removeBtn}
                                <div style="text-align: left; flex: 1; min-width: 0;">
                                    <strong>${user.first_name || ''} ${user.last_name || ''}</strong><br>
                                    <span style="font-size: 0.9rem; color: #6c757d;">${user.email || ''}</span>
                                </div>
                            </div>
                            <button class="modal-btn confirm" style="background: #5aa6b0; color: white;" ${isAdmin ? 'disabled' : ''} onclick="makeUserAdmin('${user.id}')">${isAdmin ? 'Already Admin' : 'Make Admin'}</button>
                        </div>`
                    );
                    container.append(userRow);
                });
            }

            $(document).on('input', '#adminUserSearch', function() {
                const searchTerm = $(this).val().toLowerCase();
                const filtered = allUsers.filter(user => {
                    const name = `${user.first_name || ''} ${user.last_name || ''}`.toLowerCase();
                    const email = (user.email || '').toLowerCase();
                    return name.includes(searchTerm) || email.includes(searchTerm);
                });
                renderAdminUserList(filtered);
            });

            window.makeUserAdmin = async function(userId) {
                try {
                    await db.updateUserRole(userId, 'admin');
                    allUsers = await db.getAllUsers();
                    const searchTerm = $('#adminUserSearch').val().toLowerCase();
                    const filtered = allUsers.filter(user => {
                        const name = `${user.first_name || ''} ${user.last_name || ''}`.toLowerCase();
                        const email = (user.email || '').toLowerCase();
                        return name.includes(searchTerm) || email.includes(searchTerm);
                    });
                    renderAdminUserList(filtered);
                    alert('User promoted to admin!');
                } catch (e) {
                    alert('Failed to promote user.');
                }
            }

            window.removeAdminPrompt = function(userId, event) {
                event.stopPropagation();
                if (confirm('Are you sure you want to remove admin privileges from this user?')) {
                    removeAdmin(userId);
                }
            }

            async function removeAdmin(userId) {
                try {
                    await db.updateUserRole(userId, 'member');
                    allUsers = await db.getAllUsers();
                    const searchTerm = $('#adminUserSearch').val().toLowerCase();
                    const filtered = allUsers.filter(user => {
                        const name = `${user.first_name || ''} ${user.last_name || ''}`.toLowerCase();
                        const email = (user.email || '').toLowerCase();
                        return name.includes(searchTerm) || email.includes(searchTerm);
                    });
                    renderAdminUserList(filtered);
                    alert('Admin privileges removed.');
                } catch (e) {
                    alert('Failed to remove admin privileges.');
                }
            }

            // Add JS for Events tab (duplicate of Tasks tab logic)
            function switchTab(tab) {
                // Update navigation
                $('.nav-tab').removeClass('active');
                $(`.nav-tab[data-tab="${tab}"]`).addClass('active');
                // Show/hide content
                $('.tab-content').removeClass('active');
                $(`#${tab}-tab`).addClass('active');
            }

            // Event search functionality
            $('#eventSearch').on('input', function() {
                const searchTerm = $(this).val().toLowerCase();
                $('.event-card').each(function() {
                    const eventTitle = $(this).find('.task-title').text().toLowerCase();
                    const eventDescription = $(this).find('.task-description').text().toLowerCase();
                    const matches = eventTitle.includes(searchTerm) || eventDescription.includes(searchTerm);
                    $(this).toggle(matches);
                });
            });

            // Show Add Event Modal (reuse Add Task modal for now)
            function showAddEventForm() {
                $('#addEventForm')[0].reset();
                $('#addEventSuccess').hide();
                $('#addEventModal').css('display', 'flex');
                setTimeout(() => {
                    $('#eventTitle').focus();
                }, 100);
            }
            function closeAddEventModal() {
                $('#addEventModal').css('display', 'none');
                $('#addEventForm')[0].reset();
                $('#addEventSuccess').hide();
            }
            // Handle event creation form submission
            $('#addEventForm').on('submit', async function(e) {
                e.preventDefault();
                const title = $('#eventTitle').val();
                const description = $('#eventDescription').val();
                const event_date = $('#eventDateTime').val();
                const registration_deadline = $('#eventRegistrationDeadline').val();
                const location = $('#eventLocation').val();
                const event_link = $('#eventLink').val();
                const eventData = {
                    title,
                    description,
                    event_date,
                    registration_deadline: registration_deadline || null,
                    location: location || null,
                    event_link: event_link || null,
                    created_at: new Date().toISOString(),
                    created_by: currentUser.user?.id || currentUser.id
                };
                try {
                    if (typeof db.createEvent === 'function') {
                        await db.createEvent(eventData);
                        $('#addEventForm')[0].reset();
                        $('#addEventSuccess').show();
                        await loadEvents();
                        // Close the modal after success
                        $('#addEventModal').css('display', 'none');
                    } else {
                        alert('Event creation not implemented in database.js');
                    }
                } catch (err) {
                    alert('Failed to create event.');
                }
            });
            // Load and render events for the Events tab
            async function loadEvents() {
                try {
                    if (typeof db.getEvents === 'function') {
                        const events = await db.getEvents();
                        window.currentEvents = events; // Ensure editEvent can find events
                        renderEvents(events);
                    }
                } catch (err) {
                    $('#eventsList').html('<div class="empty-state"><h3>Error loading events</h3></div>');
                }
            }
            // Update renderEvents to accept events param
            function renderEvents(events) {
                const container = $('#eventsList');
                container.empty();
                if (!events || events.length === 0) {
                    container.html('<div class="empty-state"><h3>No events found</h3><p>Create your first event using the Add button above.</p></div>');
                    return;
                }
                // Filter events by status
                let filteredEvents = events;
                if (currentEventStatusFilter && currentEventStatusFilter !== 'all') {
                    filteredEvents = events.filter(e => {
                        // If event_date is in the past, treat as 'past' for filtering
                        const now = new Date();
                        const eventDate = e.event_date ? new Date(e.event_date) : null;
                        let displayStatus = e.status || 'upcoming';
                        if (eventDate && eventDate < now) displayStatus = 'past';
                        return displayStatus === currentEventStatusFilter;
                    });
                }
                if (filteredEvents.length === 0) {
                    container.html('<div class="empty-state"><h3>No events found for this status</h3></div>');
                    return;
                }
                filteredEvents.forEach(event => {
                    const creator = allUsers.find(u => u.id === event.created_by);
                    const creatorName = creator ? `${creator.first_name} ${creator.last_name}` : 'Unknown';
                    // Status label color and logic
                    let statusClass = 'event-status-upcoming';
                    let statusText = 'Upcoming';
                    const now = new Date();
                    const eventDate = event.event_date ? new Date(event.event_date) : null;
                    let displayStatus = event.status || 'upcoming';
                    if (eventDate && eventDate < now) displayStatus = 'past';
                    if (displayStatus === 'past') { statusClass = 'event-status-past'; statusText = 'Past'; }
                    else if (displayStatus === 'cancelled') { statusClass = 'event-status-cancelled'; statusText = 'Cancelled'; }
                    const eventCard = `
                        <div class="task-card event-card" style="position: relative; padding-bottom: 5rem;">
                            <div class="task-header">
                                <div>
                                    <h3 class="task-title">${event.title}</h3>
                                    <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 1.2rem; margin: 1.2rem 0 0.3rem 0;">
                                        <div class="event-status-label ${statusClass}">${statusText}</div>
                                        <span><strong>Registration Deadline:</strong> ${event.registration_deadline ? new Date(event.registration_deadline).toLocaleString() : ''}</span>
                                        <span><strong>Event Date:</strong> ${event.event_date ? new Date(event.event_date).toLocaleString() : ''}</span>
                                        <span><strong>Location:</strong> ${event.location}</span>
                                        <span><strong>Created by:</strong> ${creatorName}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="task-description">${event.description || ''}</div>
                            <div class="task-actions" style="position: absolute; bottom: 35px; right: 35px; display: flex; align-items: center; gap: 0.5rem; z-index: 10;">
                                <button class="btn-modify" onclick="editEvent(${event.id})" title="Edit">Edit</button>
                                <button class="btn-decline" onclick="deleteEvent(${event.id})" title="Delete" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">Delete</button>
                            </div>
                        </div>
                    `;
                    container.append(eventCard);
                });
            }
            // Call loadEvents when switching to Events tab
            $('.nav-tab[data-tab="events"]').on('click', function() {
                loadEvents();
            });

            // Edit event logic
            async function editEvent(eventId) {
                // Find the event
                const event = (window.currentEvents || []).find(e => e.id === eventId) || null;
                if (!event) {
                    alert('Event not found.');
                    return;
                }
                // Fill the form
                $('#editEventId').val(event.id);
                $('#editEventTitle').val(event.title);
                $('#editEventDescription').val(event.description);
                $('#editEventDateTime').val(event.event_date ? event.event_date.slice(0, 16) : '');
                $('#editEventRegistrationDeadline').val(event.registration_deadline ? event.registration_deadline.slice(0, 16) : '');
                $('#editEventMaxParticipants').val(event.max_participants);
                $('#editEventLocation').val(event.location);
                $('#editEventStatus').val(event.status);
                $('#editEventSuccess').hide();
                // If event.task_id exists, fetch the task and pre-fill fields
                if (event.task_id && typeof db.getTask === 'function') {
                    const task = await db.getTask(event.task_id);
                    if (task) {
                        $('#editEventToTaskCheckbox').prop('checked', true);
                        $('#editEventTaskFields').show();
                        $('#editTaskCode').val(task.task_code || '');
                        $('#editTaskPoints').val(task.points || '');
                    } else {
                        $('#editEventToTaskCheckbox').prop('checked', false);
                        $('#editEventTaskFields').hide();
                        $('#editTaskCode').val('');
                        $('#editTaskPoints').val('');
                    }
                } else {
                    $('#editEventToTaskCheckbox').prop('checked', false);
                    $('#editEventTaskFields').hide();
                    $('#editTaskCode').val('');
                    $('#editTaskPoints').val('');
                }
                $('#editEventModal').css('display', 'flex');
            }
            function closeEditEventModal() {
                $('#editEventModal').css('display', 'none');
                $('#editEventForm')[0].reset();
                $('#editEventSuccess').hide();
            }
            $('#editEventForm').on('submit', async function(e) {
                e.preventDefault();
                const id = $('#editEventId').val();
                const title = $('#editEventTitle').val();
                const description = $('#editEventDescription').val();
                const event_date = $('#editEventDateTime').val();
                const registration_deadline = $('#editEventRegistrationDeadline').val();
                const max_participants = parseInt($('#editEventMaxParticipants').val(), 10);
                const location = $('#editEventLocation').val();
                const status = $('#editEventStatus').val();
                const toTask = $('#editEventToTaskCheckbox').is(':checked');
                const task_code = $('#editTaskCode').val();
                const points = parseInt($('#editTaskPoints').val(), 10);
                let task_id = null;
                if (toTask) {
                    // Create or update the task
                    const taskData = {
                        title,
                        description,
                        deadline: event_date,
                        task_code,
                        points,
                        created_by: currentUser.user?.id || currentUser.id
                    };
                    try {
                        if (typeof db.getTask === 'function' && typeof db.updateTask === 'function' && typeof db.createTask === 'function') {
                            // If event already has a task, update it
                            const event = (window.currentEvents || []).find(e => e.id == id);
                            if (event && event.task_id) {
                                const updatedTask = await db.updateTask(event.task_id, taskData);
                                task_id = updatedTask.id;
                            } else {
                                const newTask = await db.createTask(taskData);
                                task_id = newTask.id;
                            }
                        }
                    } catch (err) {
                        alert('Failed to create/update task for event.');
                        return;
                    }
                }
                const eventData = {
                    title,
                    description,
                    event_date,
                    registration_deadline,
                    max_participants,
                    location,
                    status,
                    task_id // store the linked task id if created
                };
                try {
                    if (typeof db.updateEvent === 'function') {
                        await db.updateEvent(id, eventData);
                        $('#editEventSuccess').show();
                        setTimeout(() => {
                            closeEditEventModal();
                            loadEvents();
                            loadTasks && loadTasks();
                        }, 1000);
                    } else {
                        alert('Event update not implemented in database.js');
                    }
                } catch (err) {
                    alert('Failed to update event.');
                }
            });

            // Add event status filter logic
            let currentEventStatusFilter = 'all';
            $(document).on('click', '.event-status-filter-btn', function() {
                $('.event-status-filter-btn').removeClass('active');
                $(this).addClass('active');
                currentEventStatusFilter = $(this).data('status');
                // Re-render events with filter
                renderEvents(window.currentEvents || []);
            });
            // Update renderEvents to filter by status
            function renderEvents(events) {
                const container = $('#eventsList');
                container.empty();
                if (!events || events.length === 0) {
                    container.html('<div class="empty-state"><h3>No events found</h3><p>Create your first event using the Add button above.</p></div>');
                    return;
                }
                // Filter events by status
                let filteredEvents = events;
                if (currentEventStatusFilter && currentEventStatusFilter !== 'all') {
                    filteredEvents = events.filter(e => {
                        // If event_date is in the past, treat as 'past' for filtering
                        const now = new Date();
                        const eventDate = e.event_date ? new Date(e.event_date) : null;
                        let displayStatus = e.status || 'upcoming';
                        if (eventDate && eventDate < now) displayStatus = 'past';
                        return displayStatus === currentEventStatusFilter;
                    });
                }
                if (filteredEvents.length === 0) {
                    container.html('<div class="empty-state"><h3>No events found for this status</h3></div>');
                    return;
                }
                filteredEvents.forEach(event => {
                    const creator = allUsers.find(u => u.id === event.created_by);
                    const creatorName = creator ? `${creator.first_name} ${creator.last_name}` : 'Unknown';
                    // Status label color and logic
                    let statusClass = 'event-status-upcoming';
                    let statusText = 'Upcoming';
                    const now = new Date();
                    const eventDate = event.event_date ? new Date(event.event_date) : null;
                    let displayStatus = event.status || 'upcoming';
                    if (eventDate && eventDate < now) displayStatus = 'past';
                    if (displayStatus === 'past') { statusClass = 'event-status-past'; statusText = 'Past'; }
                    else if (displayStatus === 'cancelled') { statusClass = 'event-status-cancelled'; statusText = 'Cancelled'; }
                    const eventCard = `
                        <div class="task-card event-card" style="position: relative; padding-bottom: 5rem;">
                            <div class="task-header">
                                <div>
                                    <h3 class="task-title">${event.title}</h3>
                                    <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 1.2rem; margin: 1.2rem 0 0.3rem 0;">
                                        <div class="event-status-label ${statusClass}">${statusText}</div>
                                        <span><strong>Registration Deadline:</strong> ${event.registration_deadline ? new Date(event.registration_deadline).toLocaleString() : ''}</span>
                                        <span><strong>Event Date:</strong> ${event.event_date ? new Date(event.event_date).toLocaleString() : ''}</span>
                                        <span><strong>Location:</strong> ${event.location}</span>
                                        <span><strong>Created by:</strong> ${creatorName}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="task-description">${event.description || ''}</div>
                            <div class="task-actions" style="position: absolute; bottom: 35px; right: 35px; display: flex; align-items: center; gap: 0.5rem; z-index: 10;">
                                <button class="btn-modify" onclick="editEvent(${event.id})" title="Edit">Edit</button>
                                <button class="btn-decline" onclick="deleteEvent(${event.id})" title="Delete" style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">Delete</button>
                            </div>
                        </div>
                    `;
                    container.append(eventCard);
                });
            }

            // Show/hide task fields based on checkbox
            $('#editEventToTaskCheckbox').on('change', function() {
              if ($(this).is(':checked')) {
                $('#editEventTaskFields').show();
                $('#editTaskCode').prop('required', true);
                $('#editTaskPoints').prop('required', true);
              } else {
                $('#editEventTaskFields').hide();
                $('#editTaskCode').prop('required', false);
                $('#editTaskPoints').prop('required', false);
              }
            });

            // Database setup and migration functions
            async function ensureFileUrlsColumn() {
                try {
                    // Test if file_urls column exists by trying to select it
                    const { data, error } = await supabase
                        .from('user_task_completions')
                        .select('file_urls')
                        .limit(1);
                    
                    if (error && error.message.includes('column "file_urls" does not exist')) {
                        console.log('file_urls column does not exist, please add it to your database');
                        return false;
                    }
                    return true;
                } catch (error) {
                    console.error('Error checking file_urls column:', error);
                    return false;
                }
            }

            // Initialize admin dashboard with database checks
            async function initializeAdminDashboard() {
                try {
                    // Check if file_urls column exists
                    const hasFileUrlsColumn = await ensureFileUrlsColumn();
                    if (!hasFileUrlsColumn) {
                        console.warn('File URLs column not found. File viewing will be limited.');
                    }
                    
                    // Continue with normal initialization
                    await loadInitialData();
                } catch (error) {
                    console.error('Error initializing admin dashboard:', error);
                }
            }

            // Enhanced file viewing and download functions

            // Chapter Dashboard Functions
            async function loadChapterDashboard() {
                try {
                    console.log('loadChapterDashboard called');
                    
                    // Load available chapters for selection
                    console.log('Loading available chapters...');
                    await loadAvailableChapters();
                    
                    // Load global rankings (always visible)
                    console.log('Loading global rankings...');
                    await loadGlobalRankings();
                    
                    console.log('Chapter dashboard loaded successfully');
                } catch (error) {
                    console.error('Error loading chapter dashboard:', error);
                }
            }

            async function loadAvailableChapters() {
                try {
                    console.log('=== LOADING AVAILABLE CHAPTERS ===');
                    console.log('Supabase client:', supabase);
                    
                    // Check if Supabase is available
                    if (!supabase) {
                        console.error('❌ Supabase client not available');
                        return;
                    }

                    console.log('✅ Supabase client found, attempting database query...');

                    // Try to load all chapters first (without the is_active filter)
                    console.log('Querying chapters table...');
                    
                    // First, let's see what columns exist in the chapters table
                    console.log('Testing different column combinations...');
                    
                    // Try with all columns first to see what's available
                    let { data: chapters, error } = await supabase
                        .from('chapters')
                        .select('*')
                        .order('school_name', { ascending: true });
                    
                    if (error) {
                        console.error('❌ Full select failed, trying minimal select...');
                        // Try with just id
                        const { data: minimalChapters, error: minimalError } = await supabase
                            .from('chapters')
                            .select('id')
                            .order('id', { ascending: true });
                        
                        if (minimalError) {
                            console.error('❌ Even minimal select failed:', minimalError);
                            throw minimalError;
                        }
                        
                        chapters = minimalChapters;
                        error = null;
                        console.log('✅ Minimal select successful:', chapters);
                    }

                    console.log('Query result:', { data: chapters, error });

                    if (error) {
                        console.error('❌ Supabase error:', error);
                        console.error('Error details:', error.message, error.details, error.hint);
                        return;
                    }

                    console.log('✅ Query successful, chapters data:', chapters);
                    console.log('Chapters type:', typeof chapters);
                    console.log('Chapters length:', chapters ? chapters.length : 'null/undefined');

                    const chapterSelect = document.getElementById('chapterSelect');
                    if (!chapterSelect) {
                        console.error('❌ Chapter select element not found');
                        return;
                    }

                    console.log('✅ Chapter select element found, updating dropdown...');
                    chapterSelect.innerHTML = '<option value="">Select a chapter...</option>';
                    
                    if (chapters && chapters.length > 0) {
                        console.log(`Processing ${chapters.length} chapters...`);
                        chapters.forEach((chapter, index) => {
                            console.log(`Chapter ${index + 1}:`, chapter);
                            const option = document.createElement('option');
                            option.value = chapter.id;
                            option.textContent = `${chapter.school_name || 'Unknown'} (${chapter.chapter_code || 'N/A'})`;
                            chapterSelect.appendChild(option);
                        });
                        console.log(`✅ Successfully loaded ${chapters.length} chapters from database`);
                    } else {
                        console.log('⚠️ No chapters found in database');
                        chapterSelect.innerHTML = '<option value="">No chapters available</option>';
                    }
                } catch (error) {
                    console.error('❌ Error loading available chapters:', error);
                    console.error('Error stack:', error.stack);
                    const chapterSelect = document.getElementById('chapterSelect');
                    if (chapterSelect) {
                        chapterSelect.innerHTML = '<option value="">Error loading chapters</option>';
                    }
                }
            }

            async function loadSelectedChapter(chapterId) {
                if (!chapterId) return;
                
                console.log('Loading selected chapter:', chapterId);
                
                try {
                    // Show the dashboard content
                    const dashboardContent = document.getElementById('chapterDashboardContent');
                    if (dashboardContent) {
                        dashboardContent.style.display = 'grid';
                    }
                    
                    // Load chapter-specific data
                    console.log('Loading chapter directors...');
                    await loadChapterDirectors(chapterId);
                    
                    console.log('Loading chapter stats...');
                    await loadChapterStats(chapterId);
                    
                    console.log('Loading member roster...');
                    await loadMemberRoster(chapterId);
                    
                    console.log('Loading join requests...');
                    await loadJoinRequests(chapterId);
                    
                    console.log('Chapter data loaded successfully');
                } catch (error) {
                    console.error('Error loading selected chapter:', error);
                }
            }

            async function loadChapterDirectors(chapterId) {
                try {
                    const { data: directors, error } = await supabase
                        .from('users')
                        .select('first_name, last_name, email')
                        .eq('role', 'chapter_director')
                        .eq('chapter_id', chapterId)
                        .eq('is_active', true);

                    if (error) throw error;

                    const directorsList = document.getElementById('directorsList');
                    if (directors && directors.length > 0) {
                        directorsList.innerHTML = directors.map(director => `
                            <div class="director-card">
                                <div class="director-icon">${director.first_name.charAt(0)}${director.last_name.charAt(0)}</div>
                                <div class="director-info">
                                    <p class="director-name">${director.first_name} ${director.last_name}</p>
                                    <small>${director.email}</small>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        directorsList.innerHTML = '<p class="loading-text">No chapter directors found</p>';
                    }

                    // Enable the change director button since we have a chapter selected
                    const changeDirectorBtn = document.getElementById('changeDirectorBtn');
                    if (changeDirectorBtn) {
                        changeDirectorBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('Error loading chapter directors:', error);
                    document.getElementById('directorsList').innerHTML = '<p class="loading-text">Error loading directors</p>';
                }
            }

            // Change Director Functions
            async function showChangeDirectorModal() {
                const chapterSelect = document.getElementById('chapterSelect');
                const selectedChapterId = chapterSelect ? chapterSelect.value : null;
                
                if (!selectedChapterId) {
                    alert('Please select a chapter first');
                    return;
                }
                
                // Load chapter status information
                await loadChapterStatusInfo(selectedChapterId);
                
                // Load current directors
                await loadCurrentDirectorsForModal(selectedChapterId);
                
                // Load available members for promotion
                await loadAvailableMembersForPromotion(selectedChapterId);
                
                // Show the modal
                document.getElementById('changeDirectorModal').style.display = 'flex';
            }

            async function loadCurrentDirectorsForModal(chapterId) {
                try {
                    const { data: directors, error } = await supabase
                        .from('users')
                        .select('id, first_name, last_name, email, role')
                        .eq('role', 'chapter_director')
                        .eq('chapter_id', chapterId)
                        .eq('is_active', true);

                    if (error) throw error;

                    const currentDirectorsList = document.getElementById('currentDirectorsList');
                    if (directors && directors.length > 0) {
                        currentDirectorsList.innerHTML = directors.map(director => `
                            <div class="director-card">
                                <div class="director-icon">${director.first_name.charAt(0)}${director.last_name.charAt(0)}</div>
                                <div class="director-info">
                                    <p class="director-name">${director.first_name} ${director.last_name}</p>
                                    <small>${director.email}</small>
                                </div>
                                <div class="director-actions" style="margin-top:.5rem; display:flex; gap:.5rem;">
                                    <button style="background:#6c757d; color:#fff; border:none; padding:.4rem .6rem; border-radius:6px; cursor:pointer;" onclick="adminDemoteDirector(${director.id})">Demote to Member</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        currentDirectorsList.innerHTML = '<p class="loading-text">No current directors</p>';
                    }
                } catch (error) {
                    console.error('Error loading current directors for modal:', error);
                    document.getElementById('currentDirectorsList').innerHTML = '<p class="loading-text">Error loading directors</p>';
                }
            }

            async function loadChapterStatusInfo(chapterId) {
                try {
                    // Get chapter information
                    const { data: chapter, error: chapterError } = await supabase
                        .from('chapters')
                        .select('name, school_name, chapter_code')
                        .eq('id', chapterId)
                        .single();

                    if (chapterError) throw chapterError;

                    // Get member count
                    const { data: members, error: membersError } = await supabase
                        .from('users')
                        .select('id')
                        .eq('chapter_id', chapterId)
                        .eq('is_active', true);

                    if (membersError) throw membersError;

                    const memberCount = members ? members.length : 0;

                    // Get director count
                    const { data: directors, error: directorsError } = await supabase
                        .from('users')
                        .select('id')
                        .eq('chapter_id', chapterId)
                        .eq('role', 'chapter_director')
                        .eq('is_active', true);

                    if (directorsError) throw directorsError;

                    const directorCount = directors ? directors.length : 0;

                    // Update the status display
                    const chapterStatusInfo = document.getElementById('chapterStatusInfo');
                    let statusHtml = '';

                    if (memberCount === 0) {
                        statusHtml = `
                            <div style="color: #dc3545; font-weight: 600; margin-bottom: 0.5rem;">
                                ⚠️ Chapter has no members
                            </div>
                            <div style="color: #6c757d; font-size: 0.9rem;">
                                <strong>${chapter.name || chapter.school_name}</strong> (${chapter.chapter_code}) currently has no members or directors.
                                <br>You can assign a new director from users who aren't part of any chapter.
                            </div>
                        `;
                    } else if (directorCount === 0) {
                        statusHtml = `
                            <div style="color: #ffc107; font-weight: 600; margin-bottom: 0.5rem;">
                                ⚠️ Chapter has no directors
                            </div>
                            <div style="color: #6c757d; font-size: 0.9rem;">
                                <strong>${chapter.name || chapter.school_name}</strong> (${chapter.chapter_code}) has ${memberCount} member(s) but no directors.
                                <br>You can promote an existing member to director.
                            </div>
                        `;
                    } else {
                        statusHtml = `
                            <div style="color: #28a745; font-weight: 600; margin-bottom: 0.5rem;">
                                ✅ Chapter is active
                            </div>
                            <div style="color: #6c757d; font-size: 0.9rem;">
                                <strong>${chapter.name || chapter.school_name}</strong> (${chapter.chapter_code}) has ${memberCount} member(s) and ${directorCount} director(s).
                            </div>
                        `;
                    }

                    chapterStatusInfo.innerHTML = statusHtml;
                } catch (error) {
                    console.error('Error loading chapter status info:', error);
                    const chapterStatusInfo = document.getElementById('chapterStatusInfo');
                    chapterStatusInfo.innerHTML = '<div style="color: #dc3545;">Error loading chapter status</div>';
                }
            }

            async function loadAvailableMembersForPromotion(chapterId) {
                try {
                    console.log('Loading available members for promotion for chapter:', chapterId);
                    
                    // Check if Supabase client is available
                    if (!supabase) {
                        console.error('Supabase client not available');
                        throw new Error('Database connection not available');
                    }
                    
                    // Check if chapterId is valid
                    if (!chapterId || isNaN(parseInt(chapterId))) {
                        console.error('Invalid chapter ID:', chapterId);
                        throw new Error('Invalid chapter ID provided');
                    }
                    
                    console.log('Supabase client available, proceeding with query...');
                    
                    // First, check if the chapter has any members at all
                    console.log('Checking for existing chapter members...');
                    const { data: chapterMembers, error: chapterError } = await supabase
                        .from('users')
                        .select('id, first_name, last_name, email, role')
                        .eq('chapter_id', chapterId)
                        .eq('is_active', true);

                    if (chapterError) {
                        console.error('Error checking chapter members:', chapterError);
                        throw chapterError;
                    }

                    console.log('Chapter members found:', chapterMembers ? chapterMembers.length : 0);

                    let availableUsers = [];

                    if (chapterMembers && chapterMembers.length > 0) {
                        // Chapter has members - get members who are not already directors
                        availableUsers = chapterMembers.filter(member => member.role !== 'chapter_director');
                        console.log('Available members from chapter:', availableUsers.length);
                    } else {
                        // Chapter has no members - get all users who aren't part of any chapter
                        console.log('Chapter has no members, looking for available users outside of chapters...');
                        
                        try {
                                                    const { data: availableUsersData, error: availableError } = await supabase
                            .from('users')
                            .select('id, first_name, last_name, email, role, school')
                            .is('chapter_id', null)
                        .eq('is_active', true)
                            .order('first_name', { ascending: true });

                            if (availableError) {
                                console.error('Error fetching available users:', availableError);
                                throw availableError;
                            }
                            
                            if (availableUsersData && availableUsersData.length > 0) {
                                availableUsers = availableUsersData;
                                console.log(`Found ${availableUsers.length} available users outside of chapters`);
                            } else {
                                console.log('No users found outside of chapters');
                            }
                        } catch (queryError) {
                            console.error('Error in available users query:', queryError);
                            // Fallback: try a simpler query
                            try {
                                console.log('Trying fallback query...');
                                const { data: fallbackData, error: fallbackError } = await supabase
                                    .from('users')
                                    .select('id, first_name, last_name, email, role')
                                    .is('chapter_id', null)
                                    .eq('is_active', true);

                                if (fallbackError) {
                                    console.error('Fallback query also failed:', fallbackError);
                                    throw fallbackError;
                                }

                                if (fallbackData && fallbackData.length > 0) {
                                    availableUsers = fallbackData;
                                    console.log(`Fallback query found ${availableUsers.length} users`);
                                }
                            } catch (fallbackError) {
                                console.error('Fallback query failed:', fallbackError);
                                throw fallbackError;
                            }
                        }
                    }

                    const newDirectorSelect = document.getElementById('newDirectorSelect');
                    const directorSelectionHelp = document.getElementById('directorSelectionHelp');
                    newDirectorSelect.innerHTML = '<option value="">Choose a member...</option>';
                    
                    if (availableUsers && availableUsers.length > 0) {
                        // Update help text based on whether we're dealing with existing members or external users
                        if (chapterMembers && chapterMembers.length > 0) {
                            directorSelectionHelp.textContent = 'Select a member from this chapter to promote to Chapter Director';
                        } else {
                            directorSelectionHelp.textContent = 'Select a user to assign to this chapter as Chapter Director (chapter currently has no members)';
                        }
                        
                        availableUsers.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            
                            // Different display text based on whether user is in the chapter or not
                            if (user.chapter_id === chapterId) {
                                // User is already in this chapter
                                option.textContent = `${user.first_name} ${user.last_name} (${user.email}) - ${user.role || 'Member'} - Current Chapter Member`;
                            } else {
                                // User is not in any chapter
                                option.textContent = `${user.first_name} ${user.last_name} (${user.email}) - ${user.role || 'Member'} - ${user.school || 'No School'} - Available for Assignment`;
                            }
                            
                            newDirectorSelect.appendChild(option);
                        });
                    } else {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No users available for promotion';
                        option.disabled = true;
                        newDirectorSelect.appendChild(option);
                        
                        // Update help text for no available users
                        directorSelectionHelp.textContent = 'No users available for promotion. All users are either already in chapters or inactive.';
                    }
                } catch (error) {
                    console.error('Error loading available members for promotion:', error);
                    const newDirectorSelect = document.getElementById('newDirectorSelect');
                    const directorSelectionHelp = document.getElementById('directorSelectionHelp');
                    
                    newDirectorSelect.innerHTML = '<option value="">Error loading members</option>';
                    
                    // Show more specific error message
                    if (error.message === 'Database connection not available') {
                        directorSelectionHelp.textContent = 'Database connection error. Please refresh the page and try again.';
                    } else if (error.message === 'Invalid chapter ID provided') {
                        directorSelectionHelp.textContent = 'Invalid chapter selected. Please select a different chapter.';
                    } else {
                        directorSelectionHelp.textContent = 'Error loading members. Please check the console for details and try again.';
                    }
                }
            }

            async function adminDemoteDirector(userId) {
                try {
                    if (!confirm('Demote this director to member?')) return;
                    const { error } = await supabase
                        .from('users')
                        .update({ role: 'member' })
                        .eq('id', userId);
                    if (error) throw error;
                    await showChangeDirectorModal();
                    alert('Director demoted to member.');
                } catch (e) {
                    console.error('Error demoting director:', e);
                    alert('Failed to demote director.');
                }
            }

            async function adminRemoveDirectorFromChapter(userId) {
                try {
                    if (!confirm('Remove this director from the chapter? They will become a regular member with no chapter.')) return;
                    const { error } = await supabase
                        .from('users')
                        .update({ role: 'member', chapter_id: null })
                        .eq('id', userId);
                    if (error) throw error;
                    await showChangeDirectorModal();
                    alert('Director removed from chapter.');
                } catch (e) {
                    console.error('Error removing director:', e);
                    alert('Failed to remove director.');
                }
            }

            async function confirmChangeDirector() {
                const newDirectorId = document.getElementById('newDirectorSelect').value;
                const action = document.querySelector('input[name="directorAction"]:checked').value;
                const reason = document.getElementById('changeReason').value;
                
                if (!newDirectorId) {
                    alert('Please select a new director');
                    return;
                }
                
                const chapterSelect = document.getElementById('chapterSelect');
                const selectedChapterId = chapterSelect ? chapterSelect.value : null;
                
                if (!selectedChapterId) {
                    alert('No chapter selected');
                    return;
                }
                
                try {
                    if (action === 'replace') {
                        // Demote all current directors to regular members
                        const { error: demoteError } = await supabase
                            .from('users')
                            .update({ role: 'member' })
                            .eq('chapter_id', selectedChapterId)
                            .eq('role', 'chapter_director')
                            .eq('is_active', true);
                        
                        if (demoteError) throw demoteError;
                    }
                    
                    // First, check if the user is already in the chapter
                    const { data: userData, error: userError } = await supabase
                        .from('users')
                        .select('chapter_id')
                        .eq('id', newDirectorId)
                        .single();
                    
                    if (userError) throw userError;
                    
                    // If user is not in the chapter, assign them to it first
                    if (!userData.chapter_id) {
                        console.log('Assigning user to chapter before promoting to director...');
                        const { error: assignError } = await supabase
                            .from('users')
                            .update({ chapter_id: selectedChapterId })
                            .eq('id', newDirectorId);
                        
                        if (assignError) throw assignError;
                    }
                    
                    // Promote the new director
                    const { error: promoteError } = await supabase
                        .from('users')
                        .update({ role: 'chapter_director' })
                        .eq('id', newDirectorId);
                    
                    if (promoteError) throw promoteError;
                    
                    // Log the change for audit purposes (console only for now)
                    console.log('Chapter director change logged:', {
                        action: action,
                        reason: reason,
                        newDirectorId: newDirectorId,
                        chapterId: selectedChapterId,
                        timestamp: new Date().toISOString()
                    });
                    
                    // Close modal and reload data
                    closeChangeDirectorModal();
                    await loadSelectedChapter(selectedChapterId);
                    
                    alert('Chapter director changed successfully!');
                    
                } catch (error) {
                    console.error('Error changing chapter director:', error);
                    alert('Error changing chapter director: ' + error.message);
                }
            }

            function closeChangeDirectorModal() {
                document.getElementById('changeDirectorModal').style.display = 'none';
                // Reset form
                document.getElementById('newDirectorSelect').value = '';
                document.getElementById('changeReason').value = '';
                document.querySelector('input[name="directorAction"][value="replace"]').checked = true;
            }

            async function loadChapterStats(chapterId) {
                try {
                    console.log('Loading chapter stats for chapter:', chapterId);
                    
                    // Load total chapters count
                    const { data: chapters, error: chaptersError } = await supabase
                        .from('chapters')
                        .select('id');

                    if (chaptersError) throw chaptersError;

                    const totalChapters = chapters ? chapters.length : 0;
                    console.log('Total chapters found:', totalChapters);
                    
                    // Update the overview stats
                    const totalChaptersElement = document.getElementById('totalChapters');
                    if (totalChaptersElement) {
                        totalChaptersElement.textContent = totalChapters;
                    }
                    
                    // Update the chapter-specific stats
                    const chapterTotalChaptersElement = document.getElementById('chapterTotalChapters');
                    if (chapterTotalChaptersElement) {
                        chapterTotalChaptersElement.textContent = totalChapters;
                    }
                    
                    // Calculate chapter rank based on alphabetical order (temporary ranking system)
                    if (chapters && chapters.length > 0) {
                        const { data: allChapters, error: rankError } = await supabase
                            .from('chapters')
                            .select('id, school_name')
                            .order('school_name', { ascending: true });
                        
                        if (!rankError && allChapters) {
                            const selectedChapterIndex = allChapters.findIndex(ch => ch.id === parseInt(chapterId));
                            const selectedRank = selectedChapterIndex !== -1 ? selectedChapterIndex + 1 : 'N/A';
                            console.log('Chapter rank calculated:', selectedRank);
                            
                            const chapterRankElement = document.getElementById('chapterRank');
                            if (chapterRankElement) {
                                chapterRankElement.textContent = selectedRank;
                            }
                        }
                    }
                    
                    // Calculate chapter points by summing member points
                    const { data: members, error: membersError } = await supabase
                        .from('users')
                        .select('id')
                        .eq('chapter_id', chapterId)
                        .eq('is_active', true);
                    
                    if (!membersError && members && members.length > 0) {
                        // Get points for each member from task completions
                        let totalChapterPoints = 0;
                        
                        for (const member of members) {
                            const { data: completions, error: pointsError } = await supabase
                                .from('user_task_completions')
                                .select('points_awarded')
                                .eq('user_id', member.id)
                                .in('status', ['completed', 'approved']);
                            
                            if (!pointsError && completions) {
                                const memberPoints = completions.reduce((sum, comp) => sum + (comp.points_awarded || 0), 0);
                                totalChapterPoints += memberPoints;
                            }
                        }
                        
                        console.log('Total chapter points calculated:', totalChapterPoints);
                        
                        const chapterPointsElement = document.getElementById('chapterPoints');
                        if (chapterPointsElement) {
                            chapterPointsElement.textContent = totalChapterPoints;
                        }
                    } else {
                        const chapterPointsElement = document.getElementById('chapterPoints');
                        if (chapterPointsElement) {
                            chapterPointsElement.textContent = '0';
                        }
                    }
                    
                } catch (error) {
                    console.error('Error loading chapter stats:', error);
                }
            }

            async function loadMemberRoster(chapterId) {
                try {
                    if (!chapterId) {
                        const memberTableBody = document.getElementById('memberTableBody');
                        if (memberTableBody) {
                            memberTableBody.innerHTML = '<tr><td colspan="5" class="loading-text">Please select a chapter to view members</td></tr>';
                        }
                        return;
                    }

                    console.log('Loading members for chapter:', chapterId);
                    console.log('Chapter ID type:', typeof chapterId, 'Value:', chapterId);

                    // Get all members of the selected chapter with their roles and other info
                    console.log('Querying users table for chapter_id:', chapterId);
                    
                    // First, let's see what users exist in the database
                    const { data: allUsers, error: allUsersError } = await supabase
                        .from('users')
                        .select('id, first_name, last_name, chapter_id, is_active')
                        .limit(10);
                    
                    if (allUsersError) {
                        console.error('Error fetching all users:', allUsersError);
                    } else {
                        console.log('Sample of all users:', allUsers);
                    }
                    
                    // Try to match chapter_id as both string and number since Supabase might store it differently
                    const chapterIdNum = parseInt(chapterId);
                    const chapterIdStr = chapterId.toString();
                    
                    console.log('Trying to match chapter_id as:', { chapterId, chapterIdNum, chapterIdStr });
                    
                    const { data: members, error } = await supabase
                        .from('users')
                        .select(`
                            id,
                            first_name,
                            last_name,
                            email,
                            role,
                            discord_username,
                            created_at,
                            chapter_id,
                            is_active
                        `)
                        .or(`chapter_id.eq.${chapterIdNum},chapter_id.eq.${chapterIdStr}`)
                        .eq('is_active', true)
                        .order('first_name', { ascending: true });

                    if (error) {
                        console.error('Error fetching members:', error);
                        throw error;
                    }

                    console.log('Members data:', members);
                    console.log('Number of members found:', members ? members.length : 0);

                    const memberTableBody = document.getElementById('memberTableBody');
                    if (members && members.length > 0) {
                        const memberCount = document.getElementById('memberCount');
                        if (memberCount) {
                            memberCount.textContent = `${members.length} members`;
                        }

                        // Get points for each member
                        const membersWithPoints = await Promise.all(
                            members.map(async (member) => {
                                const { data: completions, error: pointsError } = await supabase
                                    .from('user_task_completions')
                                    .select('points_awarded')
                                    .eq('user_id', member.id)
                                    .in('status', ['completed', 'approved']);
                                
                                const totalPoints = pointsError ? 0 : 
                                    completions.reduce((sum, comp) => sum + (comp.points_awarded || 0), 0);
                                
                                return {
                                    ...member,
                                    points: totalPoints
                                };
                            })
                        );
                        
                        if (memberTableBody) {
                            memberTableBody.innerHTML = membersWithPoints.map(member => `
                                <tr>
                                    <td>${member.first_name} ${member.last_name}</td>
                                    <td>${member.role || 'N/A'}</td>
                                    <td>${member.points}</td>
                                    <td>N/A</td>
                                    <td>${member.discord_username || 'N/A'}</td>
                                </tr>
                            `).join('');
                        }
                    } else {
                        if (memberTableBody) {
                            memberTableBody.innerHTML = '<tr><td colspan="5" class="loading-text">No members found</td></tr>';
                        }
                        const memberCount = document.getElementById('memberCount');
                        if (memberCount) {
                            memberCount.textContent = '0 members';
                        }
                    }
                } catch (error) {
                    console.error('Error loading member roster:', error);
                    const memberTableBody = document.getElementById('memberTableBody');
                    if (memberTableBody) {
                        memberTableBody.innerHTML = '<tr><td colspan="5" class="loading-text">Error loading members</td></tr>';
                    }
                }
            }

            async function loadJoinRequests(chapterId) {
                try {
                    if (!chapterId) {
                        const requestsTableBody = document.getElementById('requestsTableBody');
                        if (requestsTableBody) {
                            requestsTableBody.innerHTML = '<tr><td colspan="4" class="loading-text">Please select a chapter to view requests</td></tr>';
                        }
                        return;
                    }

                    const { data: requests, error } = await supabase
                        .from('chapter_join_request')
                        .select(`
                            id,
                            user_id,
                            reason,
                            status,
                            created_at,
                            users!inner(first_name, last_name, email)
                        `)
                        .eq('chapter_id', chapterId)
                        .eq('status', 'pending');

                    if (error) throw error;

                    const requestsTableBody = document.getElementById('requestsTableBody');
                    const requestCount = document.getElementById('requestCount');
                    
                    if (requests && requests.length > 0) {
                        if (requestCount) {
                            requestCount.textContent = `${requests.length} pending requests`;
                        }

                        if (requestsTableBody) {
                            requestsTableBody.innerHTML = requests.map(request => `
                                <tr>
                                    <td>${request.users.first_name} ${request.users.last_name}</td>
                                    <td>N/A</td>
                                    <td>${new Date(request.created_at).toLocaleDateString()}</td>
                                    <td>
                                        <div class="request-actions">
                                            <button class="approve-btn" onclick="approveJoinRequest(${request.id})">Approve</button>
                                            <button class="deny-btn" onclick="denyJoinRequest(${request.id})">Deny</button>
                                            <button class="view-reason-btn" onclick="viewRequestReason('${request.reason || 'No reason provided'}')">View</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('');
                        }
                    } else {
                        if (requestsTableBody) {
                            requestsTableBody.innerHTML = '<tr><td colspan="4" class="loading-text">No pending requests</td></tr>';
                        }
                        if (requestCount) {
                            requestCount.textContent = '0 pending requests';
                        }
                    }
                } catch (error) {
                    console.error('Error loading join requests:', error);
                    const requestsTableBody = document.getElementById('requestsTableBody');
                    if (requestsTableBody) {
                        requestsTableBody.innerHTML = '<tr><td colspan="4" class="loading-text">Error loading requests</td></tr>';
                    }
                }
            }

            async function loadGlobalRankings() {
                try {
                    console.log('Loading global rankings...');
                    
                    const { data: chapters, error } = await supabase
                        .from('chapters')
                        .select('id, school_name, chapter_code')
                        .limit(10);

                    if (error) throw error;

                    console.log('Chapters for rankings:', chapters);

                    const rankingsList = document.getElementById('rankingsList');
                    if (chapters && chapters.length > 0) {
                        // Calculate points for each chapter
                        const chaptersWithPoints = await Promise.all(
                            chapters.map(async (chapter) => {
                                // Get all members of this chapter
                                const { data: members, error: membersError } = await supabase
                                    .from('users')
                                    .select('id')
                                    .eq('chapter_id', chapter.id)
                                    .eq('is_active', true);
                                
                                let totalChapterPoints = 0;
                                
                                if (!membersError && members && members.length > 0) {
                                    // Get points for each member from task completions
                                    for (const member of members) {
                                        const { data: completions, error: pointsError } = await supabase
                                            .from('user_task_completions')
                                            .select('points_awarded')
                                            .eq('user_id', member.id)
                                            .in('status', ['completed', 'approved']);
                                        
                                        if (!pointsError && completions) {
                                            const memberPoints = completions.reduce((sum, comp) => sum + (comp.points_awarded || 0), 0);
                                            totalChapterPoints += memberPoints;
                                        }
                                    }
                                }
                                
                                return {
                                    ...chapter,
                                    points: totalChapterPoints
                                };
                            })
                        );
                        
                        // Sort chapters by points (highest first)
                        chaptersWithPoints.sort((a, b) => b.points - a.points);
                        
                        console.log('Chapters with points:', chaptersWithPoints);

                        // Set chapter of the season (highest points)
                        const topChapter = chaptersWithPoints[0];
                        const seasonChapterNameElement = document.getElementById('seasonChapterName');
                        const seasonChapterCodeElement = document.getElementById('seasonChapterCode');
                        const seasonLeaderElement = document.getElementById('seasonLeader');
                        
                        if (seasonChapterNameElement) {
                            seasonChapterNameElement.textContent = topChapter.school_name;
                        }
                        if (seasonChapterCodeElement) {
                            seasonChapterCodeElement.textContent = topChapter.chapter_code;
                        }
                        if (seasonLeaderElement) {
                            seasonLeaderElement.textContent = 'N/A';
                        }

                        // Set rankings list
                        if (rankingsList) {
                            rankingsList.innerHTML = chaptersWithPoints.map((chapter, index) => `
                                <div class="ranking-item">
                                    <span class="ranking-number">${index + 1}</span>
                                    <span class="ranking-chapter">${chapter.school_name} (${chapter.chapter_code})</span>
                                    <span class="ranking-points">${chapter.points}</span>
                                </div>
                            `).join('');
                        }
                    } else {
                        if (rankingsList) {
                            rankingsList.innerHTML = '<p class="loading-text">No rankings available</p>';
                        }
                    }
                } catch (error) {
                    console.error('Error loading global rankings:', error);
                    const rankingsList = document.getElementById('rankingsList');
                    if (rankingsList) {
                        rankingsList.innerHTML = '<p class="loading-text">Error loading rankings</p>';
                    }
                }
            }

            async function approveJoinRequest(requestId) {
                try {
                    const { error } = await supabase
                        .from('chapter_join_request')
                        .update({ status: 'approved' })
                        .eq('id', requestId);

                    if (error) throw error;

                    // Get the current selected chapter to reload data
                    const chapterSelect = document.getElementById('chapterSelect');
                    const selectedChapterId = chapterSelect ? chapterSelect.value : null;
                    
                    if (selectedChapterId) {
                        // Reload join requests and member roster for the current chapter
                        await loadJoinRequests(selectedChapterId);
                        await loadMemberRoster(selectedChapterId);
                    }
                    
                    alert('Join request approved successfully!');
                } catch (error) {
                    console.error('Error approving join request:', error);
                    alert('Error approving join request');
                }
            }

                        async function denyJoinRequest(requestId) {
                try {
                    const { error } = await supabase
                        .from('chapter_join_request')
                        .update({ status: 'denied' })
                        .eq('id', requestId);

                    if (error) throw error;

                    // Get the current selected chapter to reload data
                    const chapterSelect = document.getElementById('chapterSelect');
                    const selectedChapterId = chapterSelect ? chapterSelect.value : null;
                    
                    if (selectedChapterId) {
                        // Reload join requests for the current chapter
                        await loadJoinRequests(selectedChapterId);
                    }
                    
                    alert('Join request denied successfully!');
                } catch (error) {
                    console.error('Error denying join request:', error);
                    alert('Error denying join request');
                }
            }

            function viewRequestReason(reason) {
                alert(`Request Reason: ${reason}`);
            }



            // Helper function to get current user
            async function getCurrentUser() {
                try {
                    const { data: { user }, error } = await supabase.auth.getUser();
                    if (error) throw error;
                    
                    if (user) {
                        const { data: userProfile, error: profileError } = await supabase
                            .from('users')
                            .select('*')
                            .eq('id', user.id)
                            .single();
                        
                        if (profileError) throw profileError;
                        return userProfile;
                    }
                    return null;
                } catch (error) {
                    console.error('Error getting current user:', error);
                    return null;
                }
            }

            // Add chapter dashboard tab click handler
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOM loaded, setting up chapter dashboard...');
                
                const chapterTab = document.querySelector('[data-tab="chapter-dashboard"]');
                if (chapterTab) {
                    chapterTab.addEventListener('click', function() {
                        console.log('Chapter dashboard tab clicked');
                        loadChapterDashboard();
                    });
                } else {
                    console.error('Chapter dashboard tab not found');
                }

                // Add chapter selection event listeners
                const chapterSelect = document.getElementById('chapterSelect');
                const loadChapterBtn = document.getElementById('loadChapterBtn');

                if (chapterSelect) {
                    console.log('Chapter select found, adding event listener');
                    chapterSelect.addEventListener('change', function() {
                        const selectedChapterId = this.value;
                        loadChapterBtn.disabled = !selectedChapterId;
                        console.log('Chapter selected:', selectedChapterId);
                    });
                } else {
                    console.error('Chapter select element not found');
                }

                if (loadChapterBtn) {
                    console.log('Load chapter button found, adding event listener');
                    loadChapterBtn.addEventListener('click', function() {
                        const selectedChapterId = document.getElementById('chapterSelect').value;
                        if (selectedChapterId) {
                            console.log('Loading chapter:', selectedChapterId);
                            loadSelectedChapter(selectedChapterId);
                        }
                    });
                } else {
                    console.error('Load chapter button not found');
                }



                            // Also try to load chapters immediately if we're on the chapter dashboard tab
            setTimeout(() => {
                if (document.getElementById('chapter-dashboard-tab').classList.contains('active')) {
                    console.log('Chapter dashboard is active, loading chapters...');
                    loadChapterDashboard();
                }
            }, 100);


            });
        </script>
        <script>
            // Initialize Supabase client
            const supabase = window.supabaseClient || window.supabase;
            if (!supabase) {
                console.error('Supabase client not initialized. Ensure database.js is loaded.');
            } else {
                console.log('Supabase client found:', supabase);
            }
        </script>
    </body>
</html>